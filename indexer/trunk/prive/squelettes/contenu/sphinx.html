<h1>Test SPHINX</h1>

[(#FORMULAIRE_RECHERCHE{#SELF})]

<?php
/*
include_spip('inc/indexer');
$sphinx = new Sphinx\SphinxQL(SPHINX_SERVER_HOST, SPHINX_SERVER_PORT);

echo '<pre>';
print_r($sphinx->allfetsel('SELECT titre FROM spip WHERE MATCH(\'Paris Brest\') LIMIT 10'));
echo '</pre>';
*/

?>

<aside class="tri">

	[(#ENV{order}|match{date}|?{
		[(#SET{order,date DESC})]
		résultats triés par date
	})]

	<div>
	[(#GET{order}|?{
		<a href="[(#SELF|parametre_url{order,''})]">trier par pertinence</a>
	,
		<a href="[(#SELF|parametre_url{order,date})]">trier par date</a>
	})]
	</div>
</aside>



[(#SET{sql,"SELECT WEIGHT() AS score, *, SNIPPET(content,"[(#ENV*{recherche}|_q|concat{","})]'limit=200') as snippet FROM [(#ENV{source,spip})] WHERE MATCH([(#ENV*{recherche}|_q)])[ ORDER BY (#GET{order})] LIMIT 10})]



<pre>[(#GET{sql}|htmlspecialchars)]</pre>


<BOUCLE_recherche(DATA) {source SphinxQL, #GET{sql}} {si #ENV{recherche}}>
        <B_documents>
            <h2>Liste des documents trouvés</h2>
            <dl>
        <BOUCLE_documents(DATA){source tableau, #VALEUR}{si #CLE|=={docs}}>
                [<dt>#SCORE <a href="[(#URI)]">(#TITLE)</a>
                 [<small>(#DATE|affdate_court)</small>]
                </dt>
                 [<dd>(#SNIPPET|sinon{#SUMMARY})</dd>]
                ]
        </BOUCLE_documents>
            </dl>
        </B_documents>


        <B_meta>
            <h2>Métas associées</h2>
            <dl>
        <BOUCLE_meta(DATA){source tableau, #VALEUR}{si #CLE|=={meta}}>
                [<dt>(#CLE)</dt>]
                [<dt><pre>(#VALEUR*|print_r{1})</pre></dt>]
        </BOUCLE_meta>
            </dl>
        </B_meta>



</BOUCLE_recherche>



<h2>Facettes</h2>

[(#REM)

	Facette par calcul d'INTERVAL (regroupement de valeurs numériques dans des classes) ; ici la taille du contenu — ca pourrait ausssi être les dates (moins d'une heure, moins d'un jour, moins d'une semaine etc)...

]
[(#SET{grouper,'INTERVAL(UINT(properties.length),100,300,1000,3000,10000,30000)'})]
[(#SET{sqlf,"SELECT COUNT(*) AS c, "[(#GET{grouper}) AS grouper, ]GROUPBY() AS facette FROM [(#ENV{source,spip})] WHERE MATCH([(#ENV*{recherche}|_q)]) GROUP BY grouper ORDER BY c DESC LIMIT 10})]

[(#REM)

	Facette par JSON multivalué

]
[(#SET{sqlf,"SELECT COUNT(*) AS c, "GROUPBY() AS facette FROM [(#ENV{source,spip})] WHERE MATCH([(#ENV*{recherche}|_q)]) GROUP BY properties.tags ORDER BY c DESC LIMIT 10})]

<pre>[(#GET{sqlf}|htmlspecialchars)]</pre>


<BOUCLE_facettes(DATA) {source SphinxQL, #GET{sqlf}} {si #ENV{recherche}}>
        <B_facette>
            <h2>Liste des facettes</h2>
        <BOUCLE_facette(DATA){source tableau, #VALEUR}{si #CLE|=={docs}}>
		#VALEUR{c} = #VALEUR{facette}<br />
        </BOUCLE_facette>
        </B_facette>


        <B_meta2>
            <h2>Métas associées</h2>
            <dl>
        <BOUCLE_meta2(DATA){source tableau, #VALEUR}{si #CLE|=={meta}}>
                [<dt>(#CLE)</dt>]
                [<dt><pre>(#VALEUR*|print_r{1})</pre></dt>]
        </BOUCLE_meta2>
            </dl>
        </B_meta2>



</BOUCLE_facettes>
