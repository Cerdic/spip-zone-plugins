<h1>Test de l'indexer</h1>

<?php

if (_request('run') || _request('continue')) {
    include_spip('inc/indexer');
    $indexer = new Indexer\Indexer();

    try {
        $indexer->registerStorage(
            new Indexer\Storage\Sphinx(
                new Sphinx\SphinxQL\SphinxQL(SPHINX_SERVER_HOST, SPHINX_SERVER_PORT), SPHINX_DEFAULT_INDEX)
        );
    } catch( \Exception $e ) {
        if (!$message = $e->getMessage())
            $message = _L('Erreur inconnue');
        die("<p class='erreur'>$message</p>");
    }

    $sources = new Indexer\Sources\Sources();
    $sources->register('articles', new Spip\Indexer\Sources\Articles());
    $sources = pipeline('indexer_sources', $sources);

    $SpipSourcesIndexer = new Spip\Indexer\Sources\SpipSourcesIndexer($indexer, $sources);
    $SpipSourcesIndexer->setTablesLiensAuto();

    if (_request('run')) {
        $SpipSourcesIndexer->resetIndexesStats();
    }
    $res = $SpipSourcesIndexer->indexAll();

    if (!$res) {
        echo "\n<br/><a id='recharger' href='[(#SELF|parametre_url{run,''}|parametre_url{continue,1})]'>Recharger la page pour continuer l'indexation</a>";
        echo "<script type='text/javascript'>window.location.replace( $('#recharger').attr('href') );</script>";
    } else {
        echo "\n<pre>"; print_r($res); echo "</pre>";
    }
}
