
<h1>Test SPHINX</h1>

[(#FORMULAIRE_RECHERCHE{#SELF})]

#SET{tri,''}
#SET{sens_tri,''}

<aside class="tri">
	[(#ENV{order}|match{date}|?{
		[(#SET{tri,date})]
		[(#SET{sens_tri,-1})]
		résultats triés par date
	})]
	<div>
	[(#GET{tri}|?{
		<a href="[(#SELF|parametre_url{order,''})]">trier par pertinence</a>
	,
		<a href="[(#SELF|parametre_url{order,date})]">trier par date</a>
	})]
	</div>
</aside>


<B_filtres>
<h4>Filtres:</h4>
<BOUCLE_filtres(DATA){source tableau, #ARRAY{auteur,Aucun auteur,tag,Aucun tag,annee,Aucune année}}>
[(#ENV{#CLE}|oui)
	<div>
		<a class="btn btn-mini" href="[(#SELF|parametre_url{#CLE,''})]"><i class="icon-remove"></i> [(#ENV{#CLE}|=={-}|?{#VALEUR,#ENV{#CLE}})]</a>
	</div>
]</BOUCLE_filtres>


<BOUCLE_recherche_sphinx(SPHINX)
	{index #ENV{source,spip}}
	{recherche #ENV*{recherche}}

	{pages #DEBUT_DOCUMENTS}

	{filter #ENV{annee},  'YEAR(date) = @valeur' }
	{filter #ENV{tag},    'IN(properties.tags, @valeurs)',    'LENGTH(properties.tags) = 0'}
	{filter #ENV{auteur}, 'IN(properties.authors, @valeurs)', 'LENGTH(properties.authors) = 0'}

	{par #GET{tri}}{inverse #GET{sens_tri}}

	{facet auteur, properties.authors ORDER BY COUNT(*) DESC}
	{facet tag,    properties.tags ORDER BY COUNT(*) DESC}
	{facet annee, YEAR(date) ORDER BY date DESC}
>

	<h1>Dans la boucle (SPHINX)</h1>
	<pre>#QUERY</pre>

	[(#INCLURE{fond=liste/sphinx_documents,docs,meta,env})]
	[(#INCLURE{fond=liste/sphinx_facettes,facets,env})]
	[(#INCLURE{fond=liste/sphinx_metas,meta,env})]

</BOUCLE_recherche_sphinx>


