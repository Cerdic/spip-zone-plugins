[(#SET{id_rubrique, #ENV{id_rubrique}|intval})]
[(#SET{id_secteur_exclus, #ENV{id_secteur_exclus}|?{#ENV{id_secteur_exclus}|explode{','},#ARRAY}})]
[(#SET{niveau_max_txt, #ENV{niveau}|intval|?{#ENV{niveau},infini}})]
[(#SET{niveau_max, #ENV{niveau}|intval|?{#ENV{niveau},1000}})]
[(#SET{sousrub_cond, #ENV{sousrub_cond}|=={oui}|?{'on',''}})]
[(#SET{afficher_articles, #ENV{afficher_articles}|=={oui}|?{'on',''}})]
[(#SET{masquer_articles_uniques, #ENV{masquer_articles_uniques}|=={oui}|?{'on',''}})]
[(#SET{articles_max, #ENV{articles_max}|intval|?{#ENV{articles_max},10000}})]
[(#SET{articles_max_plus_un, #GET{articles_max}|plus{1}})]

[(#SET{articles_max_affiches, #ENV{articles_max_affiches}|intval|?{#ENV{articles_max_affiches},10000}})]

[(#SET{id_rubriques_exclues, #ENV{id_rubriques_exclues}|?{#ENV{id_rubriques_exclues}|explode{','},#ARRAY}})]

[(#SET{tri_num, #ENV{tri_num}|ou{#ENV{tri_alpha}}|?{#ENV{tri_num},'titre'}})]
[(#SET{tri_alpha, #ENV{tri_num}|ou{#ENV{tri_alpha}}|?{#ENV{tri_alpha},'titre'}})]
[(#ENV{appel_formulaire}|oui)
	[(#SET{titre, #GET{id_rubrique}|?{#INFO_TITRE{rubrique, #GET{id_rubrique}}, <:info_racine_site:>}})]
	[(#ENV{secteurlangue}non)<div class="titre">#GET{titre}</div>]
	[(#ENV{secteurlangue}oui)<div class="titre"><:menus:nom_menu_secteurlangue:></div>]
	<div class="infos">
		[(#GET{niveau_max_txt}|=={infini}|non)
			<:menus:entree_sur_n_niveaux{n=#GET{niveau_max_txt}}:>
		]
		[(#GET{niveau_max_txt}|=={infini}|oui)
			<:menus:entree_infini:>
		]
		[(#GET{id_secteur_exclus}|oui)
			<:menus:info_secteur_exclus{id_secteur=#ENV{id_secteur_exclus}}:>
		]
		[(#GET{id_rubriques_exclues}|oui)
			<:menus:info_rubriques_exclues{id_rubriques=#ENV{id_rubriques_exclues}}:>
		]
		[(#GET{sousrub_cond}|oui)
			<br /><:menus:info_sousrub_cond:>
		]
		[(#GET{afficher_articles}|oui)
			<br /><:menus:info_afficher_articles:>
            [(#GET{articles_max}|<{10000}|oui) / <:menus:info_articles_max{max=#GET{articles_max}}:>]
            [(#GET{articles_max_affiches}|<{10000}|oui) / <:menus:info_articles_max_affiches{max=#GET{articles_max_affiches}}:>]
            [(#GET{masquer_articles_uniques}|oui) / <:menus:info_masquer_articles_uniques:>]
		]
		<br /><:menus:info_tri:> [(#GET{tri_num}) <:menus:info_tri_num:>][(#GET{tri_num}|et{GET{tri_alpha}}), ][(#GET{tri_alpha}) <:menus:info_tri_alpha:>]
	</div>
]
<BOUCLE_appel(CONDITION){si #ENV{appel_menu}|oui}>
	<BOUCLE_rubriques(RUBRIQUES){id_parent=#GET{id_rubrique}}{id_secteur !IN #GET{id_secteur_exclus}}{id_rubrique !IN #GET{id_rubriques_exclues}}{par num #GET{tri_num}}{par #GET{tri_alpha}}>
		#SET{niveau_actuel,#EVAL{1}|intval}
		<li class="menu-entree item[ (#ID_RUBRIQUE|menus_exposer{rubrique,#ENV*{env}})]">
			<a href="#URL_RUBRIQUE" title="[(#TITRE|attribut_html)]">#TITRE</a>
			[(#SET{cond,#GET{niveau_max}|>{#GET{niveau_actuel}}|et{#GET{sousrub_cond}|?{#ID_RUBRIQUE|menus_exposer{rubrique,#ENV*{env}},'on'}}})]
			<BOUCLE_test_niveau(CONDITION){si #GET{cond}}>
                <B_sous_rubriques>
                <ul class="menu-liste menu-items">
                    <BOUCLE_sous_rubriques(RUBRIQUES){id_parent}{id_rubrique !IN #GET{id_rubriques_exclues}}{par num #GET{tri_num}}{par #GET{tri_alpha}}>
                        #SET{niveau_actuel,#GET{niveau_actuel}|plus{1}}
                        <li class="menu-entree item[ (#ID_RUBRIQUE|menus_exposer{rubrique,#ENV*{env}})]">
                            <a href="#URL_RUBRIQUE" title="[(#TITRE|attribut_html)]">#TITRE</a>
                            [(#SET{cond,#GET{niveau_max}|>{#GET{niveau_actuel}}|et{#GET{sousrub_cond}|?{#ID_RUBRIQUE|menus_exposer{rubrique,#ENV*{env}},'on'}}})]
                            <BOUCLE_test_niveau2(CONDITION){si #GET{cond}}>
                            <BOUCLE_sous_sous(BOUCLE_sous_rubriques)></BOUCLE_sous_sous>
                            </BOUCLE_test_niveau2>
                        </li>
                    </BOUCLE_sous_rubriques>

					[(#REM) ------------------------------------------------
                            Premier cas de gestion de l'affichage des articles 
                    		Ce code est dupliqué dans le 2e cas, voir ci dessous (a un ul pres)
                            Il n'est pas possible en spip 2 d'utiliser inclure pour eviter la duplication
                            Cf http://comments.gmane.org/gmane.comp.web.spip.devel/60475
                            Ce doit etre le meme soucis qui fait que #URL_RUBRIQUE est trasnforme en
                            spip.php?page=rubrique&id_rubrique=2&connect=condition qu'on enleve avec le filtre parametre_url ]

                    <BOUCLE_test_articles_si_sousrub(CONDITION){si #GET{afficher_articles}}>
                    	[(#REM) On commence par compter le nombre d'articles de la rubrique]
                        #SET{cpt,0}
                        <BOUCLE_cpt_si_sousrub(ARTICLES){id_rubrique}> </BOUCLE_cpt_si_sousrub>#SET{cpt,#TOTAL_BOUCLE}</B_cpt_si_sousrub>
                
                    	[(#REM) On affiche les articles :
                                 - S'il y en a moins que le max demandé 
                                 - ET - si on n'a pas demandé de masquage des articles uniques
                                 	  - OU si le masquage des articles uniques est demandé et qu'il y en a plus d'un ]
                        #SET{afficher,non}
                        [(#GET{cpt}|<={#GET{articles_max}}|oui|et{#GET{cpt}|>{1}|ou{#GET{masquer_articles_uniques}|=={'on'}|non}}) 		
                        	#SET{afficher,oui}]

                        <BOUCLE_test_afficher_si_sousrub(CONDITION){si #GET{afficher}|=={oui}|oui}>
                            <B_articles_si_sousrub>
                            <BOUCLE_articles_si_sousrub(ARTICLES){id_rubrique}{par num #GET{tri_num}}{par #GET{tri_alpha}}{0,#GET{articles_max_affiches}}>
                                <li class="menu-entree item[ (#ID_ARTICLE|menus_exposer{article,#ENV*{env}})]">
                                    <a href="#URL_ARTICLE" title="[(#TITRE|attribut_html)]">#TITRE</a>
                                </li>
                            </BOUCLE_articles_si_sousrub>
                            [(#GET{cpt}|>{#GET{articles_max_affiches}}|oui)
                            	<li><a class="suite" href="[(#URL_RUBRIQUE|parametre_url{connect,''})]"><:menus:tous_les_articles:></a></li>	
                            ]
                            </B_articles_si_sousrub>
                        </BOUCLE_test_afficher_si_sousrub>
                     </BOUCLE_test_articles_si_sousrub>
                    [(#REM) --------------------------- Fin Premier cas ]
                </ul>
                </B_sous_rubriques>

					[(#REM) ---------------------------------- 
                            Second cas de gestion de l'affichage des articles ]
                    <BOUCLE_test_articles_pas_de_sousrub(CONDITION){si #GET{afficher_articles}}>
                    	[(#REM) On commence par compter le nombre d'articles de la rubrique]
                        <BOUCLE_cpt_pas_de_sousrub(ARTICLES){id_rubrique}> </BOUCLE_cpt_pas_de_sousrub>#SET{cpt,#TOTAL_BOUCLE}</B_cpt_pas_de_sousrub>
                
                    	[(#REM) On affiche les articles :
                                 - S'il y en a moins que le max demandé 
                                 - ET - si on n'a pas demandé de masquage des articles uniques
                                 	  - OU si le masquage des articles uniques est demandé et qu'il y en a plus d'un ]
                        #SET{afficher,non}
                        [(#GET{cpt}|<={#GET{articles_max}}|oui|et{#GET{cpt}|>{1}|ou{#GET{masquer_articles_uniques}|=={'on'}|non}}) 		
                        	#SET{afficher,oui}]

                        <BOUCLE_test_afficher_pas_de_sousrub(CONDITION){si #GET{afficher}|=={oui}|oui}>
                            <B_articles_pas_de_sousrub>
                            <ul class="menu-liste menu-items">
                            <BOUCLE_articles_pas_de_sousrub(ARTICLES){id_rubrique}{par num #GET{tri_num}}{par #GET{tri_alpha}}{0,#GET{articles_max_affiches}}>
                                <li class="menu-entree item[ (#ID_ARTICLE|menus_exposer{article,#ENV*{env}})]">
                                    <a href="#URL_ARTICLE" title="[(#TITRE|attribut_html)]">#TITRE</a>
                                </li>
                            </BOUCLE_articles_pas_de_sousrub>
                            [(#GET{cpt}|>{#GET{articles_max_affiches}}|oui)
                            	<li><a class="suite" href="[(#URL_RUBRIQUE|parametre_url{connect,''})]"><:menus:tous_les_articles:></a></li>	
                            ]
                            </ul>
                            </B_articles_pas_de_sousrub>
                        </BOUCLE_test_afficher_pas_de_sousrub>
                     </BOUCLE_test_articles_pas_de_sousrub>
                    [(#REM) --------------------------- Fin Second cas ]

                <//B_sous_rubriques>
			</BOUCLE_test_niveau>
		</li>
	</BOUCLE_rubriques>
</BOUCLE_appel>
