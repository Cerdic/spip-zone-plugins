[(#CACHE{0})][(#REM)
             ACS
         (Plugin Spip)
         Squelette Cat
    http://acs.geomaticien.org

Copyright Daniel FAIVRE, 2007-2011
Copyleft: licence GPL - Cf. LICENCES.txt in acs plugin dir

Insere une carte interactive utilisant JSON. Requiert les plugins gis_escoitar et openlayers.

Note: les fonds de plan Google ne sont disponibles QUE si la librairie Google Map API a été chargée par le plugin éponyme

Centrage et zoom de la carte selon les paramètres (latit, lonxit, zoom) reçus,
sinon sur celles du mot-clé id_mot passé en parametre, 
sinon sur celles de l'article id_article,
sinon sur celles de la rubrique id_rubrique,
sinon sur les coordonnées et le zoom par défaut du composant (variables ACS),
ou à défaut sur celles par défaut du plugin GIS Escoitar.

Paramètres:
- id_carte_gis: id de l'élément div de la carte (pour Openlayers)
- lat, lon, zoom: latitude, longitude, et zoom initiaux.
- maxmots: nb max de pictos de mots-clés géoréférencés.
- maxrubs: nb max de pictos de rubriques géoréférencés.
- maxarts: nb max de pictos d'articles géoréférencés.

][(#SET{id_carte_gis,#ENV{id_carte_gis,1}})]<BOUCLE_centrer_article(GIS){id_rubrique=0}{id_article}{0,1}>[(#ENV{lat}|non)#SET{latitude,#LAT}][(#ENV{lon}|non)#SET{lonxitude,#LONX}][(#ENV{zoom}|non)#SET{zoommapa,#ZOOM}]ca</BOUCLE_centrer_article>
<BOUCLE_centrer_rubrique(GIS){id_rubrique}{id_article=0}{0,1}>[(#ENV{lat}|non)#SET{latitude,#LAT}][(#ENV{lon}|non)#SET{lonxitude,#LONX}][(#ENV{zoom}|non)#SET{zoommapa,#ZOOM}]cr</BOUCLE_centrer_rubrique>
<BOUCLE_centrer_mot(gis_mots){id_mot}{0,1}>[(#ENV{lat}|non)#SET{latitude,#LAT}][(#ENV{lon}|non)#SET{lonxitude,#LONX}][(#ENV{zoom}|non)#SET{zoommapa,#ZOOM}]cm</BOUCLE_centrer_mot>
[(#REM)
  
  Sinon centrer sur les coordonnes passees en parametre ou sur celles par defaut
  
  ][(#GET{latitude}|non)#SET{latitude,#ENV{lat,#VAR{#EVAL{'acsCarte'.'#NIC'.'Lat'},#CONFIG**{geomap/latitude,0}}}}]
  [(#GET{lonxitude}|non)#SET{lonxitude,#ENV{lon,#VAR{#EVAL{'acsCarte'.'#NIC'.'Lon'},#CONFIG**{geomap/longitude,0}}}}]
  [(#GET{zoommapa}|non)#SET{zoommapa, #ENV{zoom,#VAR{#EVAL{'acsCarte'.'#NIC'.'Zoom'},#CONFIG**{geomap/zoom,0}}}]
  
  <script type="text/javascript">
  if (document.namespaces) { // only needed in IE
    document.namespaces.add("v", "urn:schemas-microsoft-com:vml");
  }
  //<![CDATA[
  defPicto = "[(#ACS_CHEMIN{pictos/#VAR{#EVAL{'acsCarte'.'#NIC'.'Picto'},interrogation.png}}|url_absolue)]";
  defPictoWidth = "[(#ACS_CHEMIN{pictos/#VAR{#EVAL{'acsCarte'.'#NIC'.'Picto'},interrogation.png}}|largeur)]";
  defPictoHeight = "[(#ACS_CHEMIN{pictos/#VAR{#EVAL{'acsCarte'.'#NIC'.'Picto'},interrogation.png}}|hauteur)]";
  defPictoHover = "[(#ACS_CHEMIN{pictos/#VAR{#EVAL{'acsCarte'.'#NIC'.'PictoHover'},interrogation_hover.png}}|url_absolue)]";
  defPictoHoverWidth = "[(#ACS_CHEMIN{pictos/#VAR{#EVAL{'acsCarte'.'#NIC'.'PictoHover'},interrogation_hover.png}}|largeur)]";
  defPictoHoverHeight = "[(#ACS_CHEMIN{pictos/#VAR{#EVAL{'acsCarte'.'#NIC'.'PictoHover'},interrogation_hover.png}}|hauteur)]";
  defAttente = "[(#CHEMIN{img_pack/attente.gif}|url_absolue)]";
  
  var map[(#GET{id_carte_gis})];
  var markerManager[(#GET{id_carte_gis})];

  OpenLayers.ImgPath = '[(#ACS_CHEMIN{mapui,dir}|url_absolue)/]';

  function getPictos[(#GET{id_carte_gis})]() {
    loadPictos(map[(#GET{id_carte_gis})], '[(#URL_PAGE{c})&type=text/javascript&c=carte[&nic=(#NIC)]&p=symbols_json&cache=3600,cache-client][&recherche=(#RECHERCHE)][&id_rubrique=(#ID_RUBRIQUE)][&id_groupe=(#ID_GROUPE)][&id_mot=(#ID_MOT)][&id_auteur=(#ID_AUTEUR)][&limit=(#ENV{limit,50})][&maxmots=(#ENV{maxmots,[(#VAR{#EVAL{'acsCarte'.'#NIC'.'Mots'}}|=={non}|?{0})]})][&maxrubs=(#ENV{maxrubs,[(#VAR{#EVAL{'acsCarte'.'#NIC'.'Rubriques'}}|=={non}|?{0})]})][&maxarts=(#ENV{maxarts,[(#VAR{#EVAL{'acsCarte'.'#NIC'.'Articles'}}|=={non}|?{0})]})]', '[(#GET{id_carte_gis})]', '<:gis:loading_msg:>', [(#VAR{acsCartePictosPins}|=={oui}|?{true,false})]);
  }

  function loadCarte[(#GET{id_carte_gis})]() {
  	jQuery("[#(#GET{id_carte_gis})]").css("overflow", "hidden");
    map[(#GET{id_carte_gis})] = new OpenLayers.Map("map[(#GET{id_carte_gis})]",{
      maxExtent: new OpenLayers.Bounds(-180,-90,180,90),
      numZoomLevels: 19,
      maxResolution: 156543.0399,
      units: 'm',
      projection: new OpenLayers.Projection("EPSG:900913"),
      displayProjection: new OpenLayers.Projection("EPSG:4326"),
      eventListeners: {
        "zoomend": function() {
        if (map[(#GET{id_carte_gis})].initialized)
        	getPictos[(#GET{id_carte_gis})]();
        }
      },
      theme: null,
      pictos: new Array
    });
    map[(#GET{id_carte_gis})].initialized = false;
    if (jQuery("#acsCarte[(#NIC)]Lat").length && jQuery("#acsCarte[(#NIC)]Lon").length && jQuery("#acsCarte[(#NIC)]Zoom").length) {
      map[(#GET{id_carte_gis})].events.register("mousemove", map[(#GET{id_carte_gis})], function(e) { 
        var position = map[(#GET{id_carte_gis})].getCenter();
        position = position.transform(map[(#GET{id_carte_gis})].projection,map[(#GET{id_carte_gis})].displayProjection);
        jQuery("#acsCarte[(#NIC)]Lat").attr('value', position.lat);
        jQuery("#acsCarte[(#NIC)]Lon").attr('value', position.lon);
        jQuery("#acsCarte[(#NIC)]Zoom").attr('value', map[(#GET{id_carte_gis})].getZoom());
      });
    }      
    [(#VAR{#EVAL{'acsCarte'.'#NIC'.'ShowLayerSwitcher'}}|!={non}|?{" "})map[(#GET{id_carte_gis})].addControl(new OpenLayers.Control.LayerSwitcher());]
    markers[(#GET{id_carte_gis})] = new OpenLayers.Layer.Markers("Markers");
    var lon = #GET{lonxitude};
    var lat = #GET{latitude};
    var zoom = #GET{zoommapa};
    var lonlat = new OpenLayers.LonLat(lon, lat);
    var lyrs = new Array;
    [(#VAR{#EVAL{'acsCarte'.'#NIC'.'OpenStreetmap'}}|!={non}|?{" "})lyrs.push(new OpenLayers.Layer.OSM());]
    [(#VAR{#EVAL{'acsCarte'.'#NIC'.'Osmarender'}}|!={non}|?{" "})lyrs.push(new OpenLayers.Layer.OSM.Osmarender("Osmarender"));]
    if (typeof G_PHYSICAL_MAP != "undefined") {
      [(#VAR{#EVAL{'acsCarte'.'#NIC'.'gPhy'}}|!={non}|?{" "})lyrs.push(new OpenLayers.Layer.Google("<:acs:carte_rues_google:>",{type: G_PHYSICAL_MAP}));]
      [(#VAR{#EVAL{'acsCarte'.'#NIC'.'gMap'}}|!={non}|?{" "})lyrs.push(new OpenLayers.Layer.Google("<:acs:carte_google:>"));]
      [(#VAR{#EVAL{'acsCarte'.'#NIC'.'gHyb'}}|!={non}|?{" "})lyrs.push(new OpenLayers.Layer.Google("<:acs:carte_sat_rues_google:>",{type: G_HYBRID_MAP}));]
      [(#VAR{#EVAL{'acsCarte'.'#NIC'.'gSat'}}|!={non}|?{" "})lyrs.push(new OpenLayers.Layer.Google("<:acs:carte_sat_google:>",{type: G_SATELLITE_MAP}));]
    }    
    [(#VAR{#EVAL{'acsCarte'.'#NIC'.'WMS'}}|!={non}|?{" "})lyrs.push(new OpenLayers.Layer.WMS(
      "#CONFIG{openlayer/nom_serveur_openlayer,OpenLayers WMS}",
      "#CONFIG{openlayer/url_script_openlayer,http://labs.metacarta.com/wms/vmap0}",
      {layers: 'basic'}
    ));]
    map[(#GET{id_carte_gis})].addLayers(lyrs);
    map[(#GET{id_carte_gis})].addLayer(markers[(#GET{id_carte_gis})]);
    map[(#GET{id_carte_gis})].zoomTo(zoom);
    map[(#GET{id_carte_gis})].setCenter(lonlat.fromDataToDisplay());

    // Disable zoom with MouseWheel
    var disableZoomWheel = [(#VAR{#EVAL{'acsCarte'.'#NIC'.'ZoomWheel'}}|!={non}|?{false, true})];
    if (disableZoomWheel) {
      var controls = map[(#GET{id_carte_gis})].getControlsByClass('OpenLayers.Control.Navigation');
      for(var i = 0; i<controls.length; ++i){
        controls[i].disableZoomWheel();
      }
    }
    
    // Chargement KML article
    <BOUCLE_kml_art(documents){id_article}{0,1}{extension=kml}>[
      (#ENV{id_article}|=={''}|non)
      var kml = new OpenLayers.Layer.GML("KML", "[(#URL_DOCUMENT|url_absolue)]", {
      format: OpenLayers.Format.KML
    });
      map[(#GET{id_carte_gis})].addLayer(kml);
    ]</BOUCLE_kml_art>
    
    // Chargement KML rubrique
    <BOUCLE_kml_rub(documents){id_rubrique}{0,1}{extension=kml}>
    [(#ENV{id_rubrique}|=={''}|non)
    var kml = new OpenLayers.Layer.GML("KML", "[(#URL_DOCUMENT|url_absolue)]", {
      format: OpenLayers.Format.KML
    });
    map[(#GET{id_carte_gis})].addLayer(kml);
    ]
    </BOUCLE_kml_rub>
    <//B_kml_art>
    getPictos[(#GET{id_carte_gis})]();
    map[(#GET{id_carte_gis})].initialized = true;
  }
  [(#ENV{load_map}|!={'non'}|oui)
  jQuery(document).ready(function(){
  	loadCarte[(#GET{id_carte_gis})]();
    [(#ENV{attente}|=={1}|oui) jQuery("#map[(#GET{id_carte_gis})]").append('<div id="attente[(#GET{id_carte_gis})]" style="position: absolute; z-index: 1000; top: 0; left: 0; background-color: #FFFFFF; filter:alpha(opacity=70); -moz-opacity: 0.7; opacity: 0.7;[ width: (#ENV{largeur,100%});][ height: (#ENV{hauteur,100%});]"><span style="display: block; width: 100%; height: 100%; background: transparent url([(#CHEMIN{img_pack/attente.gif})]) center center no-repeat;"></span></div>'); ]
  });
  /*
  jQuery(window).resize(function() {
    alert("resize");
  });*/]
  
  //]]>
  </script>