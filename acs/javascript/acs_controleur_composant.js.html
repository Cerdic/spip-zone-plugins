[(#REM)
               ACS
           (Plugin Spip)
      http://acs.geomaticien.org

  Copyright Daniel FAIVRE, 2007-2010
  Copyleft: licence GPL - Cf. LICENCES.txt

  JS interface d'admin d'ACS - ACS admin GUI

  Active les controleurs de composants sur la partie publique du site et gere les drag/drop de composants

]#HTTP_HEADER{'Content-Type: text/javascript'}

function init_controleur_composant() {
  jQuery(".edit_composant").each(
  	function(i, composant) {
    	jQuery(this).draggable({zIndex: 99999000, handle: ".acs_box_titre"});
    	jQuery(this).find(".acs_box_titre").css("cursor", "move");
  	}
  );
  jQuery(".type_pinceau").each(
  	function(i, composant) {
    	jQuery(this).draggable({
    		helper: "clone",
    		delay: 100,
    		distance: 20,
    		ghosting: true,
    		opacity:	0.9,
        cursor: "move",
        zIndex: 99999999
			});
  	}
  );
  jQuery(".cadre-composant").droppable({
  	accept: ".type_pinceau",
    greedy: true,
    tolerance: "pointer",
		activeClass: "ctlWidget_droppable_active",
		hoverClass: "ctlWidget_droppable_over",
		over: function(e, cc) {
      var dropid = cQuery(this).attr("id");
      var current = cQuery(this).find(".type_pinceau");
      if (!current) return false;
      if (!current.attr("class")) return false;
      var current_i = current.attr("class").match(/\b\w+-(\w+)-(\d+)\b/);
      var current_c = current_i[1];
      var current_nic = current_i[2];
      var from = cc.draggable.parent();
      var new_i = cc.draggable.attr("class").match(/\b\w+-(\w+)-(\d+)\b/);
      var new_c = new_i[1];
      var new_nic = new_i[2];
      window.status = dropid + ' = ' + current_c + '-' + current_nic + ' => ' + new_c + '-' + new_nic + ' (' + from.attr("id") +')';
		},
    drop: function(e, cc) {
      cQuery(".cadre-composant").removeClass("ctlWidget_droppable_over");
      cQuery(this).addClass("ctlWidget_droppable_drop");
      var dropid = cQuery(this).attr("id");
      var current = cQuery(this).find(".type_pinceau");
      var current_i = current.attr("class").match(/\b\w+-(\w+)-(\d+)\b/);
      var current_c = current_i[1];
      var current_nic = current_i[2];
      var current_value = current_c + ((current_nic != "0") ? '-' + current_nic : '');
      
      var from = cc.draggable.parent();
      var new_i = cc.draggable.attr("class").match(/\b\w+-(\w+)-(\d+)\b/);
      var new_c = new_i[1];
      var new_nic = new_i[2];
      var new_value = new_c + ((new_nic != "0") ? '-' + new_nic : '');

      [(#REM) Reste à ouvrir les controleurs des deux composants concernes, pour valider les changements
      On recupere ou on ouvre le controleur du composant "cFrom", qui contient le composant avec la variable de type widget "from"
      
      ]var cFrom = from.parents('.crayon:eq(0)');
      [(#REM) Si le parent n'a pas de pinceau, prendre le grand-parent 
      ]if (!cFrom.hasClass("type_pinceau")) {
        cFrom = from.parent().parents('.crayon:eq(0)');
        [(#REM) Si le grand-parent non plus n'a pas de pinceau, echec
        ]if (!cFrom.hasClass("type_pinceau")) return false;
      }
      var cFrom_i = cFrom.attr("class").match(/\b\w+-(\w+)-(\d+)\b/);
      var cFrom_c = cFrom_i[1];
      var cFrom_nic = cFrom_i[2];
      var ccf = cFrom.find(".edit_composant");
      if (!cQuery.isPlainObject(ccf)) {
        cQuery(cFrom).opencrayon(e);
      }
      setSelectValueThreaded(from.attr("id"), current_value, cc.draggable.parent(), current, '#composant-' + cFrom_c + '-' + cFrom_nic);

      [(#REM) On recupere ou on ouvre le controleur du composant "cTo", qui contient le composant avec la variable de type widget "dropid"
      ]var cTo = cQuery(this).parents('.crayon:eq(0)');
      [(#REM)  Si le parent n'a pas de pinceau, prendre le grand-parent 
      ]if (!cTo.hasClass("type_pinceau")) {
        cTo = cQuery(this).parent().parents('.crayon:eq(0)');
        [(#REM) Si le grand-parent non plus n'a pas de pinceau, echec 
        ]if (!cTo.hasClass("type_pinceau")) return false;
      }
      var cTo_i = cTo.attr("class").match(/\b\w+-(\w+)-(\d+)\b/);
      var cTo_c = cTo_i[1];
      var cTo_nic = cTo_i[2];
      var cct = cTo.find(".edit_composant");
      if (!cQuery.isPlainObject(cct)) {
        cQuery(cTo).opencrayon(e);
      }
      setSelectValueThreaded(dropid, new_value, cQuery(this), cc.draggable, '#composant-' + cTo_c + '-' + cTo_nic);      
      
      window.status = dropid + ' = ' + current_value + ' => ' + new_value + ' (' + from.attr("id") +')';
      cQuery(this).removeClass("ctlWidget_droppable_drop");
    }
	});
}

function ucfirst(txt) {
  txt += '';
  var cap = txt.charAt(0).toUpperCase();
  return cap + txt.substr(1);
}

[(#REM) La mise à jour de valeurs dans les controleurs de composants utilise un systeme threaded
car le chargement en ajax des controleurs de composants est asynchrone.

]var todo = new Array();

function setSelectValueThreaded(acsvarname, value, parent, c, crayon_c) {
  todo[acsvarname] = new Array(value, parent, c, crayon_c);
  todo.length++;
  setSelectValueDoThreads();
}

function setSelectValueDoThreads() {
  if (todo.length == 0) return;
  var try_again = false;
  for(var avar in todo) {
    if (setSelectValue(avar, todo[avar][0])) {
      cQuery(todo[avar][3]).css('opacity', '0.1');
      todo[avar][1].append(todo[avar][2]);
      todo[avar][2].css('visibility', 'visible').css('opacity', '1');
      delete todo[avar];
      todo.length--;
    }
    else
      try_again = true;
  }
  if (try_again)
    window.setTimeout(setSelectValueDoThreads, 100);
}

function setSelectValue(acsvarname, value) {
  var select =  cQuery("select[id^='select_" + acsvarname + "_']");
  select.val(value);
  if (select.val() == value)
    return true;
  return false;
}