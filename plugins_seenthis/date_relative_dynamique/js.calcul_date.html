[(#HTTP_HEADER{Content-type: text/javascript[; charset=(#CHARSET)]})]

var chaines_lang = {
	'date_il_y_a': '<:date_il_y_a:>',
	'date_une_seconde': '<:date_une_seconde:>',
	'date_secondes': '<:date_secondes:>',
	'date_une_minute': '<:date_une_minute:>',
	'date_minutes': '<:date_minutes:>',
	'date_une_heure': '<:date_une_heure:>',
	'date_heures': '<:date_heures:>',

	'date_hier': '<:date_hier:>',
	'date_jours': '<:date_jours:>',

	'date_une_semaine': '<:date_une_semaine:>',
	'date_semaines': '<:date_semaines:>',

	'date_un_mois': '<:date_un_mois:>',
	'date_mois': '<:date_mois:>'
};


function _T(chaine, nom_val, val) {
	return chaines_lang[chaine].replace("@" + nom_val + "@", val);
}

/**
 * Intervalles pour formatter la date
 * [0]: intervalle valide en desous de cette valeur
 * [1]: facteur par lequel il faut diviser le nombre de secondes pour l'affichage
 * [2]: clé pour la traduction
 */
var intervalleFormattageDates = [
	[2, 1, 'date_une_seconde'],
	[60, 1, 'date_secondes'],
	[120, 60, 'date_une_minute'],
	[3600, 60, 'date_minutes'],
	[7200, 3600, 'date_une_heure'],
	[86400, 3600, 'date_heures'],
	[172800, -1, 'date_hier'],
	[1209600, 604800, 'date_une_semaine'],
	[2419200, 604800,'date_semaines'],
	[4838400, 2419200, 'date_un_mois'],
	[31449600, 2419200, 'date_mois']
];


function afficher_dates() {
	var date_now = Math.floor((new Date()).getTime() / 1000) + Math.floor($.cookie('dateoffset'));

	$(".calcul_date").each(function () {
		var $this = $(this);
		var date;
		if ($this.attr("datetime")) {
			var dateTime = new Date($this.attr("datetime"));
			date = Math.floor(dateTime.getTime() / 1000);
		} else if ($this.attr("title")) {
			date = Math.floor($this.attr("title"));
		}

		// L'age de l'article depend du serveur
		// l'age affichee depend du client
		var age = date_now - date;

		if(age < 1) {
			// date dans le futur :-(
			age = false;
		} else {
			var intervalle = null;
			// on parcourt les intervalles jusqu'à en trouver
			for (var i = 0; i < intervalleFormattageDates.length; i++) {
				var intervalle_courant = intervalleFormattageDates[i];
				if (age < intervalle_courant[0]) {
					intervalle = intervalle_courant;
					break;
				}
			}
			if (intervalle) {
				if (intervalle[1] == -1) {
					// formattage simplifié
					age = _T(intervalle[2])
				} else {
					age = _T("date_il_y_a", "delai", Math.max(1, Math.floor(age/ intervalle[1])) + " " + _T(intervalle[2]));
				}
			} else {
				age = false;
			}
		}

		if (age) {
			$this.attr('title', $this.html());
			$this.html(age);
		}

	});
}

// Masquer les dateServer
// puis recuperer date serveur
// donc reafficher dates pour calcul
$(function () {
	var calculDateInterval;
	function triggerCalculDateInterval(){
		calculDateInterval = setInterval(function(){
			afficher_dates();
		}, 1000)
	}

	triggerCalculDateInterval();
	$(document).on('visibilitychange', function(){
		if(document.hidden) {
			clearInterval(calculDateInterval);
		} else {
			triggerCalculDateInterval();
		}
	});

	if ($.cookie('dateoffset') == null) {
		var date_now = Math.floor((new Date()).getTime() / 1000);
		$.ajax({
			type: "POST",
			url: "[(#VAL{spip.php?action=dateoffset}|url_absolue)]",
			data: {time: date_now},
			complete: function (data) {
				var date_sql = Math.floor(data.responseText);
				if (date_sql > 1200000000) // sanity check sur la reponse
					$.cookie('dateoffset', date_sql - date_now, {path: "/"});
			}
		});
	}

});
