	
	<?php
######################################################################
# RECHERCHE MULTI-CRITERES                                           #
# Auteur: Dominique (Dom) Lepaisant - Novembre 2007                   #
# Adaptation de la contrib de Paul Sanchez - Netdeveloppeur          #
# http://www.netdeveloppeur.com                                      #
# Ce programme est un logiciel libre distribue sous licence GNU/GPL. #
# Pour plus de details voir le fichier COPYING.txt                   #
######################################################################
		$url = parse_url($_SERVER['QUERY_STRING']);
	 	
		$param =  $url['path'];
	 	$pos = 0;
	 	$indice = 255;
	?>
	
	<?php
	 
	 	if (isset($_POST['idmot'])) 
		{	
				
			// Récupération du nombre de jours
			// pour periodicité de la rechercher
			$nbjour = 0;
			if (isset($_POST['nbjour'])) 
			{
				$nbjour =$_POST['nbjour'];
			}
			
			// Récupération du nombre de jours
			// pour periodicité de la rechercher
			$idonlyrub = 0;
			if (isset($_POST['onlyrub'])) {
				if (isset($_POST['rubnum'])) {	
					$idonlyrub = $_POST['rubnum'];
				}
			}
			
			// 1 = Tous les mots doivent être associés aux articles trouvés
			$allword = 0;
			if (isset($_POST['allword'])) {
				$allword = 1;
			}
?>

<?php
/*
			if (isset($_POST['order'])) {	
				$order = $_POST['order'];
				if ($order == 0) 
				{
	?>
					<A HREF="./spip.php?<?php echo $param; ?>&order=1">
						Voir les résultats de la recherche classés par ordre de numéro de rubrique
					</A>
					<br />
					<br />
	<?php
				}
				else 
				{
					
	?>
					<A HREF="./spip.php?<?php echo $param; ?>&order=0">
						Voir les résultats de la recherche classés par nombre de mot clé
					</A>
					<br />
					<br />
	<?php
				}
			}
			else 
			{
	?>
				<A HREF="./spip.php?<?php echo $param; ?>&order=1">
					Voir les résultats de la recherche classés par ordre de numéro de rubrique
				</A>
				<br />
				<br />
	<?php		
			}
			
*/
	?>
	
	<?php
			$nbmot = count($_POST['idmot']);
						
			$sql = "select id_mot,titre from spip_mots where id_mot in (". implode(",", $_POST['idmot']) .") group by id_mot,titre";
			
			$result = mysql_query($sql);
			
			$tabmot = "<div style='margin-bottom:10px;text-align:center;width:100%;'><table align=\"center\" border=\"0\"><tr>";	
			$nbcol = 0;
			$nbcolmax = 4;
			
			if ($result) {
				
				$compt = 0; 
				while ($row = mysql_fetch_assoc($result)) {
					extract($row);
					$titre = supprimer_numero($titre);
					if ($nbcol == $nbcolmax) {
						$tabmot .= "</tr><tr>";
						$nbcol=0;
					}
					$tabmot .= "<td><img src='[(#CHEMIN{img_pack/key_go.png})]' alt=''> $titre </td>";
					$nbcol += 1;
				}
				mysql_free_result($result);
			}
			$tabmot .= "</tr></table></div>";
					
			$sql = "select count(*) as num,spip_articles.id_article,spip_rubriques.id_rubrique,spip_rubriques.titre as titrerub ";
			$sql .= "from spip_articles inner join spip_rubriques on spip_rubriques.id_rubrique = spip_articles.id_rubrique ";
			$sql .= "inner join spip_mots_articles on spip_mots_articles.id_article = spip_articles.id_article ";
			$sql .= " where spip_mots_articles.id_mot in (". implode(",", $_POST['idmot']) .") ";
			
			$datedeb = date("Y-m-d", mktime(0,0,0,date("m"),(date("d") - $nbjour),date("Y")));
			
			if ($nbjour != 0) 
			{
				$sql .= "and spip_articles.date >= '$datedeb' ";
			}
			
			if ($idonlyrub != 0) 
			{
					$sql .= "and spip_rubriques.id_rubrique= $idonlyrub ";
			}
					
			$sql .= "and spip_articles.statut like 'publie' group by spip_articles.id_article";
			if ($order == 1)
			{
				$sql .= " order by spip_rubriques.id_rubrique,num desc,spip_mots_articles.id_mot,spip_articles.date desc";
			}
			else 
			{	
				$sql .= " order by num desc,spip_rubriques.id_rubrique,spip_mots_articles.id_mot,spip_articles.date desc";	
			}
			
			$result = mysql_query($sql);
			
			//$nbart = mysql_num_rows($result);
			$nbart = 0;
			
			$resultataffiche = "";
			if ($result) {
				$titrerub = supprimer_numero($titrerub);
				$resultataffiche.= "<br />";
				$idrub = 0;
				$resultataffiche.= "<h1>Résultats :</h1>"; 
				$listidmot2 ="";
				$listidmotprec ="";
				
				while ($row = mysql_fetch_assoc($result)) {
					extract($row);
					if (($num != $nbmot) && ($allword == 1)) {
			 			break;
					}
					
					if ($idrub != $id_rubrique) {
						
						if (($pospoint = strrpos($titrerub,". ")) === FALSE) {
							 $titrerub2=$titrerub;
						}
						else {
							if (is_numeric(substr($titrerub,0,$pospoint)) == false)
								$titrerub2 = $titrerub;
							else 
								$titrerub2 = substr($titrerub,$pospoint + 2);
						}
					
						if ($order == 1) 
						{
								$resultataffiche.= "<br /><a href=\"./spip.php?fond=rubrique&id_rubrique=$id_rubrique\">$titrerub2 :</a><br />";
						}
					}
					
					$sql2 = "select spip_articles.id_article as artid, spip_articles.titre as titreart, spip_articles.date,spip_mots.id_mot ";
					$sql2 .= ", spip_mots.titre as titremot from spip_articles inner join spip_mots_articles on spip_mots_articles.id_article = spip_articles.id_article ";
					$sql2 .= "inner join spip_mots on spip_mots.id_mot=spip_mots_articles.id_mot ";
					$sql2 .= "where spip_articles.id_article = $id_article and spip_mots_articles.id_mot in (". implode(",", $_POST['idmot']) .")  and statut like 'publie' ";
					$sql2 .= "order by spip_mots.id_mot";
					
					$result2 = mysql_query($sql2);
					
					if ($result2) {
						$listmot = "<img src='[(#CHEMIN{img_pack/key_go.png})]' alt='' />";
						$titrearticle = "";
						$dataffich = "";
						$idart = 0;
						while ($row2 = mysql_fetch_assoc($result2)) {
							extract($row2);
							$listidmot2 .= "$id_mot,";
							if ($idart== 0) {
								$titrearticle = supprimer_numero($titreart);
								if (!(($pospoint = strpos($titrearticle,'.')) === FALSE))  {
							 		if (is_numeric(substr($titrearticle,0,$pospoint)) == true)
										$titrearticle = substr($titrearticle,$pospoint + 2);
																
								}
								if (!(($pospoint = strpos($titremot,'.')) === FALSE)) {
							 		if (is_numeric(substr($titremot,0,$pospoint)) == true)
										$titremot = substr($titremot,$pospoint + 2);
									
								}
								$dataffich = date("d/m/Y",strtotime($date))	;
							
								if ($order == 1) {
									$nbart += 1;
									$resultataffiche.= "<img src='[(#CHEMIN{img_pack/page_key.png})]' alt='' style='margin-left:10px' /> <a href=\"./spip.php?fond=article&id_article=$artid\">$titrearticle</a> <small>$dataffich </small>(";
									$resultataffiche.= "$titremot";		
								}
								
								$listmot .= "$titremot";
								$idart= 1;
							}
							else {
								$listmot .= ", $titremot";
								if ($order == 1) {
									$resultataffiche.= ", $titremot";		
								}
							}
						}
						
						if ($order == 1) {
							$resultataffiche.= ")<br />";
						}
						
						
						mysql_free_result($result2);
						
						if ($order == 0) {
							
							if ($listidmot2 != $listmodidprec) {
								$resultataffiche.= "<br />$listmot :<br />";
							}
							$nbart += 1;
							$resultataffiche.= "<img src='[(#CHEMIN{img_pack/page_key.png})]' alt='' style='margin-left:10px' /> <a href=\"./spip.php?article$id_article\">$titrearticle</a> <small>$dataffich</small>";
							$resultataffiche.= "&nbsp;(<i><a href=\"./spip.php?rubrique$id_rubrique\">$titrerub2</a></i>)<br />";
							$listmodidprec = $listidmot2;
							$listidmot2 = "";
						
						}
					
					}
					$idrub = $id_rubrique;
				}
				$resultataffiche.= "<br />";
				
				mysql_free_result($result);
				
				echo "<div class=\"text\">$nbart article(s) trouvé(s) pour les mots :<br />$tabmot";	
				echo "$resultataffiche";
//				echo "<p style=\"text-align: center;\"><a href=\"http://www.netdeveloppeur.com\" title=\"Net Developpeur, création sites web SPIP\"><font color=\"#CCCCCC\" size=\"1\" face=\"Verdana, Arial, Helvetica, sans-serif\">Développé par Net Developpeur - Création sites web SPIP</font></a></p>";
				
				
			}
			else {
				echo "<hr />";
				echo "<div class=\"text\">il n'y a pas d'article lié aux mots de numéro $the, $org<br /></div>";
				echo "<hr />";
					
			}
			
		}
		else {
			echo "<div class=\"text\">Merci de bien vouloir sélectionner au moins 1 mot clé!";
			echo "<br /><a href=\"javascript:history.back()\">Retour</a></div>";
			
		}
	?>
	

