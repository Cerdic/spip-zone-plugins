#SET{actions,#ARRAY}
#SET{dates,#ARRAY}
#SET{auteurs,#ARRAY}
#SET{actions_auteurs,#ARRAY}
<BOUCLE_journal_stats_total(JOURNAL){id_journal IN #ENV{id_journals}}{par objet,id_objet}>
	#SET{actions,
		#GET{actions}|push{#ACTION}
	}

	#SET{
		actions_auteurs,
		#GET{actions_auteurs}|array_merge{
			#ARRAY{
				action#ACTION_aut#ID_AUTEUR,
				#GET{actions_auteurs}|table_valeur{action#ACTION_aut#ID_AUTEUR,0}|plus{1},
				action_aut#ID_AUTEUR,
				#GET{actions_auteurs}|table_valeur{action_aut#ID_AUTEUR,0}|plus{1}
			}
		}
	}
	#SET{action_#ACTION,
		#GET{action_#ACTION,#ARRAY}|push{
			#ARRAY{id_journal,#ID_JOURNAL,date,#DATE}
		}
	}

	#SET{auteurs,#GET{auteurs}|push{#ID_AUTEUR}}
	#SET{date,#DATE|affdate{Y-m-d}}
	#SET{dates,#GET{dates}|push{#GET{date}}}

	[(#SET{action_date_[(#ACTION)]_[(#GET{date})],[(#GET{action_date_[(#ACTION)]_[(#GET{date})],0}|plus{1})]})]
</BOUCLE_journal_stats_total>
[(#SET{actions_uniques,[(#GET{actions}|array_unique)]})]
[(#SET{dates_uniques,[(#GET{dates}|array_unique)]})]
[(#SET{auteurs_uniques,[(#GET{auteurs}|array_unique)]})]
#SET{nb_actions,#GET{actions_uniques}|count}
#SET{nb_auteurs,#GET{auteurs_uniques}|count}
<h2><:bigbrother:titre_compilation_resultats:></h2>

<BOUCLE_plusieurs_actions(CONDITION){si #GET{nb_actions}|>{1}}>
<B_actions_par_auteurs>
	<div class="cadre-r cadre">
		<div class="cadre_padding">
			[(#ENV{id_auteur}|is_numeric|oui)
				#SET{auteur,#INFO_NOM{auteur,#ENV{id_auteur}}
			][(#ENV{id_auteur}|is_numeric|non)
				#SET{auteur,#ENV{id_auteur}}
			]
			[(#ENV{id_auteur}|oui)
			<h3><:bigbrother:titre_actions_nombre_par_auteur{auteur=#GET{auteur}}:></h3>]
			[(#ENV{id_auteur}|non)
			<h3><:bigbrother:titre_actions_nombre:></h3>]
			#ANCRE_PAGINATION
			<table class="bigbrother" id="graph_actions_auteurs_table">
				<thead>
					<tr class="row_first">
						<th><:bigbrother:thead_action:></th>
						<th class="nombre"><:bigbrother:thead_nombre:></th>
					</tr>
				</thead>
				<tbody>
			<BOUCLE_actions_par_auteurs(POUR){tableau #GET{actions_uniques}}{par valeur}{pagination #ENV{pagination,0}}>
				<tr class="tr_liste">
					<td class="action">
						[(#ENV{journal_action}|!={#VALEUR}|oui)<a href="[(#SELF|parametre_url{journal_action,#VALEUR})]" title="<:bigbrother:filtrer_par_action{action=#VALEUR}:>">]
						#VALEUR
						[(#ENV{journal_action}|!={#VALEUR}|oui)</a>]
					</td>
					<td class="nombre">
						[(#GET{action_[(#VALEUR)]}|count)]
					</td>
				</tr>
			</BOUCLE_actions_par_auteurs>
				</tbody>
			</table>
			[<div class="pagination pagination_bigbrother">(#PAGINATION{page_precedent_suivant})</div>]

			<div id="graph_actions_nombre" class="bigbrother_graphs"></div>
			<script type="text/javascript"><!--
				jQuery(document).ready(function(){
					var actions = [];
					var actions_labels = [];
					var actions_ticks = [];

					i=0;
					$('#graph_actions_auteurs_table tr.tr_liste').each(function(){
						var nombre = parseFloat(plot_trim($(this).find('.nombre').text()));
						actions.push([i,nombre]);
						var label = plot_trim($(this).find('.action').text());
						actions_labels.push(label);
						actions_ticks.push([i,label]);
						i++;
					});

					var data_actions = [{ data: actions }];
					var options = {
						points : {show:true},
						lines : {show:true},
						yaxis : {},
						xaxis : {ticks:actions_ticks},
						grid : { hoverable: true, clickable: true, autoHighlight : true,borderColor : '#ccc' }
					};

					$.plot($("#graph_actions_nombre"), data_actions, options);

					var previousPoint = null;
					$("#graph_actions_nombre").bind("plothover", function (event, pos, item) {
						if (item) {
							if (previousPoint != item.dataIndex) {
								previousPoint = item.dataIndex;
								$("#bigbrother_tooltip").remove();
								var x = item.datapoint[0].toFixed(2),
									y = item.datapoint[1].toFixed(2);

								var index = item.dataIndex;
								content = actions_labels[index];
								content += '<br />'+item.datapoint[1];
								plot_showtooltip(
									item.pageX,
									item.pageY,
									content,'bigbrother_tooltip');
							}
						}
						else {
							$("#bigbrother_tooltip").remove();
							previousPoint = null;
						}
					});
				});
			// --></script>
		</div>
	</div>
</B_actions_par_auteurs>
</BOUCLE_plusieurs_actions>
<BOUCLE_plusieurs_auteurs(CONDITION){si #GET{nb_auteurs}|>{1}}>
<B_action_par_auteur>
	<div class="cadre-r cadre">
		<div class="cadre_padding">
			[(#ENV{id_auteur}|is_numeric|oui)
				#SET{auteur,#INFO_NOM{auteur,#ENV{id_auteur}}
			][(#ENV{id_auteur}|is_numeric|non)
				#SET{auteur,#ENV{id_auteur}}
			]
			[(#ENV{id_auteur}|oui)
			<h3><:bigbrother:titre_actions_nombre_par_auteur{auteur=#GET{auteur}}:></h3>]
			[(#ENV{id_auteur}|non)
			<h3><:bigbrother:titre_actions_nombre_par_auteurs:></h3>]
			#FORMULAIRE_BIGBROTHER_PAGINATION{'graph_action_auteurs_table'}
			#ANCRE_PAGINATION
			<table class="bigbrother" id="graph_action_auteurs_table">
				<thead>
					<tr class="row_first">
						<th><:bigbrother:thead_action:></th>
						<th class="nombre"><:bigbrother:thead_nombre:></th>
					</tr>
				</thead>
				<tbody>
			<BOUCLE_action_par_auteur(POUR){tableau #GET{auteurs_uniques}}{par valeur}{pagination #ENV{pagination_action_par_auteur,0}}>
				<tr class="tr_liste">
					[(#VALEUR|is_numeric|oui)
						#SET{auteur,#INFO_NOM{auteur,#VALEUR}
					][(#VALEUR|is_numeric|non)
						#SET{auteur,#VALEUR}
					]
					<td class="auteur">
						[(#ENV{id_auteur}|!={#VALEUR}|oui)<a href="[(#SELF|parametre_url{id_auteur,#VALEUR})]" title="<:bigbrother:filtrer_par_auteur{auteur=#GET{auteur}}:>">]
						#GET{auteur}
						[(#ENV{id_auteur}|!={#VALEUR}|oui)</a>]
					</td>
					<td class="nombre">
						[(#GET{actions_auteurs}|table_valeur{action_aut#VALEUR})]
					</td>
				</tr>
			</BOUCLE_action_par_auteur>
				</tbody>
			</table>
			[<div class="pagination pagination_bigbrother">(#PAGINATION{page_precedent_suivant})</div>]

			<div id="graph_actions_auteur" class="bigbrother_graphs"></div>
			<script type="text/javascript"><!--
				jQuery(document).ready(function(){
					var auteurs = [];
					var auteurs_labels = [];
					var auteurs_ticks = [];

					i=0;
					$('#graph_action_auteurs_table tr.tr_liste').each(function(){
						var nombre = parseFloat(plot_trim($(this).find('.nombre').text()));
						auteurs.push([i,nombre]);
						var label = plot_trim($(this).find('.auteur').text());
						auteurs_labels.push(label);
						auteurs_ticks.push([i,label]);
						i++;
					});

					var data_auteurs = [{ data: auteurs }];
					var options = {
						points : {show:true},
						lines : {show:true},
						yaxis : {},
						xaxis : {ticks:auteurs_ticks},
						grid : { hoverable: true, clickable: true, autoHighlight : true,borderColor : '#ccc' }
					};

					$.plot($("#graph_actions_auteur"), data_auteurs, options);

					var previousPoint = null;
					$("#graph_actions_auteur").bind("plothover", function (event, pos, item) {
						if (item) {
							if (previousPoint != item.dataIndex) {
								previousPoint = item.dataIndex;
								$("#bigbrother_tooltip").remove();
								var x = item.datapoint[0].toFixed(2),
									y = item.datapoint[1].toFixed(2);

								var index = item.dataIndex;
								content = auteurs_labels[index];
								content += '<br />'+item.datapoint[1];
								plot_showtooltip(
									item.pageX,
									item.pageY,
									content,'bigbrother_tooltip');
							}
						}
						else {
							$("#bigbrother_tooltip").remove();
							previousPoint = null;
						}
					});
				});
			// --></script>
		</div>
	</div>
</B_action_par_auteur>
</BOUCLE_plusieurs_auteurs>
<//B_plusieurs_actions>

<B_actions_par_auteurs_date>
	<div class="cadre-r cadre">
		<div class="cadre_padding">
			[(#ENV{id_auteur}|is_numeric|oui)
				#SET{auteur,#INFO_NOM{auteur,#ENV{id_auteur}}
			][(#ENV{id_auteur}|is_numeric|non)
				#SET{auteur,#ENV{id_auteur}}
			]
			[(#ENV{id_auteur}|oui)
			<h3><:bigbrother:titre_actions_nombre_par_auteur_date{auteur=#GET{auteur}}:></h3>]
			[(#ENV{id_auteur}|non)
			<h3><:bigbrother:titre_actions_nombre_date:></h3>]
			#FORMULAIRE_BIGBROTHER_PAGINATION{'graph_actions_date_auteurs_table','select',7}
			#ANCRE_PAGINATION
			<table class="bigbrother" id="graph_actions_date_auteurs_table">
				<thead>
					<tr class="row_first">
						<th><:bigbrother:thead_date:></th>
						<th><:bigbrother:thead_action:></th>
						<th class="nombre"><:bigbrother:thead_nombre:></th>
					</tr>
				</thead>
				<tbody>
			<BOUCLE_actions_par_auteurs_date(POUR){tableau #GET{dates_uniques}}{par valeur}{inverse}{pagination #ENV{pagination_actions_par_auteurs_date,7}}>
				#SET{date,#VALEUR}
				#SET{date_nb,0}
				<BOUCLE_chaque_actions_par_auteur_date(POUR){tableau #GET{actions_uniques}}>
				#SET{date_nb,#GET{date_nb}|plus{1}}
				<tr class="tr_liste"[(#GET{action_date_[(#VALEUR)]_[(#GET{date})]}|non)style="display:none"]>
					<td class="date">
						<abbr[(#GET{date_nb}|=={1}|non)style="display:none"]>#GET{date}</abbr>
					</td>
					<td class="action action_#VALEUR">
						[(#ENV{journal_action}|!={#VALEUR}|oui)<a href="[(#SELF|parametre_url{journal_action,#VALEUR})]" title="<:bigbrother:filtrer_par_action{action=#VALEUR}:>">]
						#VALEUR
						[(#ENV{journal_action}|!={#VALEUR}|oui)</a>]
					</td>
					<td class="nombre">
						[(#GET{action_date_[(#VALEUR)]_[(#GET{date})]}|sinon{0})]
					</td>
				</tr>
				</BOUCLE_chaque_actions_par_auteur_date>
			</BOUCLE_actions_par_auteurs_date>
				</tbody>
			</table>
			[<div class="pagination pagination_bigbrother">(#PAGINATION{page_precedent_suivant})</div>]

			<div id="graph_actions_date_nombre" class="bigbrother_graphs"></div>
			<div id="choices"></div>
			<script type="text/javascript"><!--
				jQuery(document).ready(function(){
					var serie_actions = [];
					var options = {
						points : {show:true},
						lines : {show:true},
						yaxis : {},
						grid : { hoverable: true, clickable: true, autoHighlight : true,borderColor : '#ccc' }
					};
					<BOUCLE_series(POUR){tableau #GET{actions_uniques}}{par valeur}>
					var actions_date_#VALEUR = [];
					var actions_date_labels_#VALEUR = [];
					var actions_date_ticks_#VALEUR = [];

					i=0;
					$('#graph_actions_date_auteurs_table tr.tr_liste .action_#VALEUR').each(function(){
						var nombre = parseFloat(plot_trim($(this).parent().find('.nombre').text()));
						var label = plot_trim($(this).parent().find('.action').text());
						var tick = plot_trim($(this).parent().find('.date').text());
						actions_date_#VALEUR.push([i,nombre]);
						actions_date_labels_#VALEUR.push(label);
						actions_date_ticks_#VALEUR.push([i,tick]);
						i++;
					});

					options.xaxis = {ticks:actions_date_ticks_#VALEUR};
					var action_#VALEUR = {label:'#VALEUR',data:actions_date_#VALEUR, content:actions_date_labels_#VALEUR};
					serie_actions.push(action_#VALEUR);
					</BOUCLE_series>

					$.plot($("#graph_actions_date_nombre"), serie_actions, options);

					// hard-code color indices to prevent them from shifting as
				    // countries are turned on/off
				    var i = 0;
				    $.each(serie_actions, function(key, val) {
				        val.color = i;
				        ++i;
				    });

				    // insert checkboxes
					[(#ENV{journal_action}|non)
				    var choiceContainer = $("#choices");
				    $.each(serie_actions, function(key, val) {
				        choiceContainer.append('<br/><input type="checkbox" name="' + key +
				                               '" checked="checked" id="id' + key + '">' +
				                               '<label for="id' + key + '">'
				                                + val.label + '</label>');
				    });
					choiceContainer.find("input").click(plotAccordingToChoices);]


				    function plotAccordingToChoices() {
				        var data = [];

				        choiceContainer.find("input:checked").each(function () {
				            var key = $(this).attr("name");
				            if (key && serie_actions[key])
				                data.push(serie_actions[key]);
				        });

						$.plot($("#graph_actions_date_nombre"), data,options);
				    }

					var previousPoint = null;
					$("#graph_actions_date_nombre").bind("plothover", function (event, pos, item) {
						if (item) {
							if (previousPoint != item.dataIndex) {
								previousPoint = item.dataIndex;
								$("#bigbrother_tooltip").remove();
								var x = item.datapoint[0].toFixed(2),
									y = item.datapoint[1].toFixed(2);

								var index = item.dataIndex;
								content = '';
								content = item.series.content[index];
								content += '<br \/>'+item.datapoint[1];
								plot_showtooltip(
									item.pageX,
									item.pageY,
									content,'bigbrother_tooltip');
							}
						}
						else {
							$("#bigbrother_tooltip").remove();
							previousPoint = null;
						}
					});
				});
			// --></script>
		</div>
	</div>
</B_actions_par_auteurs_date>