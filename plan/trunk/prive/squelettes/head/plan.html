<INCLURE{fond=prive/squelettes/head/dist, env}>

[<link rel="stylesheet" href="(#CHEMIN{lib/jstree/dist/themes/default/style.min.css})" />]
[<script src="(#CHEMIN{lib/jstree/dist/jstree.min.js})"></script>]


<script type="text/javascript">
(function($){
$(document).ready(function(){
	$(function () {

		var $mytree = $('body.plan #contenu #racine');
		var $mytree_source = $mytree.clone();
		// $mytree.after($mytree_source);

		$mytree.jstree({
			"plugins" : [ "types", "search", "state" ],
			"core" : {
				"data" : function (node, cb) {
					// on est obligé de tout charger en ajax (même la racine)
					// donc on charge 1 fois la racine avec le html qu'on reçoit d'origine
					if (node.id === '#') {
						cb($mytree_source.html());
					}

					// et pour ce qu'on ne connait pas (classe css 'jstree-closed' sur un LI, et pas de UL à l'intérieur)
					// on fait un appel ajax pour obtenir la liste correspondant à l'objet souhaité, lorsque c'est demandé.
					else {
						var id_rubrique = node.parent.split('-')[1];
						var params = {
							"id_rubrique": id_rubrique,
							"objet": node.type
						};
						if ("#ENV{statut}") {
							params.statut = "#ENV{statut}";
						}
						console.log(params);
						$.ajax({
							url: "[(#VAL{plan}|generer_url_action{"", 1})]",
							data: params,
							dataType: 'html',
							cache: false,
						}).done(function(data) {
							cb(data);
						});
					}
				}
				/*,
				"themes" : {
					"variant" : "large"
				}*/
			},
			"search" : {
				"show_only_matches" : true,
			},
			"types" : {
				"default" : {
					"icon" : "[(#VAL{rubrique}|objet_icone{16}|extraire_attribut{src})]",
				}
				<BOUCLE_objets(DATA){source table,#REM|plan_lister_objets_rubrique}>
				,"[(#VALEUR|objet_type)]" : {
					"icon" : "[(#VALEUR|objet_icone{16}|extraire_attribut{src})]",
				}
				</BOUCLE_objets>
			}
		});

		// un clic d'une feuille amène sur son lien
		// mais… éviter que le plugin 'state' clique automatiquement lorsqu'il restaure
		// la sélection précédente !
		$mytree.one("restore_state.jstree", function () {
			$(this).on("changed.jstree", function (e, data) {
				data.instance.save_state();
				location.href = data.instance.get_node(data.node, true).children('a').attr('href');
			});
		});


		// recherche automatique
		$mytree_search = $("#mytree_search");

		var to = false;
		$mytree_search.keyup(function () {
			if (to) { clearTimeout(to); }
			to = setTimeout(function () {
				var v = $mytree_search.val();
				$mytree.jstree(true).search(v);
			}, 250);
		});

	});
});
})(jQuery);
</script>

<style type='text/css'>
#mytree_actions { margin-bottom:1em; margin-top:1em; }
#mytree_actions input,
#mytree_actions .pliage { margin-right:2em; }
</style>
