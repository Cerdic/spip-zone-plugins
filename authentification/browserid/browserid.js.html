#HTTP_HEADER{Content-Type: text/javascript; charset=#CHARSET}
/*
 *  Plugin BrowserID pour SPIP
 *
 *  (c) Fil 2011 - Licence GNU/GPL
 *
 */

[(#INCLURE{javascript/browserid.js})]

/*
 * fonction demandant au client de verifier l'assertion renvoyee
 * par browserid
 */
function browserid_verify_client(assertion) {
  if (assertion) {
    $.post("https://browserid.org/verify",
      {
      assertion: assertion,
      audience: window.location.href.replace(/(\/\/.*?)\/.*/, '$1')
      }, browserid_welcome
    );
  }
}


/*
 * fonction demandant au serveur de verifier l'assertion browserid
 * et de nous loger sur SPIP au passage, si le site est ainsi configure'
 */
function browserid_verify_server(assertion) {
  if (assertion) {
    $.post("?action=browserid_verify",
      {
      assertion: assertion,
      audience: window.location.href.replace(/(\/\/.*?)\/.*/, '$1')
      }, browserid_welcome
    );
  }
}


/*
 * Fonction appelee quand on a reussi a se connecter
 */
function browserid_welcome(e) {
  console.log(e);
  if (e.status == "okay") {
    if (e.message) {
      alert(e.message);
    }
    if (e.action) {
      eval(e.action);
    }
    if (url) {
      window.location = url;
    }
  } else {
    alert('something was wrong: '+(e.reason || ""));
  }
}
 
