<div class="formulaire_spip formulaire_configurer formulaire_configurer_gis">

[<p class="reponse_formulaire reponse_formulaire_ok">(#ENV*{message_ok})</p>]
[<p class="reponse_formulaire reponse_formulaire_erreur">(#ENV*{message_erreur})</p>]

<div id="map_config" class="carte_gis" style="width: 100%; height: 370px"></div>

<form method="post" action="#ENV{action}"><div>
	#ACTION_FORMULAIRE{#ENV{action}}
	<ul>
		[(#SAISIE{input,lat,
			label=<:gis:lat:>,
			defaut=0,
			size=40})]
		[(#SAISIE{input,lon,
			label=<:gis:lon:>,
			defaut=0,
			size=40})]
		[(#SAISIE{input,zoom,
			label=<:gis:zoom:>,
			defaut=0,
			size=2,
			maxlength=2})]
		
		[(#SET{apis,[(#ARRAY{
				openlayers,<:gis:cfg_lbl_api_openlayers:>,
				googlev3,<:gis:cfg_lbl_api_googlev3:>})]})]
		
		[(#VAL{_GIS_APIS}|defined|oui)
			[(#EVAL{_GIS_APIS}|unserialize|is_array|oui)#SET{apis,#EVAL{_GIS_APIS}|unserialize}]
		]
		
		[(#SET{api_defaut,openlayers})]
		[(#VAL{_GIS_APIS_DEFAUT}|defined|oui)
			[(#SET{api_defaut,[(#EVAL{_GIS_APIS_DEFAUT})]})]
		]
		[(#VAL{_GIS_APIS_FORCEE}|defined|oui)
			[(#SET{api_readonly,readonly})]
			[(#SET{api_disable,disabled})]
			[(#SET{api_forcee,[(#EVAL{_GIS_APIS_FORCEE})]})]
			[(#SET{api_explications,<:gis:explication_api_forcee:>})]
		]

		[(#SAISIE{selection,api,
			label=<:gis:cfg_lbl_api:>,
			cacher_option_intro=oui,
			defaut=#GET{api_defaut},valeur_forcee=#GET{api_forcee},readonly=#GET{api_readonly},disable=#GET{api_disable},explication=#GET{api_explications},
			datas=#GET{apis}})]

		[(#SET{maptypes,[(#ARRAY{
				ROAD,<:gis:cfg_lbl_maptype_carte:>,
				SATELLITE,<:gis:cfg_lbl_maptype_satellite:>,
				HYBRID,<:gis:cfg_lbl_maptype_hybride:>,
				PHYSICAL,<:gis:cfg_lbl_maptype_relief:>})]})]

		[(#VAL{_GIS_MAPTYPES}|defined|oui)
			[(#EVAL{_GIS_MAPTYPES}|unserialize|is_array|oui)#SET{apis,#EVAL{_GIS_MAPTYPES}|unserialize}]
		]

		[(#SET{maptype_defaut,carte})]
		[(#VAL{_GIS_MAPTYPES_DEFAUT}|defined|oui)
			[(#SET{maptype_defaut,[(#EVAL{_GIS_MAPTYPES_DEFAUT})]})]
		]
		[(#VAL{_GIS_MAPTYPES_FORCE}|defined|oui)
			[(#SET{maptype_readonly,readonly})]
			[(#SET{maptype_disable,disabled})]
			[(#SET{maptype_force,[(#EVAL{_GIS_MAPTYPES_FORCE})]})]
			[(#SET{maptype_explications,<:gis:explication_maptype_force:>})]
		]
		[(#SAISIE{selection,maptype,
			label=<:gis:cfg_lbl_maptype:>,
			cacher_option_intro=oui,
			defaut=#GET{maptype_defaut},valeur_forcee=#GET{maptype_force},readonly=#GET{maptype_readonly},disable=#GET{maptype_disable},explication=#GET{maptype_explications},
			datas=#GET{maptypes}})]

		[(#SAISIE{oui_non,geocoder,
			defaut='',
			label=<:gis:cfg_lbl_geocoder:>,
			explication=<:gis:cfg_inf_geocoder:>})]
		
		[(#SAISIE{oui_non,adresse,
			defaut='',
			label=<:gis:cfg_lbl_adresse:>,
			explication=<:gis:cfg_inf_adresse:>})]
		
		[(#SAISIE{oui_non,geolocaliser_user_html5,
			defaut='',
			label=<:gis:cfg_lbl_geolocaliser_user_html5:>,
			explication=<:gis:cfg_inf_geolocaliser_user_html5:>})]

		[(#SAISIE{choisir_objets,gis_objets,
			label=<:gis:cfg_lbl_activer_objets:>,
			exclus=spip_gis})]

	</ul>


	<p class="boutons">
		<input type="submit" name="_cfg_ok" class="submit" value="<:bouton_enregistrer:>" />
	</p>
</div></form>

<script type="text/javascript">
<!---
(function($){
	
	var maj_inputs = function(map,pos) {
		var zoom = map.getZoom();
		$("#champ_lat").val(pos.lat);
		$("#champ_lon").val(pos.lng);
		$("#champ_zoom").val(zoom);
	}
	
	var init_config = function() {
		var map;
		var map_container = 'map_config';
		map = new L.Map(map_container);
		
		map.attributionControl.setPrefix('');
		
		[(#SET{maptype, #REM|gis_maptype_utilise})]
		// defalut layer
		[(#REM|gis_api_utilisee|=={openlayers}|oui)
		var base_layer = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'});
		][(#VAL|gis_api_utilisee|=={googlev3}|oui)
		var base_layer = new L.Google('[(#GET{maptype}|replace{ROAD,ROADMAP}|replace{PHYSICAL,TERRAIN})]');
		]
		
		map.addLayer(base_layer);

		map.setView(new L.LatLng(#ENV{lat,0},#ENV{lon,0}),#ENV{zoom,0});
		/*
		map.addControls({
			pan: true,
			zoom: '#ENV{control,small}',
			map_type: true
		});
		*/
		
		var marker = new L.Marker(new L.LatLng(#ENV{lat,0},#ENV{lon,0}));
		map.addLayer(marker);
		
		// mettre a jour les coordonnees quand on clique la carte
		map.on('click', function(e) {
			marker.setLatLng(e.latlng);
			map.panTo(e.latlng);
			maj_inputs(map,e.latlng);
		});
		
		// mettre Ã  jour le zoom quand on le modifie
		map.on('zoomend', function(e) {
			$("#champ_zoom").val(e.target._zoom);
		});

	}

	$(function(){
		init_config();
		//onAjaxLoad(init_config);
	});

})(jQuery);
-->
</script>
</div>
