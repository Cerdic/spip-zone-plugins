<B_lieux>

<BOUCLE_lieux(VISITES_VIRTUELLES_LIEUX){id_lieu}>
<BOUCLE_visites(VISITES_VIRTUELLES){id_visite=#ID_VISITE}>
	
	
	<a id="[lieu(#ID_LIEU)]" name="[lieu(#ID_LIEU)]"></a>
	<BOUCLE_photo(DOCUMENTS){id_document=#ID_PHOTO}>
		<img src="#URL_DOCUMENT" unselectable="on" style="-moz-user-select: none; visibility: hidden;" class="panorama#ID_LIEU" width="#LARGEUR" height="#HAUTEUR"  
	</BOUCLE_photo>
	 alt="[(#_lieux:TITRE|texte_backend)]" usemap="map#ID_LIEU" />
	<B_interactions>
	<map id="map#ID_LIEU" name="map#ID_LIEU"> 
		<BOUCLE_interactions(VISITES_VIRTUELLES_INTERACTIONS){id_lieu}>
				[(#TYPE|=={'article'}|?{' ',''})<area shape="rect" coords="#X1,#Y1,#X2,#Y2" href="#URL_PAGE{article,id_article=#ID_ARTICLE_CIBLE}" class="interaction#ID_INTERACTION type-article" alt="#TITRE" />]
				[(#TYPE|=={'rubrique'}|?{' ',''})<area shape="rect" coords="#X1,#Y1,#X2,#Y2" href="#URL_PAGE{rubrique,id_rubrique=#ID_RUBRIQUE_CIBLE}" class="interaction#ID_INTERACTION type-rubrique" alt="#TITRE" />]
				[(#TYPE|=={'lieu'}|?{' ',''})<area shape="rect" coords="#X1,#Y1,#X2,#Y2" href="#URL_PAGE{lieu,id_lieu=#ID_LIEU_CIBLE}#[(#REM)]lieu#ID_LIEU_CIBLE" class="interaction#ID_INTERACTION type-lieu" alt="#TITRE" />]
				[(#TYPE|=={'visite'}|?{' ',''})<area shape="rect" coords="#X1,#Y1,#X2,#Y2" href="#URL_PAGE{visite,id_visite=#ID_VISITE_CIBLE}" class="interaction#ID_INTERACTION type-visite" alt="#TITRE" />]
				[(#TYPE|=={'url'}|?{' ',''})<area shape="rect" coords="#X1,#Y1,#X2,#Y2" href="#URL_CIBLE" class="interaction#ID_INTERACTION type-url" alt="#TITRE" />]
				[(#TYPE|=={'descriptif'}|?{' ',''})<area shape="rect" coords="#X1,#Y1,#X2,#Y2" href="#URL_PAGE{descriptif_interaction_ajax,id_interaction=#ID_INTERACTION&KeepThis=true&TB_iframe=true&height=400&width=600}" class="interaction#ID_INTERACTION type-descriptif thickbox" alt="#TITRE" />]
				<BOUCLE_documentimagepointe(DOCUMENTS){id_document=#ID_DOCUMENT_CIBLE}{extension IN jpg,JPG}>[(#TYPE|=={'document'}|?{' ',''})<area shape="rect" coords="#X1,#Y1,#X2,#Y2" href="#URL_DOCUMENT" class="interaction#ID_INTERACTION type-document thickbox" alt="[<b>(#TITRE|htmlspecialchars)</b>][<br />(#DESCRIPTIF|htmlspecialchars)]" />]</BOUCLE_documentimagepointe>
				<BOUCLE_documentmp3pointe(DOCUMENTS){id_document=#ID_DOCUMENT_CIBLE}{extension IN mp3,MP3}>[(#TYPE|=={'document'}|?{' ',''})<area shape="rect" coords="#X1,#Y1,#X2,#Y2" href="#URL_PAGE{document_ajax,id_document=#ID_DOCUMENT_CIBLE&KeepThis=true&TB_iframe=true&height=400&width=600}" class="interaction#ID_INTERACTION type-audio thickbox" alt="#TITRE" />]</BOUCLE_documentmp3pointe>
				<BOUCLE_documentvideopointe(DOCUMENTS){id_document=#ID_DOCUMENT_CIBLE}{extension IN flv,FLV,swf,SWF}>[(#TYPE|=={'document'}|?{' ',''})<area shape="rect" coords="#X1,#Y1,#X2,#Y2" href="#URL_PAGE{document_ajax,id_document=#ID_DOCUMENT_CIBLE&KeepThis=true&TB_iframe=true&height=400&width=600}" class="interaction#ID_INTERACTION type-video thickbox" alt="#TITRE" />]</BOUCLE_documentvideopointe>
				[(#MODE_JEU|=={'oui'}|?{' ',''})[(#TYPE|=={'jeu'}|?{' ',''})<area shape="rect" coords="#X1,#Y1,#X2,#Y2" href="#URL_PAGE{jeu_interaction_ajax,id_interaction=#ID_INTERACTION&KeepThis=true&TB_iframe=true&height=400&width=600}" class="interaction#ID_INTERACTION type-jeu thickbox" alt="#TITRE" />]]
				<BOUCLE_objetetpersonnage(DOCUMENTS){id_document=#ID_IMAGE_FOND}>[(#MODE_JEU|=={'oui'}|?{' ',''})[(#TYPE|=={'objet'}|?{' ',''})<area shape="rect" coords="#X1,#Y1,#X2,#Y2" href="#" class="interaction#ID_INTERACTION type-objet type-objet#ID_DOCUMENT" alt="#TITRE" />][(#TYPE|=={'personnage'}|?{' ',''})<area shape="rect" coords="#X1,#Y1,#X2,#Y2" href="#" class="interaction#ID_INTERACTION type-personnage type-personnage#ID_DOCUMENT" alt="#TITRE" />]]</BOUCLE_objetetpersonnage>
		</BOUCLE_interactions>
		
	</map>
	</B_interactions>
	<script type="text/javascript">
	$(document).ready(function(){
		$("img.panorama#ID_LIEU").panorama({
	                auto_start: 0,
                 	control_display: 'yes',
			viewport_width: <BOUCLE_visiteparent(VISITES_VIRTUELLES){id_visite}>[(#LARGEUR|=={0}|?{'570',#LARGEUR})]</BOUCLE_visiteparent>[,
			start_position: (#DECALAGE_X)][,
			mode_360: (#BOUCLER|=={'oui'}|?{1,0})]<BOUCLE_recherchelargeurimage(DOCUMENTS){id_document=#ID_PHOTO}>[,
			speed: (#LARGEUR|mult{8})]</BOUCLE_recherchelargeurimage>

	         });
	});
	</script>
<script type="text/javascript" src="#CHEMIN{js/cvi_text_lib.js}"></script>
<script type="text/javascript" src="#CHEMIN{js/jquery.advanced-panorama.js}"></script>
<script type="text/javascript" src="#CHEMIN{js/jquery.flipv.js}"></script>
<script type="text/javascript">
	if(!Array.indexOf){
		    Array.prototype.indexOf = function(obj){
			for(var i=0; i<this.length; i++){
			    if(this[i]==obj){
				return i;
			    }
			}
			return -1;
		    }
		}


	[(#MODE_JEU|=={'oui'}|?{' ',''})var mode_jeu=1;]
	//chargement des objets � ramasser pour terminer le jeu
	var chaine_objets_a_ramasser = "[(#LISTE_OBJETS_JEU)]";
	var tableau_objets_a_ramasser = new Array(); 
	tableau_objets_a_ramasser = chaine_objets_a_ramasser.split(','); 

	  function alert_panorama(texte) {
	    $('.fenetre-dialogue').remove(); $('.panorama-viewport').append("<div class='fenetre-dialogue' style='position: absolute; margin: 0; padding: 0; bottom: 29px; width: 100%; height: auto; background: white; opacity: .8; text-align: center; color: black; font-style: italic; font-weight: normal;'><div style='padding: 5px;'>"+texte+"&nbsp;<a href='#' class='fermer-dialogue'>Fermer</a></div></div>");
	    $('.fermer-dialogue').bind('click', function(){$('.fenetre-dialogue').remove();return false;});
      
	}

	function verifier_objets_ramasses() {
		
		
		
		//tester si tous les objets ont été ramassés pour terminer la partie
		var partie_terminee=0;
		for (var i=0; i<tableau_objets_a_ramasser.length; i++) {
			if ($('div.panorama-panier ul').find('.objet'+tableau_objets_a_ramasser[i]).length > 0) {
				partie_terminee++;
				
			}
		}	
		if (partie_terminee == tableau_objets_a_ramasser.length) {
			var panoramas_bravo = "[(#MESSAGE_FIN_JEU|sinon{<:panoramas:bravo:>})]"; 
			$('.panorama-viewport').append("<div class='panorama-fond-demarrer'></div>")
			.append("<div class='panorama-bouton-demarrer'><a href='#' focus='1'>"+panoramas_bravo.replace("NOM_JOUEUR",$.cookie('nom_joueur'))+"</a></div>");
			
			$('.panorama-viewport').append("<div class='panorama-bouton-demarrer'><a href='#'>"+panoramas_bravo.replace("NOM_JOUEUR",$.cookie('nom_joueur'))+"</a></div>");
			
			
			$('.panorama-bouton-demarrer a').bind('click', function(){
					$.cookie('lieux_visites','');
					$.cookie('objets_ramasses',' '); 
					$.cookie('jeux_reussis','');
					$.cookie('nom_joueur','');
					$.cookie('objets_ramasses_memo',''); 	
					$('.panorama-bouton-demarrer, .panorama-fond-demarrer').fadeOut(1000);
					document.location.href="[(#URL_FIN_JEU|sinon{?page=visite&id_visite=#ID_VISITE})]"; 

					return false;
				});
		}
	}



<BOUCLE_carte(DOCUMENTS){id_document=#ID_CARTE}>
$(document).ready(function(){
	[(#MODE_JEU|=={'oui'}|?{' ',''})if (!$.cookie('objets_ramasses')) 
		$.cookie('objets_ramasses',' ');]
	$('.panorama-viewport').append("<div class='panorama-onglets'><div class='panorama-carte'><img src='#URL_DOCUMENT' height='"+parseInt($('.panorama-viewport').css('height'))+"' /><BOUCLE_position(VISITES_VIRTUELLES_LIEUX){id_visite=#ID_VISITE}{position_x_carte>0}><a class='icone-carte' href='[(#URL_CARTE|sinon{[(#URL_PAGE{lieu,id_lieu=#ID_LIEU})]#[(#REM)]lieu#ID_LIEU})]'[(#_lieux:ID_LIEU|=={#ID_LIEU}|?{' ',''})style='display:none;']><img src='<B_iconecarte><BOUCLE_iconecarte(DOCUMENTS){id_document=#ICONE_CARTE}>#URL_DOCUMENT</BOUCLE_iconecarte></B_iconecarte>#CHEMIN{img_pack/icone_carte.png}<//B_iconecarte>'  style='cursor: pointer; position: absolute; [left: (#POSITION_X_CARTE)px;][ top: (#POSITION_Y_CARTE)px;]' /></a><span class='lien-plan[(#ACCES_CARTE|=={si_visite}|?{' ',''}) verifier-lien-plan verifier-lien-plan#ID_LIEU]' style='display: none; [left: (#POSITION_X_CARTE|plus{13})px;][ top: (#POSITION_Y_CARTE|moins{33})px;]'><a href='[(#URL_CARTE|sinon{[(#URL_PAGE{lieu,id_lieu=#ID_LIEU})]#[(#REM)]lieu#ID_LIEU})]'>[(#TITRE|replace{' ','&nbsp;'})]</a></span></BOUCLE_position></div>[(#MODE_JEU|=={'oui'}|?{' ',''})<div class='panorama-panier' style='width: "+parseInt(parseInt($('.panorama-viewport').css('width'))/3)+"px; height: "+parseInt($('.panorama-viewport').css('height'))+"px;' ><:panoramas:contenu_panier:> :<div class='panorama-panier-conteneur'><ul>"+ $.cookie('objets_ramasses') +"</ul></div></div>][(#REM) fin mode_jeu ]<div class='panorama-onglets-titres'><h2 class='panorama-carte'><a href='#'><:panoramas:carte:></a></h2>[(#MODE_JEU|=={'oui'}|?{' ',''})<h2 class='panorama-panier'><a href='#'><:panoramas:panier:></a></h2>][(#REM) fin mode_jeu ]</div></div>");
	
	$('.panorama-viewport a.icone-carte').bind('mouseover', function(){
		if ($(this).next().css('display') == 'none') {
			$('.panorama-viewport a.icone-carte').next().hide();
			$(this).next().show();
		}
	});

	$('.panorama-viewport .lien-plan').css('z-index', 50).bind('mouseover', function(){
								$('.panorama-viewport .lien-plan').css('z-index', 50);
								$(this).css('z-index', 60);
							});
	$('.panorama-onglets h2.panorama-carte a').flipv().bind('click', function() { 
				$('div.panorama-carte').toggle();
				[(#MODE_JEU|=={'oui'}|?{' ',''})if ($('div.panorama-carte').css('display') != 'none') 
					$('h2.panorama-panier').hide();
				else
					$('h2.panorama-panier').show();][(#REM) fin mode_jeu ]
				return false;
	});
	[(#MODE_JEU|=={'oui'}|?{' ',''})$('.panorama-onglets h2.panorama-panier a').flipv().bind('click', function() { 
				$('div.panorama-panier').toggle();
				if ($('div.panorama-panier').css('display') != 'none') 
					$('h2.panorama-carte').hide();
				else
					$('h2.panorama-carte').show();
				return false;
	});][(#REM) fin mode_jeu ]
	
});
</BOUCLE_carte>

	$(document).ready(function(){
		
		if (mode_jeu) {
			//maj des lieux visites
			var tableau_lieux_visites = new Array();
			if ($.cookie('lieux_visites')) {
				tableau_lieux_visites = $.cookie('lieux_visites').split(','); 
				if (tableau_lieux_visites.indexOf('#ID_LIEU')>=0) {
					//le lieu est d�ja dans la liste
				} else {
					tableau_lieux_visites.push('#ID_LIEU');
				}
			} else {
				tableau_lieux_visites.push('#ID_LIEU');
			}
			var nouveau_cookie_lieux = '';
			for (var i=0;i<tableau_lieux_visites.length;i++) {
				nouveau_cookie_lieux += ',' + tableau_lieux_visites[i];
			}
			$.cookie('lieux_visites', nouveau_cookie_lieux);

			
			
		}



		
		<BOUCLE_toutesinteractions(VISITES_VIRTUELLES_INTERACTIONS){id_lieu}>
			
			[ (#REM) interactions qui ont précisé une image de fond : ajouter l'image dans le cadre ]
			<BOUCLE_imagedefondcourante(DOCUMENTS){id_document=#ID_IMAGE_FOND}>
				$('.interaction#_toutesinteractions:ID_INTERACTION').append("<img src='#URL_DOCUMENT' width='"+$('.interaction#_toutesinteractions:ID_INTERACTION').css('width')+"' height='"+$('.interaction#_toutesinteractions:ID_INTERACTION').css('height')+"' style='position: absolute; top: 0; left: 0;'/>").css('opacity',1).css('border','none').css('background','none');
				$('.interaction#_toutesinteractions:ID_INTERACTION').bind('click', function() {
								return true;
							});
					
				[ (#REM) interactions qui ont précisé une image de fond au survol : ajouter l'image dans le cadre ]
				<BOUCLE_imagedefondsurvolcourante(DOCUMENTS){id_document=#ID_IMAGE_FOND_SURVOL}>
					$('.interaction#_toutesinteractions:ID_INTERACTION img').bind('mouseover', function(){
						$(this).attr('src', '#URL_DOCUMENT');
					}).bind('mouseout', function(){
						$(this).attr('src', '#_imagedefondcourante:URL_DOCUMENT');
					});
					
				</BOUCLE_imagedefondsurvolcourante>
					
			</BOUCLE_imagedefondcourante>
			

			[ (#REM) interactions avec les objets : ajouter l'image de l'objet et gérer le drag and drop dans le panier ]
			<BOUCLE_objetcourant(DOCUMENTS){id_document=#ID_IMAGE_FOND}>
				[(#MODE_JEU|=={'oui'}|?{' ',''})	
				[(#TYPE|=={'objet'}|?{' ',''})
					$('.type-objet#ID_DOCUMENT').bind('click', function() {
								return false;
							}).draggable({helper: 'clone', opacity: .4, revert: true})
					.bind('dblclick',function(){  
						  $('div.panorama-panier ul').append("<li><div class='objet#ID_DOCUMENT'><img src='#URL_DOCUMENT' style='max-height: 100px; margin-left: 10px;' /><span style='display: none;'>#ID_DOCUMENT</span></div></li>");
						  $.cookie('objets_ramasses_memo', $.cookie('objets_ramasses_memo')+',#ID_DOCUMENT');
						  $('div.panorama-panier ul li div').draggable({helper: 'clone', opacity: .4, revert: true});
							$('.type-objet#ID_DOCUMENT').remove();
							
							//mis � jour des cookies
							var objets_ramasses = $('div.panorama-panier ul').html();
							$.cookie('objets_ramasses', objets_ramasses);
							
							//vérifier si on a trouvé tous les objets du jeu. Si oui, on affiche un message de félicitation et la partie est terminée
							verifier_objets_ramasses();	
					});
					
					
					[ (#REM) suppression des objets qui sont déjà dans le panier ]
					if ($('div.panorama-panier ul').find('.objet#ID_DOCUMENT').length > 0) {
						$('.type-objet#ID_DOCUMENT').remove();
					}
					
				]
				][(#REM) fin mode_jeu ]
			</BOUCLE_objetcourant>
			

			[ (#REM) interactions qui requi�rent un objet pour �tre actives (il faudra drag and dropper l'objet sur l'interaction depuis le panier ]
			<BOUCLE_objetactivationobjet(DOCUMENTS){id_document=#ID_OBJET_ACTIVATION}>
				if (mode_jeu) {
				$('.interaction#ID_INTERACTION')
					.unbind('click')
					.bind('click', function() {
								[var texte_avant_activation = "(#TEXTE_AVANT_ACTIVATION|replace{"\n","<br />"}|replace{"\r",""}|htmlspecialchars)";
								texte_avant_activation = texte_avant_activation.replace("NOM_JOUEUR",$.cookie('nom_joueur'));
								alert_panorama(texte_avant_activation);
								
								]
								return false;
							})
					.droppable({
						accept: "div.objet#ID_DOCUMENT, .type-objet#ID_DOCUMENT",
						activeClass: 'droppable-active',
						hoverClass: 'droppable-hover',
						drop: function(ev, ui) {
							[var texte_apres_activation = "(#TEXTE_APRES_ACTIVATION|replace{"\n","<br />"}|replace{"\r",""}|htmlspecialchars)";
								texte_apres_activation = texte_apres_activation.replace("NOM_JOUEUR",$.cookie('nom_joueur'));
								alert_panorama(texte_apres_activation);]
						      
							<BOUCLE_documentobjetapresactivationobjet(DOCUMENTS){id_document=#ID_OBJET_APRES_ACTIVATION}>
								$('div.panorama-panier ul').append("<li><div class='objet#ID_DOCUMENT'><img src='#URL_DOCUMENT' style='max-height: 100px; margin-left: 10px;' /><span style='display: none;'>#ID_DOCUMENT</span></div></li>");
								$.cookie('objets_ramasses_memo', $.cookie('objets_ramasses_memo')+',#ID_DOCUMENT');
								$('div.panorama-panier ul li div').draggable({helper: 'clone', opacity: .4, revert: true});
							
								//mis � jour des cookies
								var objets_ramasses = $('div.panorama-panier ul').html();
								$.cookie('objets_ramasses', objets_ramasses);
							
								//v�rifier si on a trouv� tous les objets du jeu. Si oui, on affiche un message de f�licitation et la partie est termin�e
								verifier_objets_ramasses();
							</BOUCLE_documentobjetapresactivationobjet>		
						
							$('div.panorama-panier').hide();
							$('h2.panorama-carte').show();
							$(this).unbind('click');
							tb_init(this);
							imgLoader.src = "#CHEMIN{img_pack/ajax-loader.gif}";
							$('div.panorama-panier ul li div.objet#ID_DOCUMENT:first, .type-objet#ID_DOCUMENT').remove();
							
							//mis � jour des cookies
							var objets_ramasses = $('div.panorama-panier ul').html();
							$.cookie('objets_ramasses', objets_ramasses);

							if ($('.images-transition-interaction#ID_INTERACTION')[0]){
							
								var nb_li = ($('.images-transition-interaction#ID_INTERACTION ul li').length);
								setTimeout(function(){
									$('.images-transition-interaction#ID_INTERACTION').remove();
									document.location.href=$('.interaction#ID_INTERACTION').attr('href');
								}, nb_li*#IMAGES_TRANSITION_DELAI );
								$('.panorama-viewport').append("<div class='fond-noir-slideshow' style='background: black; width: 100%; height: 100%; position: absolute; left: 0; top: 0; opacity: .8;'></div>");
								$('.images-transition-interaction#ID_INTERACTION').appendTo(".panorama-viewport").show();
								$('.images-transition-interaction#ID_INTERACTION ul').innerfade({
												speed: 'slow', 
												timeout: #IMAGES_TRANSITION_DELAI, 
												type: 'sequence'
											});
								return false;
							} 
							
						}
						});
				}[(#REM) fin mode_jeu ]
			</BOUCLE_objetactivationobjet>

			[ (#REM) interactions qui requi�rent d'avoir visit� un lieu ]
			<BOUCLE_objetactivationlieu(VISITES_VIRTUELLES_LIEUX){id_lieu=#ID_LIEU_ACTIVATION}>
				if (mode_jeu) {
				$('.interaction#ID_INTERACTION')
					.unbind('click')
					.bind('click', function() {
								if ($.cookie('lieux_visites')) {
									var tableau_lieux_visites = $.cookie('lieux_visites').split(','); 
									if (tableau_lieux_visites.indexOf('#ID_LIEU')>=0) {
										[var texte_apres_activation = "(#TEXTE_APRES_ACTIVATION|replace{"\n","<br />"}|replace{"\r",""}|htmlspecialchars)";
										texte_apres_activation = texte_apres_activation.replace("NOM_JOUEUR",$.cookie('nom_joueur'));
										alert_panorama(texte_apres_activation);]

										<BOUCLE_documentobjetapresactivationlieu(DOCUMENTS){id_document=#ID_OBJET_APRES_ACTIVATION}>
											$('div.panorama-panier ul').append("<li><div class='objet#ID_DOCUMENT'><img src='#URL_DOCUMENT' style='max-height: 100px; margin-left: 10px;' /><span style='display: none;'>#ID_DOCUMENT</span></div></li>");
											$.cookie('objets_ramasses_memo', $.cookie('objets_ramasses_memo')+',#ID_DOCUMENT');
											$('div.panorama-panier ul li div').draggable({helper: 'clone', opacity: .4, revert: true});
							
											//mis � jour des cookies
											var objets_ramasses = $('div.panorama-panier ul').html();
											$.cookie('objets_ramasses', objets_ramasses);
							
											//v�rifier si on a trouv� tous les objets du jeu. Si oui, on affiche un message de f�licitation et la partie est termin�e
											verifier_objets_ramasses();
										</BOUCLE_documentobjetapresactivationlieu>		
									} else {
										[var texte_avant_activation = "(#TEXTE_AVANT_ACTIVATION|replace{"\n","<br />"}|replace{"\r",""}|htmlspecialchars)";
										texte_avant_activation = texte_avant_activation.replace("NOM_JOUEUR",$.cookie('nom_joueur'));
										alert_panorama(texte_avant_activation);]
									}
								} else {
									[var texte_avant_activation = "(#TEXTE_AVANT_ACTIVATION|replace{"\n","<br />"}|replace{"\r",""}|htmlspecialchars)";
									texte_avant_activation = texte_avant_activation.replace("NOM_JOUEUR",$.cookie('nom_joueur'));
									alert_panorama(texte_avant_activation);]
								}
								return false;
							});
				}[(#REM) fin mode_jeu ]
			</BOUCLE_objetactivationlieu>

			[ (#REM) interactions qui requi�rent d'avoir r�ussi un questionnaire avant ]
			<BOUCLE_objetactivationjeu(JEUX){id_jeu=#ID_JEU_ACTIVATION}>
				if (mode_jeu) {
				$('.interaction#ID_INTERACTION')
					.unbind('click')
					.bind('click', function() {
								if($.cookie('jeux_reussis')) {
									var tableau_jeux_visites = $.cookie('jeux_reussis').split(','); 
									if (tableau_jeux_visites.indexOf('#ID_JEU')>=0) {
										[var texte_apres_activation = "(#TEXTE_APRES_ACTIVATION|replace{"\n","<br />"}|replace{"\r",""}|htmlspecialchars)";
										texte_apres_activation = texte_apres_activation.replace("NOM_JOUEUR",$.cookie('nom_joueur'));
										alert_panorama(texte_apres_activation);]
										<BOUCLE_documentobjetapresactivationjeu(DOCUMENTS){id_document=#ID_OBJET_APRES_ACTIVATION}>
											$('div.panorama-panier ul').append("<li><div class='objet#ID_DOCUMENT'><img src='#URL_DOCUMENT'  style='max-height: 100px; margin-left: 10px;' /><span style='display: none;'>#ID_DOCUMENT</span></div></li>");
											$.cookie('objets_ramasses_memo', $.cookie('objets_ramasses_memo')+',#ID_DOCUMENT');
											$('div.panorama-panier ul li div').draggable({helper: 'clone', opacity: .4, revert: true});
							
											//mis � jour des cookies
											var objets_ramasses = $('div.panorama-panier ul').html();
											$.cookie('objets_ramasses', objets_ramasses);
							
											//v�rifier si on a trouv� tous les objets du jeu. Si oui, on affiche un message de f�licitation et la partie est termin�e
											verifier_objets_ramasses();
										</BOUCLE_documentobjetapresactivationjeu>
									} else {
										[var texte_avant_activation = "(#TEXTE_AVANT_ACTIVATION|replace{"\n","<br />"}|replace{"\r",""}|htmlspecialchars)";
										texte_avant_activation = texte_avant_activation.replace("NOM_JOUEUR",$.cookie('nom_joueur'));
										alert_panorama(texte_avant_activation);]
									}
								} else	{
									[var texte_avant_activation = "(#TEXTE_AVANT_ACTIVATION|replace{"\n","<br />"}|replace{"\r",""}|htmlspecialchars)";
									texte_avant_activation = texte_avant_activation.replace("NOM_JOUEUR",$.cookie('nom_joueur'));
									alert_panorama(texte_avant_activation);]
								}
								return false;
							});
				}[(#REM) fin mode_jeu ]
			</BOUCLE_objetactivationjeu>

			
			


			[(#REM) Transistion de type film avant d'activer l'interaction ]
			<BOUCLE_filmtransitionstd(DOCUMENTS){id_document=#ID_FILM_TRANSITION}>
				$('.interaction#ID_INTERACTION').bind('click', function(){
					setTimeout(function(){
						document.location.href=$('.interaction#ID_INTERACTION').attr('href');
					}, #FILM_TRANSITION_DUREE );
					$('.panorama-viewport').append("<div class='fond-noir-slideshow' style='background: black; width: 100%; height: 100%; position: absolute; left: 0; top: 0; opacity: .8;'></div><div style='position: absolute; top: 0; left: 0;'><a class='media' href='#URL_DOCUMENT'>#TITRE</a></div>");
					$('.media').media({
							<BOUCLE_visiteparent1(VISITES_VIRTUELLES){id_visite=#_lieux:ID_VISITE}>
							width: #LARGEUR, 
							height: #HAUTEUR,
							</BOUCLE_visiteparent1>
							autoplay: true,
							flashvars: { flv: '[(#URL_DOCUMENT|url_absolue)]', autoplay: 1, autoload: 1}
							});
					return false;
			
				});
			</BOUCLE_filmtransitionstd>
			
		</BOUCLE_toutesinteractions>


	
		    $('div.panorama-carte .lien-plan a, div.panorama-carte a.icone-carte').bind('click', function(){
				    $('.panorama-viewport').append("<div class='fond-noir-slideshow' style='background: black; width: 100%; height: 100%; position: absolute; left: 0; top: 0; opacity: .8;'></div><img src='#CHEMIN{img_pack/ajax-loader.gif}' style='position: absolute; top: 50%; left: 50%; margin-left: -33px; margin-top: -33px;' />");
				    return true;
			    });
	
		
		    [(#MODE_JEU|=={'oui'}|?{' ',''})
		    //v�rifier si les lieux doivent �tre affich�s sur le plan
		    //certains doivent avoir �t� visit�s pour appara�tre
		    $('.verifier-lien-plan').each(function(){
			    var numero_lieu = $(this).attr('class').substr(47);
			    if ($.cookie('lieux_visites')) {
				    var tableau_lieux_visites = $.cookie('lieux_visites').split(','); 
				    if (tableau_lieux_visites.indexOf(numero_lieu)<0) {
					    $(this).hide();	
				    }
			    } else {
				$(this).hide();
			    }
			    
			    
		    });
		    ][(#REM) fin mode_jeu ]
		    
});
	

</script>

[(#REM) gif animée sur fond noir avant le chargement de la page suivante (préchargement) ]
<img src="#CHEMIN{img_pack/ajax-loader.gif}" width="0" height="0" alt="" />



#SET{docs, #DOCUMENTS_ASSOCIES}
<B_documentsassocies>
<div class="documents-lieu">
<h2><:panoramas:documents_associes:></h2>
<BOUCLE_documentsassocies(DOCUMENTS)>[(#ID_DOCUMENT|inclusdans{#GET**{docs}}|?{' ',''})
		<a href="#URL_DOCUMENT" class="thickbox">[(#LOGO_DOCUMENT||image_reduire{0,100})]</a>
	]</BOUCLE_documentsassocies>
</div>
</B_documentsassocies>

<script type="text/javascript" src="#CHEMIN{js/thickbox.js}"></script>
<script type="text/javascript">
$(document).ready(function(){
imgLoader.src = "#CHEMIN{img_pack/ajax-loader.gif}";
});
</script>

<BOUCLE_interactionstransitions(VISITES_VIRTUELLES_INTERACTIONS){id_lieu}>

	[ (#REM) pr�chargement des images de fond de survol ]
	<BOUCLE_imagedefondsurvolprechargement(DOCUMENTS){id_document=#ID_IMAGE_FOND_SURVOL}>
		<img src="#URL_DOCUMENT"  width="0" height="0" alt="" />				
	</BOUCLE_imagedefondsurvolprechargement>

#SET{transition, #IMAGES_TRANSITION}
<B_imagestransition>
<div class="images-transition-interaction#ID_INTERACTION" style="display: none; position: absolute; top: 0; left: 0;">
<ul class="innerfade">
	
<BOUCLE_imagestransition(DOCUMENTS)>[(#ID_DOCUMENT|inclusdans{#GET**{transition}}|?{' ',''})
		<li>[<img src="(#FICHIER)" height="#_visites:HAUTEUR" />]</li>
	]</BOUCLE_imagestransition>
</ul>
<img src="#CHEMIN{img_pack/bg-transition.png}" style="position: absolute; top: 0; left: 0; z-index: 0; width: <BOUCLE_visiteparent2(VISITES_VIRTUELLES){id_visite=#ID_VISITE}>[(#LARGEUR|=={0}|?{'570',#LARGEUR})]</BOUCLE_visiteparent2>px;" />
</div>
<script type="text/javascript">
$(document).ready(function(){
[(#REM) faire jouer la transition avant d'activer l'interaction : cas d'une s�quence d'images ]
	

	<BOUCLE_testobjetactivation(VISITES_VIRTUELLES_INTERACTIONS){id_interaction}{id_objet_activation<=0}>
	$('.interaction#ID_INTERACTION').bind('click', function(){
		if ($('.images-transition-interaction#ID_INTERACTION')[0]){
		
			var nb_li = ($('.images-transition-interaction#ID_INTERACTION ul li').length);
			setTimeout(function(){
				$('.images-transition-interaction#ID_INTERACTION').remove();
				document.location.href=$('.interaction#ID_INTERACTION').attr('href');
			}, nb_li*#IMAGES_TRANSITION_DELAI );
			$('.panorama-viewport').append("<div class='fond-noir-slideshow' style='background: black; width: 100%; height: 100%; position: absolute; left: 0; top: 0; opacity: .8;'></div>");
			$('.images-transition-interaction#ID_INTERACTION').appendTo(".panorama-viewport").show();
			$('.images-transition-interaction#ID_INTERACTION ul').innerfade({
							speed: 'slow', 
							timeout: #IMAGES_TRANSITION_DELAI, 
							type: 'sequence'
						});
			return false;
		} else {
			
			return true;
		}
	});
	</BOUCLE_testobjetactivation>
		
});

</script>
</B_imagestransition>
</BOUCLE_interactionstransitions>

<script type="text/javascript">

	function gestion_molette_souris() {
		[(#REM) Gestion de la molette de la souris pour aller à gauche & à droite ]
		var intOverallDelta = 0;
		$(".panorama-viewport").mousewheel(function(objEvent, intDelta){
			if (intDelta > 0) { 
			      	intOverallDelta++;
				if (intOverallDelta>0) {
					intOverallDelta = 1;
					$('.panorama-control-right').trigger('click');
				} else {
					$('.panorama-control-pause').trigger('click');
				}
			} else if (intDelta < 0) {
				intOverallDelta--;
				if (intOverallDelta<0) {
					intOverallDelta = -1;
					$('.panorama-control-left').trigger('click');
				} else {
					$('.panorama-control-pause').trigger('click');
				}
			}
									
			objEvent.stopPropagation();
			objEvent.preventDefault();
	
			return false;
		
		});
	
		
	}

	$(document).ready(function(){
		$('.panorama-viewport').append("<div class='panorama-fond-demarrer'></div>");
		
		//masquer les objets déjà ramassés
		var tableau_objets_ramasses_memo = new Array();
		if ($.cookie('objets_ramasses_memo')) {
			tableau_objets_ramasses_memo = $.cookie('objets_ramasses_memo').split(','); 
			<BOUCLE_objets(VISITES_VIRTUELLES_INTERACTIONS){id_lieu}{type=objet}>
			<BOUCLE_imageobjet(DOCUMENTS){id_document=#ID_IMAGE_FOND}>
			if (tableau_objets_ramasses_memo.indexOf('#ID_DOCUMENT')>=0) {
				//l'objet a déjà été ramassé
				$('.interaction#ID_INTERACTION').remove();
			} 
			</BOUCLE_imageobjet>
			</BOUCLE_objets>
		}
		

		[(#MODE_JEU|=={oui}|?{' ',''})
		verifier_objets_ramasses();
		$('div.panorama-panier ul li div').draggable({helper: 'clone', opacity: .4, revert: true});
			if (!$.cookie('nom_joueur')) {
			$('.panorama-viewport').append("<div class='panorama-fond-demarrer'></div>")
			.append("<div class='panorama-bouton-demarrer'><label for='nom_joueur'><:panoramas:nom_joueur:> :</label> <input type='text' value='' id='nom_joueur' name='nom_joueur'/><br /><a href='#'><:panoramas:demarrer:></a></div>");
		
			$('.panorama-bouton-demarrer a').bind('click', function(){
					if ($('#nom_joueur').val() == "") {
						alert_panorama("<:panoramas:nom_obligatoire:>");
					} else {
						$.cookie('nom_joueur',$('#nom_joueur').val());
						$('.panorama-bouton-demarrer, .panorama-fond-demarrer').fadeOut(1000);
						gestion_molette_souris();
					}
					return false;
				});
		} else {
			gestion_molette_souris();
		}]
		[(#MODE_JEU|=={oui}|?{'',' '})
			gestion_molette_souris();
		]

		$('.panorama#ID_LIEU').css('visibility','visible');
		$('.panorama-fond-demarrer').fadeOut(3000);

					
			
	});
function trim (myString)
{

return myString.replace(/^\s+/g,'').replace(/\s+$/g,'');
} 
function rafraichir_panier() {
 if ($.cookie('objets_ramasses')) { 
      if ($.cookie('objets_ramasses') != $('div.panorama-panier ul').html()) {
		$('div.panorama-panier ul').html($.cookie('objets_ramasses')); 
		verifier_objets_ramasses();
		$('div.panorama-panier ul li div').draggable({helper: 'clone', opacity: .4, revert: true});
							
      }
  } 	
  setTimeout("rafraichir_panier()", 1000);
}

setTimeout("rafraichir_panier()", 1000);
</script>

</BOUCLE_visites>
</BOUCLE_lieux>

	




</B_lieux>
