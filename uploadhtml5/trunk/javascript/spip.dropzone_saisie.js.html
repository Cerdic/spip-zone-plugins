[(#REM) Si env contient un maxFiles il surpasse la configuration ]
[(#SET{maxFiles, [(#ENV{maxFiles, [(#CONFIG{uploadhtml5/max_file}|>{0}|?{#CONFIG{uploadhtml5/max_file},null})]})]})]

<script type="text/javascript">

// Cette fonction s'occupe de bloquer le submit et de lancer l'upload de la queue
 var processSaisieUpload = function (event) {
   // Ne pas submit vraiment le formulaire
   event.preventDefault();
   event.stopPropagation();

   // Activer l'autoProcess
   event.data.dropzone.options.autoProcessQueue = true;
   // Lancer l'upload
   event.data.dropzone.processQueue();
 }

 var options = {
   [url: "(#ENV*{url})",]
   paramName: ["(#ENV{paramName, file})"],
   maxFilesize: #CONFIG{uploadhtml5/max_file_size},
   maxFiles: #GET{maxFiles},

   // On déclenchera manuellement l'envoie
   autoProcessQueue: false,

   // Pour ne pas embrouiller le script d'upload, on ne va faire qu'un seul fichier à la fois
   parallelUploads: 1,

   [acceptedFiles: "(#ENV{acceptedFiles})",]

   init: function () {

     // Si le formulaire est soumit, on va d'abord envoyer les fichiers
     $("\##ENV{id}").parents("form").bind("submit",{dropzone: this}, processSaisieUpload);
   },

   queuecomplete: function () {
     // Le formulaire est uploader, on a plus besoin de l'event sur submit
     // On soumet le formulaire normalement
     $("\##ENV{id}").parents("form").unbind("submit", processSaisieUpload).submit();
   },

   // Traduire dropzone
   #INCLURE{fond=javascript/traduire_dropzone/#ENV{paramName, file}, env}

 };

 // Désactiver la découverte automatique de dropzone
 Dropzone.autoDiscover = false;

 $("\##ENV{id}").dropzone(options);

</script>
