#CACHE{0}
<?php
if ( isset($_POST['idEvenement']) && isset($_POST['idAuteur']) )
{
  $txtQuery = "SELECT count(id_evenement) As nbAuteur FROM amap_evenements";
  $txtQuery .= " WHERE id_evenement=".$_POST['idEvenement'];
  $txtQuery .= " AND (id_personne1=".$_POST['idAuteur'];
  $txtQuery .= " OR id_personne2=".$_POST['idAuteur'];
  $txtQuery .= " OR id_personne3=".$_POST['idAuteur'].")";

  $sqlResult = spip_query($txtQuery);
  if (  ($tabUnEnregistrement = spip_fetch_array($sqlResult)) && ($tabUnEnregistrement['nbAuteur']==0)  )
  {
    $test_ajout = false;	// booléen qui permet de n'inscrire qu'une seule fois l'auteur
    $txtQuery = "UPDATE amap_evenements SET ";

    if ( ($_POST['idPersonne1'] == '') && !($test_ajout) )
    {
      $txtQuery .= "id_personne1='".$_POST['idAuteur']."', ";
      $test_ajout = true;
    }
    else if ($_POST['idPersonne1'] == '')
      $txtQuery .= "id_personne1=null, ";
    else
      $txtQuery .= "id_personne1='".$_POST['idPersonne1']."', ";
    if ( ($_POST['idPersonne2'] == '')  && !($test_ajout) )
    {
      $txtQuery .= "id_personne2='".$_POST['idAuteur']."', ";
      $test_ajout = true;
    }
    else if ($_POST['idPersonne2'] == '')
      $txtQuery .= "id_personne2=null, ";
    else
      $txtQuery .= "id_personne2='".$_POST['idPersonne2']."', ";
    if ( ($_POST['idPersonne3'] == '')  && !($test_ajout) )
    {
      $txtQuery .= "id_personne3='".$_POST['idAuteur']."' ";
      $test_ajout = true;
    }
    else if ($_POST['idPersonne3'] == '')
      $txtQuery .= "id_personne3=null ";
    else
      $txtQuery .= "id_personne3='".$_POST['idPersonne3']."' ";
    $txtQuery .= "WHERE id_evenement=".$_POST['idEvenement'];

    $sqlResult = spip_query($txtQuery);

    if ($sqlResult)
      echo "<hr/><div class='verdana2' style='text-align: justify'>Mise à jour dans la table amap_evenements sous le numero: ".$_POST['idEvenement']."</div><hr/>";
    else
      echo "<hr/><div class='verdana2' style='text-align: justify'>Erreur !!</div><hr/>";
  }
  else
    echo "<hr/><div class='verdana2' style='text-align: justify'>Vous &ecirc;tes d&eacute;j&agrave; responsable de cette distribution...</div><hr/>";
}
?>
<INCLURE{fond=../amap/includes/amap_responsable_liste}{id_article}>
