<h1 class="grostitre"><:factures:editer_facturation_titre:></h1>
<p><:factures:explication_editer_facturation_titre:></p>

[(#URL_ECRIRE{menus_editer}|parametre_url{nouveau,oui}|icone{<:menus:editer_menus_nouveau:>,#CHEMIN{images/menus-nouveau-24.png},#LANG_RIGHT,creer.gif})]

<div class="nettoyeur" />

[(#REM) On construit un tableau avec tous les types de documents; clause "id_type_facture IN" de la boucle ]
	#SET{type,#ARRAY}
	<BOUCLE_t(type_facture)>
	#SET{type, #GET{type}|array_merge{#ARRAY{#COMPTEUR_BOUCLE,#ID_type_facture}}}
	</BOUCLE_t>


[(#REM) On construit un tableau avec tous les contacts ; clause "id_client IN" de la boucle ]
	#SET{contacts,#ARRAY}
	<BOUCLE_c(contacts ?)>
	#SET{contacts, #GET{contacts}|array_merge{#ARRAY{#COMPTEUR_BOUCLE,#ID_CLIENT}}}
	</BOUCLE_c>


[(#REM) On récupère les valeurs de id_contact et de id_type_facture éventuellement passés dans l'url ]
	[(#EVAL{_request('id_type_facture')}|?{' ',''})
		#SET{type, #EVAL{_request('id_type_facture')} }
	]

	[(#EVAL{_request('id_contact')}|?{' ',''})
		#SET{contacts, #EVAL{_request('id_client')} }
	]


<fieldset class="liste factures" >

	[(#REM) La légende dépend du type de document ]
	<legend>
	[(#EVAL{_request('id_type_facture')}|=={''}|?{'Tous les documents',''})]
	[(#EVAL{_request('id_type_facture')}|=={'1'}|?{'Factures',''})]
	[(#EVAL{_request('id_type_facture')}|=={'2'}|?{'Devis',''})]
	[(#EVAL{_request('id_type_facture')}|=={'3'}|?{'Avoirs',''})]
	[(#EVAL{_request('id_type_facture')}|=={'4'}|?{'Factures proforma',''})]
	</legend>

<form name="type_facture" action="#SELF" method="get">

	[(#REM) Ces hidden là sont pour garder une trace de ce qui est déja saisi dans les forms ]
	<input type="hidden" name="page" value="#ENV{page}" />
	
	<select name="id_type_facture" onchange="this.form.submit()" >
		<option value="">---</option>
		<BOUCLE_t2(type_facture)>
		<option value="#ID_type_facture" [(#GET{type}|=={#ID_type_facture}|?{'selected="selected"'})]>#NOM_type_facture</option>
		</BOUCLE_t2>
	</select>
	
	<select name="id_contact" onchange="this.form.submit()" >
		<option value="">---</option>
		<BOUCLE_cl(contacts){par nom}>
		<option value="#ID_CONTACT" [(#GET{contacts}|=={#ID_CONTACT}|?{'selected="selected"'})]>#NOM</option>
		</BOUCLE_cl>
	</select>

	<input type="submit" value="OK" />

	<input type="button" value="Cr&eacute;er facture" onclick="[document.location='(#URL_PAGE{creer_facture}|parametre_url{id_client,#EVAL{_request('id_client')}})']" />

</form>	
<B_factures>
#PAGINATION
<table class="spip tablesorter">
	<thead>
	<tr>
		<th>ID contact</th>
		<th>Num facture</th>
		<th>Date</th>
		<th>Libell&eacute;</th>
		<th>Montant</th>
		<th>R&egrave;glement</th>
		<th title="Il s'agit strictement du nombre d'heures vendues pour cette facture; il sagit d'un nombre à ne pas dépasser.">Nb heures<br />vendues</th>
		<th title="Il s'agit du total des heures utilisées sur cette facture; l'objectif est que ce montant reste inférieur au nombre d'heures vendues.">Nb heures<br />utilis&eacute;es</th>
		<th title="Il s'agit du total des heures restantes sur cette facture (calculé dans une balise SPIP)">Nb heures<br />restantes</th>
	</tr>
	</thead>
	<tbody>
<BOUCLE_factures(factures){id_contact IN #GET{contacts}}{id_type_facture IN #GET{type}}{!par date_facture}{!par num_facture}{pagination 20}>
	<tr[ id="ligne_(#NUM_FACTURE)"][ class="(#COMPTEUR_BOUCLE|alterner{'row_even','row_odd'})"]><BOUCLE_n(spipmine_contacts){id_client}>
		<td class="num #EDIT{nom}"><a href="[(#URL_PAGE{contact}|parametre_url{id_client,#ID_CLIENT})]" title="Fiche client N&deg;#ID_CLIENT, #NOM_CLIENT">#NOM_COURT</a></td></BOUCLE_n>
		<td class="num #EDIT{num_facture}"><a href="[(#URL_PAGE{fiche_facture}|parametre_url{'id_facture',#ID_FACTURE})]">#NUM_FACTURE</a></td>
		<td class="date #EDIT{date_facture}">[(#DATE_FACTURE|affdate{'d/m/Y'})]</td>
		<td class="libelle #EDIT{libelle_facture}">[(#LIBELLE_FACTURE|couper{55}|sinon{'<em>éditer libellé...</em>'})]</td>
		<td class="montant #EDIT{montant}"><a href="#" class="aide" title="[(#TOTAL_HT|monetaire)&nbsp;HT][ | (#TOTAL_HT|ttc|monetaire)&nbsp;TTC]">[?]</a>[(#MONTANT|monetaire)]</td>
		<td class="reglement">[(#MODELE{reglement}{id_facture})]</td>
		<td class="temps">[<span class="#EDIT{nb_heures_vendues}">(#NB_HEURES_VENDUES|horaire|sinon{'<em>saisir...</em>'})</span>]</td>
		<td class="temps">[(#TOTAL_HEURES_UTILISEES|horaire)]</td>
		<td class="temps">[(#TOTAL_HEURES_RESTANTES|horaire|alerte)]</td>
	</tr>
</BOUCLE_factures>
	</tbody>
</table>

</B_factures>
<//B_factures>


</fieldset>

<div class="nettoyeur" />
