[(#SET{defaut_tri,#ARRAY{
	date_facture,#ENV{date_facture_sens,-1}
}})
]<B_liste_factures>
#ANCRE_PAGINATION
<div class="liste-elements factures">
<table class='spip liste'>
[<caption><strong class="caption">(#ENV*{titre,<:info_tous_factures_presents:>})</strong></caption>]
	<thead>
		<tr class='first_row'>
			<th class='num_facture'>[(#TRI{num_facture,<:factures:num_facture:>,ajax})]</th>
			<th class='date_facture'>[(#TRI{date_facture,<:factures:date_facture:>,ajax})]</th>
			<th class='libelle_facture'>[(#TRI{libelle_facture,<:factures:libelle_facture:>,ajax})]</th>
			<th class='montant'>[(#TRI{montant,<:factures:montant:>,ajax})]</th>
		</tr>
	</thead>
	<tbody>
	<BOUCLE_liste_factures(factures){id_organisation?}{tri #ENV{order,num_facture},#GET{defaut_tri}}{pagination #ENV{nb,10}}{!lang_select}>
		<tr class="[(#COMPTEUR_BOUCLE|alterner{row_odd,row_even})]">
			<td class="num_facture"><a href="[(#URL_ECRIRE{facture}|parametre_url{'id_facture',#ID_FACTURE})]">#NUM_FACTURE</a></td>
			<td class="date_facture">[(#DATE_FACTURE|affdate{'d/m/Y'})]</td>
			<td class="libelle_facture">[(#LIBELLE_FACTURE|couper{55})]</td>
			<td class="montant"><a href="#" class="aide" title="[(#TOTAL_HT|monetaire)&nbsp;HT][ | (#TOTAL_HT|ttc|monetaire)&nbsp;TTC]">[?]</a>[(#MONTANT|monetaire)]</td>
		</tr>
	</BOUCLE_liste_factures>
	</tbody>
</table>
[<p class='pagination'>(#PAGINATION{prive})</p>]
</div>
</B_liste_factures>[
<div class="liste-elements factures"><strong class="caption">(#ENV*{sinon,''})</strong></div>
]<//B_liste_factures>


<!-- Debut de l'ancien tableau -->

[(#REM) On construit un tableau avec tous les types de documents; clause "id_type_facture IN" de la boucle ]
	#SET{type,#ARRAY}
	<BOUCLE_t(types_facture)>
	#SET{type, #GET{type}|array_merge{#ARRAY{#COMPTEUR_BOUCLE,#ID_TYPE_FACTURE}}}
	</BOUCLE_t>


[(#REM) On construit un tableau avec toutes les organisations; clause "id_organisation IN" de la boucle ]
	#SET{organisations,#ARRAY}
	<BOUCLE_c(ORGANISATIONS ?)>
	#SET{organisations, #GET{organisations}|array_merge{#ARRAY{#COMPTEUR_BOUCLE,#ID_ORGANISATION}}}
	</BOUCLE_c>


[(#REM) On récupère les valeurs de id_organisation et de id_type_facture éventuellement passés dans l'url ]
	[(#EVAL{_request('id_type_facture')}|?{' ',''})
		#SET{type, #EVAL{_request('id_type_facture')} }
	]

	[(#EVAL{_request('id_organisation')}|?{' ',''})
		#SET{organisations, #EVAL{_request('id_organisation')} }
	]


<fieldset class="liste factures" >

	[(#REM) La légende dépend du type de document ]
	<legend>
	[(#EVAL{_request('id_type_facture')}|=={''}|?{'Tous les documents',''})]
	[(#EVAL{_request('id_type_facture')}|=={'1'}|?{'Factures',''})]
	[(#EVAL{_request('id_type_facture')}|=={'2'}|?{'Devis',''})]
	[(#EVAL{_request('id_type_facture')}|=={'3'}|?{'Avoirs',''})]
	[(#EVAL{_request('id_type_facture')}|=={'4'}|?{'Factures proforma',''})]
	</legend>

<form name="type_facture" action="#SELF" method="get">

	[(#REM) Ces hidden là sont pour garder une trace de ce qui est déja saisi dans les forms ]
	<input type="hidden" name="page" value="#ENV{page}" />
	
	<select name="id_type_facture" onchange="this.form.submit()" >
		<option value="">---</option>
		<BOUCLE_t2(types_facture)>
		<option value="#ID_TYPE_FACTURE" [(#GET{type}|=={#ID_TYPE_FACTURE}|?{'selected="selected"'})]>#TITRE</option>
		</BOUCLE_t2>
	</select>
	
	<select name="id_contact" onchange="this.form.submit()" >
		<option value="">---</option>
		<BOUCLE_cl(contacts){par nom}>
		<option value="#ID_CONTACT" [(#GET{contacts}|=={#ID_CONTACT}|?{'selected="selected"'})]>#NOM</option>
		</BOUCLE_cl>
	</select>

	<input type="submit" value="OK" />

	<input type="button" value="Cr&eacute;er facture" onclick="[document.location='(#URL_PAGE{creer_facture}|parametre_url{id_client,#EVAL{_request('id_client')}})']" />

</form>	
<B_factures>
#PAGINATION
<table class="spip tablesorter">
	<thead>
	<tr>
		<th>ID contact</th>
		<th>Num facture</th>
		<th>Date</th>
		<th>Libell&eacute;</th>
		<th>Montant</th>
		<th>R&egrave;glement</th>
		<th title="Il s'agit strictement du nombre d'heures vendues pour cette facture; il sagit d'un nombre à ne pas dépasser.">Nb heures<br />vendues</th>
		<th title="Il s'agit du total des heures utilisées sur cette facture; l'objectif est que ce montant reste inférieur au nombre d'heures vendues.">Nb heures<br />utilis&eacute;es</th>
		<th title="Il s'agit du total des heures restantes sur cette facture (calculé dans une balise SPIP)">Nb heures<br />restantes</th>
	</tr>
	</thead>
	<tbody>
<BOUCLE_factures(FACTURES){id_organisation IN #GET{organisations}}{id_type_facture IN #GET{type}}{!par date_facture}{!par num_facture}{pagination 20}>
	<tr[ id="ligne_(#NUM_FACTURE)"][ class="(#COMPTEUR_BOUCLE|alterner{'row_even','row_odd'})"]><BOUCLE_n(CONTACTS){id_client}>
		<td class="num #EDIT{nom}"><a href="[(#URL_PAGE{contact}|parametre_url{id_client,#ID_CLIENT})]" title="Fiche client N&deg;#ID_CLIENT, #NOM_CLIENT">#NOM_COURT</a></td></BOUCLE_n>
		<td class="num #EDIT{num_facture}"><a href="[(#URL_PAGE{fiche_facture}|parametre_url{'id_facture',#ID_FACTURE})]">#NUM_FACTURE</a></td>
		<td class="date #EDIT{date_facture}">[(#DATE_FACTURE|affdate{'d/m/Y'})]</td>
		<td class="libelle #EDIT{libelle_facture}">[(#LIBELLE_FACTURE|couper{55}|sinon{'<em>éditer libellé...</em>'})]</td>
		<td class="montant #EDIT{montant}"><a href="#" class="aide" title="[(#TOTAL_HT|monetaire)&nbsp;HT][ | (#TOTAL_HT|ttc|monetaire)&nbsp;TTC]">[?]</a>[(#MONTANT|monetaire)]</td>
		<td class="reglement">[(#MODELE{reglement}{id_facture})]</td>
		<td class="temps">[<span class="#EDIT{nb_heures_vendues}">(#NB_HEURES_VENDUES|horaire|sinon{'<em>saisir...</em>'})</span>]</td>
		<td class="temps">[(#TOTAL_HEURES_UTILISEES|horaire)]</td>
		<td class="temps">[(#TOTAL_HEURES_RESTANTES|horaire|alerte)]</td>
	</tr>
</BOUCLE_factures>
	</tbody>
</table>

</B_factures>
<//B_factures>


</fieldset>

<div class="nettoyeur" />
