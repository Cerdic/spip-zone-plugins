#CACHE{0}
[(#REM)
/**
* Plugin SPIP Geoportail
*
* @author:
* Jean-Marc Viglino (ign.fr)
*
* Copyright (c) 2010
* Logiciel distribue sous licence GNU/GPL.
*
* Utilisez ce modele pour afficher une carte Geoportail sur le site SPIP.
*
* Parametres :
* - id_geoportail		: identifiant de la carte (unique de preference !)
* - article				: numero de l'article si on veut afficher les documents de l'article 
* - id_rubrique			: affichage des services lies a une rubrique
* - id_secteur			: affichage des services lies a un secteur
* - width, height		: largeur, hauteur (utiliser pc au lieu de % dans les URI) par defaut, ceux du css
* - mode				: normal/mini, GEOP(Geoportail), GMAP(Google Maps), OSM(OpenStreetMap), YHOO(Yahoo! Maps)
* - type				: Default/Standard/OpenLayers
* - lon, lat, zoom		: centrage sur la zone 
* - zone				: la zone geoportail (FXX)
* - layerctrl			: affichage du gestionnaire de couche (1,true,0,false,mini) par defaut: mini
* - toolbox				: affichage des outils (1,true,0,false,mini) par defaut: 1
* - infobox				: affichage des infos (1,true,0,false,mini) par defaut: mini
* - searchtools			: afficher les outils de recherche (0,1) par defaut:1
* - measuretools		: afficher les outils de mesure (0,1) par defaut : 0
* - toolprint			: outil d'impression (0,1) par defaut : 0
* - overview			: afficher une vue globale (0,1) par defaut : 0. 
						  La vue s'affiche dans la div id="overViewMap" ou est cree dans la div id="navigation"
* - min_zoom			: zoom mini
* - max_zoom			: zoom maxi
* - carto				: opacite de la carte (0->1)
* - ortho				: opacite de l'image (0->1)
* - formulaire			: la carte est un formulaire (ajoute un controleur pour faire le lien avec le formulaire)
**/
]
[(#REM) Recherche de la zone dans le parametre ou dans le profil utilisateur ]
[(#ZONE|=={''}|?{
[(#SET{zone,[(#ENV|geoportail_profil{zone})]})]
,
[(#SET{zone,[(#ZONE)]})]
})]
[

(#REM) GESTION de l'espace prive :
Ne pas charger dans l'espace prive (previsu) 
sauf si en mode geoportail_force (saisie)
*****************
]
<?php 
global $geoportail_force;
if (_DIR_RESTREINT!="" || $geoportail_force) 
{
?>
[(#REM) Rubriques pour les geoservices ]
#SET{rubriques,#ARRAY{site,0,rub,#ID_RUBRIQUE,sect,#ID_SECTEUR}}


[(#REM) Balise d'inclusion du geoportail ]
<!--_SPIP_GEOPORTAIL_[(#MODE|geoportail_defaut)]-->

<script type="text/javascript">
// Ajouter une nouvelle carte
var map#ENV{id_geoportail,0} = null;

jQuery.geoportail.addMap(
	{	id : '#ENV{id_geoportail,0}',
		formulaire : #ENV{formulaire,false},
		zone: "[(#GET{zone})]",
		type: "[(#ENV{type,Default})]",
		mode:"[(#MODE|geoportail_defaut)]",
		map : null,
		geoportalLoadmap : function () 
		{	// Definir la carte
			var map = map#ENV{id_geoportail,0} = this.map;
		
			// Proxy pour la recherche
			map.getMap().setProxyUrl("?action=geoproxy&hash="+jQuery.geoportail.hash+"&url=");
			// Afficher de la carte
			jQuery.geoportail.showMap (map,
				'[(#MODE|geoportail_defaut)]',
				{	zone: '#GET{zone}', 
					lon: Number('#LON'), 
					lat: Number('#LAT'), 
					zoom: Number('#ZOOM')
				},
				{	layer:'#LAYERCTRL', 
					tools:'#TOOLBOX', 
					info:'#INFOBOX',
					search:'#SEARCHTOOLS',
					measure:'#MEASURETOOLS',
					overview:'#OVERVIEW',
					toolprint:'#TOOLPRINT'
				}, 
				{	carto:'#CARTO', 
					ortho:'#ORTHO',
					minZ: '#MIN_ZOOM',
					maxZ:'#MAX_ZOOM'
				});
			// Internationalisation
			map.getMap().setLocale("#LANG");
			// Style d'affichage par defaut
			OpenLayers.Feature.Vector.style['default'].externalGraphic = "#CHEMIN{img/punaise.gif}";
			
			<B_poubelle>
			// Supprimer les layers Geoportail dans un geoservice refuse
			<BOUCLE_poubelle(GEOSERVICES){id_rubrique IN #GET{rubriques}}{type='Geoportail'}{statut=refuse}>
				jQuery.geoportail.removeGeoservice ( map, "#TYPE", "#LAYERS" );
			</BOUCLE_poubelle>

			<B_services>
			// Ajouter les services disponibles dans les geoservices en fonction de son niveau d'affichage
			//{id_rubrique IN #GET{rubriques}}{zone IN WLD,#GET{zone}}{statut=publie}{par niveau}
			<BOUCLE_services(GEOSERVICES){id_rubrique IN #GET{rubriques}}{zone IN WLD,#GET{zone}}{statut=publie}{par niveau}>
				jQuery.geoportail.addGeoservice ( map, "#TYPE", "#TITRE", '[(#DESCRIPTIF|texte_script|replace{\r,<br\/>}|replace{\n,<br\/>}|replace{</,<\/})]',
					{	id: #ID_GEOSERVICE,
						url: "[(#URL_GEOSERVICE|geoservice_url)]",
						map: "#MAP",
						layers: "#LAYERS",
						format: "#FORMAT"
					},
					{	maxentent: new OpenLayers.Bounds(#MAXEXTENT),
						minzoom: #MINZOOM,
						maxzoom: #MAXZOOM,
						opacity: #OPACITY,
						visibility: #VISIBILITY,
						select: #SELECTION,
						logo: "#LOGO",
						picture: "[(#LOGO_GEOSERVICE||extraire_attribut{src}|url_absolue)]",
						link: "#LINK"
					});
			</BOUCLE_services>
		}
	}
);

// Ajouter les documents (si dans un article)
<BOUCLE_gpx(DOCUMENTS){id_article=#ENV{article}}{extension IN gpx,kml}>
	$.geoportail.addDoc (#ENV{id_geoportail,0}, "[(#EXTENSION|sinon{[(#FICHIER|substr{-3})]})]", #ID_DOCUMENT, "#TITRE", "#URL_DOCUMENT", [(#ENV{align}|=={center}|?{false,true})]);
</BOUCLE_gpx>

</script>
[
(#REM) 
************
FIN gestion de l'espace prive 
]<?php } ?>

<!-- La carte #[(#ENV{id_geoportail,0})]-->
<div class='GeoportalMapDiv [(#MODE|geoportail_defaut)]' id='GeoportalMapDiv#ENV{id_geoportail,0}' style="[float:(#ALIGN|match{left|right}); ][width:(#ENV{width}|replace{pc,%}); ][height:(#ENV{height}|replace{pc,%}); ]" ><!-- --></div>
[(#REM) Surcharger l'affichage du viewer]

