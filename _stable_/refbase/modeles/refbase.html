<?php
	// On determine l url a utiliser
	$url_refbase = '[(#ENV{url_refbase}|sinon{#CONFIG{refbase/url_refbase}})]';
	$requete = $url_refbase;
	// Elements constants de la requete
	$requete .= 'show.php?client=inc-refbase-1.0&wrapResults=0';
		$id = '#ENV{id}';
	if ($id!='') $requete .= '&records='.$id;
	// On recupere le parametre par
	$par = '[(#ENV**{by}|sinon{#ENV**{par}})]';
	
	// On determine la vue (citations par defaut)
	$vue = '[(#ENV{vue}|sinon{#CONFIG{refbase/vue}})]';
	$submit = '[(#ENV{submit})]';
	switch ($submit) {
		case 'Cite':
		$vue = 'citations';
		break;
		case 'List':
		$vue = 'liste';
		break;
		case 'Display':
		$vue = 'details';
		break;
		case 'Browse':
		$vue = 'recap';
		break;
	}
	if ($vue=='') $vue = 'citations';
	if ($id!='')  $vue = 'citations'; // Si un id, on force en citations
	switch ($vue) {
		case 'citations':
		$requete .= '&submit=Cite';
		break;
		case 'liste':
		$requete .= '&submit=List';
		break;
		case 'details':
		$requete .= '&submit=Display';
		break;
		case 'recap':
		$requete .= '&submit=Browse';
		break;
	}
	if ($vue=='recap' and $par=='') $par = 'year'; // Si vue recap, un par est obligatoire, year par defaut
	// Doit on afficher les liens externes ?
	$liens = '[(#ENV{liens}|sinon{#CONFIG{refbase/liens}})]';
	$showLinks = '[(#ENV{showLinks})]';
	switch ($showLinks) {
		case '1':
		case 'yes':
		$liens = 'oui';
		break;
		case '0':
		case 'no':
		$liens = 'non';
		break;
	}
	if ($liens =='non' AND $id=='') // Si id, on force en oui
		$requete .= '&showLinks=0';
	else
		$requete .= '&showLinks=1';
	// Nombre maximum de liens affiches
	$max = '[(#ENV{max}|sinon{#CONFIG{refbase/max}})]';
	$showRows = '[(#ENV{showRows})]';
	if ($showRows != '') $max = $showRows;
	if ($max=='') $max = '100';
	$requete .= '&showRows='.$max;
	// Doit on afficher doublons ?
	$doublons = '[(#ENV{doublons}|sinon{#CONFIG{refbase/doublons}})]';
	$showDups = '[(#ENV{showDups})]';
	switch ($showDups) {
		case '1':
		case 'yes':
		$doublons = 'oui';
		break;
		case '0':
		case 'no':
		$doublons = 'non';
		break;
	}
	if ('[(#ENV{without})]'=='dups') $doublons = 'non';
	if ($doublons=='non') $requete .= '&without=dups';
	// On determine le tri (annee par defaut)
	$tri = '[(#ENV{tri}|sinon{#CONFIG{refbase/tri}})]';
	$citeOrder = '[(#ENV{citeOrder})]';
	switch ($citeOrder) {
		case 'year':
		$tri = 'annee';
		break;
		case 'author':
		$tri = 'auteur';
		break;
		case 'type':
		$tri = 'type';
		break;
		case 'type-year':
		$tri = 'type-annee';
		break;
		case 'creation-date':
		$tri = 'date-creation';
		break;
	}	
	if ($tri=='') $tri = 'annee';
	if ($id=='' AND $par=='')  { // Si un id ou si un par est passe, pas de tri via CiteOrder
		switch ($tri) {
			case "annee":
			$requete .= '&citeOrder=year';
			break;
			case "auteur":
			$requete .= '&citeOrder=author';
			break;
			case "type":
			$requete .= '&citeOrder=type';
			break;
			case "type-annee":
			$requete .= '&citeOrder=type-year';
			break;
			case "date-creation":
			$requete .= '&citeOrder=creation-date';
			break;
		}
	}
	if ($par!='') $requete .= '&by='.urlencode($par); //si on a un par, on transmet
	// Style des citations
	$style = '[(#ENV{style}|sinon{#CONFIG{refbase/style}})]';
	$citeStyle = '[(#ENV{citeStyle})]';
	if ($citeStyle != '') $style = $citeStyle;
	if ($style=='') $style = 'APA';
	$requete .= '&citeStyle='.urlencode($style);
	// Doit on masquer abstracts et options export ?
	$liens_exports = '[(#ENV{liens_exports}|sinon{#CONFIG{refbase/liens_exports}})]';
	$showAbstract = '[(#ENV{showAbstract})]';
	switch ($showAbstract) {
		case '1':
		case 'yes':
		$liens_exports = 'oui';
		break;
		case '0':
		case 'no':
		$liens_exports = 'non';
		break;
	}
	$viewType = '[(#ENV{viewType})]';
		switch ($viewType) {
		case 'Mobile':
		$liens_exports = 'non';
		break;
		case 'Web':
		$liens_exports = 'oui';
		break;
	}
	if ($liens_exports=='non' OR $id!='') // Si id on n'affiche pas les liens
		$requete .= '&viewType=Mobile';
	else
		$requete .= '&viewType=Web';
	
	// Parametres de la recherche
	$where = '[(#ENV**{where})]';
	if (!preg_match('#%20#',$where)) $where = urlencode($where); // On verifie la necissite d encode l url
	if ($where!='') $requete .= '&where='.$where;
	
	$type = '[(#ENV**{type}|urlencode)]';
	if ($type!='') $requete .= '&type='.$type;
	
	$auteur = '[(#ENV**{author}|sinon{#ENV**{auteur}}|urlencode)]';
	if ($auteur!='') $requete .= '&author='.$auteur;
	
	$voir = '[(#ENV{voir})]';
	$records = '[(#ENV{records})]';
	if ($voir=='tout' OR $records=='all') $requete .= '&records=all';
	
	$institution = '[(#ENV**{contribution_id}|sinon{#ENV**{institution}}|urlencode)]';
	if ($institution!='') $requete .= '&contribution_id='.$institution;
	
	$motcle = '[(#ENV**{keywords}|sinon{#ENV**{motcle}}|urlencode)]';
	if ($motcle!='') $requete .= '&keywords='.$motcle;
	
	$journal = '[(#ENV**{publication}|sinon{#ENV**{journal}}|urlencode)]';
	if ($journal!='') $requete .= '&publication='.$journal;
	
	$identifiants = '[(#ENV{identifiants})]';
	if ($records!='' AND $records !='all') $identifiants=$records;
	if ($identifiants!='') $requete .= '&records='.$identifiants;
	
	$annee = '[(#ENV**{year}|sinon{#ENV**{annee}}|urlencode)]';
	if ($annee!='') $requete .= '&year='.$annee;
	
	$titre = '[(#ENV**{title}|sinon{#ENV**{titre}}|urlencode)]';
	if ($titre!='') $requete .= '&title='.$titre;
	
	$depuis = '[(#ENV**{since}|sinon{#ENV**{depuis}})]';
	if ($depuis!='') {
		// Si c est une annee
		if (preg_match('#^[0-9]{4}$#',$depuis))
			$requete .= '&where=year+>+'.($depuis-1);
		// Si c est une duree en annee 
		elseif (preg_match('#^[0-9]{1,3}ans$#',$depuis))
			$requete .= '&where=year+>+YEAR(NOW())-'.substr($depuis,0,-3);
		elseif (preg_match('#^[0-9]{1,3}an$#',$depuis))
			$requete .= '&where=year+>+YEAR(NOW())-'.substr($depuis,0,-2);
		elseif (preg_match('#^[0-9]{1,3}y$#',$depuis))
			$requete .= '&where=year+>+YEAR(NOW())-'.substr($depuis,0,-1);
		elseif (preg_match('#^[0-9]{1,3}year$#',$depuis))
			$requete .= '&where=year+>+YEAR(NOW())-'.substr($depuis,0,-4);
		elseif (preg_match('#^[0-9]{1,3}years$#',$depuis))
			$requete .= '&where=year+>+YEAR(NOW())-'.substr($depuis,0,-5);
	}
	
	$doi = '[(#ENV**{doi}|urlencode)]';
	if ($doi!='') $requete .= '&where=doi%20RLIKE%20%22'.$doi.'%22';
		
	// On recupere le flux
	$texte = spip_file_get_contents($requete);
	
	// Cas de plusieurs références
	if ($id=='') {
		// Renommage pour eviter toute interference
		$texte = str_replace('toggleVisibilitySlide','refbase_toggleVisibilitySlide',$texte);
		// Si vue=recap, il faut rendre les liens absolus
		if ($vue=='recap') {
			$texte = str_replace('<a href="search.php','<a href="'.$url_refbase.'search.php',$texte);
			$texte = str_replace('src="img/details','src="'.$url_refbase.'img/details',$texte);
		}
		// On affiche
		echo '<div class="refbasecss" [style="(#ENV{css}|sinon{#CONFIG{refbase/css}})"]>';
		echo $texte;
		echo '</div>';
	}
	else { // Cas d une reference unique
		
		preg_match("#<div class=\"citation\">.*</div>#",$texte,$reference);
		preg_match("#<span class=\"Z3988\".*</span>#",$texte,$coins);
		$reference = substr($reference[0],22,-6);
		
		// rendre url clicable
		$in=array(
			'#((?:https?|ftp)://\S+)(\s|\z)#',
			'#((?<!//)(www\.)\S+)(\s|\z)#'
		);
		$out=array(
			'<a href="$1">$1</a>',
			'<a href="http://$1">$1</a>'
		);
		$reference = preg_replace($in,$out,$reference);
		
		echo $reference.' '.$coins[0];
	}
?>