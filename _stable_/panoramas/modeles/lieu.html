<B_lieux>

<BOUCLE_lieux(VISITES_VIRTUELLES_LIEUX){id_lieu}>
	
	<?php
		//mise à jour de la liste des lieux visités
		$tab_lieux_visites = split(",", $_COOKIE['lieux_visites']);
		if (!in_array("#ID_LIEU", $tab_lieux_visites)) {
			setcookie("lieux_visites",implode(",", $tab_lieux_visites).",#ID_LIEU");
		}
	?>
	<a id="[lieu(#ID_LIEU)]" name="[lieu(#ID_LIEU)]"></a>
	<BOUCLE_photo(DOCUMENTS){id_document=#ID_PHOTO}>
		<img src="#URL_DOCUMENT" class="panorama#ID_LIEU" width="#LARGEUR" height="#HAUTEUR" 
	</BOUCLE_photo>
	 alt="#TITRE" usemap="map#ID_LIEU" />
	<B_interactions>
	<map id="map#ID_LIEU" name="map#ID_LIEU"> 
		<BOUCLE_interactions(VISITES_VIRTUELLES_INTERACTIONS){id_lieu}>
			<area shape="rect" coords="#X1,#Y1,#X2,#Y2"
				[(#TYPE|=={'article'}|?{' ',''}) href="#URL_PAGE{article,id_article=#ID_ARTICLE_CIBLE}" class="interaction#ID_INTERACTION type-article"]
				[(#TYPE|=={'rubrique'}|?{' ',''}) href="#URL_PAGE{rubrique,id_rubrique=#ID_RUBRIQUE_CIBLE}" class="interaction#ID_INTERACTION type-rubrique"]
				[(#TYPE|=={'lieu'}|?{' ',''}) href="#URL_PAGE{lieu,id_lieu=#ID_LIEU_CIBLE}" class="interaction#ID_INTERACTION type-lieu"]
				[(#TYPE|=={'visite'}|?{' ',''}) href="#URL_PAGE{visite,id_visite=#ID_VISITE_CIBLE}" class="interaction#ID_INTERACTION type-visite"]
				[(#TYPE|=={'url'}|?{' ',''}) href="#URL_CIBLE" class="interaction#ID_INTERACTION type-url"]
				[(#TYPE|=={'descriptif'}|?{' ',''}) href="#URL_PAGE{descriptif_interaction_ajax,id_interaction=#ID_INTERACTION}" class="interaction#ID_INTERACTION type-descriptif thickbox"]
				<BOUCLE_documentimagepointe(DOCUMENTS){id_document=#ID_DOCUMENT_CIBLE}{extension IN jpg,JPG}>[(#TYPE|=={'document'}|?{' ',''})  href="#URL_DOCUMENT" class="interaction#ID_INTERACTION type-document thickbox"]</BOUCLE_documentimagepointe>
				<BOUCLE_documentmp3pointe(DOCUMENTS){id_document=#ID_DOCUMENT_CIBLE}{extension IN mp3,MP3}>[(#TYPE|=={'document'}|?{' ',''})  href="#URL_PAGE{document_ajax,id_document=#ID_DOCUMENT_CIBLE}" class="interaction#ID_INTERACTION type-audio thickbox"]</BOUCLE_documentmp3pointe>
				<BOUCLE_documentvideopointe(DOCUMENTS){id_document=#ID_DOCUMENT_CIBLE}{extension IN flv,FLV}>[(#TYPE|=={'document'}|?{' ',''})  href="#URL_PAGE{document_ajax,id_document=#ID_DOCUMENT_CIBLE}" class="interaction#ID_INTERACTION type-video thickbox"]</BOUCLE_documentvideopointe>
				[(#TYPE|=={'jeu'}|?{' ',''}) href="#URL_PAGE{jeu_interaction_ajax,id_interaction=#ID_INTERACTION&KeepThis=true&TB_iframe=true&height=400&width=600}" class="interaction#ID_INTERACTION type-jeu thickbox"]
				<BOUCLE_objet(DOCUMENTS){id_document=#ID_OBJET}>[(#TYPE|=={'objet'}|?{' ',''})  href="#" class="interaction#ID_INTERACTION type-objet type-objet#ID_DOCUMENT"]</BOUCLE_objet>
				<BOUCLE_personnage(DOCUMENTS){id_document=#ID_PERSONNAGE}>[(#TYPE|=={'personnage'}|?{' ',''})  href="#" class="interaction#ID_INTERACTION type-personnage- type-personnage#ID_DOCUMENT"]</BOUCLE_personnage>
				
			alt="#TITRE" />
		</BOUCLE_interactions>
		
	</map>
	</B_interactions>
	<script type="text/javascript">
	$(document).ready(function(){
		$("img.panorama#ID_LIEU").panorama({
	                auto_start: 0,
                 	control_display: 'yes',
			viewport_width: <BOUCLE_visiteparent(VISITES_VIRTUELLES){id_visite}>[(#LARGEUR|=={0}|?{'570',#LARGEUR})]</BOUCLE_visiteparent>[,
			start_position: (#DECALAGE_X)][,
			mode_360: (#BOUCLER|=={'oui'}|?{1,0})]

	         });
	});
	</script>
<script type="text/javascript" src="#CHEMIN{js/cvi_text_lib.js}"></script>
<script type="text/javascript" src="#CHEMIN{js/jquery.advanced-panorama.js}"></script>
<script type="text/javascript" src="#CHEMIN{js/jquery.flipv.js}"></script>
<script type="text/javascript">
	tb_pathToImage = "#CHEMIN{css/loadingAnimation.gif}";

<BOUCLE_visites(VISITES_VIRTUELLES){id_visite=#ID_VISITE}>
<BOUCLE_carte(DOCUMENTS){id_document=#ID_CARTE}>
$(document).ready(function(){
	$('.panorama-viewport').append("<div class='panorama-onglets'><div class='panorama-carte'><img src='#URL_DOCUMENT' height='"+parseInt($('.panorama-viewport').css('height'))+"' /><BOUCLE_position(VISITES_VIRTUELLES_LIEUX){id_visite=#ID_VISITE}><span class='lien-plan' style='[left: (#POSITION_X_CARTE)px;][ top: (#POSITION_Y_CARTE|moins{40})px;]'><a href='[(#URL_CARTE|sinon{[(#URL_PAGE{lieu,id_lieu=#ID_LIEU})]})]'>#TITRE</a></span></BOUCLE_position></div><div class='panorama-panier' style='width: "+parseInt(parseInt($('.panorama-viewport').css('width'))/3)+"px; height: "+parseInt($('.panorama-viewport').css('height'))+"px;' ><:panoramas:contenu_panier:><ul><?php echo(str_replace('"', '\'', $_COOKIE['objets_ramasses'])); ?></ul></div><div class='panorama-onglets-titres'><h2 class='panorama-carte'><a href='#'><:panoramas:carte:></a></h2><h2 class='panorama-panier'><a href='#'><:panoramas:panier:></a></h2></div></div>");
	
	$('.panorama-viewport .lien-plan').css('z-index', 50).bind('mouseover', function(){
								$('.panorama-viewport .lien-plan').css('z-index', 50);
								$(this).css('z-index', 60);
							});
	$('.panorama-onglets h2.panorama-carte a').flipv().bind('click', function() { 
				$('div.panorama-carte').toggle();
				if ($('div.panorama-carte').css('display') != 'none') 
					$('h2.panorama-panier').hide();
				else
					$('h2.panorama-panier').show();
				return false;
	});
	$('.panorama-onglets h2.panorama-panier a').flipv().bind('click', function() { 
				$('div.panorama-panier').toggle();
				if ($('div.panorama-panier').css('display') != 'none') 
					$('h2.panorama-carte').hide();
				else
					$('h2.panorama-carte').show();
				return false;
	});
});
</BOUCLE_carte>
</BOUCLE_visites>
	$(document).ready(function(){
		
	
	<BOUCLE_interactionsobjetetpersonnage(VISITES_VIRTUELLES_INTERACTIONS){id_lieu}>
		
		[ (#REM) interactions qui ont précisé une image de fond : ajouter l'image dans le cadre ]
		<BOUCLE_imagedefondcourante(DOCUMENTS){id_document=#ID_IMAGE_FOND}>
			$('.interaction#_interactionsobjetetpersonnage:ID_INTERACTION').append("<img src='#URL_DOCUMENT' width='100%' height='100%' />").css('opacity',1).css('border','none').css('background','none');
			$('.interaction#_interactionsobjetetpersonnage:ID_INTERACTION').bind('click', function() {
							return false;
						});
				
				
		</BOUCLE_imagedefondcourante>

		[ (#REM) interactions avec les objets : ajouter l'image de l'objet et gérer le drag and drop dans le panier ]
		<BOUCLE_objetcourant(DOCUMENTS){id_document=#ID_OBJET}>
			[(#TYPE|=={'objet'}|?{' ',''})  
				$('.type-objet#ID_DOCUMENT').append("<img src='#URL_DOCUMENT' width='100%' height='100%' />");
				$('.type-objet#ID_DOCUMENT').bind('click', function() {
							return false;
						}).draggable({helper: 'clone', opacity: .4, revert: true});
				$('h2.panorama-panier').droppable({
					accept: ".type-objet#ID_DOCUMENT",
					activeClass: 'droppable-active',
					hoverClass: 'droppable-hover',
					drop: function(ev, ui) {
						$('div.panorama-panier ul').append("<li><div class='objet#ID_DOCUMENT'><img src='#URL_DOCUMENT' /><span style='display: none;'>#ID_DOCUMENT</span></div></li>");
						$('div.panorama-panier ul li div').draggable({helper: 'clone', opacity: .4, revert: true});
						$('.type-objet#ID_DOCUMENT').remove();
						
						//mis à jour des cookies
						var objets_ramasses = $('div.panorama-panier ul').html();
						$.cookie('objets_ramasses', objets_ramasses);
						
					}
				});
				
				[ (#REM) suppression des objets qui sont déjà dans le panier ]
				if ($('div.panorama-panier ul').find('.objet#ID_DOCUMENT').length > 0) {
					$('.type-objet#ID_DOCUMENT').remove();
				}
				
			]
		</BOUCLE_objetcourant>

		[ (#REM) interactions de type personnage : ajouter l'image du personnage ]
		<BOUCLE_personnagecourant(DOCUMENTS){id_document=#ID_PERSONNAGE}>
			[(#TYPE|=={'personnage'}|?{' ',''})  
				$('.type-personnage#ID_DOCUMENT').append("<img src='#URL_DOCUMENT' width='100%' height='100%' />").css('opacity',1).css('border','none').css('background','none');
				$('.type-personnage#ID_DOCUMENT').bind('click', function() {
							return false;
						});
				
				
			]
		</BOUCLE_personnagecourant>

		[ (#REM) interactions qui requièrent un objet pour être actives (il faudra drag and dropper l'objet sur l'interaction depuis le panier ]
		<BOUCLE_objetactivationobjet(DOCUMENTS){id_document=#ID_OBJET_ACTIVATION}>
			$('.interaction#ID_INTERACTION')
				.unbind('click')
				.bind('click', function() {
							[alert("(#TEXTE_AVANT_ACTIVATION)");]
							return false;
						})
				.droppable({
					accept: "div.objet#ID_DOCUMENT, .type-objet#ID_DOCUMENT",
					activeClass: 'droppable-active',
					hoverClass: 'droppable-hover',
					drop: function(ev, ui) {
						[alert("(#TEXTE_APRES_ACTIVATION)");]
						$('div.panorama-panier').hide();
						$('h2.panorama-carte').show();
						$(this).unbind('click');
						tb_init(this);
						$('div.panorama-panier ul li div.objet#ID_DOCUMENT, .type-objet#ID_DOCUMENT').remove();
						
						//mis à jour des cookies
						var objets_ramasses = $('div.panorama-panier ul').html();
						$.cookie('objets_ramasses', objets_ramasses);
						
					}
			});
		</BOUCLE_objetactivationobjet>

		[ (#REM) interactions qui requièrent d'avoir visité un lieu ]
		<BOUCLE_objetactivationlieu(VISITES_VIRTUELLES_LIEUX){id_lieu=#ID_LIEU_ACTIVATION}>
			$('.interaction#ID_INTERACTION')
				.unbind('click')
				.bind('click', function() {
							if ($.cookie('lieux_visites')) {
								var tableau_lieux_visites = $.cookie('lieux_visites').split(','); 
								if (tableau_lieux_visites.indexOf('#ID_LIEU')>=0) {
									[alert("(#TEXTE_APRES_ACTIVATION)");]
								} else {
									[alert("(#TEXTE_AVANT_ACTIVATION)");]
								}
							} else {
								[alert("(#TEXTE_AVANT_ACTIVATION)");]
							}
							return false;
						});
		</BOUCLE_objetactivationlieu>

		[ (#REM) interactions qui requièrent d'avoir réussi un questionnaire avant ]
		<BOUCLE_objetactivationjeu(JEUX){id_jeu=#ID_JEU_ACTIVATION}>
			$('.interaction#ID_INTERACTION')
				.unbind('click')
				.bind('click', function() {
							if($.cookie('jeux_reussis')) {
								var tableau_jeux_visites = $.cookie('jeux_reussis').split(','); 
								if (tableau_jeux_visites.indexOf('#ID_JEU')>=0) {
									[alert("(#TEXTE_APRES_ACTIVATION)");]
								} else {
									[alert("(#TEXTE_AVANT_ACTIVATION)");]
								}
							} else	{
								[alert("(#TEXTE_AVANT_ACTIVATION)");]
							}
							return false;
						});
		</BOUCLE_objetactivationjeu>
		
	</BOUCLE_interactionsobjetetpersonnage>

	});

</script>

#SET{docs, #DOCUMENTS_ASSOCIES}
<B_documentsassocies>
<div class="documents-lieu">
<h2><:panoramas:documents_associes:></h2>
<BOUCLE_documentsassocies(DOCUMENTS)>[(#ID_DOCUMENT|inclusdans{#GET**{docs}}|?{' ',''})
		<a href="#URL_DOCUMENT" class="thickbox">[(#LOGO_DOCUMENT||image_reduire{0,100})]</a>
	]</BOUCLE_documentsassocies>
</div>
</B_documentsassocies>

</BOUCLE_lieux>
<script type="text/javascript" src="#CHEMIN{js/thickbox.js}"></script>

</B_lieux>