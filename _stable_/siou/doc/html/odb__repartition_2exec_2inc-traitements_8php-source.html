<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Siou:  Fichier source de odb_repartition/exec/inc-traitements.php</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Généré par Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Page&nbsp;principale</span></a></li>
    <li class="current"><a href="files.html"><span>Fichiers</span></a></li>
    <li><a href="dirs.html"><span>Répertoires</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;Rechercher&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul>
</div>
<div class="nav">
<a class="el" href="dir_815c5a1351c78a122efb88a2a7d5980d.html">odb_repartition</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_a9fe0185a7b497ba5d897d786e368dbb.html">exec</a></div>
<h1>inc-traitements.php</h1><a href="odb__repartition_2exec_2inc-traitements_8php.html">Aller à la documentation de ce fichier.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 include_once(<a class="code" href="inc-odb__repartition_8php.html#11ee20e9f2854148d2c4defad4f70990">_DIR_PLUGIN_ODB_REPARTITION</a>.'exec/inc-base.php');
<a name="l00004"></a>00004 
<a name="l00016"></a><a class="code" href="odb__repartition_2exec_2inc-traitements_8php.html#010c580ae6309b4804db56b0ee07e5f8">00016</a> function <a class="code" href="odb__repartition_2exec_2inc-traitements_8php.html#010c580ae6309b4804db56b0ee07e5f8" title="Répartir les candidats.">repartirCandidats</a>($par,$filtre,$envoi_centre,$envoi_salle,$lib_centre,<a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>,<a class="code" href="inc-pdf-attestations_8php.html#e05862a0294251c88629b141b5ce329a">$limit</a>=0) {
<a name="l00017"></a>00017 
<a name="l00018"></a>00018    <span class="keywordflow">if</span>(substr_count($lib_centre,<span class="stringliteral">"departement"</span>)&gt;0) {
<a name="l00019"></a>00019       $id_departement=substr($lib_centre,strlen(<span class="stringliteral">"departement|"</span>));
<a name="l00020"></a>00020       $lib_centre=$tab_referentiel['etablissement'][$id_departement][$envoi_centre];
<a name="l00021"></a>00021       echo <span class="stringliteral">"$id_departement - $envoi_centre - $lib_centre"</span>;
<a name="l00022"></a>00022    }
<a name="l00023"></a>00023    <span class="comment">// infos salle</span>
<a name="l00024"></a>00024    $tab_capacite=<a class="code" href="inc-base_8php.html#3df289cb98e86548dd5a2ba1d612844f" title="Recupere le tableau de capacite d&amp;#39;accueil d&amp;#39;un centre de composition.">getCapacite</a>(<a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>,$envoi_centre,$envoi_salle);
<a name="l00025"></a>00025    $nb_capacite=count($tab_capacite);
<a name="l00026"></a>00026    <span class="comment">// numeros de saisie candidats selectionnes</span>
<a name="l00027"></a>00027    $tab_candidat = <a class="code" href="inc-base_8php.html#ab9ba183925f5b59dcc76998488cb5ae" title="Recupere le tableau des candidats a repartir.">getCandidatsARepartir</a>(<a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>,$par,$filtre,<a class="code" href="inc-pdf-attestations_8php.html#e05862a0294251c88629b141b5ce329a">$limit</a>);
<a name="l00028"></a>00028    $nb_rows=count($tab_candidat);
<a name="l00029"></a>00029    $dispoMax=0;
<a name="l00030"></a>00030    <span class="keywordflow">if</span>($nb_capacite&gt;0)
<a name="l00031"></a>00031       <span class="keywordflow">foreach</span>($tab_capacite as $idSalle=&gt;$tab) {
<a name="l00032"></a>00032          $dispoMax=max($tab['dispo'],$dispoMax);
<a name="l00033"></a>00033          <span class="keywordflow">if</span>($tab['dispo']&gt;=$nb_rows) {
<a name="l00034"></a>00034             <span class="comment">// cette salle peut contenir les candidats</span>
<a name="l00035"></a>00035             $id_salle=$idSalle;
<a name="l00036"></a>00036             <span class="keywordflow">foreach</span>($tab as <a class="code" href="resultats__ajournes__par__centre_8php.html#28034c8e7e61c01855a789a9215d8acd">$cle</a>=&gt;$val)
<a name="l00037"></a>00037                $$cle=$val;
<a name="l00038"></a>00038          }
<a name="l00039"></a>00039       }
<a name="l00040"></a>00040       <span class="keywordflow">if</span>($nb_capacite&gt;0) {
<a name="l00041"></a>00041          $thead=<span class="stringliteral">"&lt;th&gt;Type de salle&lt;/th&gt;&lt;th&gt;Capacit&amp;eacute; de&lt;br/&gt;chaque salle&lt;/th&gt;&lt;th&gt;Capacit&amp;eacute; totale de ce&lt;br/&gt;type de salle&lt;/th&gt;&lt;th&gt;Places disponibles &lt;br/&gt;avant cette r&amp;eacute;partition&lt;/th&gt;&lt;/tr&gt;\n"</span>;
<a name="l00042"></a>00042          <span class="keywordflow">foreach</span>($tab_capacite as $idSaisie=&gt;$tab) {
<a name="l00043"></a>00043             $tbody[]=<span class="stringliteral">"&lt;td&gt;"</span>.$tab['salle'].<span class="stringliteral">"&lt;/td&gt;&lt;td&gt;"</span>.$tab['capacite_salle'].<span class="stringliteral">"&lt;/td&gt;&lt;td&gt;"</span>.$tab['capacite_type'].<span class="stringliteral">"&lt;/td&gt;&lt;td&gt;"</span>.$tab['dispo'].<span class="stringliteral">"&lt;/td&gt;"</span>;
<a name="l00044"></a>00044          }
<a name="l00045"></a>00045          $msg_info.=<a class="code" href="inc-html_8php.html#5f91efa37c4c6e04e1e2792cc0c37600" title="Affiche une table html.">odb_html_table</a>(<span class="stringliteral">"Historique (rappel)"</span>,$tbody,$thead);
<a name="l00046"></a>00046       } <span class="keywordflow">else</span> {
<a name="l00047"></a>00047          $msg_info.= <a class="code" href="odb__ref_8php.html#e56b96c4dfcced36887ba02c496c40a3">KO</a>.<span class="stringliteral">" - Ce centre n'a pas &amp;eacute;t&amp;eacute; correctement configur&amp;eacute; dans le &lt;A HREF='"</span>.generer_url_ecrire('odb_ref').<span class="stringliteral">"&amp;table=odb_ref_salle&amp;step2=manuel'&gt;r&amp;eacute;f&amp;eacute;rentiel salle&lt;/A&gt;."</span>;
<a name="l00048"></a>00048          $nb_rows=0;
<a name="l00049"></a>00049       }
<a name="l00050"></a>00050       <span class="keywordflow">if</span>($nb_rows&gt;0 &amp;&amp; $nb_rows&lt;=$dispoMax) {
<a name="l00051"></a>00051         $idTableMax=<a class="code" href="inc-base_8php.html#9655e52be1c8d2424b01b145d69bbe3d" title="Recupere le plus grand id_table disponible pour le centre de composition.">getIdTableMax</a>(<a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>,$envoi_centre);
<a name="l00052"></a>00052          <span class="keywordflow">if</span>($idTableMax!='') {
<a name="l00053"></a>00053             $tRang=<a class="code" href="inc-base_8php.html#e94bb1db4a3bc1bc687818e3eec738b3" title="Recupere le rang (numero de salle et de table) d&amp;#39;un candidat dans une salle.">getRangCandidatDansSalle</a>(<a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>,$envoi_centre,$envoi_salle);
<a name="l00054"></a>00054             $num_salle=$tRang['numSalle'];
<a name="l00055"></a>00055             $rangCandidatDansSalle=$tRang['rang']; <span class="comment">//rang dans la salle</span>
<a name="l00056"></a>00056             $numCan=$tRang['numero']; <span class="comment">// numero dans le centre (4 derniers chiffres du id_table)</span>
<a name="l00057"></a>00057          } <span class="keywordflow">else</span> {
<a name="l00058"></a>00058             $num_salle=1;
<a name="l00059"></a>00059             $numCan=0;
<a name="l00060"></a>00060             $rangCandidatDansSalle=0; <span class="comment">// rang du candidat dans la salle</span>
<a name="l00061"></a>00061          }
<a name="l00062"></a>00062             
<a name="l00063"></a>00063          <span class="comment">//echo "$sql&lt;br/&gt;numCan cptCan capacite_salle numSalle : [$id] $numCan - $rangCandidatDansSalle - $capacite_salle - $num_salle&lt;br/&gt;";</span>
<a name="l00064"></a>00064          <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>=0; <span class="comment">// compteur de candidats affectes</span>
<a name="l00065"></a>00065          <span class="keywordflow">foreach</span>($tab_candidat as $id_saisie=&gt;$tab) {
<a name="l00066"></a>00066             $id_departement=$tab['id_departement'];
<a name="l00067"></a>00067             $id_ville=$tab['id_ville'];
<a name="l00068"></a>00068             $rangCandidatDansSalle++;
<a name="l00069"></a>00069             $numCan++;
<a name="l00070"></a>00070             <span class="keywordflow">if</span>($rangCandidatDansSalle&gt;$capacite_salle) {
<a name="l00071"></a>00071                $num_salle++;
<a name="l00072"></a>00072                $rangCandidatDansSalle=1;
<a name="l00073"></a>00073             }
<a name="l00074"></a>00074             $numCan=str_pad($numCan,4,<span class="stringliteral">"0"</span>,STR_PAD_LEFT);
<a name="l00075"></a>00075             $num_salle=str_pad($num_salle,3,<span class="stringliteral">"0"</span>,STR_PAD_LEFT);
<a name="l00076"></a>00076             <a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>=$envoi_centre.<span class="charliteral">'-'</span>.<a class="code" href="inc-pdf-convocation_8php.html#02836f11c8d8f2355fc2208ad4adf415">$salle</a>.$num_salle.<span class="charliteral">'-'</span>.$numCan;
<a name="l00077"></a>00077             <span class="keywordflow">if</span>(<a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>==0) $id_table_premier=<a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>;
<a name="l00078"></a>00078             <a class="code" href="inc-base_8php.html#eafd2085176b2d14d9d1ccb06045c1cc" title="Cree le numero de table du candidat id_saisie.">setRepartition</a>(<a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>,$envoi_centre,$id_saisie,<a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>,$id_salle,$num_salle,$rangCandidatDansSalle);
<a name="l00079"></a>00079             <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>++;
<a name="l00080"></a>00080          }
<a name="l00081"></a>00081          <a class="code" href="inc-base_8php.html#4d8032ee329b76b0283193796ff51c13" title="Synchronise les id_table de la table odb_repartition vers la table odb_candidats...">setSynchroIdTableRepartition2Candidats</a>(<a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>);
<a name="l00082"></a>00082          $msg_repartition= <span class="stringliteral">"&lt;b&gt;$nb_rows&lt;/b&gt; candidats ont &amp;eacute;t&amp;eacute; r&amp;eacute;partis dans le centre &lt;b&gt;$lib_centre&lt;/b&gt;\n"</span>;
<a name="l00083"></a>00083          $msg_repartition.= <span class="stringliteral">"\n&lt;ul&gt;\n\t&lt;li&gt;Premier num&amp;eacute;ro de table g&amp;eacute;n&amp;eacute;r&amp;eacute; : &lt;b&gt;"</span>.getIdTableHumain($id_table_premier).<span class="stringliteral">"&lt;/b&gt;&lt;/li&gt;"</span>;
<a name="l00084"></a>00084          $msg_repartition.= <span class="stringliteral">"\n\t&lt;li&gt;Dernier num&amp;eacute;ro de table g&amp;eacute;n&amp;eacute;r&amp;eacute; : &lt;b&gt;"</span>.getIdTableHumain(<a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>).<span class="stringliteral">"&lt;/b&gt;&lt;/li&gt;\n&lt;/ul&gt;\n"</span>;
<a name="l00085"></a>00085       } elseif($nb_rows&gt;$dispoMax) $msg_repartition= <a class="code" href="odb__ref_8php.html#e56b96c4dfcced36887ba02c496c40a3">KO</a>.<span class="stringliteral">" - Vous avez demand&amp;eacute; &amp;agrave; r&amp;eacute;partir &lt;b&gt;$nb_rows&lt;/b&gt; candidats.&lt;br/&gt;Ce centre n'est pas capable d'accueillir plus de &lt;b&gt;$dispoMax&lt;/b&gt; candidats, veuillez modifier le nombre de candidats &amp;agrave; r&amp;eacute;partir&lt;br/&gt;\n"</span>;
<a name="l00086"></a>00086       <span class="keywordflow">else</span> $msg_repartition= <span class="stringliteral">"Aucun candidat &amp;agrave r&amp;eacute;partir dans le &lt;b&gt;$lib_centre&lt;/b&gt;\n"</span>;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088    $retour['msg_info']=$msg_info;
<a name="l00089"></a>00089    $retour['msg_repartition']=$msg_repartition;
<a name="l00090"></a>00090    $retour['nb_rows']=$nb_rows;
<a name="l00091"></a>00091    
<a name="l00092"></a>00092    <span class="keywordflow">return</span>($retour);
<a name="l00093"></a>00093 }
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 ?&gt;
</pre></div><hr size="1"><address style="text-align: right;"><small>Généré le Mon Mar 17 22:53:00 2008 pour Siou par&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
