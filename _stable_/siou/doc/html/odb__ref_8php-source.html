<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Siou:  Fichier source de odb_referentiel/exec/odb_ref.php</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Généré par Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Page&nbsp;principale</span></a></li>
    <li class="current"><a href="files.html"><span>Fichiers</span></a></li>
    <li><a href="dirs.html"><span>Répertoires</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;Rechercher&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul>
</div>
<div class="nav">
<a class="el" href="dir_dc64cf9f1a122bc8ce2a3db8a9e8186d.html">odb_referentiel</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_5ff68b244f73219e99073f0a29941c3d.html">exec</a></div>
<h1>odb_ref.php</h1><a href="odb__ref_8php.html">Aller à la documentation de ce fichier.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 session_start();
<a name="l00003"></a>00003 include_spip('inc/presentation');
<a name="l00004"></a>00004 include_spip('inc/charsets');
<a name="l00005"></a>00005 include_spip('inc/acces');
<a name="l00006"></a><a class="code" href="odb__ref_8php.html#c24ff0f08fb134ed2d43c99826787bc2">00006</a> define('<a class="code" href="odb__affiche__csv_8php.html#c24ff0f08fb134ed2d43c99826787bc2">DIR_ODB_COMMUN</a>',_DIR_PLUGINS.<span class="stringliteral">"odb/odb_commun/"</span>);
<a name="l00007"></a>00007 include_once(<a class="code" href="odb__affiche__csv_8php.html#c24ff0f08fb134ed2d43c99826787bc2">DIR_ODB_COMMUN</a>.'inc-html.php');
<a name="l00008"></a>00008 include_once(<a class="code" href="odb__affiche__csv_8php.html#c24ff0f08fb134ed2d43c99826787bc2">DIR_ODB_COMMUN</a>.<span class="stringliteral">"inc-referentiel.php"</span>);
<a name="l00009"></a>00009 include_once(<a class="code" href="odb__affiche__csv_8php.html#c24ff0f08fb134ed2d43c99826787bc2">DIR_ODB_COMMUN</a>.'inc-odb.php');
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="comment">//include_once(DIR_ODB_COMMUN."inc-regles_gestion.php");</span>
<a name="l00012"></a>00012 
<a name="l00013"></a><a class="code" href="odb__ref_8php.html#b7d0a4711c7f4bdfcfc3374f50ddd2ff">00013</a> define('<a class="code" href="odb__ref_8php.html#b7d0a4711c7f4bdfcfc3374f50ddd2ff">MIN_REFERENTIEL</a>',2002); <span class="comment">// ann&amp;eacute;e minimale dans le r&amp;eacute;f&amp;eacute;rentiel</span>
<a name="l00014"></a><a class="code" href="odb__ref_8php.html#509f04652b5e1b2d2b9e6bc121a87e50">00014</a> define('<a class="code" href="odb__ref_8php.html#509f04652b5e1b2d2b9e6bc121a87e50">OK</a>',<span class="stringliteral">"&lt;SPAN style='color:#3C3;font-weight:bold;'&gt;[OK]&lt;/SPAN&gt;"</span>);
<a name="l00015"></a><a class="code" href="odb__ref_8php.html#e56b96c4dfcced36887ba02c496c40a3">00015</a> define('<a class="code" href="odb__ref_8php.html#e56b96c4dfcced36887ba02c496c40a3">KO</a>',<span class="stringliteral">"&lt;SPAN style='color:#C33;font-weight:bold;'&gt;[KO]&lt;/SPAN&gt;"</span>);
<a name="l00016"></a><a class="code" href="odb__ref_8php.html#9f5eef19bf0ee262d8aa0b7dc20c6be8">00016</a> define('<a class="code" href="odb__ref_8php.html#9f5eef19bf0ee262d8aa0b7dc20c6be8">ODB_PREFIXE</a><span class="charliteral">','</span>odb_ref_'); <span class="comment">// prefixe tables referentiel odb</span>
<a name="l00017"></a><a class="code" href="odb__ref_8php.html#b2c21ab7f7609643e58f96f9928cb3eb">00017</a> define('<a class="code" href="odb__ref_8php.html#b2c21ab7f7609643e58f96f9928cb3eb">LIGNES_TITRE</a>',20); <span class="comment">// nb lignes avant rappel titre</span>
<a name="l00018"></a><a class="code" href="odb__ref_8php.html#cca20e7f1e7c70089180dc3c39e8d977">00018</a> define('<a class="code" href="odb__ref_8php.html#cca20e7f1e7c70089180dc3c39e8d977">INPUT_MAX_SIZE</a>',40);
<a name="l00019"></a><a class="code" href="odb__ref_8php.html#6ba61f298a687e8e6095795392b1c95b">00019</a> define('<a class="code" href="odb__notes_8php.html#6ba61f298a687e8e6095795392b1c95b">ODB_BIO_OPERATEUR</a><span class="charliteral">','</span>Operateur de saisie');
<a name="l00020"></a>00020 
<a name="l00021"></a><a class="code" href="odb__ref_8php.html#58f5fd0b9d70bc87295be959c7bc176a">00021</a> global <a class="code" href="inc-fichiers_8php.html#58f5fd0b9d70bc87295be959c7bc176a">$debug</a>;
<a name="l00022"></a><a class="code" href="odb__ref_8php.html#85ae3e64cd40e9564adceb010085e9dd">00022</a> <a class="code" href="inc-fichiers_8php.html#58f5fd0b9d70bc87295be959c7bc176a">$debug</a>=<span class="keyword">false</span>;
<a name="l00023"></a>00023 
<a name="l00029"></a><a class="code" href="odb__ref_8php.html#f0b6f12f726293fcfdb8dd144b4156e1">00029</a> function <a class="code" href="odb__ref_8php.html#f0b6f12f726293fcfdb8dd144b4156e1" title="exécuté automatiquement par le plugin au chargement de la page ?exec=odb_ref">exec_odb_ref</a>() {
<a name="l00030"></a>00030    global $connect_statut, $connect_toutes_rubriques,<a class="code" href="inc-fichiers_8php.html#58f5fd0b9d70bc87295be959c7bc176a">$debug</a>;
<a name="l00031"></a>00031    debut_page(_T('R&amp;<a class="code" href="inc-pdf-table_8php.html#1c3d7fb9d2f4e0216017175154061426">eacute</a>;f&amp;<a class="code" href="inc-pdf-table_8php.html#1c3d7fb9d2f4e0216017175154061426">eacute</a>;rentiel ODB'), <span class="stringliteral">""</span>, <span class="stringliteral">""</span>);
<a name="l00032"></a>00032    echo <span class="stringliteral">"&lt;br /&gt;&lt;br /&gt;"</span>;
<a name="l00033"></a>00033    gros_titre(_T('Office Du Baccalaur&amp;eacute;at'));
<a name="l00034"></a>00034 
<a name="l00035"></a>00035    debut_cadre_relief(  <span class="stringliteral">""</span>, <span class="keyword">false</span>, <span class="stringliteral">""</span>, <a class="code" href="inc-pdf-attestations_8php.html#43e5b5a819fedbd12b8cf5421ba6985e">$titre</a> = _T('Gestion du r&amp;eacute;f&amp;eacute;rentiel ODB'));
<a name="l00036"></a>00036    debut_boite_info();
<a name="l00037"></a>00037    echo '&lt;br&gt;';
<a name="l00038"></a>00038    <span class="keywordflow">if</span>($debug) {
<a name="l00039"></a>00039       echo <span class="stringliteral">"_POST&lt;pre&gt;"</span>;print_r($_POST);echo <span class="stringliteral">"&lt;/pre&gt;\n"</span>;
<a name="l00040"></a>00040    }
<a name="l00041"></a>00041    $REFERER=$_SERVER['HTTP_REFERER'];
<a name="l00042"></a>00042    $REMOTE_ADDR=$_SERVER['REMOTE_ADDR'];
<a name="l00043"></a>00043    <span class="comment">/* envoi de mail (pour rappel)</span>
<a name="l00044"></a>00044 <span class="comment">      $texte="connexion $REMOTE_ADDR - Site appelant - $REFERER \n";</span>
<a name="l00045"></a>00045 <span class="comment">      $headers= "From: cedric.protiere@auf.org";</span>
<a name="l00046"></a>00046 <span class="comment">      $to="cedric.protiere@auf.org";</span>
<a name="l00047"></a>00047 <span class="comment">      $envoi = @mail($to, "Connexion à votre site - Page priv&amp;eacute;e, "$texte", $headers,"-f cedric.protiere@auf.org");</span>
<a name="l00048"></a>00048 <span class="comment">      echo "Curieux! Un mail vient d'être envoy&amp;eacute; à l'administrateur";</span>
<a name="l00049"></a>00049 <span class="comment">   */</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051    echo <span class="stringliteral">"&lt;IMG SRC='"</span>._DIR_PLUGIN_ODB_REF.<span class="stringliteral">"/img_pack/logo_odb.png' alt='Office du bac' ALIGN='absmiddle'&gt;&lt;br&gt;&lt;br&gt;\n"</span>;
<a name="l00052"></a>00052    
<a name="l00053"></a>00053    <a class="code" href="inc-odb_8php.html#bbbb7d83cb4d809eae2b31b2a3b1f556" title="Interdit l&amp;#39;acces a un utilisateur qui n&amp;#39;est pas dans le tableau $tOK.">isAutorise</a>(array('Admin'));
<a name="l00054"></a>00054 
<a name="l00055"></a>00055    $annuler=$_REQUEST[<span class="stringliteral">"annuler"</span>];
<a name="l00056"></a>00056    <a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>=$_REQUEST[<span class="stringliteral">"annee"</span>];
<a name="l00057"></a>00057    <span class="keywordflow">if</span>(<a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>=='') <a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>=date(<span class="stringliteral">"Y"</span>);
<a name="l00058"></a>00058    $table=$_REQUEST[<span class="stringliteral">"table"</span>];
<a name="l00059"></a>00059    $step2=$_REQUEST[<span class="stringliteral">"step2"</span>];
<a name="l00060"></a>00060    $step3=$_REQUEST[<span class="stringliteral">"step3"</span>];
<a name="l00061"></a>00061    <span class="keywordflow">if</span>(strlen($step3)&gt;0) $table=$step3;
<a name="l00062"></a>00062 
<a name="l00063"></a>00063    <span class="comment">//$libelle=$_POST["libelle"];</span>
<a name="l00064"></a>00064    <span class="keywordflow">if</span>(substr_count($table,'ETA|')&gt;0) {
<a name="l00065"></a>00065       $isETA=<span class="keyword">true</span>;
<a name="l00066"></a>00066       $tab_table=explode(<span class="charliteral">'|'</span>,$table);
<a name="l00067"></a>00067       $id_departement=$tab_table[1];
<a name="l00068"></a>00068       $lib_departement=$tab_table[2];
<a name="l00069"></a>00069       $table_step2=$table;
<a name="l00070"></a>00070       $table=$tab_table[3];
<a name="l00071"></a>00071       $libelle=<span class="stringliteral">"&amp;Eacute;tablissements de $lib_departement"</span>;
<a name="l00072"></a>00072    } <span class="keywordflow">else</span> {
<a name="l00073"></a>00073       $isETA=<span class="keyword">false</span>;
<a name="l00074"></a>00074       $libelle=ucwords(substr($table,strlen(<a class="code" href="odb__ref_8php.html#9f5eef19bf0ee262d8aa0b7dc20c6be8">ODB_PREFIXE</a>)));
<a name="l00075"></a>00075       <span class="keywordflow">switch</span>($libelle) {
<a name="l00076"></a>00076          <span class="keywordflow">case</span> 'Ef':
<a name="l00077"></a>00077             $libelle='&amp;Eacute;preuves facultatives';
<a name="l00078"></a>00078             <span class="keywordflow">break</span>;
<a name="l00079"></a>00079          <span class="keywordflow">case</span> 'Lv':
<a name="l00080"></a>00080             $libelle='Langues vivantes';
<a name="l00081"></a>00081             <span class="keywordflow">break</span>;
<a name="l00082"></a>00082       }
<a name="l00083"></a>00083       $table_step2=$table;
<a name="l00084"></a>00084    }
<a name="l00085"></a>00085    $champ = substr($table,strlen(<a class="code" href="odb__ref_8php.html#9f5eef19bf0ee262d8aa0b7dc20c6be8">ODB_PREFIXE</a>));
<a name="l00086"></a>00086 
<a name="l00087"></a>00087    
<a name="l00088"></a>00088    <span class="keywordflow">if</span>(!$isETA &amp;&amp; !in_array($champ,array('salle<span class="charliteral">','</span>examen<span class="charliteral">','</span>operateur<span class="charliteral">','</span>ecole'))) 
<a name="l00089"></a>00089       $afficherRaccourcis=<span class="keyword">true</span>;
<a name="l00090"></a>00090    <span class="keywordflow">else</span> $afficherRaccourcis=<span class="keyword">false</span>;
<a name="l00091"></a>00091    <span class="keywordflow">if</span>($afficherRaccourcis) {
<a name="l00092"></a>00092         debut_gauche();
<a name="l00093"></a>00093                 <a class="code" href="inc-referentiel_8php.html#ca269ae75f013c9730f590443481c7f9">odb_raccourcis</a>('odb_ref');
<a name="l00094"></a>00094                 debut_droite();
<a name="l00095"></a>00095    }
<a name="l00096"></a>00096    <span class="keywordflow">if</span>(strlen($step2)&gt;0) {
<a name="l00099"></a>00099                 $colspan_textarea=1;
<a name="l00100"></a>00100       <span class="keywordflow">if</span>($afficherRaccourcis)
<a name="l00101"></a>00101          debut_cadre_relief(<span class="stringliteral">""</span>, <span class="keyword">false</span>, <span class="stringliteral">""</span>, <a class="code" href="inc-pdf-attestations_8php.html#43e5b5a819fedbd12b8cf5421ba6985e">$titre</a> = _T(<span class="stringliteral">"Modification du r&amp;eacute;f&amp;eacute;rentiel [$libelle]"</span>));
<a name="l00102"></a>00102       <span class="keywordflow">else</span> gros_titre(<span class="stringliteral">"Modification du r&amp;eacute;f&amp;eacute;rentiel [$libelle]"</span>);
<a name="l00103"></a>00103       <span class="comment">// Après choix : affichage du referentiel pour consultation / modification / ajout</span>
<a name="l00104"></a>00104       echo <span class="stringliteral">"&lt;FORM NAME='form_odb_ref' id='form_odb_ref' ACTION='"</span>.generer_url_ecrire('odb_ref') .<span class="stringliteral">"' class='forml spip_xx-small' METHOD='POST'&gt;\n"</span>;
<a name="l00105"></a>00105       echo <span class="stringliteral">"Videz un champ pour supprimer une valeur&lt;br/&gt;\n"</span>;
<a name="l00106"></a>00106       echo <span class="stringliteral">"&lt;TABLE class='spip' style='background-color:#eee;'&gt;\n"</span>;
<a name="l00107"></a>00107       echo <span class="stringliteral">"&lt;INPUT type='hidden' name='exec' value='odb_ref'/&gt;\n"</span>;
<a name="l00108"></a>00108       echo <span class="stringliteral">"&lt;INPUT type='hidden' name='step3' value='$table_step2'/&gt;\n"</span>;
<a name="l00109"></a>00109       echo <span class="stringliteral">"&lt;INPUT type='hidden' name='table' value='$table'/&gt;\n"</span>;
<a name="l00110"></a>00110       echo <span class="stringliteral">"&lt;INPUT type='hidden' name='annee' value='$annee'/&gt;\n"</span>;
<a name="l00111"></a>00111       echo <span class="stringliteral">"&lt;INPUT type='hidden' name='libelle' value='$libelle'/&gt;\n"</span>;
<a name="l00112"></a>00112 
<a name="l00113"></a>00113       <span class="keywordflow">if</span>($isETA) {
<a name="l00114"></a>00114          $colspan=<span class="stringliteral">"&gt;&lt;small&gt;Action&lt;/small&gt;&lt;/TD&gt;&lt;TD colspan=2 "</span>;
<a name="l00115"></a>00115          <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT id, etablissement etablissement, id_ville, id_centre, annee_centre, id_departement from odb_ref_etablissement WHERE id_departement=$id_departement ORDER BY etablissement"</span>;
<a name="l00116"></a>00116          <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00117"></a>00117          <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>=0;
<a name="l00118"></a>00118          $maxlength=mysql_field_len(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>, 1);
<a name="l00119"></a>00119          $size=min($maxlength,35);
<a name="l00120"></a>00120          <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00121"></a>00121             unset($selectVille,$selectCentre,$selectDepartement,$id_centre);
<a name="l00122"></a>00122             <span class="keywordflow">if</span>(<a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a> % <a class="code" href="odb__ref_8php.html#b2c21ab7f7609643e58f96f9928cb3eb">LIGNES_TITRE</a> == 0)
<a name="l00123"></a>00123                echo <span class="stringliteral">"&lt;tr&gt;&lt;th&gt;$lib_departement&lt;/th&gt;&lt;th&gt;&amp;Eacute;tablissement&lt;/th&gt;&lt;th&gt;Ville&lt;/th&gt;&lt;th&gt;D&amp;eacute;partement&lt;/th&gt;&lt;th&gt;Centre le + proche&lt;/th&gt;&lt;th&gt;Si centre : depuis quand ?&lt;/th&gt;&lt;/tr&gt;\n"</span>;
<a name="l00124"></a>00124             $id=$row[<span class="stringliteral">"id"</span>];
<a name="l00125"></a>00125             $id_ville=trim($row['id_ville']);
<a name="l00126"></a>00126             $selectVille=<a class="code" href="inc-referentiel_8php.html#c23eab81895f040f0ff6f3ee312a7f63" title="Cree les OPTIONS tirees du referentiel passe en parametre.">formOptionsRefInSelect</a>('ville',$id_ville,'Ville',$id_departement);
<a name="l00127"></a>00127             $selectVille=<span class="stringliteral">"&lt;SELECT class='fondo' NAME='set|id_ville|$id'&gt;$selectVille&lt;/SELECT&gt;\n"</span>;
<a name="l00128"></a>00128             $id_centre=trim($row['id_centre']);
<a name="l00129"></a>00129             $selectCentre=<a class="code" href="inc-referentiel_8php.html#c23eab81895f040f0ff6f3ee312a7f63" title="Cree les OPTIONS tirees du referentiel passe en parametre.">formOptionsRefInSelect</a>('centre',$id_centre,'Centre',$id_departement);
<a name="l00130"></a>00130             $selectCentre=<span class="stringliteral">"&lt;SELECT class='fondo' NAME='set|id_centre|$id'&gt;$selectCentre&lt;/SELECT&gt;\n"</span>;
<a name="l00131"></a>00131             $id_departement=trim($row['id_departement']);
<a name="l00132"></a>00132             $selectDepartement=<a class="code" href="inc-referentiel_8php.html#c23eab81895f040f0ff6f3ee312a7f63" title="Cree les OPTIONS tirees du referentiel passe en parametre.">formOptionsRefInSelect</a>('departement',$id_departement);
<a name="l00133"></a>00133             $selectDepartement=<span class="stringliteral">"&lt;SELECT class='fondo' NAME='set|id_departement|$id'&gt;$selectDepartement&lt;/SELECT&gt;\n"</span>;
<a name="l00134"></a>00134             $selectAnneeCentre=<span class="stringliteral">"&lt;OPTION NAME='' VALUE='0'&gt;-=[Ann&amp;eacute;e]=-&lt;/OPTION&gt;\n"</span>.formSelectAnnee($row['annee_centre']);
<a name="l00135"></a>00135             $selectAnneeCentre=<span class="stringliteral">"&lt;SELECT class='fondo' NAME='set|annee_centre|$id'&gt;$selectAnneeCentre&lt;/SELECT&gt;\n"</span>;
<a name="l00136"></a>00136             <span class="keywordflow">if</span>($id_ville==0 || $id_centre==0 || $id_departement==0) $couleur='red';
<a name="l00137"></a>00137             <span class="keywordflow">else</span> $couleur='gray';
<a name="l00138"></a>00138             echo <a class="code" href="inc-html_8php.html#ee820c089a642b6c9643b4a48fc46395" title="Cree un champ INPUT TEXT dans une ligne TR.">formInputTextTR</a>(<span class="stringliteral">"&lt;font color='$couleur'&gt;[&lt;b&gt;$id&lt;/b&gt;]&lt;/font&gt;"</span>,$table.<span class="stringliteral">"|"</span>.$id,trim($row[$champ]),<span class="stringliteral">"class='fondo' size='$size' maxlength='$maxlength' onfocus='this.select();' "</span>,<span class="stringliteral">"&lt;td&gt;$selectVille&lt;/td&gt;&lt;td&gt;$selectDepartement&lt;/td&gt;&lt;td&gt;$selectCentre&lt;/td&gt;&lt;td&gt;$selectAnneeCentre&lt;/td&gt;"</span>);
<a name="l00139"></a>00139             <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>++;
<a name="l00140"></a>00140          }
<a name="l00141"></a>00141       } elseif ($champ=='serie') {
<a name="l00142"></a>00142          $colspan=<span class="stringliteral">"&gt;&lt;small&gt;Action&lt;/small&gt;&lt;/TD&gt;&lt;TD colspan=1 "</span>;
<a name="l00143"></a>00143          $colspan_textarea=2;
<a name="l00144"></a>00144          <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT id, serie, libelle from odb_ref_serie ORDER BY serie"</span>;
<a name="l00145"></a>00145          <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00146"></a>00146          <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>=0;
<a name="l00147"></a>00147          $maxlength=mysql_field_len(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>, 1);
<a name="l00148"></a>00148          $size=min($maxlength,35);
<a name="l00149"></a>00149          <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00150"></a>00150             <span class="keywordflow">if</span>(<a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a> % <a class="code" href="odb__ref_8php.html#b2c21ab7f7609643e58f96f9928cb3eb">LIGNES_TITRE</a> == 0)
<a name="l00151"></a>00151                echo <span class="stringliteral">"&lt;tr&gt;&lt;th&gt;#"</span>.ucwords($champ).<span class="stringliteral">"&lt;/th&gt;&lt;th&gt;"</span>.ucwords($champ).<span class="stringliteral">"&lt;/th&gt;&lt;th&gt;Libell&amp;eacute;&lt;/th&gt;&lt;/tr&gt;\n"</span>;
<a name="l00152"></a>00152             $id=$row[<span class="stringliteral">"id"</span>];
<a name="l00153"></a>00153             $serie=trim($row['serie']);
<a name="l00154"></a>00154             $lib=trim($row['libelle']);
<a name="l00155"></a>00155             <span class="keywordflow">if</span>($lib=='') $couleur='red';
<a name="l00156"></a>00156             <span class="keywordflow">else</span> $couleur='gray';
<a name="l00157"></a>00157             echo <a class="code" href="inc-html_8php.html#ee820c089a642b6c9643b4a48fc46395" title="Cree un champ INPUT TEXT dans une ligne TR.">formInputTextTR</a>(<span class="stringliteral">"&lt;font color='$couleur'&gt;[&lt;b&gt;$id&lt;/b&gt;]&lt;/font&gt;"</span>,$table.<span class="stringliteral">"|"</span>.$id,trim($row[$champ]),<span class="stringliteral">"class='fondo' size='$size' maxlength='$maxlength' onfocus='this.select();' "</span>,
<a name="l00158"></a>00158             <span class="stringliteral">"&lt;td&gt;&lt;input class='fondo' type='text' onfocus='this.select();' maxlength='36' size='30' value='$lib' name='set|libelle|$id'/&gt;&lt;/td&gt;"</span>);
<a name="l00159"></a>00159             <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>++;
<a name="l00160"></a>00160          }
<a name="l00161"></a>00161       } elseif ($champ=='ville') {
<a name="l00162"></a>00162          $colspan=<span class="stringliteral">"&gt;&lt;small&gt;Action&lt;/small&gt;&lt;/TD&gt;&lt;TD colspan=1 "</span>;
<a name="l00163"></a>00163          <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT id, ville, id_departement from odb_ref_ville ORDER BY ville"</span>;
<a name="l00164"></a>00164          <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00165"></a>00165          <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>=0;
<a name="l00166"></a>00166          $maxlength=mysql_field_len(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>, 1);
<a name="l00167"></a>00167          $size=min($maxlength,35);
<a name="l00168"></a>00168          <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00169"></a>00169             <span class="keywordflow">if</span>(<a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a> % <a class="code" href="odb__ref_8php.html#b2c21ab7f7609643e58f96f9928cb3eb">LIGNES_TITRE</a> == 0)
<a name="l00170"></a>00170                echo <span class="stringliteral">"&lt;tr&gt;&lt;th&gt;#"</span>.ucwords($champ).<span class="stringliteral">"&lt;/th&gt;&lt;th&gt;"</span>.ucwords($champ).<span class="stringliteral">"&lt;/th&gt;&lt;th&gt;D&amp;eacute;partement&lt;/th&gt;&lt;/tr&gt;\n"</span>;
<a name="l00171"></a>00171             $id=$row[<span class="stringliteral">"id"</span>];
<a name="l00172"></a>00172             $id_ville=trim($row['id_ville']);
<a name="l00173"></a>00173             $id_departement=trim($row['id_departement']);
<a name="l00174"></a>00174             $selectDepartement=<a class="code" href="inc-referentiel_8php.html#c23eab81895f040f0ff6f3ee312a7f63" title="Cree les OPTIONS tirees du referentiel passe en parametre.">formOptionsRefInSelect</a>('departement',$id_departement);
<a name="l00175"></a>00175             $selectDepartement=<span class="stringliteral">"&lt;SELECT class='fondo' NAME='set|id_departement|$id'&gt;$selectDepartement&lt;/SELECT&gt;\n"</span>;
<a name="l00176"></a>00176             <span class="keywordflow">if</span>($id_departement==0) $couleur='red';
<a name="l00177"></a>00177             <span class="keywordflow">else</span> $couleur='gray';
<a name="l00178"></a>00178             echo <a class="code" href="inc-html_8php.html#ee820c089a642b6c9643b4a48fc46395" title="Cree un champ INPUT TEXT dans une ligne TR.">formInputTextTR</a>(<span class="stringliteral">"&lt;font color='$couleur'&gt;[&lt;b&gt;$id&lt;/b&gt;]&lt;/font&gt;"</span>,$table.<span class="stringliteral">"|"</span>.$id,trim($row[$champ]),<span class="stringliteral">"class='fondo' size='$size' maxlength='$maxlength' onfocus='this.select();' "</span>,<span class="stringliteral">"&lt;td&gt;$selectDepartement&lt;/td&gt;"</span>);
<a name="l00179"></a>00179             <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>++;
<a name="l00180"></a>00180          }
<a name="l00181"></a>00181       } elseif ($champ=='ecole') {
<a name="l00182"></a>00182          $colspan=<span class="stringliteral">"&gt;&lt;small&gt;Action&lt;/small&gt;&lt;/TD&gt;&lt;TD colspan=3 "</span>;
<a name="l00183"></a>00183          <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT ecole.id, ecole, commentaire, id_serie, id_matiere1, id_matiere2, id_matiere3, id_matiere4, coeff1, coeff2, coeff3, coeff4, serie\n"</span>.
<a name="l00184"></a>00184          <span class="stringliteral">" from odb_ref_ecole ecole\n"</span>.
<a name="l00185"></a>00185          <span class="stringliteral">" left join odb_ref_serie serie on ecole.id_serie=serie.id\n"</span>.
<a name="l00186"></a>00186          <span class="stringliteral">" ORDER BY ecole, serie"</span>;
<a name="l00187"></a>00187          <span class="comment">//echo $sql;</span>
<a name="l00188"></a>00188          <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00189"></a>00189          <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>=0;
<a name="l00190"></a>00190          $maxlength=mysql_field_len(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>, 1);
<a name="l00191"></a>00191          $size=min($maxlength,35);
<a name="l00192"></a>00192          $trTitre=<span class="stringliteral">"&lt;tr&gt;&lt;th&gt;#"</span>.ucwords($champ).<span class="stringliteral">"&lt;/th&gt;&lt;th&gt;"</span>.ucwords($champ).<span class="stringliteral">"&lt;/th&gt;&lt;th&gt;S&amp;eacute;rie&lt;/th&gt;&lt;th&gt;Mati&amp;egrave;re&lt;/th&gt;&lt;th&gt;Coeff&lt;/th&gt;&lt;/tr&gt;\n"</span>;
<a name="l00193"></a>00193          <span class="comment">//echo $trTitre;</span>
<a name="l00194"></a>00194          <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00195"></a>00195             <span class="keywordflow">foreach</span>(array('<span class="keywordtype">id</span><span class="charliteral">','</span>ecole<span class="charliteral">','</span>commentaire<span class="charliteral">','</span>id_serie<span class="charliteral">','</span>serie<span class="charliteral">','</span>id_matiere1<span class="charliteral">','</span>id_matiere2<span class="charliteral">','</span>id_matiere3<span class="charliteral">','</span>id_matiere4<span class="charliteral">','</span>coeff1<span class="charliteral">','</span>coeff2<span class="charliteral">','</span>coeff3<span class="charliteral">','</span>coeff4') as $col)
<a name="l00196"></a>00196                 $$col=$row[$col];
<a name="l00197"></a>00197             $textCommentaire=<span class="stringliteral">"&lt;TEXTAREA COLS=80 ROWS=2 class='fondo' name='set|commentaire|$id'&gt;$commentaire&lt;/TEXTAREA&gt;\n"</span>;
<a name="l00198"></a>00198             echo <span class="stringliteral">"&lt;tr&gt;&lt;td colspan=7&gt;&lt;hr size=1/&gt;&lt;/td&gt;&lt;/tr&gt;\n"</span>;
<a name="l00199"></a>00199             <span class="keywordflow">if</span>($ecole!=$old_ecole) {
<a name="l00200"></a>00200                 echo <span class="stringliteral">"&lt;tr&gt;&lt;th colspan=2 style='color:#f00;'&gt;$ecole&lt;/th&gt;&lt;td colspan=3&gt;$textCommentaire&lt;/td&gt;&lt;/tr&gt;\n"</span>;
<a name="l00201"></a>00201                 echo $trTitre;
<a name="l00202"></a>00202             }
<a name="l00203"></a>00203             $selectSerie=<span class="stringliteral">"&lt;SELECT class='fondo' NAME='set|id_serie|$id'&gt;"</span>.formOptionsRefInSelect('serie',$id_serie).<span class="stringliteral">"&lt;/SELECT&gt;\n"</span>;
<a name="l00204"></a>00204             $selectMatieres='';
<a name="l00205"></a>00205             $inputCoeffs='';
<a name="l00206"></a>00206             <span class="keywordflow">for</span> (<a class="code" href="odb__commun_2img__pack_2vignettes_2index_8php.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>=1;<a class="code" href="odb__commun_2img__pack_2vignettes_2index_8php.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>&lt;5;<a class="code" href="odb__commun_2img__pack_2vignettes_2index_8php.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>++) {
<a name="l00207"></a>00207                 $inputCoeffs.=<span class="stringliteral">"&lt;INPUT CLASS='fondo' NAME='set|coeff$i|$id' VALUE='"</span>.${<span class="stringliteral">"coeff$i"</span>}.<span class="stringliteral">"' SIZE=2 MAXLENGTH=2/&gt;&lt;br/&gt;\n"</span>;
<a name="l00208"></a>00208                 <span class="keywordflow">if</span>($id_serie==0) 
<a name="l00209"></a>00209                         $selectMatieres.=<span class="stringliteral">"&lt;input size=40 value='Veuillez commencer par choisir la s&amp;eacute;rie' disabled class='fondo'&gt;&lt;br/&gt;\n"</span>;
<a name="l00210"></a>00210                 <span class="keywordflow">else</span> $selectMatieres.=<a class="code" href="inc-referentiel_8php.html#07bef630f993c827650782c7a4588b21" title="cree une liste SELECT a partir des resultats d&amp;#39;une requete SQL">formSelectQuery</a>(<span class="stringliteral">"Mati&amp;egrave;re $i"</span>,<span class="stringliteral">"set|id_matiere$i|$id"</span>,
<a name="l00211"></a>00211                                 <span class="stringliteral">"SELECT DISTINCT id_matiere, matiere\n from odb_ref_examen exa, odb_ref_matiere mat\n"</span>.
<a name="l00212"></a>00212                                 <span class="stringliteral">" WHERE exa.id_serie=$id_serie and exa.id_matiere=mat.id and exa.annee=$annee order by matiere"</span>,
<a name="l00213"></a>00213                                 'matiere', ${<span class="stringliteral">"id_matiere$i"</span>}, <span class="stringliteral">"class='fondo'"</span>, 'id_matiere'
<a name="l00214"></a>00214                         ).<span class="stringliteral">"&lt;br/&gt;\n"</span>;
<a name="l00215"></a>00215             }
<a name="l00216"></a>00216             <span class="keywordflow">if</span>($id_serie==0) $couleur='red';
<a name="l00217"></a>00217             <span class="keywordflow">else</span> $couleur='gray';
<a name="l00218"></a>00218             echo <a class="code" href="inc-html_8php.html#ee820c089a642b6c9643b4a48fc46395" title="Cree un champ INPUT TEXT dans une ligne TR.">formInputTextTR</a>(<span class="stringliteral">"&lt;font color='$couleur'&gt;[&lt;b&gt;$id&lt;/b&gt;]&lt;/font&gt;"</span>,$table.<span class="stringliteral">"|"</span>.$id,trim($row[$champ]),<span class="stringliteral">"class='fondo' size='$size' maxlength='$maxlength' onfocus='this.select();' "</span>,<span class="stringliteral">"&lt;td&gt;$selectSerie&lt;/td&gt;&lt;td&gt;$selectMatieres&lt;/td&gt;&lt;td&gt;$inputCoeffs&lt;/td&gt;"</span>);
<a name="l00219"></a>00219             <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>++;
<a name="l00220"></a>00220             $old_ecole=$ecole;
<a name="l00221"></a>00221          }
<a name="l00222"></a>00222       } elseif ($champ=='operateur') {
<a name="l00223"></a>00223          $colspan=<span class="stringliteral">"&gt;&lt;small&gt;Action&lt;/small&gt;&lt;/TD&gt;&lt;TD colspan=3 "</span>;
<a name="l00224"></a>00224          <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a> = 'SELECT ope . id , operateur , mot_passe, id_deliberation , del . deliberation , jury1 , jury2 , jury3 , jury4 '
<a name="l00225"></a>00225         . ' from odb_ref_operateur ope '
<a name="l00226"></a>00226         . ' left join odb_ref_deliberation del on ( ope . id_deliberation = del . <span class="keywordtype">id</span> ) '
<a name="l00227"></a>00227         . <span class="stringliteral">" where ope.annee=$annee"</span>
<a name="l00228"></a>00228         . ' ORDER BY deliberation , operateur';
<a name="l00229"></a>00229          <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00230"></a>00230          <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>=0;
<a name="l00231"></a>00231          <span class="comment">//echo $sql;</span>
<a name="l00232"></a>00232          $maxlength=mysql_field_len(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>, 1);
<a name="l00233"></a>00233          $maxlengthMotPasse=mysql_field_len(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>,2);
<a name="l00234"></a>00234          $size=min($maxlength,35);
<a name="l00235"></a>00235          <a class="code" href="inc-pdf-attestations_8php.html#6a5a233adfaad0185a2b89ba6c4f3ae3">$colonnes</a>=array('<span class="keywordtype">id</span><span class="charliteral">','</span>operateur<span class="charliteral">','</span>id_deliberation<span class="charliteral">','</span>mot_passe<span class="charliteral">','</span>deliberation<span class="charliteral">','</span>jury1<span class="charliteral">','</span>jury2<span class="charliteral">','</span>jury3<span class="charliteral">','</span>jury4');
<a name="l00236"></a>00236          $nb_jury=mysql_num_rows(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>);
<a name="l00237"></a>00237          <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00238"></a>00238             <span class="keywordflow">foreach</span>(<a class="code" href="inc-pdf-attestations_8php.html#6a5a233adfaad0185a2b89ba6c4f3ae3">$colonnes</a> as $col)
<a name="l00239"></a>00239             $$col=trim($row[$col]);
<a name="l00240"></a>00240             <span class="keywordflow">if</span>(<a class="code" href="inc-pdf-attestations_8php.html#dd57477ad14361f5834629e405ff5478">$deliberation</a>!=$oldDeliberation)
<a name="l00241"></a>00241             echo <span class="stringliteral">"&lt;tr&gt;&lt;th&gt;#"</span>.ucwords($champ).<span class="stringliteral">"&lt;/th&gt;&lt;th&gt;Op&amp;eacute;rateur&lt;br/&gt;($deliberation)&lt;/th&gt;&lt;th&gt;Mot de&lt;br/&gt;passe&lt;/th&gt;&lt;th&gt;Centre de&lt;br/&gt;d&amp;eacute;lib&amp;eacute;ration&lt;/th&gt;&lt;th&gt;Jury 1&lt;/th&gt;&lt;th&gt;Jury 2&lt;/th&gt;&lt;th&gt;Jury 3&lt;/th&gt;&lt;th&gt;Jury 4&lt;/th&gt;&lt;/tr&gt;\n"</span>;
<a name="l00242"></a>00242             $selectDeliberation=<a class="code" href="inc-referentiel_8php.html#c23eab81895f040f0ff6f3ee312a7f63" title="Cree les OPTIONS tirees du referentiel passe en parametre.">formOptionsRefInSelect</a>('deliberation',$id_deliberation);
<a name="l00243"></a>00243             <span class="keywordflow">if</span>($id_deliberation&gt;0) {
<a name="l00244"></a>00244                                 <span class="comment">// lorsqu'un centre de deliberation est defini,</span>
<a name="l00245"></a>00245                                 <span class="comment">// on ne propose que les jurys qui ne sont pas d'un autre centre de deliberation</span>
<a name="l00246"></a>00246                                 <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a> = 'SELECT DISTINCT jury FROM odb_repartition rep '
<a name="l00247"></a>00247                                         . <span class="stringliteral">" WHERE annee=$annee AND jury &gt;= IFNULL( "</span>
<a name="l00248"></a>00248                                         . <span class="stringliteral">" (SELECT min( jury1 ) FROM odb_ref_operateur WHERE annee=$annee AND id_deliberation = $id_deliberation and jury1 is not null )"</span>
<a name="l00249"></a>00249                                         . ' ,0) '
<a name="l00250"></a>00250                                         . ' ORDER BY jury';
<a name="l00251"></a>00251             } <span class="keywordflow">else</span>
<a name="l00252"></a>00252                 <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT distinct jury from odb_repartition where annee=$annee order by jury"</span>;
<a name="l00253"></a>00253             <span class="comment">//echo "&lt;br/&gt;$sql";</span>
<a name="l00254"></a>00254             <span class="keywordflow">for</span> (<a class="code" href="odb__commun_2img__pack_2vignettes_2index_8php.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>=1;<a class="code" href="odb__commun_2img__pack_2vignettes_2index_8php.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>&lt;=4;<a class="code" href="odb__commun_2img__pack_2vignettes_2index_8php.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>++) {
<a name="l00255"></a>00255                 ${<span class="stringliteral">"selectJury$i"</span>}=<a class="code" href="inc-referentiel_8php.html#07bef630f993c827650782c7a4588b21" title="cree une liste SELECT a partir des resultats d&amp;#39;une requete SQL">formSelectQuery</a>(<span class="stringliteral">"Jury $i"</span>, <span class="stringliteral">"set|jury$i|$id"</span>, <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>, 'jury', ${<span class="stringliteral">"jury$i"</span>});
<a name="l00256"></a>00256             }
<a name="l00257"></a>00257             $selectDeliberation=<span class="stringliteral">"&lt;SELECT class='fondo' NAME='set|id_deliberation|$id'&gt;$selectDeliberation&lt;/SELECT&gt;\n"</span>;
<a name="l00258"></a>00258             $inputMotPasse=<span class="stringliteral">"&lt;INPUT NAME='set|mot_passe|$id' value='$mot_passe' size=$maxlengthMotPasse maxlength=$maxlengthMotPasse onClick=\"if(this.value=='') alert('Veuillez noter que SIOU generera automatiquement\\nun mot de passe a la creation des auteurs SPIP\\n\\n(Voir lien ci-dessous)');\"/&gt;\n"</span>;
<a name="l00259"></a>00259             <span class="keywordflow">if</span>((<span class="keywordtype">int</span>)$id_deliberation==0) $couleur='red';
<a name="l00260"></a>00260             <span class="keywordflow">else</span> $couleur='gray';
<a name="l00261"></a>00261             echo <a class="code" href="inc-html_8php.html#ee820c089a642b6c9643b4a48fc46395" title="Cree un champ INPUT TEXT dans une ligne TR.">formInputTextTR</a>(<span class="stringliteral">"&lt;font color='$couleur'&gt;[&lt;b&gt;$id&lt;/b&gt;]&lt;/font&gt;"</span>,$table.<span class="stringliteral">"|"</span>.$id,$operateur,<span class="stringliteral">"class='fondo' size='$size' maxlength='$maxlength' onfocus='this.select();' "</span>
<a name="l00262"></a>00262             ,<span class="stringliteral">"&lt;td&gt;$inputMotPasse&lt;/td&gt;&lt;td&gt;$selectDeliberation&lt;/td&gt;&lt;td&gt;$selectJury1&lt;/td&gt;&lt;td&gt;$selectJury2&lt;/td&gt;&lt;td&gt;$selectJury3&lt;/td&gt;&lt;td&gt;$selectJury4&lt;/td&gt;"</span>);
<a name="l00263"></a>00263             <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>++;
<a name="l00264"></a>00264             $oldDeliberation=<a class="code" href="inc-pdf-attestations_8php.html#dd57477ad14361f5834629e405ff5478">$deliberation</a>;
<a name="l00265"></a>00265          }
<a name="l00266"></a>00266          $tmpStr=<span class="stringliteral">"Cr&amp;eacute;er les auteurs SPIP correspondants aux op&amp;eacute;rateurs $annee ci-dessus"</span>;
<a name="l00267"></a>00267          $imgCreerAuteurs='&lt;img src=<span class="stringliteral">"'._DIR_PLUGIN_ODB_REF.'img_pack/auteurs.png"</span> alt=<span class="stringliteral">"'.$tmpStr.'"</span> align=<span class="stringliteral">"absmiddle"</span>/&gt;';
<a name="l00268"></a>00268          echo <span class="stringliteral">"&lt;tr&gt;&lt;td colspan=8 align='center'&gt;&lt;center&gt;"</span>
<a name="l00269"></a>00269                         . <span class="stringliteral">"&lt;A HREF='"</span>.generer_url_ecrire('odb_ref').<span class="stringliteral">"&amp;actionSession=creer_operateurs' onClick=\"return confirm('Cette action va supprimer les auteurs actuels et generer un nouveau mot de passe pour les operateurs ayant un mot de passe vide\\n\\nEtes-vous sur(e) de vouloir continuer ?')\"&gt;$imgCreerAuteurs &lt;b&gt;$tmpStr&lt;/b&gt;&lt;/A&gt;"</span>
<a name="l00270"></a>00270                         . <span class="stringliteral">"&lt;/center&gt;&lt;/td&gt;&lt;/tr&gt;\n"</span>
<a name="l00271"></a>00271                         ;
<a name="l00272"></a>00272                         <span class="comment">//generation des 'alea_actuel' et 'alea_futur' pour les mots de passe ($pass = md5($alea_actuel.$new_pass); : editer_auteur[162])</span>
<a name="l00273"></a>00273                         <span class="keywordflow">for</span> (<a class="code" href="odb__commun_2img__pack_2vignettes_2index_8php.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>=0;<a class="code" href="odb__commun_2img__pack_2vignettes_2index_8php.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>&lt;$nb_jury;<a class="code" href="odb__commun_2img__pack_2vignettes_2index_8php.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>++) {
<a name="l00274"></a>00274                                 $tAlea[<a class="code" href="odb__commun_2img__pack_2vignettes_2index_8php.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>]['actuel']=creer_uniqid();
<a name="l00275"></a>00275                                 $tAlea[<a class="code" href="odb__commun_2img__pack_2vignettes_2index_8php.html#83018d9153d17d91fbcf3bc10158d34f">$i</a>]['futur']=creer_uniqid();
<a name="l00276"></a>00276                         }
<a name="l00277"></a>00277                         $tAlphabet=range(<span class="charliteral">'a'</span>,<span class="charliteral">'z'</span>);
<a name="l00278"></a>00278                         $tVoyelles=array(<span class="charliteral">'a'</span>,<span class="charliteral">'e'</span>,<span class="charliteral">'i'</span>,<span class="charliteral">'o'</span>,<span class="charliteral">'u'</span>,<span class="charliteral">'y'</span>);
<a name="l00279"></a>00279                         $tConsonnes=array_diff($tAlphabet,$tVoyelles);
<a name="l00280"></a>00280                         unset(<a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['creer_operateurs']);
<a name="l00281"></a>00281                         <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['creer_operateurs']['sql'][]='DELETE FROM spip_auteurs WHERE bio = \''.ODB_BIO_OPERATEUR.<span class="charliteral">'\''</span>;
<a name="l00282"></a>00282                         $sqlPass=<span class="stringliteral">"UPDATE odb_ref_operateur SET mot_passe=concat(ELT(1+floor(RAND()*"</span>.(count($tConsonnes)-1).<span class="stringliteral">"),'"</span>.implode(<span class="stringliteral">"','"</span>,$tConsonnes).<span class="stringliteral">"'),ELT(1+floor(RAND()*"</span>.(count($tVoyelles)-1).<span class="stringliteral">"),'"</span>.implode(<span class="stringliteral">"','"</span>,$tVoyelles).<span class="stringliteral">"'),ELT(1+floor(RAND()*"</span>.(count($tConsonnes)-1).<span class="stringliteral">"),'"</span>.implode(<span class="stringliteral">"','"</span>,$tConsonnes).<span class="stringliteral">"'),ELT(1+floor(RAND()*"</span>.(count($tVoyelles)-1).<span class="stringliteral">"),'"</span>.implode(<span class="stringliteral">"','"</span>,$tVoyelles).<span class="stringliteral">"')) WHERE mot_passe=''"</span>;
<a name="l00283"></a>00283                         <span class="comment">//echo $sqlPass;</span>
<a name="l00284"></a>00284                         <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['creer_operateurs']['sql'][]=$sqlPass;
<a name="l00285"></a>00285                         <span class="keywordflow">foreach</span> (array(<span class="charliteral">'a'</span>,<span class="charliteral">'b'</span>) as $ope) {
<a name="l00286"></a>00286                                 <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['creer_operateurs']['sql'][]='INSERT INTO spip_auteurs(id_auteur, nom, statut, bio, nom_site, email, maj, login, pass, alea_actuel, alea_futur, source, lang, idx ) ('
<a name="l00287"></a>00287                 . ' select ope.id + (select max(id_auteur) from spip_auteurs), '
<a name="l00288"></a>00288                 . ' CONCAT(operateur,\<span class="charliteral">' '</span>.strtoupper($ope).<span class="charliteral">'\'</span>), \'1comite\' statut, \'Operateur de saisie\' bio, concat( deliberation, \' - centre \', id_deliberation ) deliberation, '
<a name="l00289"></a>00289                 . ' concat(\'notes@\', ifnull( jury1, \<span class="charliteral">'\'</span> ) , \'|\', ifnull( jury2, \<span class="charliteral">'\'</span> ) , \'|\', ifnull( jury3, \<span class="charliteral">'\'</span> ) , \'|\', ifnull( jury4, \<span class="charliteral">'\'</span> ) ) jurys, '
<a name="l00290"></a>00290                 . ' now( ) , CONCAT(LCASE(operateur),\''.$ope.<span class="charliteral">'\'</span>) login, md5(mot_passe) pass, \<span class="charliteral">'\'</span> alea_actuel, \<span class="charliteral">'\'</span>alea_futur, \'siou\' source, \'fr\' lang, \'oui\' idx '
<a name="l00291"></a>00291                 . ' FROM odb_ref_operateur ope, odb_ref_deliberation delib '
<a name="l00292"></a>00292                 . <span class="stringliteral">" WHERE delib.id = ope.id_deliberation and ope.annee=$annee ORDER BY operateur)"</span>;
<a name="l00293"></a>00293                         }
<a name="l00294"></a>00294                         <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['creer_operateurs']['msgSql'][]='anciens auteurs SPIP op&amp;eacute;rateurs de saisie supprim&amp;eacute;s avec succ&amp;egrave;s';
<a name="l00295"></a>00295                         <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['creer_operateurs']['msgSql'][]='mots de passe des op&amp;eacute;rateurs g&amp;eacute;n&amp;eacute;r&amp;eacute;s avec succ&amp;egrave;s';
<a name="l00296"></a>00296                         <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['creer_operateurs']['msgSql'][]='&lt;b&gt;auteurs SPIP [A] cr&amp;eacute;&amp;eacute;s avec succ&amp;egrave;s&lt;/b&gt;';
<a name="l00297"></a>00297                         <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['creer_operateurs']['msgSql'][]='&lt;b&gt;auteurs SPIP [B] cr&amp;eacute;&amp;eacute;s avec succ&amp;egrave;s&lt;/b&gt;';
<a name="l00298"></a>00298                         <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['creer_operateurs']['retour']['msg']='Retour au r&amp;eacute;f&amp;eacute;rentiel &lt;b&gt;[Op&amp;eacute;rateur]&lt;/b&gt;';
<a name="l00299"></a>00299                         <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['creer_operateurs']['retour']['url']=generer_url_ecrire('odb_ref').'&amp;table=odb_ref_operateur&amp;step2=manuel';
<a name="l00300"></a>00300                         <span class="comment">//$pass = md5($alea_actuel.$new_pass);</span>
<a name="l00301"></a>00301       } elseif ($champ=='salle') {
<a name="l00302"></a>00302          $colspan=<span class="stringliteral">"&gt;&lt;small&gt;Action&lt;/small&gt;&lt;/TD&gt;&lt;TD colspan=1 "</span>;
<a name="l00303"></a>00303          <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT salle.id, salle.annee, salle, id_etablissement, nb_salles, capacite, departement, eta.id_departement\n"</span>
<a name="l00304"></a>00304                 . <span class="stringliteral">" FROM odb_ref_salle salle, odb_ref_etablissement eta, odb_ref_departement dept\n"</span>
<a name="l00305"></a>00305                 . <span class="stringliteral">" WHERE salle.id_etablissement = eta.id\n"</span>
<a name="l00306"></a>00306                 . <span class="stringliteral">" AND eta.id_departement = dept.id AND annee=$annee\n"</span>
<a name="l00307"></a>00307                 . <span class="stringliteral">" ORDER BY departement, id_etablissement, salle"</span>
<a name="l00308"></a>00308                 ;
<a name="l00309"></a>00309          <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00310"></a>00310          <span class="keywordflow">if</span>(mysql_num_rows(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)==0) {
<a name="l00311"></a>00311                 echo <span class="stringliteral">"&lt;tr&gt;&lt;td&gt;"</span>
<a name="l00312"></a>00312                         . <span class="stringliteral">"Aucun r&amp;eacute;sultat en $annee&lt;br/&gt;"</span>
<a name="l00313"></a>00313                         . <span class="stringliteral">"&lt;A HREF='"</span>.generer_url_ecrire('odb_ref').<span class="stringliteral">"&amp;actionSession=majCapaciteSalles&amp;annee=$annee'&gt;R&amp;eacute;cup&amp;eacute;rer les capacit&amp;eacute;s de salles "</span>.(<a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>-1).<span class="stringliteral">"&lt;/A&gt;"</span>
<a name="l00314"></a>00314                         . <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;"</span>
<a name="l00315"></a>00315                         ;
<a name="l00316"></a>00316                 echo <span class="stringliteral">"&lt;/table&gt;\n"</span>;
<a name="l00317"></a>00317                 unset(<a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['majCapaciteSalles']);
<a name="l00318"></a>00318                                 <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['majCapaciteSalles']['msgSql'][]=<span class="stringliteral">"Capacit&amp;eacute; d'accueil $annee mise &amp;agrave; jour avec succ&amp;egrave;s"</span>;
<a name="l00319"></a>00319                 <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['majCapaciteSalles']['sql']['']=<span class="stringliteral">"INSERT INTO odb_ref_salle(id, annee, salle, id_etablissement, nb_salles, capacite)\n (SELECT id, $annee,salle,id_etablissement,nb_salles,capacite\n\t FROM odb_ref_salle WHERE annee="</span>.($annee-1).<span class="charliteral">')'</span>;
<a name="l00320"></a>00320                                 <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['majCapaciteSalles']['retour']['msg']='Retour au r&amp;eacute;f&amp;eacute;rentiel &lt;b&gt;[Salles]&lt;/b&gt;';
<a name="l00321"></a>00321                                 <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['majCapaciteSalles']['retour']['url']=generer_url_ecrire('odb_ref').'&amp;table=odb_ref_salle&amp;step2=manuel';
<a name="l00322"></a>00322                 exit;
<a name="l00323"></a>00323                         }
<a name="l00324"></a>00324          <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>=0;
<a name="l00325"></a>00325          $maxlength=mysql_field_len(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>, 1);
<a name="l00326"></a>00326          $size=min($maxlength,35);
<a name="l00327"></a>00327          <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00328"></a>00328             $departement=$row['departement'];
<a name="l00329"></a>00329             <span class="keywordflow">if</span>($departement!=$oldDepartement)
<a name="l00330"></a>00330                echo <span class="stringliteral">"&lt;tr&gt;&lt;th&gt;$departement&lt;/th&gt;&lt;th&gt;Nom salle&lt;/th&gt;&lt;th&gt;Centre de composition&lt;/th&gt;&lt;th&gt;Nb salles&lt;/th&gt;&lt;th&gt;Capacit&amp;eacute;&lt;/th&gt;&lt;/tr&gt;\n"</span>;
<a name="l00331"></a>00331             $id=$row['<span class="keywordtype">id</span>'];
<a name="l00332"></a>00332             <a class="code" href="inc-pdf-convocation_8php.html#9173474babbbe880fc1f648e171d03d0">$id_etablissement</a>=trim($row['id_etablissement']);
<a name="l00333"></a>00333             $id_departement=$row['id_departement'];
<a name="l00334"></a>00334             $selectCentre=<a class="code" href="inc-referentiel_8php.html#c23eab81895f040f0ff6f3ee312a7f63" title="Cree les OPTIONS tirees du referentiel passe en parametre.">formOptionsRefInSelect</a>('centre',<a class="code" href="inc-pdf-convocation_8php.html#9173474babbbe880fc1f648e171d03d0">$id_etablissement</a>,'Centre',$id_departement);
<a name="l00335"></a>00335             $selectCentre=<span class="stringliteral">"&lt;SELECT class='fondo' NAME='set|id_etablissement|$id'&gt;$selectCentre&lt;/SELECT&gt;\n"</span>;
<a name="l00336"></a>00336             $nb_salles=$row['nb_salles'];
<a name="l00337"></a>00337             $inputNbSalles=<span class="stringliteral">"&lt;INPUT type=text size=3 maxlength=3 name='set|nb_salles|$id' VALUE='$nb_salles'/&gt;"</span>;
<a name="l00338"></a>00338             $capacite=$row['capacite'];
<a name="l00339"></a>00339             $tab_capacite=array(0,20,25,30,35,40,45,50);
<a name="l00340"></a>00340             $selectCapacite=array();
<a name="l00341"></a>00341             <span class="keywordflow">foreach</span>($tab_capacite as $cap)
<a name="l00342"></a>00342                $selectCapacite.=<a class="code" href="inc-html_8php.html#7be54cdf2beda343e02419f1ac46fa0c" title="Cree un champ OPTION dans un SELECT.">formOptionsInSelect</a>(<span class="stringliteral">"$cap places"</span>,$cap,$capacite);
<a name="l00343"></a>00343             $selectCapacite=<span class="stringliteral">"&lt;SELECT class='fondo' NAME='set|capacite|$id'&gt;\n$selectCapacite&lt;/SELECT&gt;\n"</span>;
<a name="l00344"></a>00344             <span class="keywordflow">if</span>(<a class="code" href="inc-pdf-convocation_8php.html#9173474babbbe880fc1f648e171d03d0">$id_etablissement</a>==0 || $nb_salles==0 || $capacite==0) $couleur='red';
<a name="l00345"></a>00345             <span class="keywordflow">else</span> $couleur='gray';
<a name="l00346"></a>00346             echo <a class="code" href="inc-html_8php.html#ee820c089a642b6c9643b4a48fc46395" title="Cree un champ INPUT TEXT dans une ligne TR.">formInputTextTR</a>(
<a name="l00347"></a>00347                <span class="stringliteral">"&lt;font color='$couleur'&gt;[&lt;b&gt;$id&lt;/b&gt;]&lt;/font&gt;"</span>,$table.<span class="stringliteral">"|"</span>.$id,trim($row[$champ]),
<a name="l00348"></a>00348                <span class="stringliteral">"class='fondo' size='$size' maxlength='$maxlength' onfocus='this.select();' "</span>,
<a name="l00349"></a>00349                <span class="stringliteral">"&lt;td&gt;$selectCentre&lt;/td&gt;&lt;td&gt;$inputNbSalles&lt;/td&gt;&lt;td&gt;$selectCapacite&lt;/td&gt;"</span>
<a name="l00350"></a>00350              );
<a name="l00351"></a>00351             <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>++;
<a name="l00352"></a>00352             $oldDepartement=$departement;
<a name="l00353"></a>00353          }
<a name="l00354"></a>00354          <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT id, `salle` , `id_etablissement` , `nb_salles` , `capacite` FROM `odb_ref_salle` WHERE id_etablissement=0"</span>;
<a name="l00355"></a>00355          <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00356"></a>00356          <span class="keywordflow">if</span>(mysql_num_rows(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)&gt;0) {
<a name="l00357"></a>00357             echo <span class="stringliteral">"&lt;tr&gt;&lt;th&gt;&amp;Agrave; d&amp;eacute;finir&lt;/th&gt;&lt;th&gt;Nom salle&lt;/th&gt;&lt;th&gt;Centre de composition&lt;/th&gt;&lt;th&gt;Nb salles&lt;/th&gt;&lt;th&gt;Capacit&amp;eacute;&lt;/th&gt;&lt;/tr&gt;\n"</span>;
<a name="l00358"></a>00358             <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00359"></a>00359             $id=$row['<span class="keywordtype">id</span>'];
<a name="l00360"></a>00360             <a class="code" href="inc-pdf-convocation_8php.html#9173474babbbe880fc1f648e171d03d0">$id_etablissement</a>=trim($row['id_etablissement']);
<a name="l00361"></a>00361             $selectCentre=<a class="code" href="inc-referentiel_8php.html#c23eab81895f040f0ff6f3ee312a7f63" title="Cree les OPTIONS tirees du referentiel passe en parametre.">formOptionsRefInSelect</a>('centres',<a class="code" href="inc-pdf-convocation_8php.html#9173474babbbe880fc1f648e171d03d0">$id_etablissement</a>,'Centre',$id_departement);
<a name="l00362"></a>00362             $selectCentre=<span class="stringliteral">"&lt;SELECT class='fondo' NAME='set|id_etablissement|$id'&gt;$selectCentre&lt;/SELECT&gt;\n"</span>;
<a name="l00363"></a>00363             $nb_salles=$row['nb_salles'];
<a name="l00364"></a>00364             $inputNbSalles=<span class="stringliteral">"&lt;INPUT type=text size=3 maxlength=3 name='set|nb_salles|$id' VALUE='$nb_salles'/&gt;"</span>;
<a name="l00365"></a>00365             $capacite=$row['capacite'];
<a name="l00366"></a>00366             $tab_capacite=array(0,20,25,30,35,40,45,50);
<a name="l00367"></a>00367             $selectCapacite=array();
<a name="l00368"></a>00368             <span class="keywordflow">foreach</span>($tab_capacite as $cap)
<a name="l00369"></a>00369                $selectCapacite.=<a class="code" href="inc-html_8php.html#7be54cdf2beda343e02419f1ac46fa0c" title="Cree un champ OPTION dans un SELECT.">formOptionsInSelect</a>(<span class="stringliteral">"$cap places"</span>,$cap,$capacite);
<a name="l00370"></a>00370             $selectCapacite=<span class="stringliteral">"&lt;SELECT class='fondo' NAME='set|capacite|$id'&gt;\n$selectCapacite&lt;/SELECT&gt;\n"</span>;
<a name="l00371"></a>00371             echo <a class="code" href="inc-html_8php.html#ee820c089a642b6c9643b4a48fc46395" title="Cree un champ INPUT TEXT dans une ligne TR.">formInputTextTR</a>(
<a name="l00372"></a>00372                <span class="stringliteral">"&lt;font color='red'&gt;[&lt;b&gt;$id&lt;/b&gt;]&lt;/font&gt;"</span>,$table.<span class="stringliteral">"|"</span>.$id,trim($row[$champ]),
<a name="l00373"></a>00373                <span class="stringliteral">"class='fondo' size='$size' maxlength='$maxlength' onfocus='this.select();' "</span>,
<a name="l00374"></a>00374                <span class="stringliteral">"&lt;td&gt;$selectCentre&lt;/td&gt;&lt;td&gt;$inputNbSalles&lt;/td&gt;&lt;td&gt;$selectCapacite&lt;/td&gt;"</span>
<a name="l00375"></a>00375              );
<a name="l00376"></a>00376             }
<a name="l00377"></a>00377          }
<a name="l00378"></a>00378       } elseif ($champ=='examen') {
<a name="l00379"></a>00379          $colspan=<span class="stringliteral">"&gt;&lt;small&gt;Action&lt;/small&gt;&lt;/TD&gt;&lt;TD colspan=2 "</span>;
<a name="l00380"></a>00380          <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT id, examen, type, id_serie, id_matiere, duree, coeff\n from odb_ref_$champ\n WHERE annee=$annee\n ORDER BY id_serie, examen"</span>;
<a name="l00381"></a>00381          <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00382"></a>00382          <span class="keywordflow">if</span>(mysql_num_rows(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)==0) {
<a name="l00383"></a>00383                 echo <span class="stringliteral">"&lt;tr&gt;&lt;td&gt;"</span>
<a name="l00384"></a>00384                         . <span class="stringliteral">"Aucun examen enregistr&amp;eacute; en $annee&lt;br/&gt;"</span>
<a name="l00385"></a>00385                         . <span class="stringliteral">"&lt;A HREF='"</span>.generer_url_ecrire('odb_ref').<span class="stringliteral">"&amp;actionSession=majExamen&amp;annee=$annee'&gt;R&amp;eacute;cup&amp;eacute;rer le calendrier des &amp;eacute;preuves "</span>.(<a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>-1).<span class="stringliteral">"&lt;/A&gt;"</span>
<a name="l00386"></a>00386                         . <span class="stringliteral">"&lt;/td&gt;&lt;/tr&gt;"</span>
<a name="l00387"></a>00387                         ;
<a name="l00388"></a>00388                 echo <span class="stringliteral">"&lt;/table&gt;\n"</span>;
<a name="l00389"></a>00389                 unset(<a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['majExamen']);
<a name="l00390"></a>00390                                 <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['majExamen']['msgSql'][]=<span class="stringliteral">"Calendrier &lt;b&gt;$annee&lt;/b&gt; mis &amp;agrave; jour avec succ&amp;egrave;s"</span>;
<a name="l00391"></a>00391                 <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['majExamen']['sql']['']=<span class="stringliteral">"INSERT INTO odb_ref_examen(id, annee, id_serie, id_matiere, examen, type, duree, coeff)\n (SELECT id, $annee, id_serie, id_matiere, adddate(examen,interval 1 year), type, duree, coeff\n\t FROM odb_ref_examen\n WHERE annee="</span>.($annee-1).<span class="charliteral">')'</span>;
<a name="l00392"></a>00392                                 <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['majExamen']['retour']['msg']='Retour au r&amp;eacute;f&amp;eacute;rentiel &lt;b&gt;[Examen]&lt;/b&gt;';
<a name="l00393"></a>00393                                 <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['majExamen']['retour']['url']=generer_url_ecrire('odb_ref').'&amp;table=odb_ref_examen&amp;step2=manuel';
<a name="l00394"></a>00394                 exit;
<a name="l00395"></a>00395                         }
<a name="l00396"></a>00396          <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>=0;
<a name="l00397"></a>00397          $maxlength=mysql_field_len(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>, 1);
<a name="l00398"></a>00398          $size=min($maxlength,35);
<a name="l00399"></a>00399          <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00400"></a>00400             <span class="keywordflow">if</span>(<a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a> % <a class="code" href="odb__ref_8php.html#b2c21ab7f7609643e58f96f9928cb3eb">LIGNES_TITRE</a> == 0)
<a name="l00401"></a>00401                echo <span class="stringliteral">"&lt;tr&gt;&lt;th&gt;#Exm&lt;/th&gt;&lt;th&gt;Date/Heure&lt;/th&gt;&lt;th&gt;S&amp;eacute;rie&lt;/th&gt;&lt;th&gt;Mati&amp;egrave;re&lt;/th&gt;&lt;th&gt;Type&lt;/th&gt;&lt;th&gt;Dur&amp;eacute;e&lt;/th&gt;&lt;th&gt;Coeff.&lt;/th&gt;&lt;/tr&gt;\n"</span>;
<a name="l00402"></a>00402             <span class="keywordflow">foreach</span>(array('<span class="keywordtype">id</span><span class="charliteral">','</span>examen<span class="charliteral">','</span>type<span class="charliteral">','</span>id_serie<span class="charliteral">','</span>id_matiere<span class="charliteral">','</span>duree<span class="charliteral">','</span>coeff') as $col)
<a name="l00403"></a>00403                $$col=$row[$col];
<a name="l00404"></a>00404             <span class="comment">//echo "examen $examen&lt;br&gt;";</span>
<a name="l00405"></a>00405             $selectSerie=<a class="code" href="inc-referentiel_8php.html#c23eab81895f040f0ff6f3ee312a7f63" title="Cree les OPTIONS tirees du referentiel passe en parametre.">formOptionsRefInSelect</a>('serie',$id_serie);
<a name="l00406"></a>00406             $selectSerie=<span class="stringliteral">"&lt;SELECT NAME='set|id_serie|$id' class='fondo'&gt;$selectSerie&lt;/SELECT&gt;\n"</span>;
<a name="l00407"></a>00407             $selectMatiere=<a class="code" href="inc-referentiel_8php.html#c23eab81895f040f0ff6f3ee312a7f63" title="Cree les OPTIONS tirees du referentiel passe en parametre.">formOptionsRefInSelect</a>('matiere',$id_matiere);
<a name="l00408"></a>00408             $selectMatiere=<span class="stringliteral">"&lt;SELECT NAME='set|id_matiere|$id' class='fondo'&gt;$selectMatiere&lt;/SELECT&gt;\n"</span>;
<a name="l00409"></a>00409             $selectType='';
<a name="l00410"></a>00410             <span class="keywordflow">foreach</span>(array('Pratique<span class="charliteral">','</span>Ecrit<span class="charliteral">','</span>Oral<span class="charliteral">','</span>Divers') as $tmpType) {
<a name="l00411"></a>00411                 $selected=$type==$tmpType?'selected<span class="charliteral">':'</span>';
<a name="l00412"></a>00412                 $selectType.=<span class="stringliteral">"&lt;OPTION $selected value='$tmpType'&gt;$tmpType&lt;/OPTION&gt;\n"</span>;
<a name="l00413"></a>00413                                 }
<a name="l00414"></a>00414             $selectType=<span class="stringliteral">"&lt;SELECT NAME='set|type|$id' class='fondo'&gt;$selectType&lt;/SELECT&gt;\n"</span>;
<a name="l00415"></a>00415             <span class="keywordflow">if</span>($examen=='0000-00-00 00:00:00' || $examen=='') {
<a name="l00416"></a>00416                $isBadDate=<span class="keyword">true</span>;
<a name="l00417"></a>00417                $examen=<a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>.'-06-00 00:00:00';
<a name="l00418"></a>00418             } <span class="keywordflow">else</span> {
<a name="l00419"></a>00419                $isBadDate=<span class="keyword">false</span>;
<a name="l00420"></a>00420             }
<a name="l00421"></a>00421             $inputDuree=<span class="stringliteral">"&lt;input name='set|duree|$id' value='$duree' size=1 maxlength=3 class='fondo'/&gt;h"</span>;
<a name="l00422"></a>00422             $inputCoeff=<span class="stringliteral">"&lt;input name='set|coeff|$id' value='$coeff' size=1 maxlength=2 class='fondo'/&gt;"</span>;
<a name="l00423"></a>00423             <span class="keywordflow">if</span>($id_serie==0 || $id_matiere==0 || ($duree==<span class="charliteral">'0'</span> &amp;&amp; !$isBadDate)) $couleur='red';
<a name="l00424"></a>00424             elseif($isBadDate) $couleur='orange';
<a name="l00425"></a>00425             <span class="keywordflow">else</span> $couleur='gray';
<a name="l00426"></a>00426             echo <a class="code" href="inc-html_8php.html#ee820c089a642b6c9643b4a48fc46395" title="Cree un champ INPUT TEXT dans une ligne TR.">formInputTextTR</a>(
<a name="l00427"></a>00427                <span class="stringliteral">"&lt;font color='$couleur'&gt;[&lt;b&gt;$id&lt;/b&gt;]&lt;/font&gt;"</span>,$table.<span class="stringliteral">"|"</span>.$id,trim($$champ),
<a name="l00428"></a>00428                <span class="stringliteral">"class='fondo' size='$size' maxlength='$maxlength' onfocus='this.select();' "</span>,
<a name="l00429"></a>00429                <span class="stringliteral">"&lt;td&gt;$selectSerie&lt;/td&gt;&lt;td&gt;$selectMatiere&lt;/td&gt;&lt;td&gt;$selectType&lt;/td&gt;&lt;td&gt;$inputDuree&lt;/td&gt;&lt;td&gt;$inputCoeff&lt;/td&gt;"</span>.
<a name="l00430"></a>00430                         <span class="stringliteral">"&lt;input type='hidden' name='set|annee|$id' value='$annee'/&gt;"</span>
<a name="l00431"></a>00431              );
<a name="l00432"></a>00432             <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>++;
<a name="l00433"></a>00433          }
<a name="l00434"></a>00434       } <span class="keywordflow">else</span> {
<a name="l00435"></a>00435          <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT id, $champ from $table ORDER BY $champ"</span>;
<a name="l00436"></a>00436          <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00437"></a>00437          <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>=0;
<a name="l00438"></a>00438          $maxlength=mysql_field_len(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>, 1);
<a name="l00439"></a>00439          $size=min($maxlength,<a class="code" href="odb__ref_8php.html#cca20e7f1e7c70089180dc3c39e8d977">INPUT_MAX_SIZE</a>);
<a name="l00440"></a>00440          <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00441"></a>00441             <span class="keywordflow">if</span>(<a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a> % <a class="code" href="odb__ref_8php.html#b2c21ab7f7609643e58f96f9928cb3eb">LIGNES_TITRE</a> == 0)
<a name="l00442"></a>00442                echo <span class="stringliteral">"&lt;tr&gt;&lt;th&gt;#"</span>.ucwords($champ).<span class="stringliteral">"&lt;/th&gt;&lt;th&gt;$libelle&lt;/th&gt;&lt;/th&gt;&lt;/tr&gt;\n"</span>;
<a name="l00443"></a>00443             $id=$row[<span class="stringliteral">"id"</span>];
<a name="l00444"></a>00444             <span class="keywordflow">if</span>($champ=='matiere') $champ_aff=trim($row[$champ]);
<a name="l00445"></a>00445             <span class="keywordflow">else</span> $champ_aff=trim(ucwords(strtolower($row[$champ])));
<a name="l00446"></a>00446             echo <a class="code" href="inc-html_8php.html#ee820c089a642b6c9643b4a48fc46395" title="Cree un champ INPUT TEXT dans une ligne TR.">formInputTextTR</a>(<span class="stringliteral">"&lt;font color='lightgray'&gt;$table&lt;/font&gt; [&lt;b&gt;$id&lt;/b&gt;]"</span>,$table.<span class="stringliteral">"|"</span>.$id,$champ_aff,<span class="stringliteral">"class='fondo' size='$size' maxlength='$maxlength' onfocus='this.select();' "</span>);
<a name="l00447"></a>00447             <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>++;
<a name="l00448"></a>00448          }
<a name="l00449"></a>00449       }
<a name="l00450"></a>00450       <span class="comment">//echo formInputTextTR("$ref [+]",$ref."_ajout","","class='formo' size='11' onfocus='this.select();'");</span>
<a name="l00451"></a>00451       echo <a class="code" href="inc-html_8php.html#5d8e88ab9e3dbed93415de2c14978c22" title="Cree un champ TEXTAREA dans un TR.">formTextAreaTR</a>(<span class="stringliteral">"Ajout en masse&lt;br/&gt;(une valeur par ligne)"</span>,$table.<span class="stringliteral">"|ajoutMasse"</span>,<span class="stringliteral">""</span>,<span class="stringliteral">"class='formo' cols='40' rows='7' onfocus='this.select();'"</span>,<span class="stringliteral">"colspan='$colspan_textarea'"</span>);
<a name="l00452"></a>00452       echo <span class="stringliteral">"&lt;INPUT type='hidden' name='cpt' value='$cpt'/&gt;\n"</span>;
<a name="l00453"></a>00453       echo <span class="stringliteral">"&lt;TR&gt;"</span>
<a name="l00454"></a>00454          . <span class="stringliteral">"&lt;TD $colspan&gt;&lt;INPUT TYPE='SUBMIT' NAME='ok' VALUE='Mettre &amp;agrave; jour\n$libelle' class='formo'/&gt;&lt;/TD&gt;"</span>
<a name="l00455"></a>00455          . <span class="stringliteral">"&lt;TD&gt;&lt;INPUT TYPE='BUTTON' NAME='annuler' VALUE='Annuler' class='formo' onClick=\"window.location='"</span>.generer_url_ecrire('odb_ref').<span class="stringliteral">"&amp;annuler=$table&amp;step3=$table&amp;table=$table';\"/&gt;&lt;/TD&gt;"</span>
<a name="l00456"></a>00456          . <span class="stringliteral">"&lt;/TR&gt;\n"</span>;
<a name="l00457"></a>00457    } <span class="keywordflow">else</span> {
<a name="l00458"></a>00458       debut_cadre_relief(  <span class="stringliteral">""</span>, <span class="keyword">false</span>, <span class="stringliteral">""</span>, <a class="code" href="inc-pdf-attestations_8php.html#43e5b5a819fedbd12b8cf5421ba6985e">$titre</a> = _T('Choix du r&amp;eacute;f&amp;eacute;rentiel'));
<a name="l00459"></a>00459 
<a name="l00462"></a>00462                 <span class="keywordflow">if</span>(isset($_REQUEST['actionSession'])) {
<a name="l00463"></a>00463                         debut_boite_info();
<a name="l00464"></a>00464                         $actionSession=$_REQUEST['actionSession'];
<a name="l00465"></a>00465                         echo <span class="stringliteral">"&lt;b&gt;"</span>.ucfirst(str_replace(<span class="charliteral">'_'</span>,<span class="charliteral">' '</span>,$actionSession)).<span class="stringliteral">"&lt;/b&gt;&lt;br/&gt;\n"</span>;
<a name="l00466"></a>00466                         <span class="keywordflow">foreach</span>(<a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>[$actionSession] as $key=&gt;$val) {
<a name="l00467"></a>00467                                 <span class="keywordflow">if</span>($key=='sql') {
<a name="l00468"></a>00468                                         <span class="keywordflow">foreach</span>($val as $k=&gt;<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>) {
<a name="l00469"></a>00469                                                 <a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00470"></a>00470                                                 $nb_rows[$k]=mysql_affected_rows();
<a name="l00471"></a>00471                                                 <span class="comment">//echo "&lt;hr/&gt;$nb_rows[$k] lignes :&lt;br/&gt;$sql ";</span>
<a name="l00472"></a>00472                                         }
<a name="l00473"></a>00473                                 } elseif ($key=='msgSql') {
<a name="l00474"></a>00474                                         <span class="keywordflow">foreach</span>($val as $k=&gt;$str)
<a name="l00475"></a>00475                                                 echo '&lt;br/&gt;'.OK.' - &lt;b&gt;'.$nb_rows[$k].'&lt;/b&gt; '.$str;
<a name="l00476"></a>00476                                 } elseif ($key=='msg') {
<a name="l00477"></a>00477                                         echo implode('&lt;br/&gt;',$val); 
<a name="l00478"></a>00478                                 } elseif ($key=='retour')
<a name="l00479"></a>00479                                         echo <span class="stringliteral">"&lt;BR/&gt;&lt;A href='"</span>.$val['url'].<span class="stringliteral">"'&gt;"</span>.$val['msg'].<span class="stringliteral">"&lt;/A&gt;"</span>;
<a name="l00480"></a>00480                                 <span class="keywordflow">else</span> die(<a class="code" href="odb__ref_8php.html#e56b96c4dfcced36887ba02c496c40a3">KO</a>.' - Cl&amp;eacute; &lt;b&gt;$key&lt;/b&gt; non pr&amp;eacute;vue');
<a name="l00481"></a>00481                         }
<a name="l00482"></a>00482                         unset(<a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>[$actionSession]);
<a name="l00483"></a>00483                         fin_boite_info();echo <span class="stringliteral">"&lt;br/&gt;\n"</span>;
<a name="l00484"></a>00484                 } elseif(strlen($step3)&gt;0) {
<a name="l00485"></a>00485          $champ=substr($table,strlen(<a class="code" href="odb__ref_8php.html#9f5eef19bf0ee262d8aa0b7dc20c6be8">ODB_PREFIXE</a>));
<a name="l00486"></a>00486          <span class="keywordflow">if</span>($champ=='etablissement') {
<a name="l00487"></a>00487             $isETA=<span class="keyword">true</span>;
<a name="l00488"></a>00488          } <span class="keywordflow">else</span> {
<a name="l00489"></a>00489             $isETA=<span class="keyword">false</span>;
<a name="l00490"></a>00490          }
<a name="l00491"></a>00491 
<a name="l00492"></a>00492          <span class="keywordflow">foreach</span>($_POST as $key =&gt; $value) {
<a name="l00493"></a>00493                <span class="keywordflow">if</span>(substr_count($key,'<span class="keyword">set</span>|')&gt;0) {
<a name="l00494"></a>00494                $tmp=explode(<span class="stringliteral">"|"</span>,$key);
<a name="l00495"></a>00495                $identifiant_set=$tmp[1];
<a name="l00496"></a>00496                $id_set=$tmp[2];
<a name="l00497"></a>00497                <span class="keywordflow">if</span>(trim($value)!='' || !is_numeric($value)) {
<a name="l00498"></a>00498                 <span class="keywordflow">if</span>(!is_numeric($value)) $value=<span class="stringliteral">"'$value'"</span>;
<a name="l00499"></a>00499                   $set[$id_set].=<span class="stringliteral">", $identifiant_set=$value"</span>;
<a name="l00500"></a>00500                   <span class="keywordflow">if</span>($debug) echo <span class="stringliteral">"set[$id_set] : $identifiant_set=$value&lt;br/&gt;\n"</span>;
<a name="l00501"></a>00501                }
<a name="l00502"></a>00502                unset($_POST[$key]);
<a name="l00503"></a>00503             }
<a name="l00504"></a>00504          }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506          debut_boite_info();
<a name="l00507"></a>00507          <span class="keywordflow">if</span>($annuler!=<span class="stringliteral">""</span>)
<a name="l00508"></a>00508             echo <span class="stringliteral">"Op&amp;eacute;ration annul&amp;eacute;e - aucun changement effectu&amp;eacute;\n"</span>;
<a name="l00509"></a>00509          <span class="keywordflow">else</span> {
<a name="l00510"></a>00510             <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>=$_POST[<span class="stringliteral">"cpt"</span>];
<a name="l00511"></a>00511             $cpt_ajoutMasse=0;
<a name="l00512"></a>00512             $cpt_supprime=0;
<a name="l00513"></a>00513             <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">""</span>;
<a name="l00514"></a>00514             <span class="keywordflow">foreach</span>($_POST as $key =&gt; $value) {
<a name="l00515"></a>00515                $sql_masse=<span class="stringliteral">""</span>;
<a name="l00516"></a>00516                <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">""</span>;
<a name="l00517"></a>00517                $value=mysql_real_escape_string(unicode2charset(charset2unicode(trim($value))));
<a name="l00518"></a>00518                $ref=explode(<span class="stringliteral">"|"</span>,$key);
<a name="l00519"></a>00519                <span class="keywordflow">if</span>($debug) {
<a name="l00520"></a>00520                   echo <span class="stringliteral">"&lt;br/&gt;[$key]=$value\t"</span>;
<a name="l00521"></a>00521                   <span class="comment">/* affichage du tableau</span>
<a name="l00522"></a>00522 <span class="comment">                  echo('&lt;pre&gt;');</span>
<a name="l00523"></a>00523 <span class="comment">                  print_r($ref);</span>
<a name="l00524"></a>00524 <span class="comment">                  echo('&lt;/pre&gt;');</span>
<a name="l00525"></a>00525 <span class="comment">                  */</span>
<a name="l00526"></a>00526                   echo htmlentities($step3);
<a name="l00527"></a>00527                }
<a name="l00528"></a>00528                <span class="keywordflow">if</span>($ref[0]==$table) {
<a name="l00529"></a>00529                   $id=$ref[1];
<a name="l00530"></a>00530                   <span class="keywordflow">if</span>($debug)
<a name="l00531"></a>00531                      echo <span class="stringliteral">"::$id"</span>;
<a name="l00532"></a>00532                   <span class="keywordflow">if</span>($id==<span class="stringliteral">"ajoutMasse"</span>) {
<a name="l00533"></a>00533                      <span class="keywordflow">if</span>($value!=<span class="stringliteral">""</span>) {
<a name="l00534"></a>00534                         $val=explode(<span class="stringliteral">"\\n"</span>,$value);
<a name="l00535"></a>00535                         $sql_masse=<span class="stringliteral">""</span>;
<a name="l00536"></a>00536                         <span class="keywordflow">foreach</span>($val as $val_masse) {
<a name="l00537"></a>00537                            $val_masse=trim(str_replace(<span class="stringliteral">"\\r"</span>,<span class="stringliteral">""</span>,$val_masse));
<a name="l00538"></a>00538                            <span class="keywordflow">if</span>($val_masse!=<span class="stringliteral">""</span>) {
<a name="l00539"></a>00539                               <span class="keywordflow">if</span>($isETA)
<a name="l00540"></a>00540                                  $sql_masse=<span class="stringliteral">"INSERT INTO $table (id_departement,etablissement) VALUES ($id_departement,'$val_masse');"</span>;
<a name="l00541"></a>00541                               <span class="keywordflow">else</span>
<a name="l00542"></a>00542                                  $sql_masse=<span class="stringliteral">"INSERT INTO $table ($champ) VALUES ('$val_masse');"</span>;
<a name="l00543"></a>00543                               <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=mysql_query($sql_masse) or $erreur=trim(mysql_errno());
<a name="l00544"></a>00544                               <span class="keywordflow">if</span>($erreur==<span class="stringliteral">"1062"</span>) { <span class="comment">//Duplicata du champ pour la clef 2</span>
<a name="l00545"></a>00545                                  $txt_erreur.=<span class="stringliteral">"&lt;b&gt;&lt;U style='color:#f81;'&gt;/!&lt;/U&gt;&lt;/b&gt; Le champ '&lt;b&gt;$val_masse&lt;/b&gt;' existait d&amp;eacute;jà dans le r&amp;eacute;f&amp;eacute;rentiel &lt;b&gt;$step3&lt;/b&gt; - ajout ignor&amp;eacute;&lt;br/&gt;\n"</span>;
<a name="l00546"></a>00546                               }
<a name="l00547"></a>00547                               elseif ($erreur&gt;0) { <span class="comment">//autre erreur</span>
<a name="l00548"></a>00548                                  die(<a class="code" href="odb__ref_8php.html#e56b96c4dfcced36887ba02c496c40a3">KO</a>.<span class="stringliteral">" - erreur "</span>.mysql_errno().<span class="stringliteral">" : requête $sql_masse&lt;br/&gt;"</span>.__FILE__.' ('.__LINE__.')&lt;br/&gt;'.mysql_error());
<a name="l00549"></a>00549                               }
<a name="l00550"></a>00550                               <span class="keywordflow">else</span> { <span class="comment">// ajout OK</span>
<a name="l00551"></a>00551                                  $cpt_ajoutMasse++;
<a name="l00552"></a>00552                                  $txt_ajoutMasse.=<span class="stringliteral">"&lt;li&gt;$val_masse&lt;/li&gt;\n"</span>;
<a name="l00553"></a>00553                               }
<a name="l00554"></a>00554                            }
<a name="l00555"></a>00555                         }
<a name="l00556"></a>00556                      } <span class="keywordflow">else</span>
<a name="l00557"></a>00557                         $sql_masse='';
<a name="l00558"></a>00558                   } <span class="keywordflow">else</span> {
<a name="l00559"></a>00559                      <span class="keywordflow">if</span>(trim($value=='')) {
<a name="l00560"></a>00560                         <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"DELETE from $table WHERE id=$id"</span>;
<a name="l00561"></a>00561                         $cpt_supprime++;
<a name="l00562"></a>00562                         <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>--;<span class="comment">// &amp;eacute;tait compt&amp;eacute; comme UPDATE alors que c'est DELETE</span>
<a name="l00563"></a>00563                      } <span class="keywordflow">else</span> {
<a name="l00564"></a>00564                         <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"UPDATE $table SET $champ='$value' "</span>.$set[$id].<span class="stringliteral">" WHERE id=$id "</span>;
<a name="l00565"></a>00565                         <span class="keywordflow">if</span>(in_array($table,array('odb_ref_operateur<span class="charliteral">','</span>odb_ref_salle<span class="charliteral">','</span>odb_ref_examen')))
<a name="l00566"></a>00566                                 <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>.=<span class="stringliteral">" and annee=$annee"</span>;
<a name="l00567"></a>00567                      }
<a name="l00568"></a>00568                      <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00569"></a>00569                   }
<a name="l00570"></a>00570                   <span class="keywordflow">if</span>($debug) {
<a name="l00571"></a>00571                      echo <span class="stringliteral">"&lt;PRE&gt;$sql $sql_masse&lt;/PRE&gt;\n"</span>;
<a name="l00572"></a>00572                   }
<a name="l00573"></a>00573                }
<a name="l00574"></a>00574             }
<a name="l00575"></a>00575             <span class="keywordflow">if</span>($cpt_supprime&gt;0) {
<a name="l00576"></a>00576                <span class="comment">//$js="confirm('Souhaitez-vous r&amp;eacute;ellement supprimer $cpt_supprime valeurs\ndu r&amp;eacute;f&amp;eacute;rentiel $step3 ?')";</span>
<a name="l00577"></a>00577                <span class="comment">//echo "&lt;script&gt;$js&lt;/script&gt;\n";</span>
<a name="l00578"></a>00578                echo <span class="stringliteral">"Suppression de &lt;b&gt;$cpt_supprime&lt;/b&gt; valeurs dans le r&amp;eacute;f&amp;eacute;rentiel &lt;b&gt;$libelle&lt;/b&gt; "</span>.OK.<span class="stringliteral">"&lt;br/&gt;\n"</span>;
<a name="l00579"></a>00579             }
<a name="l00580"></a>00580             echo <span class="stringliteral">"Modification des &lt;b&gt;$cpt&lt;/b&gt; valeurs du r&amp;eacute;f&amp;eacute;rentiel &lt;b&gt;$libelle&lt;/b&gt; "</span>.OK.<span class="stringliteral">"&lt;br/&gt;\n"</span>;
<a name="l00581"></a>00581             <span class="keywordflow">if</span>(strlen($ajout)&gt;0)
<a name="l00582"></a>00582                echo <span class="stringliteral">"Ajout de la valeur &lt;b&gt;$ajout&lt;/b&gt; dans le r&amp;eacute;f&amp;eacute;rentiel &lt;b&gt;$libelle&lt;/b&gt; "</span>.OK.<span class="stringliteral">"&lt;br/&gt;\n"</span>;
<a name="l00583"></a>00583             <span class="keywordflow">if</span>($cpt_ajoutMasse&gt;0) {
<a name="l00584"></a>00584                echo <span class="stringliteral">"Ajout en masse de &lt;b&gt;$cpt_ajoutMasse&lt;/b&gt; valeurs dans le r&amp;eacute;f&amp;eacute;rentiel &lt;b&gt;$libelle&lt;/b&gt; "</span>.OK.<span class="stringliteral">"&lt;br/&gt;\n"</span>;
<a name="l00585"></a>00585                echo <span class="stringliteral">"&lt;ul&gt;$txt_ajoutMasse&lt;/ul&gt;\n"</span>;
<a name="l00586"></a>00586             }
<a name="l00587"></a>00587                                 <span class="keywordflow">switch</span>($table) {
<a name="l00588"></a>00588                                         <span class="keywordflow">case</span> 'odb_ref_operateur':
<a name="l00589"></a>00589                                         <span class="keywordflow">case</span> 'odb_ref_salle':
<a name="l00590"></a>00590                                         <span class="keywordflow">case</span> 'odb_ref_examen':
<a name="l00591"></a>00591                                                 <span class="comment">// pour les referentiels qui dependent de l'annee</span>
<a name="l00592"></a>00592                                                 <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"UPDATE $table SET annee=$annee WHERE annee=0"</span>;
<a name="l00593"></a>00593                                                 <a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00594"></a>00594                                                 $nb=mysql_affected_rows();
<a name="l00595"></a>00595                                                 <span class="keywordflow">if</span>($nb&gt;0)
<a name="l00596"></a>00596                                                         echo <span class="stringliteral">"&lt;b&gt;$nb&lt;/b&gt; valeurs du r&amp;eacute;f&amp;eacute;rentiel &lt;b&gt;$libelle&lt;/b&gt; pass&amp;eacute;es en &lt;b&gt;$annee&lt;/b&gt; - "</span>.OK.<span class="stringliteral">"&lt;br/&gt;\n"</span>;
<a name="l00597"></a>00597                                 }
<a name="l00598"></a>00598             echo $txt_erreur;
<a name="l00599"></a>00599          }
<a name="l00600"></a>00600          echo <span class="stringliteral">"&lt;br/&gt;Retourner &amp;agrave; la gestion du r&amp;eacute;f&amp;eacute;rentiel &lt;A HREF='"</span>.generer_url_ecrire('odb_ref').<span class="stringliteral">"&amp;table=$step3&amp;step2=manuel&amp;annee=$annee'&gt;$libelle&lt;/b&gt;&lt;/A&gt;\n"</span>;
<a name="l00601"></a>00601          fin_boite_info();
<a name="l00602"></a>00602          echo <span class="stringliteral">"&lt;br/&gt;\n"</span>;
<a name="l00603"></a>00603       }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605       echo <span class="stringliteral">"&lt;FORM NAME='form_odb_ref' id='form_odb_ref' ACTION='"</span>.generer_url_ecrire('odb_ref').<span class="stringliteral">"'"</span>
<a name="l00606"></a>00606         . <span class="stringliteral">" class='forml spip_xx-small' METHOD='POST'"</span>
<a name="l00607"></a>00607         . <span class="stringliteral">" onSubmit=\"if(this.table.value=='') {alert('Veuillez choisir un referentiel dans la liste');this.table.focus();return false;}\"&gt;\n"</span>
<a name="l00608"></a>00608         ;
<a name="l00609"></a>00609       echo <span class="stringliteral">"&lt;TABLE&gt;\n"</span>;
<a name="l00610"></a>00610       echo <span class="stringliteral">"&lt;INPUT type='hidden' name='step2' value='step2'/&gt;\n"</span>;
<a name="l00611"></a>00611       <span class="comment">/* année</span>
<a name="l00612"></a>00612 <span class="comment">      echo formSelectTR1("&lt;b&gt;Ann&amp;eacute;e du r&amp;eacute;f&amp;eacute;rentiel&lt;/b&gt;","annee","onChange=\"document.forms['form_odb_ref'].ref.value='';\"");</span>
<a name="l00613"></a>00613 <span class="comment">      echo formSelectAnnee($annee);</span>
<a name="l00614"></a>00614 <span class="comment">      echo formSelectTR2();</span>
<a name="l00615"></a>00615 <span class="comment">      */</span>
<a name="l00616"></a>00616       echo <a class="code" href="inc-html_8php.html#9e275c42206610f6e5a60fb84f386886" title="Debut de balise SELECT dans un TR.">formSelectTR1</a>(<span class="stringliteral">"Veuillez choisir un r&amp;eacute;f&amp;eacute;rentiel"</span>,<span class="stringliteral">"table"</span>,<span class="stringliteral">"class='fondo' onChange=\"document.forms['form_odb_ref'].submit();\""</span>);
<a name="l00617"></a>00617       $base=<a class="code" href="inc-odb_8php.html#9b3a021f05992ff16e374c2e0dfa1ef9" title="Recupere les informations de connection bdd du fichier de conf spip.">getBddConf</a>('bdd');
<a name="l00618"></a>00618       <span class="comment">//echo "base $base";</span>
<a name="l00619"></a>00619       <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a> = <span class="stringliteral">"SHOW TABLES FROM $base LIKE '"</span>.ODB_PREFIXE.<span class="stringliteral">"%'"</span>;
<a name="l00620"></a>00620       <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00621"></a>00621       ;
<a name="l00622"></a>00622       <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00623"></a>00623          $table=$row[0];
<a name="l00624"></a>00624          $libelle=ucwords(substr($table,strlen(<a class="code" href="odb__ref_8php.html#9f5eef19bf0ee262d8aa0b7dc20c6be8">ODB_PREFIXE</a>)));
<a name="l00625"></a>00625          <span class="keywordflow">switch</span>(strtolower($libelle)) {
<a name="l00626"></a>00626             <span class="keywordflow">case</span> 'etablissement':
<a name="l00627"></a>00627                $tab_ref=<a class="code" href="inc-referentiel_8php.html#8da6b5d71b8b85a4443092e825841479">getReferentiel</a>('departement');
<a name="l00628"></a>00628                <span class="comment">//echo "tab_ref&lt;pre&gt;";print_r($tab_ref);echo "&lt;/pre&gt;\n";</span>
<a name="l00629"></a>00629                $sql2=<span class="stringliteral">"SELECT DISTINCT(id_departement) from $table"</span>;
<a name="l00630"></a>00630                $result2=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>($sql2,__FILE__,__LINE__);
<a name="l00631"></a>00631                ;
<a name="l00632"></a>00632                <span class="keywordflow">while</span>($row2=mysql_fetch_array($result2)) {
<a name="l00633"></a>00633                   $id_departement = $row2['id_departement'];
<a name="l00634"></a>00634                   <span class="keywordflow">if</span>($id_departement==0) {
<a name="l00635"></a>00635                      $cpt_pb_dept++;
<a name="l00636"></a>00636                      $lib_departement=<span class="stringliteral">"&amp;lt;!&amp;gt; Sans d&amp;eacute;partement &amp;lt;!&amp;gt;"</span>;
<a name="l00637"></a>00637                   } <span class="keywordflow">else</span> {
<a name="l00638"></a>00638                      $lib_departement=ucwords(strtolower(str_replace(<span class="charliteral">'-'</span>,' / ',$tab_ref[$id_departement])));
<a name="l00639"></a>00639                   }
<a name="l00640"></a>00640                   $tab_eta_lib[$id_departement]=$lib_departement;
<a name="l00641"></a>00641                   $tab_eta_val[$id_departement]=<span class="stringliteral">"ETA|$id_departement|$lib_departement|$table"</span>;
<a name="l00642"></a>00642                }
<a name="l00643"></a>00643                $lib_out='&amp;Eacute;tablissement';
<a name="l00644"></a>00644                unset($libelle); <span class="comment">//pour ne pas l'afficher dans la premiere liste</span>
<a name="l00645"></a>00645                <span class="keywordflow">break</span>;
<a name="l00646"></a>00646             <span class="keywordflow">case</span> 'lv':
<a name="l00647"></a>00647                $libelle='Langues vivantes';
<a name="l00648"></a>00648                <span class="keywordflow">break</span>;
<a name="l00649"></a>00649             <span class="keywordflow">case</span> 'ef':
<a name="l00650"></a>00650                $libelle='&amp;Eacute;preuves facultatives';
<a name="l00651"></a>00651                <span class="keywordflow">break</span>;
<a name="l00652"></a>00652             <span class="comment">//default:</span>
<a name="l00653"></a>00653          }
<a name="l00654"></a>00654          <span class="comment">//echo "Libelle $libelle table $table&lt;br&gt;\n";</span>
<a name="l00655"></a>00655          <span class="keywordflow">if</span>($libelle) $ref_optgroup.= <a class="code" href="inc-html_8php.html#7be54cdf2beda343e02419f1ac46fa0c" title="Cree un champ OPTION dans un SELECT.">formOptionsInSelect</a>($libelle,$table,$selectedTable);
<a name="l00656"></a>00656       }
<a name="l00657"></a>00657       echo <a class="code" href="inc-html_8php.html#7be54cdf2beda343e02419f1ac46fa0c" title="Cree un champ OPTION dans un SELECT.">formOptionsInSelect</a>(<span class="stringliteral">"-=[R&amp;eacute;f&amp;eacute;rentiel]=-"</span>,<span class="stringliteral">""</span>,$selectedTable);
<a name="l00658"></a>00658       echo <span class="stringliteral">"&lt;optgroup label='R&amp;eacute;f&amp;eacute;rentiel''&gt;$ref_optgroup&lt;/optgroup&gt;\n"</span>;
<a name="l00659"></a>00659       echo <span class="stringliteral">"&lt;optgroup label='$lib_out'&gt;\n"</span>;
<a name="l00660"></a>00660       <span class="comment">//echo "tab_eta_lib&lt;pre&gt;";print_r($tab_eta_lib);echo "&lt;/pre&gt;\n";</span>
<a name="l00661"></a>00661       asort($tab_eta_lib);<span class="comment">//trie sur les clés</span>
<a name="l00662"></a>00662       <span class="keywordflow">foreach</span>($tab_eta_lib as $id_departement =&gt; $lib_departement)
<a name="l00663"></a>00663          echo <a class="code" href="inc-html_8php.html#7be54cdf2beda343e02419f1ac46fa0c" title="Cree un champ OPTION dans un SELECT.">formOptionsInSelect</a>($lib_departement,$tab_eta_val[$id_departement],$selectedTable);
<a name="l00664"></a>00664       echo '&lt;/optgroup&gt;';
<a name="l00665"></a>00665       echo <span class="stringliteral">"&lt;/SELECT&gt;&lt;/TD&gt;&lt;TD&gt;"</span>
<a name="l00666"></a>00666         . <span class="stringliteral">"&lt;SELECT class='fondo' name='annee'&gt;"</span>.formSelectAnnee(<a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>).<span class="stringliteral">"&lt;/SELECT&gt;"</span>
<a name="l00667"></a>00667         . <span class="stringliteral">"&lt;/TD&gt;&lt;/TR&gt;\n"</span>;
<a name="l00668"></a>00668       echo <span class="stringliteral">"&lt;TR&gt;&lt;TD&gt;&amp;nbsp;&lt;/TD&gt;&lt;TD&gt;&lt;INPUT TYPE='SUBMIT' NAME='ok' VALUE='Ok' class='formo'/&gt;&lt;/TD&gt;&lt;/TR&gt;\n"</span>;
<a name="l00669"></a>00669    }
<a name="l00670"></a>00670    echo <span class="stringliteral">"&lt;/FORM&gt;\n&lt;/TABLE&gt;\n"</span>;
<a name="l00671"></a>00671    <span class="keywordflow">if</span>($cpt_pb_dept&gt;0)
<a name="l00672"></a>00672       echo <a class="code" href="inc-html_8php.html#af111db152a79e88015b3a80345d0cdd" title="affiche une boite de message">boite_important</a>(<span class="stringliteral">"Aucune info sur le d&amp;eacute;partement pour &lt;b&gt;$cpt_pb_dept &amp;eacute;tablissement(s)&lt;/b&gt;&lt;br/&gt;&lt;i&gt;Conseil&lt;/i&gt; : Commencez par leur &lt;a href='"</span>.generer_url_ecrire('odb_ref').<span class="stringliteral">"&amp;table="</span>.$tab_eta_val[0].<span class="stringliteral">"&amp;step2=manuel'&gt;affecter un d&amp;eacute;partement&lt;/a&gt;"</span>,'&lt;!&gt;');
<a name="l00673"></a>00673 
<a name="l00674"></a>00674    fin_cadre_relief();
<a name="l00675"></a>00675 
<a name="l00676"></a>00676    fin_boite_info();
<a name="l00677"></a>00677    fin_cadre_relief();
<a name="l00678"></a>00678         $jquery= &lt;&lt;&lt;FINSCRIPT
<a name="l00679"></a>00679 $(document).ready(function() {
<a name="l00680"></a>00680         $('#form_odb_ref').submit(function() {
<a name="l00681"></a>00681                 flag=<span class="keyword">true</span>;
<a name="l00682"></a>00682                 $(<span class="stringliteral">"input[@name*=odb_ref_]"</span>).each(function() {
<a name="l00683"></a>00683                         <span class="keywordflow">if</span>(<span class="keyword">this</span>.value=='') {
<a name="l00684"></a>00684                                 <span class="keyword">this</span>.focus();
<a name="l00685"></a>00685                                 flag=flag&amp;&amp;confirm('Etes-vous sur(e) de vouloir supprimer \\n'+<span class="keyword">this</span>.name+' ?\\n\\nReflechissez bien aux impacts !');
<a name="l00686"></a>00686                         }
<a name="l00687"></a>00687                 });
<a name="l00688"></a>00688                 <span class="keywordflow">return</span> flag;
<a name="l00689"></a>00689         });
<a name="l00690"></a>00690 });
<a name="l00691"></a>00691 FINSCRIPT;
<a name="l00692"></a>00692         echo <a class="code" href="inc-html_8php.html#26ce7f961b7c017f444305029440e0d3" title="Ajoute du code javascript.">putJavascript</a>($jquery);
<a name="l00693"></a>00693    fin_page();
<a name="l00694"></a>00694    exit;
<a name="l00695"></a>00695 }
<a name="l00696"></a>00696 ?&gt;
</pre></div><hr size="1"><address style="text-align: right;"><small>Généré le Mon Mar 17 22:53:00 2008 pour Siou par&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
