<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Siou:  Fichier source de odb_commun/inc-referentiel.php</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Généré par Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Page&nbsp;principale</span></a></li>
    <li class="current"><a href="files.html"><span>Fichiers</span></a></li>
    <li><a href="dirs.html"><span>Répertoires</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;Rechercher&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul>
</div>
<div class="nav">
<a class="el" href="dir_d85a68ddeac050d85549308ca402191f.html">odb_commun</a></div>
<h1>inc-referentiel.php</h1><a href="inc-referentiel_8php.html">Aller à la documentation de ce fichier.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a><a class="code" href="inc-referentiel_8php.html#32f56aa14be3aa7fa481441d26b8bca5">00002</a> global <a class="code" href="inc-referentiel_8php.html#32f56aa14be3aa7fa481441d26b8bca5">$odb_referentiel</a>,<a class="code" href="inc-referentiel_8php.html#b3984efda359cc31d6cfe267131a7ff9">$odb_mapping</a>;
<a name="l00003"></a><a class="code" href="inc-referentiel_8php.html#250a58ff3386f8733afc86c93a171d7f">00003</a> define('<a class="code" href="inc-referentiel_8php.html#250a58ff3386f8733afc86c93a171d7f">PAYS</a><span class="charliteral">','</span>benin');
<a name="l00004"></a><a class="code" href="inc-referentiel_8php.html#6d16734dee8d708efe9daa5361783b1a">00004</a> <a class="code" href="inc-referentiel_8php.html#32f56aa14be3aa7fa481441d26b8bca5">$odb_referentiel</a>=array(
<a name="l00005"></a>00005 <span class="stringliteral">"odb_candidats"</span> =&gt; array(
<a name="l00006"></a>00006    <span class="stringliteral">"Num_Saisie"</span> =&gt; <span class="stringliteral">"INTEGER"</span>,
<a name="l00007"></a>00007    <span class="stringliteral">"Num_Table"</span>=&gt;<span class="stringliteral">"VARCHAR"</span>,
<a name="l00008"></a>00008         <span class="stringliteral">"Old_Num_Table"</span> =&gt; <span class="stringliteral">"VARCHAR"</span>,
<a name="l00009"></a>00009    <span class="stringliteral">"Annee"</span>=&gt;<span class="stringliteral">"YEAR"</span>,
<a name="l00010"></a>00010    <span class="stringliteral">"Serie"</span> =&gt; <span class="stringliteral">"refSerie"</span>,
<a name="l00011"></a>00011    <span class="stringliteral">"Prefixe"</span> =&gt; <span class="stringliteral">"refPrefixe"</span>,
<a name="l00012"></a>00012    <span class="stringliteral">"Nom"</span> =&gt; <span class="stringliteral">"VARCHAR"</span>,
<a name="l00013"></a>00013    <span class="stringliteral">"Prenoms"</span> =&gt; <span class="stringliteral">"VARCHAR"</span>,
<a name="l00014"></a>00014    <span class="stringliteral">"Ne_le"</span> =&gt; <span class="stringliteral">"DATE"</span>,
<a name="l00015"></a>00015    <span class="stringliteral">"Ne_en"</span> =&gt; <span class="stringliteral">"YEAR"</span>,
<a name="l00016"></a>00016    <span class="stringliteral">"Ne_vers"</span> =&gt; <span class="stringliteral">"YEAR"</span>,
<a name="l00017"></a>00017    <span class="stringliteral">"Ville_Naissance"</span> =&gt; <span class="stringliteral">"VARCHAR"</span>,
<a name="l00018"></a>00018    <span class="stringliteral">"Pays_Naissance"</span> =&gt; <span class="stringliteral">"refPays"</span>,
<a name="l00019"></a>00019    <span class="stringliteral">"Sexe"</span> =&gt; <span class="stringliteral">"refSexe"</span>,
<a name="l00020"></a>00020    <span class="stringliteral">"Nationalite"</span> =&gt; <span class="stringliteral">"refPays"</span>,
<a name="l00021"></a>00021    <span class="stringliteral">"Quartier_Residence"</span> =&gt; <span class="stringliteral">"VARCHAR"</span>,
<a name="l00022"></a>00022    <span class="stringliteral">"LV1"</span> =&gt; <span class="stringliteral">"refLV"</span>,
<a name="l00023"></a>00023    <span class="stringliteral">"LV2"</span> =&gt; <span class="stringliteral">"refLV"</span>,
<a name="l00024"></a>00024    <span class="stringliteral">"EPS"</span> =&gt; <span class="stringliteral">"refEPS"</span>,
<a name="l00025"></a>00025    <span class="stringliteral">"EF1"</span> =&gt; <span class="stringliteral">"refEF"</span>,
<a name="l00026"></a>00026    <span class="stringliteral">"EF2"</span> =&gt; <span class="stringliteral">"refEF"</span>,
<a name="l00027"></a>00027    <span class="stringliteral">"Ville"</span> =&gt; <span class="stringliteral">"refVille"</span>,
<a name="l00028"></a>00028    <span class="stringliteral">"Departement"</span> =&gt; <span class="stringliteral">"refDepartement"</span>,         <span class="comment">//'RIENDUTOUT', //</span>
<a name="l00029"></a>00029    <span class="stringliteral">"Etablissement"</span> =&gt; <span class="stringliteral">"Et."</span>,
<a name="l00030"></a>00030    <span class="stringliteral">"Ajourne"</span> =&gt; <span class="stringliteral">"VraiFaux"</span>,
<a name="l00031"></a>00031    <span class="stringliteral">"Date_naiss_invalide"</span> =&gt; <span class="stringliteral">"VraiFaux"</span>,
<a name="l00032"></a>00032    <span class="stringliteral">"MAJ"</span>=&gt;<span class="stringliteral">"TIMESTAMP"</span>,
<a name="l00033"></a>00033    <span class="stringliteral">"GUESS"</span> =&gt; array(
<a name="l00034"></a>00034       <span class="stringliteral">"Num_Anonyme"</span> =&gt; <span class="stringliteral">"VARCHAR"</span>,
<a name="l00035"></a>00035       <span class="stringliteral">"Centre"</span> =&gt; <span class="stringliteral">"refSalle"</span>,
<a name="l00036"></a>00036       <span class="stringliteral">"Salle"</span> =&gt; <span class="stringliteral">"INTEGER"</span>
<a name="l00037"></a>00037    )
<a name="l00038"></a>00038 ),
<a name="l00039"></a>00039 <span class="stringliteral">"odb_notes"</span> =&gt; array(
<a name="l00040"></a>00040    <span class="stringliteral">"Num_Anonyme"</span> =&gt; <span class="stringliteral">"VARCHAR"</span>,
<a name="l00041"></a>00041    <span class="stringliteral">"Serie"</span> =&gt; <span class="stringliteral">"refSerie"</span>,
<a name="l00042"></a>00042    <span class="stringliteral">"Num_Jury"</span> =&gt; <span class="stringliteral">"INTEGER"</span>
<a name="l00043"></a>00043    )
<a name="l00044"></a>00044 );
<a name="l00045"></a><a class="code" href="inc-referentiel_8php.html#bb0ea75df54ac4a893f97e8e55073d1d">00045</a> <a class="code" href="inc-referentiel_8php.html#b3984efda359cc31d6cfe267131a7ff9">$odb_mapping</a>=array(
<a name="l00046"></a>00046 <span class="stringliteral">"odb_candidats"</span>=&gt;array(
<a name="l00047"></a>00047    <span class="stringliteral">"id_saisie"</span>=&gt;<span class="stringliteral">"Num_Saisie"</span>,
<a name="l00048"></a>00048    <span class="stringliteral">"id_table"</span>=&gt;<span class="stringliteral">"Num_Table"</span>,
<a name="l00049"></a>00049    <span class="stringliteral">"id_table_old"</span>=&gt;<span class="stringliteral">"Old_Num_Table"</span>,
<a name="l00050"></a>00050    <span class="stringliteral">"annee"</span>=&gt;<span class="stringliteral">"Annee"</span>,
<a name="l00051"></a>00051    <span class="stringliteral">"serie"</span>=&gt;<span class="stringliteral">"Serie"</span>,
<a name="l00052"></a>00052    <span class="stringliteral">"prefixe"</span>=&gt;<span class="stringliteral">"Prefixe"</span>,
<a name="l00053"></a>00053    <span class="stringliteral">"nom"</span>=&gt;<span class="stringliteral">"Nom"</span>,
<a name="l00054"></a>00054    <span class="stringliteral">"prenoms"</span>=&gt;<span class="stringliteral">"Prenoms"</span>,
<a name="l00055"></a>00055    <span class="stringliteral">"ne_le"</span>=&gt;<span class="stringliteral">"Ne_le"</span>,
<a name="l00056"></a>00056    <span class="stringliteral">"ne_en"</span>=&gt;<span class="stringliteral">"Ne_en"</span>,
<a name="l00057"></a>00057    <span class="stringliteral">"ne_vers"</span>=&gt;<span class="stringliteral">"Ne_vers"</span>,
<a name="l00058"></a>00058    <span class="stringliteral">"ldn"</span>=&gt;<span class="stringliteral">"Ville_Naissance"</span>,
<a name="l00059"></a>00059    <span class="stringliteral">"pdn"</span>=&gt;<span class="stringliteral">"Pays_Naissance"</span>,
<a name="l00060"></a>00060    <span class="stringliteral">"sexe"</span>=&gt;<span class="stringliteral">"Sexe"</span>,
<a name="l00061"></a>00061    <span class="stringliteral">"nationalite"</span>=&gt;<span class="stringliteral">"Nationalite"</span>,
<a name="l00062"></a>00062    <span class="stringliteral">"quartier_res"</span>=&gt;<span class="stringliteral">"Quartier_Residence"</span>,
<a name="l00063"></a>00063    <span class="stringliteral">"lv1"</span>=&gt;<span class="stringliteral">"LV1"</span>,
<a name="l00064"></a>00064    <span class="stringliteral">"lv2"</span>=&gt;<span class="stringliteral">"LV2"</span>,
<a name="l00065"></a>00065    <span class="stringliteral">"eps"</span>=&gt;<span class="stringliteral">"EPS"</span>,
<a name="l00066"></a>00066    <span class="stringliteral">"ef1"</span>=&gt;<span class="stringliteral">"EF1"</span>,
<a name="l00067"></a>00067    <span class="stringliteral">"ef2"</span>=&gt;<span class="stringliteral">"EF2"</span>,
<a name="l00068"></a>00068    <span class="stringliteral">"ville"</span>=&gt;<span class="stringliteral">"Ville"</span>,
<a name="l00069"></a>00069    <span class="stringliteral">"departement"</span>=&gt;<span class="stringliteral">"Departement"</span>,
<a name="l00070"></a>00070    <span class="stringliteral">"etablissement"</span>=&gt;<span class="stringliteral">"Etablissement"</span>,
<a name="l00071"></a>00071    <span class="stringliteral">"ajourne"</span>=&gt;<span class="stringliteral">"Ajourne"</span>,
<a name="l00072"></a>00072    <span class="stringliteral">"non_inscrit"</span>=&gt;<span class="stringliteral">"Date_naiss_invalide"</span>,
<a name="l00073"></a>00073    <span class="stringliteral">"maj"</span>=&gt;<span class="stringliteral">"MAJ"</span>
<a name="l00074"></a>00074    )
<a name="l00075"></a>00075 );
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="comment">// rcupre le rfrentiel dans le tableau $tab_referentiel__</span>
<a name="l00078"></a>00078 <span class="comment">// $ref : nom de la table de referentiel sans le prefixe 'odb_ref_'</span>
<a name="l00079"></a>00079 <span class="comment">// $retour :</span>
<a name="l00080"></a>00080 <span class="comment">//   - 'id' pour retourner tableau des id tris par valeur</span>
<a name="l00081"></a>00081 <span class="comment">//   - 'valeur' pour retourner un tableau des valeurs tries par id</span>
<a name="l00082"></a>00082 <span class="comment">//   - 'tout' pour retourner les 2 ci-dessus</span>
<a name="l00083"></a><a class="code" href="inc-referentiel_8php.html#8da6b5d71b8b85a4443092e825841479">00083</a> function <a class="code" href="inc-referentiel_8php.html#8da6b5d71b8b85a4443092e825841479">getReferentiel</a>($ref,$retour='tout') {
<a name="l00084"></a>00084    <span class="keyword">static</span> $tab_referentiel__;
<a name="l00085"></a>00085    <span class="keywordflow">if</span>(!isset($tab_referentiel__[$ref])) { <span class="comment">// histoire de pas retourner en base si d&amp;eacute;j pomp&amp;eacute;</span>
<a name="l00086"></a>00086       <span class="keywordflow">switch</span>(strtolower($ref)) {
<a name="l00087"></a>00087          <span class="keywordflow">case</span> 'etablissement':
<a name="l00088"></a>00088             <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT id, id_departement, etablissement FROM odb_ref_$ref ORDER BY id_departement, etablissement"</span>;
<a name="l00089"></a>00089             <span class="keywordflow">break</span>;
<a name="l00090"></a>00090          <span class="keywordflow">case</span> 'centre':
<a name="l00091"></a>00091             <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT id, id_departement, etablissement, annee_centre from odb_ref_etablissement WHERE annee_centre&gt;0 order by id_departement, etablissement"</span>;
<a name="l00092"></a>00092             <span class="keywordflow">break</span>;
<a name="l00093"></a>00093          <span class="keywordflow">case</span> 'ville':
<a name="l00094"></a>00094             <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT id, id_departement, $ref from odb_ref_$ref order by id_departement, $ref"</span>;
<a name="l00095"></a>00095             <span class="keywordflow">break</span>;
<a name="l00096"></a>00096          <span class="keywordflow">default</span>:
<a name="l00097"></a>00097             <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a> = <span class="stringliteral">"SELECT id, $ref FROM odb_ref_$ref ORDER BY $ref"</span>;
<a name="l00098"></a>00098       }
<a name="l00099"></a>00099       <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00100"></a>00100       <span class="keywordflow">if</span>(mysql_num_rows(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)==0) die (<a class="code" href="odb__ref_8php.html#e56b96c4dfcced36887ba02c496c40a3">KO</a>.<span class="stringliteral">" - Rien n'a t trouv dans le rfrentiel $ref'"</span>);
<a name="l00101"></a>00101       <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00102"></a>00102          $id=$row[<span class="stringliteral">"id"</span>];
<a name="l00103"></a>00103          $ref2=$ref=='centre<span class="charliteral">'?'</span>etablissement':$ref;
<a name="l00104"></a>00104          $valeur=unicode2charset(charset2unicode(trim($row[$ref2])));
<a name="l00105"></a>00105          <span class="keywordflow">switch</span> (strtolower($ref)) {
<a name="l00106"></a>00106             <span class="keywordflow">case</span> 'etablissement':
<a name="l00107"></a>00107             <span class="keywordflow">case</span> 'ville':
<a name="l00108"></a>00108                $id_departement=$row['id_departement'];
<a name="l00109"></a>00109                <span class="keywordflow">if</span>($retour=='tout' || $retour=='<span class="keywordtype">id</span>')
<a name="l00110"></a>00110                   $tab_referentiel__[$ref][$id_departement][$valeur]=$id;
<a name="l00111"></a>00111                <span class="keywordflow">if</span>($retour=='tout' || $retour=='valeur')
<a name="l00112"></a>00112                   $tab_referentiel__[$ref][$id_departement][$id]=$valeur;
<a name="l00113"></a>00113                <span class="keywordflow">break</span>;
<a name="l00114"></a>00114             <span class="keywordflow">case</span> 'centre':
<a name="l00115"></a>00115                $id_departement=$row['id_departement'];
<a name="l00116"></a>00116                <span class="keywordflow">if</span>($retour=='tout' || $retour=='<span class="keywordtype">id</span>')
<a name="l00117"></a>00117                $tab_referentiel__[$ref][$id_departement][$valeur]=$id;
<a name="l00118"></a>00118                <span class="keywordflow">if</span>($retour=='tout' || $retour=='valeur') {
<a name="l00119"></a>00119                   $tab_referentiel__[$ref][$id_departement][$id]['libelle']=$valeur;
<a name="l00120"></a>00120                   $tab_referentiel__[$ref][$id_departement][$id]['annee_centre']=$row['annee_centre'];
<a name="l00121"></a>00121                }
<a name="l00122"></a>00122                <span class="keywordflow">break</span>;
<a name="l00123"></a>00123             <span class="keywordflow">default</span>:
<a name="l00124"></a>00124                <span class="keywordflow">if</span>($retour=='tout' || $retour=='<span class="keywordtype">id</span>')
<a name="l00125"></a>00125                   $tab_referentiel__[$ref][$valeur]=$id;
<a name="l00126"></a>00126                <span class="keywordflow">if</span>($retour=='tout' || $retour=='valeur')
<a name="l00127"></a>00127                   $tab_referentiel__[$ref][$id]=$valeur;
<a name="l00128"></a>00128          }
<a name="l00129"></a>00129       }
<a name="l00130"></a>00130    }
<a name="l00131"></a>00131    asort($tab_referentiel__[$ref]);
<a name="l00132"></a>00132    <span class="keywordflow">return</span> $tab_referentiel__[$ref];
<a name="l00133"></a>00133 }
<a name="l00134"></a>00134 
<a name="l00142"></a><a class="code" href="inc-referentiel_8php.html#38c3065b99469bad788c627a7b70360b">00142</a> function <a class="code" href="inc-referentiel_8php.html#38c3065b99469bad788c627a7b70360b" title="Met les decisions a jour.">odb_maj_decisions</a>(<a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>,<a class="code" href="inc-pdf-attestations_8php.html#1f711ee6f46195ba9dfce71eaf779d02">$jury</a>=0,$iPrecision=3,<a class="code" href="inc-pdf-attestations_8php.html#dd57477ad14361f5834629e405ff5478">$deliberation</a>=1) {
<a name="l00143"></a>00143         <span class="keywordflow">if</span>(<a class="code" href="inc-pdf-attestations_8php.html#1f711ee6f46195ba9dfce71eaf779d02">$jury</a>&gt;0) {
<a name="l00144"></a>00144                 $from_jury=<span class="stringliteral">", odb_repartition rep"</span>;
<a name="l00145"></a>00145                 $where_jury=<span class="stringliteral">" AND rep.id_table=notes.id_table and rep.annee = $annee and rep.jury=$jury"</span>;
<a name="l00146"></a>00146         }
<a name="l00147"></a>00147         <span class="keywordflow">if</span>(<a class="code" href="inc-pdf-attestations_8php.html#dd57477ad14361f5834629e405ff5478">$deliberation</a>==1) {
<a name="l00148"></a>00148                 <span class="comment">// supprime les notes d'eps des candidats dispenses (logiquement pour corrrection des cas reserves)</span>
<a name="l00149"></a>00149                 $tSql[]=<span class="stringliteral">"DELETE from odb_notes notes using odb_notes notes, odb_candidats can, odb_ref_eps eps\n"</span>.
<a name="l00150"></a>00150                 <span class="stringliteral">" where can.id_table=notes.id_table and can.annee=$annee and notes.annee=$annee and can.eps=eps.id and eps.eps!='Apte' and notes.id_matiere=-3"</span>;
<a name="l00151"></a>00151                 $tSql[]=<span class="stringliteral">"UPDATE odb_notes notes $from_jury SET notes.note='0' WHERE type='Divers' and note&lt;0 $where_jury and notes.annee=$annee"</span>;
<a name="l00152"></a>00152                 $tSql[]=<span class="stringliteral">"REPLACE INTO odb_decisions( id_table, id_anonyme,`annee` , `moyenne` , coeff, `delib1` ) (\n"</span>.
<a name="l00153"></a>00153                 <span class="stringliteral">"SELECT notes.id_table, notes.id_anonyme, notes.annee, if(min(note)&lt;0,-1,ROUND(sum( coeff * note ) / sum( coeff ),$iPrecision)) moy,sum( coeff ) coeff , null \n"</span>.
<a name="l00154"></a>00154                 <span class="stringliteral">"FROM odb_notes notes $from_jury\n WHERE notes.annee = $annee and notes.type!='Divers' AND notes.type!='Oral' $where_jury\n GROUP BY notes.id_table, notes.annee \n);"</span>;
<a name="l00155"></a>00155                 $tSql[]=<span class="stringliteral">"UPDATE odb_decisions notes $from_jury SET notes.moyenne = ROUND(moyenne,1) where moyenne&lt;9 $where_jury and notes.annee=$annee"</span>;
<a name="l00156"></a>00156                 $tSql[]=<span class="stringliteral">"UPDATE odb_decisions notes $from_jury SET notes.delib1 = 'Absent' WHERE moyenne = -1 $where_jury and notes.annee=$annee"</span>;
<a name="l00157"></a>00157                 $tSql[]=<span class="stringliteral">"UPDATE odb_decisions notes $from_jury SET notes.delib1 = 'Ajourne' WHERE 0&lt;=moyenne and moyenne &lt; 5 $where_jury and notes.annee=$annee"</span>;
<a name="l00158"></a>00158                 $tSql[]=<span class="stringliteral">"UPDATE odb_decisions notes $from_jury SET notes.delib1 = 'Refuse' WHERE 5&lt;=moyenne and moyenne &lt; 9 $where_jury and notes.annee=$annee"</span>;
<a name="l00159"></a>00159                 $tSql[]=<span class="stringliteral">"UPDATE odb_decisions notes $from_jury SET notes.delib1 = 'Admissible' WHERE moyenne &gt;= 9 $where_jury and notes.annee=$annee"</span>;
<a name="l00160"></a>00160                 <span class="comment">//TODO rendre parametrable : on refuse les candidats ayant eu un 0 et moins de 10</span>
<a name="l00161"></a>00161                 $tSql[]=<span class="stringliteral">"update odb_decisions decis, odb_notes notes $from_jury\n SET delib1='Refuse'\n"</span>.
<a name="l00162"></a>00162                 <span class="stringliteral">"WHERE decis.delib1 = 'Admissible' AND decis.id_table = notes.id_table\n AND notes.note=0 AND notes.type!='Divers' AND notes.type!='Oral' AND moyenne&lt;10\n"</span>.
<a name="l00163"></a>00163                 <span class="stringliteral">" AND decis.annee=$annee AND notes.annee=$annee $where_jury"</span>;
<a name="l00164"></a>00164                 <span class="keywordflow">foreach</span>($tSql as <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>) {
<a name="l00165"></a>00165                         <span class="comment">//echo "&lt;pre&gt;$sql&lt;/pre&gt;\n";</span>
<a name="l00166"></a>00166                         <a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>($sql,__FILE__,__LINE__);
<a name="l00167"></a>00167                 }
<a name="l00168"></a>00168         } elseif(<a class="code" href="inc-pdf-attestations_8php.html#dd57477ad14361f5834629e405ff5478">$deliberation</a>==2) {
<a name="l00169"></a>00169                 <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT notes.id_table, note, id_matiere from odb_notes notes, odb_decisions decis $from_jury where decis.id_table=notes.id_table and delib2='' and notes.type='Divers' $where_jury"</span>;
<a name="l00170"></a>00170                 <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00171"></a>00171                 <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00172"></a>00172                         <span class="keywordflow">foreach</span>(array('id_matiere<span class="charliteral">','</span>id_table<span class="charliteral">','</span>note') as $col) $$col=$row[$col];
<a name="l00173"></a>00173                         $tNote[<a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>]+=$note;
<a name="l00174"></a>00174                         <span class="keywordflow">if</span>($id_matiere==-3) $tEps[<a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>]=<span class="keyword">true</span>;
<a name="l00175"></a>00175                 }
<a name="l00176"></a>00176                 <span class="keywordflow">if</span>(is_array($tNote)) {
<a name="l00177"></a>00177                         <span class="keywordflow">foreach</span>($tNote as <a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>=&gt;$points) {
<a name="l00178"></a>00178                                 <span class="keywordflow">if</span>($tEps[<a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>]) <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"UPDATE odb_decisions notes SET moyenne=ROUND((moyenne*coeff+$points)/(coeff+1),$iPrecision), coeff=coeff+1 where notes.id_table='$id_table'"</span>;
<a name="l00179"></a>00179                                 <span class="keywordflow">else</span> <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"UPDATE odb_decisions notes SET moyenne=ROUND(moyenne+$points/coeff,$iPrecision) where notes.id_table='$id_table'"</span>;
<a name="l00180"></a>00180                                 <span class="comment">//echo "&lt;br/&gt;$sql";</span>
<a name="l00181"></a>00181                                 <a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00182"></a>00182                         }
<a name="l00183"></a>00183                 }
<a name="l00184"></a>00184                 $tSql[]=<span class="stringliteral">"UPDATE odb_decisions decis, odb_notes notes $from_jury SET decis.delib2 = 'Reserve'\n"</span>.
<a name="l00185"></a>00185                 <span class="stringliteral">" WHERE notes.id_table = decis.id_table $where_jury\n and decis.annee=$annee and notes.annee=$annee and notes.id_matiere=-3 and notes.note=0"</span>;
<a name="l00186"></a>00186                 $tSql[]=<span class="stringliteral">"UPDATE odb_decisions notes $from_jury SET notes.delib2 = 'Oral'\n WHERE moyenne &gt;= 9 and moyenne&lt;10 AND notes.delib2!='Reserve' $where_jury and notes.annee=$annee"</span>;
<a name="l00187"></a>00187                 $tSql[]=<span class="stringliteral">"UPDATE odb_decisions notes $from_jury SET notes.delib2 = 'Passable'\n WHERE moyenne &gt;= 10 and moyenne&lt;12 AND notes.delib2!='Reserve' $where_jury and notes.annee=$annee"</span>;
<a name="l00188"></a>00188                 $tSql[]=<span class="stringliteral">"UPDATE odb_decisions notes $from_jury SET notes.delib2 = 'ABien'\n WHERE moyenne &gt;= 12 and moyenne&lt;14 AND notes.delib2!='Reserve' $where_jury and notes.annee=$annee"</span>;
<a name="l00189"></a>00189                 $tSql[]=<span class="stringliteral">"UPDATE odb_decisions notes $from_jury SET notes.delib2 = 'Bien'\n WHERE moyenne &gt;= 14 and moyenne&lt;16 AND notes.delib2!='Reserve' $where_jury and notes.annee=$annee"</span>;
<a name="l00190"></a>00190                 $tSql[]=<span class="stringliteral">"UPDATE odb_decisions notes $from_jury SET notes.delib2 = 'TBien'\n WHERE moyenne &gt;= 16 AND notes.delib2!='Reserve' $where_jury and notes.annee=$annee"</span>;
<a name="l00191"></a>00191                 <span class="keywordflow">foreach</span>($tSql as <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>) {
<a name="l00192"></a>00192                         <a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>($sql,__FILE__,__LINE__);
<a name="l00193"></a>00193                         <span class="comment">//echo mysql_affected_rows()." lignes :&lt;pre&gt;$sql&lt;/pre&gt;\n";</span>
<a name="l00194"></a>00194                 }
<a name="l00195"></a>00195         } elseif (<a class="code" href="inc-pdf-attestations_8php.html#dd57477ad14361f5834629e405ff5478">$deliberation</a>==3) {
<a name="l00196"></a>00196                 <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT notes.id_table, note, id_matiere, notes.coeff\n from odb_notes notes, odb_decisions decis $from_jury\n where decis.id_table=notes.id_table and delib2='Oral' and delib3='-' and notes.type='Oral' $where_jury"</span>;
<a name="l00197"></a>00197                 <span class="comment">//die("&lt;pre&gt;$sql");</span>
<a name="l00198"></a>00198                 <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00199"></a>00199                 $tCR=array();
<a name="l00200"></a>00200                 <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00201"></a>00201                         <span class="keywordflow">foreach</span>(array('coeff<span class="charliteral">','</span>id_table<span class="charliteral">','</span>note') as $col) $$col=$row[$col];
<a name="l00202"></a>00202                         <span class="keywordflow">if</span>($note&lt;=0) {
<a name="l00203"></a>00203                                 $tCR[<a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>]=<span class="keyword">true</span>; <span class="comment">// cas reserve</span>
<a name="l00204"></a>00204                                 $tNote[<a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>]+=0;
<a name="l00205"></a>00205                                 $tCoeff[<a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>]+=$coeff;
<a name="l00206"></a>00206                                 <span class="comment">//echo "$id_table $note/20 $coeff - $tCoeff[$id_table] -  RESERVE&lt;br/&gt;";</span>
<a name="l00207"></a>00207                         } <span class="keywordflow">else</span> {
<a name="l00208"></a>00208                                 $tCoeff[<a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>]+=$coeff;
<a name="l00209"></a>00209                                 $tNote[<a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>]+=(int)$note*$coeff;
<a name="l00210"></a>00210                                 <span class="comment">//echo "$id_table $note/20 $coeff&lt;br/&gt;";</span>
<a name="l00211"></a>00211                         }
<a name="l00212"></a>00212                         
<a name="l00213"></a>00213                         <span class="comment">//echo "$id_table $note/20 $coeff - $tCoeff[$id_table]&lt;br/&gt;";</span>
<a name="l00214"></a>00214                 }
<a name="l00215"></a>00215                 <span class="keywordflow">if</span>(is_array($tNote)) {
<a name="l00216"></a>00216                         <span class="keywordflow">foreach</span>($tNote as <a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>=&gt;$points) {
<a name="l00217"></a>00217                                 $coeff=$tCoeff[<a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>];
<a name="l00218"></a>00218                                 <span class="keywordflow">if</span>($tCR[<a class="code" href="inc-pdf-convocation_8php.html#295929cd9243ffe88a7c63fc065d7e9e">$id_table</a>]) {
<a name="l00219"></a>00219                                         <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"UPDATE odb_decisions notes SET delib3='Reserve', moyenne=ROUND((moyenne*coeff+$points)/(coeff+$coeff),$iPrecision), coeff=coeff+$coeff\n where notes.id_table='$id_table'"</span>;
<a name="l00220"></a>00220                                         <span class="comment">//echo "$id_table RESERVE&lt;br/&gt;";</span>
<a name="l00221"></a>00221                                 } <span class="keywordflow">else</span> {
<a name="l00222"></a>00222                                         <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"UPDATE odb_decisions notes SET delib3='Passable', moyenne=ROUND((moyenne*coeff+$points)/(coeff+$coeff),$iPrecision), coeff=coeff+$coeff\n where notes.id_table='$id_table'"</span>;
<a name="l00223"></a>00223                                 }
<a name="l00224"></a>00224                                 <span class="comment">//echo "&lt;br/&gt;$sql";</span>
<a name="l00225"></a>00225                                 <a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00226"></a>00226                                 
<a name="l00227"></a>00227                         }
<a name="l00228"></a>00228                 }
<a name="l00229"></a>00229                 <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"UPDATE odb_decisions notes $from_jury SET delib3='Reserve'\n where delib2='Reserve' and delib1='Admissible' $where_jury"</span>;
<a name="l00230"></a>00230                 <a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00231"></a>00231                 <span class="comment">//echo mysql_affected_rows()." lignes :&lt;pre&gt;$sql&lt;/pre&gt;\n";</span>
<a name="l00232"></a>00232 
<a name="l00233"></a>00233         } <span class="keywordflow">else</span> die(<a class="code" href="odb__ref_8php.html#e56b96c4dfcced36887ba02c496c40a3">KO</a>.<span class="stringliteral">" - Deliberation inattendue : $deliberation"</span>);
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 <span class="comment">// V&amp;eacute;rifie si la valeur est dans le r&amp;eacute;f&amp;eacute;rentiel</span>
<a name="l00237"></a>00237 <span class="comment">// Sorties : ["isFound"] : odb_referentiel.[id|valeur] si trouv&amp;eacute; (d&amp;eacute;pend de $chercherValeurEtPasId), false sinon</span>
<a name="l00238"></a>00238 <span class="comment">//           ["valeursPossibles"] : valeurs possibles pour ce r&amp;eacute;f&amp;eacute;rentiel</span>
<a name="l00239"></a><a class="code" href="inc-referentiel_8php.html#34801d7492d31569357873533e30d04d">00239</a> function <a class="code" href="inc-referentiel_8php.html#34801d7492d31569357873533e30d04d">isInReferentiel</a> ($valeurOuId,$referentiel,$chercherValeurEtPasId) {
<a name="l00240"></a>00240    <span class="keyword">static</span> $aErreurs = array();
<a name="l00241"></a>00241    <span class="keyword">static</span> $tab_referentiel = array();
<a name="l00242"></a>00242    <span class="keywordflow">if</span>(!isset($tab_referentiel['departements']))
<a name="l00243"></a>00243       $tab_referentiel['departements']=<a class="code" href="inc-referentiel_8php.html#8da6b5d71b8b85a4443092e825841479">getReferentiel</a>('departement<span class="charliteral">','</span>tout');
<a name="l00244"></a>00244    <span class="keywordflow">if</span>(trim($referentiel)==<span class="stringliteral">""</span> || trim($chercherValeurEtPasId)==<span class="stringliteral">""</span>)
<a name="l00245"></a>00245       die (<span class="stringliteral">"Valeur/ID [$valeurOuId]&lt;br/&gt;R&amp;eacute;f&amp;eacute;rentiel [$referentiel]&lt;br/&gt;Chercher Valeur (et pas Id) [$chercherValeurEtPasId]\n"</span>);
<a name="l00246"></a>00246    <span class="keywordflow">if</span>(!is_array($tab_referentiel[$referentiel]))
<a name="l00247"></a>00247       $tab_referentiel[$referentiel]=<a class="code" href="inc-referentiel_8php.html#8da6b5d71b8b85a4443092e825841479">getReferentiel</a>($referentiel,'tout');
<a name="l00248"></a>00248    $isFound=<span class="keyword">false</span>;
<a name="l00249"></a>00249    <span class="comment">//$valeurs_possibles="&lt;A NAME='$referentiel".'_'.$valeurOuId."'&gt;&lt;/A&gt;\n";</span>
<a name="l00250"></a>00250    <span class="keywordflow">if</span>(!is_array($tab_referentiel[$referentiel]))
<a name="l00251"></a>00251       $valeurs_possibles=<span class="stringliteral">"&lt;li&gt;R&amp;eacute;f&amp;eacute;rentiel &lt;b&gt;[$referentiel]&lt;/b&gt; introuvable&lt;/li&gt;\n"</span>;
<a name="l00252"></a>00252    <span class="keywordflow">else</span> {
<a name="l00253"></a>00253       <span class="keywordflow">foreach</span>($tab_referentiel[$referentiel] as $valeurRef =&gt; $idRef) {
<a name="l00254"></a>00254          <span class="keywordflow">if</span>(!$aErreurs[$referentiel][$valeurOuId])
<a name="l00255"></a>00255             <span class="keywordflow">if</span>(!is_numeric($valeurRef)) {
<a name="l00256"></a>00256                $valeurs_possibles.=<span class="stringliteral">"\t&lt;li&gt;$valeurRef [$idRef]&lt;/li&gt;\n"</span>;
<a name="l00257"></a>00257                <span class="keywordflow">if</span>($chercherValeurEtPasId) {
<a name="l00258"></a>00258                   <span class="keywordflow">if</span>(strtolower(<a class="code" href="inc-html_8php.html#5b029790bb0355c3329199b4a8cdd8b8" title="Supprime les accents et enleve les espaces inutiles.">supprimeAccents</a>($valeurOuId))==strtolower(<a class="code" href="inc-html_8php.html#5b029790bb0355c3329199b4a8cdd8b8" title="Supprime les accents et enleve les espaces inutiles.">supprimeAccents</a>($valeurRef)))
<a name="l00259"></a>00259                      $isFound=$idRef;
<a name="l00260"></a>00260                } <span class="keywordflow">else</span> {
<a name="l00261"></a>00261                   <span class="keywordflow">if</span>($valeurOuId==$idRef)
<a name="l00262"></a>00262                      $isFound=$valeurRef;
<a name="l00263"></a>00263                }
<a name="l00264"></a>00264             }
<a name="l00265"></a>00265             elseif(is_array($idRef)) {
<a name="l00266"></a>00266                <span class="comment">//echo "&lt;pre&gt;$referentiel";print_r($tab_referentiel[$referentiel]);echo "&lt;/pre&gt;";</span>
<a name="l00267"></a>00267                $id_dept=$valeurRef;
<a name="l00268"></a>00268                $tab_la_valeur=$idRef;
<a name="l00269"></a>00269                <span class="comment">//foreach($tab_referentiel[$referentiel] as $id_dept =&gt; $tab_la_valeur) {</span>
<a name="l00270"></a>00270                   $valeurs_possibles .=<span class="stringliteral">"&lt;/ul&gt;\n&amp;Eacute;tablissements &lt;b&gt;"</span>.$tab_referentiel['departements'][$id_dept].<span class="stringliteral">"&lt;/b&gt; [$id_dept]&lt;ul&gt;\n"</span>;
<a name="l00271"></a>00271                   <span class="keywordflow">foreach</span>($tab_la_valeur as $la_valeur =&gt; $le_id) {
<a name="l00272"></a>00272                      <span class="keywordflow">if</span>(!is_numeric($la_valeur))
<a name="l00273"></a>00273                         $valeurs_possibles.=<span class="stringliteral">"\t&lt;li&gt;$la_valeur [$le_id]&lt;/li&gt;\n"</span>;
<a name="l00274"></a>00274                      <span class="keywordflow">if</span>($chercherValeurEtPasId) {
<a name="l00275"></a>00275                         <span class="comment">//echo '&lt;br/&gt;'.strtolower(supprimeAccents($valeurOuId)).'='.strtolower(supprimeAccents($la_valeur));</span>
<a name="l00276"></a>00276                         <span class="keywordflow">if</span>(strtolower(<a class="code" href="inc-html_8php.html#5b029790bb0355c3329199b4a8cdd8b8" title="Supprime les accents et enleve les espaces inutiles.">supprimeAccents</a>($valeurOuId))==strtolower(<a class="code" href="inc-html_8php.html#5b029790bb0355c3329199b4a8cdd8b8" title="Supprime les accents et enleve les espaces inutiles.">supprimeAccents</a>($la_valeur)))
<a name="l00277"></a>00277                            $isFound=$le_id;
<a name="l00278"></a>00278                      } <span class="keywordflow">else</span> {
<a name="l00279"></a>00279                         <span class="keywordflow">if</span>($valeurOuId==$le_id)
<a name="l00280"></a>00280                            $isFound=$la_valeur;
<a name="l00281"></a>00281                      }
<a name="l00282"></a>00282                   }
<a name="l00283"></a>00283                <span class="comment">//}</span>
<a name="l00284"></a>00284                <span class="comment">//die("&lt;ul&gt;$valeurs_possibles&lt;/ul&gt;");</span>
<a name="l00285"></a>00285             }
<a name="l00286"></a>00286       }
<a name="l00287"></a>00287    }
<a name="l00288"></a>00288    <span class="keywordflow">if</span> (!$isFound) {
<a name="l00289"></a>00289       <span class="keywordflow">if</span>(!$aErreurs[$referentiel][$valeurOuId]) {
<a name="l00290"></a>00290          $aErreurs[$referentiel][$valeurOuId]=<span class="keyword">true</span>;
<a name="l00291"></a>00291       } <span class="keywordflow">else</span> {
<a name="l00292"></a>00292          $valeurs_possibles=<span class="stringliteral">"Erreur d&amp;eacute;j&amp;agrave; rencontr&amp;eacute;e : "</span>.$referentiel
<a name="l00293"></a>00293                            .<span class="stringliteral">"[&lt;A HREF='#"</span>.$referentiel.<span class="charliteral">'_'</span>.$valeurOuId
<a name="l00294"></a>00294                            .<span class="stringliteral">"'&gt;$valeurOuId&lt;/A&gt;]\n"</span>
<a name="l00295"></a>00295                            ;
<a name="l00296"></a>00296       }
<a name="l00297"></a>00297    }
<a name="l00298"></a>00298    $isInRef[<span class="stringliteral">"valeursPossibles"</span>]=$valeurs_possibles;
<a name="l00299"></a>00299    $isInRef[<span class="stringliteral">"isFound"</span>]=$isFound;
<a name="l00300"></a>00300    <span class="keywordflow">return</span> $isInRef;
<a name="l00301"></a>00301 }
<a name="l00302"></a>00302  
<a name="l00312"></a><a class="code" href="inc-referentiel_8php.html#c23eab81895f040f0ff6f3ee312a7f63">00312</a> function <a class="code" href="inc-referentiel_8php.html#c23eab81895f040f0ff6f3ee312a7f63" title="Cree les OPTIONS tirees du referentiel passe en parametre.">formOptionsRefInSelect</a> ($referentiel,$valeur_defaut,$label='',$id_departement='') {
<a name="l00313"></a>00313    <span class="comment">//echo "$referentiel,$valeur_defaut,$label,$id_departement&lt;hr/&gt;";</span>
<a name="l00314"></a>00314    global $tab_referentiel__,<a class="code" href="inc-fichiers_8php.html#58f5fd0b9d70bc87295be959c7bc176a">$debug</a>;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316    <span class="keyword">static</span> $pb = array();
<a name="l00317"></a>00317    <span class="keyword">static</span> $cpt_bidon=0;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319    unset($tab_referentiel);
<a name="l00320"></a>00320    <span class="keywordflow">if</span>($referentiel=='centres') $tab_referentiel=<a class="code" href="inc-referentiel_8php.html#8da6b5d71b8b85a4443092e825841479">getReferentiel</a>('centre<span class="charliteral">','</span><span class="keywordtype">id</span>');
<a name="l00321"></a>00321    elseif($referentiel=='villes') $tab_referentiel=<a class="code" href="inc-referentiel_8php.html#8da6b5d71b8b85a4443092e825841479">getReferentiel</a>('ville<span class="charliteral">','</span><span class="keywordtype">id</span>');
<a name="l00322"></a>00322    elseif($referentiel=='etablissements') $tab_referentiel=<a class="code" href="inc-referentiel_8php.html#8da6b5d71b8b85a4443092e825841479">getReferentiel</a>('etablissement<span class="charliteral">','</span><span class="keywordtype">id</span>');
<a name="l00323"></a>00323    <span class="keywordflow">else</span> $tab_referentiel=<a class="code" href="inc-referentiel_8php.html#8da6b5d71b8b85a4443092e825841479">getReferentiel</a>($referentiel,'<span class="keywordtype">id</span>');
<a name="l00324"></a>00324 
<a name="l00325"></a>00325    <span class="keywordflow">if</span>($label==<span class="stringliteral">""</span>) $label=ucwords($referentiel);
<a name="l00326"></a>00326 
<a name="l00327"></a>00327    <span class="keywordflow">switch</span>(strtolower($referentiel)) {
<a name="l00328"></a>00328       <span class="keywordflow">case</span> 'etablissements':
<a name="l00329"></a>00329       <span class="keywordflow">case</span> 'centres':
<a name="l00330"></a>00330       <span class="keywordflow">case</span> 'villes':
<a name="l00331"></a>00331          <span class="keywordflow">if</span>($id_departement=='') <span class="keywordflow">if</span> ($debug) echo <span class="stringliteral">"&lt;u&gt;/!&lt;/u&gt; id_departement n'a pas t saisi pour un $referentiel  l'appel de "</span>.__FUNCTION__;
<a name="l00332"></a>00332          <span class="comment">//echo'&lt;hr/&gt;&lt;pre&gt;tab_referentiel';print_r($tab_referentiel);echo'&lt;/pre&gt;';</span>
<a name="l00333"></a>00333          $ref_dept=<a class="code" href="inc-referentiel_8php.html#8da6b5d71b8b85a4443092e825841479">getReferentiel</a>('departement<span class="charliteral">','</span><span class="keywordtype">id</span>');
<a name="l00334"></a>00334          ksort($ref_dept);
<a name="l00335"></a>00335          <span class="comment">//echo'&lt;hr/&gt;&lt;pre&gt;ref_dept';print_r($ref_dept);echo'&lt;/pre&gt;';</span>
<a name="l00336"></a>00336          $str.=<a class="code" href="inc-html_8php.html#7be54cdf2beda343e02419f1ac46fa0c" title="Cree un champ OPTION dans un SELECT.">formOptionsInSelect</a>(<span class="stringliteral">"-=[$label]=-"</span>,0,$valeur_defaut);
<a name="l00337"></a>00337          <span class="keywordflow">foreach</span>($ref_dept as $dept =&gt; $id_dept) {
<a name="l00338"></a>00338             <span class="keywordflow">if</span>(is_string($dept)) {
<a name="l00339"></a>00339                $str.=<span class="stringliteral">"&lt;optgroup label='$dept'&gt;\n"</span>;
<a name="l00340"></a>00340                ksort($tab_referentiel[$id_dept]);
<a name="l00341"></a>00341                <span class="keywordflow">foreach</span>($tab_referentiel[$id_dept] as $valeur =&gt; $id) {
<a name="l00342"></a>00342                   <span class="keywordflow">if</span>(is_string($valeur))
<a name="l00343"></a>00343                      $str.=<a class="code" href="inc-html_8php.html#7be54cdf2beda343e02419f1ac46fa0c" title="Cree un champ OPTION dans un SELECT.">formOptionsInSelect</a>($valeur,$id,$valeur_defaut);
<a name="l00344"></a>00344                }
<a name="l00345"></a>00345             }
<a name="l00346"></a>00346          }
<a name="l00347"></a>00347          <span class="keywordflow">break</span>;
<a name="l00348"></a>00348       <span class="keywordflow">case</span> 'etablissement':
<a name="l00349"></a>00349         <span class="keywordflow">if</span>($id_departement=='') die(<a class="code" href="odb__ref_8php.html#e56b96c4dfcced36887ba02c496c40a3">KO</a>.<span class="stringliteral">" &lt;b&gt;id_departement&lt;/b&gt; n'a pas t saisi pour un &lt;b&gt;&amp;eacute;tablissement&lt;/b&gt; &amp;agrave; l'appel de &lt;i&gt;"</span>.__FUNCTION__.'&lt;/i&gt;');
<a name="l00350"></a>00350         $isDepartement=<span class="keyword">true</span>;
<a name="l00351"></a>00351       <span class="keywordflow">case</span> 'centre':
<a name="l00352"></a>00352         <span class="keywordflow">if</span>(!$isDepartement) {
<a name="l00353"></a>00353                                 <span class="keywordflow">if</span>($id_departement=='') die(<a class="code" href="odb__ref_8php.html#e56b96c4dfcced36887ba02c496c40a3">KO</a>.<span class="stringliteral">" &lt;b&gt;id_departement&lt;/b&gt; n'a pas t saisi pour un &lt;b&gt;centre&lt;/b&gt; &amp;agrave; l'appel de &lt;i&gt;"</span>.__FUNCTION__.'&lt;/i&gt;');
<a name="l00354"></a>00354                                 $isCentre=<span class="keyword">true</span>;
<a name="l00355"></a>00355                         }
<a name="l00356"></a>00356       <span class="keywordflow">case</span> 'ville':
<a name="l00357"></a>00357          <span class="keywordflow">if</span>($id_departement=='') <span class="keywordflow">if</span> ($debug) echo <span class="stringliteral">"&lt;u&gt;/!&lt;/u&gt; id_departement n'a pas t saisi pour une &lt;b&gt;ville&lt;/b&gt; &amp;agrave; l'appel de "</span>.__FUNCTION__;
<a name="l00358"></a>00358          $isDepartement=<span class="keyword">true</span>;
<a name="l00359"></a>00359          $tab_ref=$tab_referentiel[$id_departement];
<a name="l00360"></a>00360          <span class="keywordflow">if</span>(count($tab_ref)==0) {
<a name="l00361"></a>00361             <span class="keywordflow">if</span>(!$pb[$referentiel]) {
<a name="l00362"></a>00362                $pb[$referentiel]=<span class="keyword">true</span>;
<a name="l00363"></a>00363                <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>= <span class="stringliteral">"Aucun(e) &lt;b&gt;$label&lt;/b&gt; n'a &amp;eacute;t&amp;eacute; trouv&amp;eacute;(e) dans le contexte, &lt;br/&gt;&lt;i&gt;Conseil : &lt;/i&gt;\n"</span>;
<a name="l00364"></a>00364                <span class="keywordflow">if</span>($referentiel=='ville') {
<a name="l00365"></a>00365                   <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>.= <span class="stringliteral">"Modifiez le &lt;A HREF='"</span>.generer_url_ecrire('odb_ref').<span class="stringliteral">"&amp;table=odb_ref_ville&amp;step2=manuel'&gt;r&amp;eacute;f&amp;eacute;rentiel &lt;b&gt;$label&lt;/b&gt;&lt;/a&gt;&lt;br/&gt;\n"</span>;
<a name="l00366"></a>00366                } elseif($referentiel=='centre') {
<a name="l00367"></a>00367                   <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>.= <span class="stringliteral">"Commencez par attribuer des centres en choisissant une ann&amp;eacute;e pour chaque &amp;eacute;tablissement qui est centre de composition&lt;br/&gt;"</span>;
<a name="l00368"></a>00368                } <span class="keywordflow">else</span> {
<a name="l00369"></a>00369                   <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>.= <span class="stringliteral">"Commencez par r&amp;eacute;soudre ce probl&amp;egrave;me&lt;br/&gt;"</span>;
<a name="l00370"></a>00370                }
<a name="l00371"></a>00371                echo <a class="code" href="inc-html_8php.html#af111db152a79e88015b3a80345d0cdd" title="affiche une boite de message">boite_important</a>(<a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>,'&lt;!&gt;');
<a name="l00372"></a>00372             }
<a name="l00373"></a>00373          <span class="comment">//echo'&lt;pre&gt;';print_r($tab_referentiel);echo'&lt;/pre&gt;';</span>
<a name="l00374"></a>00374          } <span class="keywordflow">else</span> {
<a name="l00375"></a>00375             unset($tab_referentiel);
<a name="l00376"></a>00376             $tab_referentiel=$tab_ref;
<a name="l00377"></a>00377             <span class="keywordflow">if</span>($cpt_bidon++ &lt;5) {
<a name="l00378"></a>00378                <span class="comment">//echo "&lt;pre&gt;--- tab_referentiel $referentiel $valeur_defaut ---";print_r($tab_referentiel);echo '&lt;/pre&gt;';</span>
<a name="l00379"></a>00379             }
<a name="l00380"></a>00380          }
<a name="l00381"></a>00381       <span class="keywordflow">default</span>:
<a name="l00382"></a>00382          ksort($tab_referentiel);
<a name="l00383"></a>00383          <span class="comment">//echo"&lt;pre&gt;";print_r($tab_referentiel);echo"&lt;/pre&gt;";</span>
<a name="l00384"></a>00384          $str.=<a class="code" href="inc-html_8php.html#7be54cdf2beda343e02419f1ac46fa0c" title="Cree un champ OPTION dans un SELECT.">formOptionsInSelect</a>(<span class="stringliteral">"-=[$label]=-"</span>,0,$valeur_defaut);
<a name="l00385"></a>00385          <span class="keywordflow">if</span>(count($tab_referentiel&gt;20)) $estGrand=<span class="keyword">true</span>; <span class="keywordflow">else</span> $estGrand=<span class="keyword">false</span>;
<a name="l00386"></a>00386          $formSelect='';
<a name="l00387"></a>00387          <span class="keywordflow">foreach</span>($tab_referentiel as $valeur =&gt; $id) {
<a name="l00388"></a>00388                 <span class="keywordflow">if</span>(strtolower(<a class="code" href="inc-html_8php.html#5b029790bb0355c3329199b4a8cdd8b8" title="Supprime les accents et enleve les espaces inutiles.">supprimeAccents</a>($valeur))==<a class="code" href="inc-referentiel_8php.html#250a58ff3386f8733afc86c93a171d7f">PAYS</a>) $str.=<a class="code" href="inc-html_8php.html#7be54cdf2beda343e02419f1ac46fa0c" title="Cree un champ OPTION dans un SELECT.">formOptionsInSelect</a>($valeur,$id,$valeur_defaut);
<a name="l00389"></a>00389             <span class="keywordflow">if</span>(is_string($valeur)) {
<a name="l00390"></a>00390                <span class="keywordflow">if</span>($estGrand) {
<a name="l00391"></a>00391                   $lettre=$valeur[0];
<a name="l00392"></a>00392                   <span class="keywordflow">if</span>($lettre!=$oldLettre)
<a name="l00393"></a>00393                      $formSelect.=<span class="stringliteral">"&lt;/optgroup&gt;\n&lt;optgroup label='"</span>.strtoupper($lettre).<span class="stringliteral">"'&gt;\n"</span>;
<a name="l00394"></a>00394                }
<a name="l00395"></a>00395                <span class="keywordflow">if</span>(strlen($valeur)&gt;29) $valeur_aff=substr($valeur, 0, 29).'...';
<a name="l00396"></a>00396                <span class="keywordflow">else</span> $valeur_aff=$valeur;
<a name="l00397"></a>00397                $formSelect.=<a class="code" href="inc-html_8php.html#7be54cdf2beda343e02419f1ac46fa0c" title="Cree un champ OPTION dans un SELECT.">formOptionsInSelect</a>($valeur_aff,$id,$valeur_defaut);
<a name="l00398"></a>00398                $oldLettre=$valeur[0];
<a name="l00399"></a>00399             }
<a name="l00400"></a>00400          }
<a name="l00401"></a>00401          
<a name="l00402"></a>00402          $str.=$formSelect;
<a name="l00403"></a>00403    }
<a name="l00404"></a>00404    <span class="keywordflow">return</span> $str;
<a name="l00405"></a>00405    <span class="comment">//echo "&lt;hr&gt;$str&lt;/hr&gt;";</span>
<a name="l00406"></a>00406 }
<a name="l00407"></a>00407 
<a name="l00408"></a>00408 <span class="comment">// cree une ligne (2 colonnes) avec liste provenant du r&amp;eacute;f&amp;eacute;rentiel</span>
<a name="l00409"></a><a class="code" href="inc-referentiel_8php.html#caa8fb22e017e5edd73e572b1c091189">00409</a> function <a class="code" href="inc-referentiel_8php.html#caa8fb22e017e5edd73e572b1c091189">formSelectRefInTR</a>($label,$name,$referentiel,$valeur_defaut,$html=<span class="stringliteral">""</span>,$id_departement='') {
<a name="l00410"></a>00410    $str=<a class="code" href="inc-html_8php.html#9e275c42206610f6e5a60fb84f386886" title="Debut de balise SELECT dans un TR.">formSelectTR1</a>($label,$name,$html);
<a name="l00411"></a>00411    <span class="keywordflow">if</span>($referentiel==<span class="stringliteral">""</span>) die (<a class="code" href="odb__ref_8php.html#e56b96c4dfcced36887ba02c496c40a3">KO</a>.<span class="stringliteral">" - Param&amp;egrave;tre r&amp;eacute;f&amp;eacute;rentiel mal pass&amp;eacute;  "</span>.__FUNCTION__.<span class="stringliteral">" dans "</span>.__FILE__.<span class="stringliteral">" ligne "</span>.__LINE__);
<a name="l00412"></a>00412    $str.=<a class="code" href="inc-referentiel_8php.html#c23eab81895f040f0ff6f3ee312a7f63" title="Cree les OPTIONS tirees du referentiel passe en parametre.">formOptionsRefInSelect</a>(strtolower($referentiel),$valeur_defaut,$label,$id_departement);
<a name="l00413"></a>00413    $str.=<a class="code" href="inc-html_8php.html#6479fd1beeb46ce4b7261b9054a8ccb1" title="Fin de balise SELECT dans un TR.">formSelectTR2</a>();
<a name="l00414"></a>00414  
<a name="l00415"></a>00415    <span class="keywordflow">return</span> $str;
<a name="l00416"></a>00416 }
<a name="l00417"></a>00417 
<a name="l00430"></a><a class="code" href="inc-referentiel_8php.html#c6883d9c334e278e5a3ca040f8b16cc2">00430</a> function <a class="code" href="inc-referentiel_8php.html#c6883d9c334e278e5a3ca040f8b16cc2" title="cree une liste SELECT a partir des resultats d&amp;#39;une requete SQL pour un referentiel...">formSelectQueryRef</a>($label, $name, <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>, $myChamp, $referentiel, $id_defaut, $html='') {
<a name="l00431"></a>00431    $sqlRef=<span class="stringliteral">"SELECT id, $referentiel from odb_ref_$referentiel order by $referentiel"</span>;
<a name="l00432"></a>00432    <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>($sqlRef,__FILE__,__LINE__);
<a name="l00433"></a>00433    $tab_ref=array();
<a name="l00434"></a>00434    <span class="keywordflow">while</span>($row = mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00435"></a>00435       $tab_ref[$row['<span class="keywordtype">id</span>']]=$row[$referentiel];
<a name="l00436"></a>00436    }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438    $str='';
<a name="l00439"></a>00439    $str.=<span class="stringliteral">"&lt;SELECT NAME='$name' $html&gt;\n"</span>;
<a name="l00440"></a>00440    $selected=(trim($id_defaut)=='')?'SELECTED<span class="charliteral">':'</span>';
<a name="l00441"></a>00441    $str.=<span class="stringliteral">"&lt;OPTION VALUE='' $selected&gt;-=[$label]=-&lt;/OPTION&gt;\n"</span>;
<a name="l00442"></a>00442    <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00443"></a>00443    <span class="keywordflow">while</span>($row = mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00444"></a>00444       $id=$row[$myChamp];
<a name="l00445"></a>00445       $champ=$tab_ref[$id];
<a name="l00446"></a>00446       $selected=($id==$id_defaut)?'SELECTED<span class="charliteral">':'</span>';
<a name="l00447"></a>00447       $str.= <span class="stringliteral">"&lt;OPTION VALUE='$id' $selected&gt;$champ&lt;/OPTION&gt;\n"</span>;
<a name="l00448"></a>00448    }
<a name="l00449"></a>00449    $str.=<span class="stringliteral">"&lt;/SELECT&gt;\n"</span>;
<a name="l00450"></a>00450    <span class="keywordflow">return</span> $str;
<a name="l00451"></a>00451 }
<a name="l00452"></a>00452 
<a name="l00465"></a><a class="code" href="inc-referentiel_8php.html#07bef630f993c827650782c7a4588b21">00465</a> function <a class="code" href="inc-referentiel_8php.html#07bef630f993c827650782c7a4588b21" title="cree une liste SELECT a partir des resultats d&amp;#39;une requete SQL">formSelectQuery</a>($label, $name, <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>, $myChamp, $defaut, $html='', $myValue='') {
<a name="l00466"></a>00466    $str='';
<a name="l00467"></a>00467    $str.=<span class="stringliteral">"&lt;SELECT NAME='$name' $html&gt;\n"</span>;
<a name="l00468"></a>00468    $selected=(trim($defaut)=='')?'SELECTED<span class="charliteral">':'</span>';
<a name="l00469"></a>00469    $str.=<span class="stringliteral">"&lt;OPTION VALUE='' $selected&gt;-=[$label]=-&lt;/OPTION&gt;\n"</span>;
<a name="l00470"></a>00470    <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00471"></a>00471    <span class="keywordflow">while</span>($row = mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00472"></a>00472       $champ=$row[$myChamp];
<a name="l00473"></a>00473       <span class="keywordflow">if</span>($myValue=='') $value=$champ;
<a name="l00474"></a>00474       <span class="keywordflow">else</span> $value=$row[$myValue];
<a name="l00475"></a>00475       $selected=($value==$defaut)?'SELECTED<span class="charliteral">':'</span>'; 
<a name="l00476"></a>00476       $str.= <span class="stringliteral">"&lt;OPTION VALUE='$value' $selected&gt;$champ&lt;/OPTION&gt;\n"</span>;
<a name="l00477"></a>00477    }
<a name="l00478"></a>00478    $str.=<span class="stringliteral">"&lt;/SELECT&gt;\n"</span>;
<a name="l00479"></a>00479    <span class="keywordflow">return</span> $str;
<a name="l00480"></a>00480 }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 <span class="comment">//affiche les raccourcis ODB (attention : ecrit directement dans le flux cause spip)</span>
<a name="l00483"></a><a class="code" href="inc-referentiel_8php.html#ca269ae75f013c9730f590443481c7f9">00483</a> function <a class="code" href="inc-referentiel_8php.html#ca269ae75f013c9730f590443481c7f9">odb_raccourcis</a>($ref_courrant) {
<a name="l00484"></a>00484    debut_raccourcis();
<a name="l00485"></a>00485                 <span class="keywordflow">if</span>($ref_courrant!=<span class="stringliteral">"odb_ref"</span>)
<a name="l00486"></a>00486                         icone_horizontale (_L('R&amp;<a class="code" href="inc-pdf-table_8php.html#1c3d7fb9d2f4e0216017175154061426">eacute</a>;f&amp;<a class="code" href="inc-pdf-table_8php.html#1c3d7fb9d2f4e0216017175154061426">eacute</a>;rentiel ODB'), generer_url_ecrire(<span class="stringliteral">"odb_ref"</span>), <span class="stringliteral">"../"</span>.<a class="code" href="inc-odb__ref_8php.html#76319c6fdabb160dcfd10671480a2ed7">_DIR_PLUGIN_ODB_REF</a>.<span class="stringliteral">"/img_pack/siou_carre.png"</span>);
<a name="l00487"></a>00487                 <span class="keywordflow">if</span>($ref_courrant!=<span class="stringliteral">"odb_saisie"</span>)
<a name="l00488"></a>00488                         icone_horizontale (_L('Saisie ODB'), generer_url_ecrire(<span class="stringliteral">"odb_saisie"</span>), <span class="stringliteral">"../"</span>.<a class="code" href="inc-odb__saisie_8php.html#dc3dc64a8aa549177185660abb160f0c">_DIR_PLUGIN_ODB_SAISIE</a>.<span class="stringliteral">"/img_pack/siou_carre.png"</span>);
<a name="l00489"></a>00489                 <span class="keywordflow">if</span>($ref_courrant!=<span class="stringliteral">"odb_repartition"</span>)
<a name="l00490"></a>00490                         icone_horizontale (_L('R&amp;eacute;partition candidats'), generer_url_ecrire(<span class="stringliteral">"odb_repartition"</span>), <span class="stringliteral">"../"</span>.<a class="code" href="inc-odb__repartition_8php.html#11ee20e9f2854148d2c4defad4f70990">_DIR_PLUGIN_ODB_REPARTITION</a>.<span class="stringliteral">"/img_pack/siou_carre.png"</span>);
<a name="l00491"></a>00491    fin_raccourcis();
<a name="l00492"></a>00492 
<a name="l00493"></a>00493 }
<a name="l00494"></a>00494 
<a name="l00503"></a><a class="code" href="inc-referentiel_8php.html#8a347b23cd689ac91a0c11390ae5a7e4">00503</a> function <a class="code" href="inc-referentiel_8php.html#8a347b23cd689ac91a0c11390ae5a7e4" title="Introspection du referentiel pour l&amp;#39;annee specifiee Consiste a verifier l&amp;#39;integrite...">odb_introspection</a>(<a class="code" href="inc-pdf-attestations_8php.html#b372e2dd50f4a592a1226a01290a2f4f">$annee</a>) {
<a name="l00504"></a>00504    global $tab_referentiel;
<a name="l00505"></a>00505    <span class="keywordflow">if</span>(in_array(<a class="code" href="inc-odb_8php.html#147d380870b3247e67b18fd9d7adf910" title="Determine le type d&amp;#39;utilisateur.">getStatutUtilisateur</a>(),array('Admin<span class="charliteral">','</span>Encadrant'))) 
<a name="l00506"></a>00506         $whereStatut='';
<a name="l00507"></a>00507    <span class="keywordflow">else</span> 
<a name="l00508"></a>00508         $whereStatut=<span class="stringliteral">" AND login='"</span>.$GLOBALS['auteur_session']['login'].<span class="stringliteral">"'"</span>;
<a name="l00509"></a>00509    
<a name="l00510"></a>00510    $nbErreurs=0;
<a name="l00511"></a>00511    <span class="comment">//mettre annee en cours si annee nulle</span>
<a name="l00512"></a>00512    <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"select count(*) from odb_candidats where annee=0 $whereStatut"</span>;
<a name="l00513"></a>00513    <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00514"></a>00514    $row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>);
<a name="l00515"></a>00515    $nb_rows=(int)$row[0];
<a name="l00516"></a>00516    <span class="keywordflow">if</span>($num_rows&gt;0) {
<a name="l00517"></a>00517       <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"UPDATE odb_candidats SET annee=$annee WHERE annee=0 $whereStatut"</span>;
<a name="l00518"></a>00518       <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00519"></a>00519       echo <a class="code" href="inc-html_8php.html#af111db152a79e88015b3a80345d0cdd" title="affiche une boite de message">boite_important</a>(<span class="stringliteral">"&lt;b&gt;$num_rows&lt;/b&gt; candidats avaient une ann&amp;eacute;e incorrecte, remplac&amp;eacute;e par &lt;b&gt;$annee&lt;/b&gt;"</span>);
<a name="l00520"></a>00520    }
<a name="l00521"></a>00521 
<a name="l00522"></a>00522    <span class="comment">//affecter departement lorsque departement nul</span>
<a name="l00523"></a>00523    <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT id_saisie, ville, etablissement from odb_candidats where annee=$annee and departement=0  $whereStatut order by ville, id_saisie"</span>;
<a name="l00524"></a>00524    <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00525"></a>00525    $num_rows=mysql_num_rows(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>);
<a name="l00526"></a>00526    $avertissement=array();
<a name="l00527"></a>00527    $cpt_avertissement=0;
<a name="l00528"></a>00528    unset($tab_res);
<a name="l00529"></a>00529    <span class="keywordflow">if</span>($num_rows&gt;0) {
<a name="l00530"></a>00530         echo <span class="stringliteral">"\n&lt;!-- DEPARTEMENT NUL --&gt;\n"</span>;
<a name="l00531"></a>00531       <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00532"></a>00532          $resultats=array('id_saisie<span class="charliteral">','</span>ville<span class="charliteral">','</span>etablissement');
<a name="l00533"></a>00533          <span class="keywordflow">foreach</span>($resultats as $col) $$col=$row[$col];
<a name="l00534"></a>00534 
<a name="l00535"></a>00535          <span class="comment">//trouver le departement</span>
<a name="l00536"></a>00536          <span class="keywordflow">if</span>(strlen($tab_res['ville'][$ville])==0) {
<a name="l00537"></a>00537             <span class="comment">// on n'a pas encore identifie le departement de cette ville ou il est different de celui de l'etablissement</span>
<a name="l00538"></a>00538             <span class="keywordflow">foreach</span>($tab_referentiel['ville'] as $dept_ville =&gt; $tab_ville) {
<a name="l00539"></a>00539                <span class="keywordflow">if</span>(isset($tab_ville[$ville])) {
<a name="l00540"></a>00540                   <span class="comment">// la ville existe dans le referentiel de ce departement</span>
<a name="l00541"></a>00541                   $tab_res['ville'][$ville]=$dept_ville;
<a name="l00542"></a>00542                   $departement=$dept_ville;
<a name="l00543"></a>00543                   <span class="keywordflow">if</span>(!isset($tab_referentiel['etablissement'][$dept_ville][$etablissement])) {
<a name="l00544"></a>00544                      <span class="keywordflow">if</span>(!isset($tab_res['eta'][$etablissement]))
<a name="l00545"></a>00545                         <span class="keywordflow">foreach</span>($tab_referentiel['etablissement'] as $dept_eta =&gt; $tab_eta) {
<a name="l00546"></a>00546                            <span class="keywordflow">if</span>(isset($tab_eta[$etablissement])) {
<a name="l00547"></a>00547                               $tab_res['eta'][$etablissement]['dept']=$tab_referentiel['departement'][$dept_eta];
<a name="l00548"></a>00548                               $tab_res['eta'][$etablissement]['eta']=$tab_eta[$etablissement];
<a name="l00549"></a>00549                            }
<a name="l00550"></a>00550                         }
<a name="l00551"></a>00551                      $cpt_avertissement++;
<a name="l00552"></a>00552                      unset($tab_res['ville'][$ville]); <span class="comment">// $dept_ville!=$dept_eta donc on refera le test prochaine fois</span>
<a name="l00553"></a>00553                      $departement=0; <span class="comment">// le departement reste inconnu</span>
<a name="l00554"></a>00554                      $avertissement[$cpt_avertissement]=<span class="stringliteral">"&lt;td&gt;&lt;A HREF='"</span>.generer_url_ecrire('odb_saisie').<span class="stringliteral">"&amp;annee=$annee&amp;step2=odb_candidats&amp;identifiant=id_saisie&amp;id=$id_saisie'&gt;$id_saisie&lt;/A&gt;&lt;/td&gt;&lt;td&gt;"</span>.$tab_referentiel['ville'][$dept_ville][$ville].<span class="stringliteral">" (&lt;b&gt;"</span>.$tab_referentiel['departement'][$dept_ville].<span class="stringliteral">"&lt;/b&gt;)&lt;/td&gt;&lt;td&gt;"</span>.$tab_res['eta'][$etablissement]['eta'].<span class="stringliteral">" (&lt;b&gt;"</span>.$tab_res['eta'][$etablissement]['dept'].<span class="stringliteral">"&lt;/b&gt;)&lt;/td&gt;"</span>;
<a name="l00555"></a>00555                   }
<a name="l00556"></a>00556                }
<a name="l00557"></a>00557             }
<a name="l00558"></a>00558          } <span class="keywordflow">else</span> {
<a name="l00559"></a>00559             <span class="comment">// on a deja identifie ce departement et dept_ville==dept_eta</span>
<a name="l00560"></a>00560             $departement=$tab_res['ville'][$ville];
<a name="l00561"></a>00561          }
<a name="l00562"></a>00562          <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"UPDATE odb_candidats SET departement=$departement WHERE id_saisie=$id_saisie $whereStatut"</span>;
<a name="l00563"></a>00563          <span class="keywordflow">if</span>($departement&gt;0)
<a name="l00564"></a>00564             <a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00565"></a>00565       }
<a name="l00566"></a>00566       $nbErreurs+=$num_rows;
<a name="l00567"></a>00567 
<a name="l00568"></a>00568       $num_rows=($num_rows-$cpt_avertissement);
<a name="l00569"></a>00569       <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>=<span class="stringliteral">"&lt;b&gt;$num_rows&lt;/b&gt; candidats contenaient un d&amp;eacute;partement invalide et ont &amp;eacute;t&amp;eacute; corrig&amp;eacute;s"</span>;
<a name="l00570"></a>00570       <span class="keywordflow">if</span>(count($avertissement)&gt;0) {
<a name="l00571"></a>00571         print_r($avertissement);
<a name="l00572"></a>00572          <a class="code" href="inc-pdf-attestations_8php.html#43e5b5a819fedbd12b8cf5421ba6985e">$titre</a>=<span class="stringliteral">"&lt;b&gt;$cpt_avertissement erreurs graves&lt;/b&gt; n'ont pas &amp;eacute;t&amp;eacute; corrig&amp;eacute;s (ville et &amp;eacute;tablissement dans d&amp;eacute;partements diff&amp;eacute;rents)"</span>;
<a name="l00573"></a>00573          $thead=<span class="stringliteral">"&lt;th&gt;&lt;small&gt;Candidat&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;Ville (d&amp;eacute;partement)&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;&amp;Eacute;tablissement (d&amp;eacute;partement)&lt;/small&gt;&lt;/th&gt;"</span>;
<a name="l00574"></a>00574          <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>.=<a class="code" href="inc-html_8php.html#5f91efa37c4c6e04e1e2792cc0c37600" title="Affiche une table html.">odb_html_table</a>(<a class="code" href="inc-pdf-attestations_8php.html#43e5b5a819fedbd12b8cf5421ba6985e">$titre</a>,$avertissement,$thead);
<a name="l00575"></a>00575                 }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577       echo <a class="code" href="inc-html_8php.html#af111db152a79e88015b3a80345d0cdd" title="affiche une boite de message">boite_important</a>(<span class="stringliteral">"&lt;span&gt;$msg&lt;/span&gt;"</span>);
<a name="l00578"></a>00578    }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580    <span class="comment">// verification referentiels (identifiants &gt;0)</span>
<a name="l00581"></a>00581    <span class="keywordflow">foreach</span>(array('departement<span class="charliteral">','</span>ville<span class="charliteral">','</span>etablissement<span class="charliteral">','</span>serie<span class="charliteral">','</span>sexe<span class="charliteral">','</span>nationalite<span class="charliteral">','</span>ldn<span class="charliteral">','</span>pdn<span class="charliteral">','</span>nom<span class="charliteral">','</span>prenoms<span class="charliteral">','</span>eps') as $ref) {
<a name="l00582"></a>00582       unset(<a class="code" href="resultats__ajournes__par__centre_8php.html#110fc80fcb224fbae884b1a3742c4924">$lien</a>);
<a name="l00583"></a>00583       <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT id_saisie from odb_candidats where ($ref='0' or $ref='') and annee=$annee $whereStatut"</span>;
<a name="l00584"></a>00584       <span class="comment">//echo "$sql&lt;br&gt;";</span>
<a name="l00585"></a>00585       <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00586"></a>00586       $num_rows=mysql_num_rows(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>);
<a name="l00587"></a>00587       <span class="keywordflow">if</span>($num_rows&gt;0) {
<a name="l00588"></a>00588          <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00589"></a>00589             $id_saisie=$row['id_saisie'];
<a name="l00590"></a>00590             <a class="code" href="resultats__ajournes__par__centre_8php.html#110fc80fcb224fbae884b1a3742c4924">$lien</a>[]=<span class="stringliteral">"&lt;A HREF='"</span>.generer_url_ecrire('odb_saisie').<span class="stringliteral">"&amp;annee=$annee&amp;step2=odb_candidats&amp;identifiant=id_saisie&amp;id=$id_saisie'&gt;$id_saisie&lt;/A&gt;\n"</span>;
<a name="l00591"></a>00591          }
<a name="l00592"></a>00592          $liens=implode(', ',<a class="code" href="resultats__ajournes__par__centre_8php.html#110fc80fcb224fbae884b1a3742c4924">$lien</a>);
<a name="l00593"></a>00593 
<a name="l00594"></a>00594          echo <a class="code" href="inc-html_8php.html#af111db152a79e88015b3a80345d0cdd" title="affiche une boite de message">boite_important</a>(<span class="stringliteral">"Le champ &lt;b&gt;$ref&lt;/b&gt; est invalide pour &lt;b&gt;$num_rows&lt;/b&gt; candidat(e)s.&lt;br/&gt;&lt;small&gt;Cliquez sur leur num&amp;eacute;ro de saisie pour effectuer la correction :&lt;br/&gt;$liens&lt;/small&gt;"</span>);
<a name="l00595"></a>00595       }
<a name="l00596"></a>00596    }
<a name="l00597"></a>00597    $nbErreurs+=$num_rows;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599    <span class="comment">// Passer les id_table inexistants à 0</span>
<a name="l00600"></a>00600       unset(<a class="code" href="resultats__ajournes__par__centre_8php.html#110fc80fcb224fbae884b1a3742c4924">$lien</a>);
<a name="l00601"></a>00601       <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT count(*) from odb_candidats where id_table='' and annee=$annee $whereStatut"</span>;
<a name="l00602"></a>00602       <span class="comment">//echo "$sql&lt;br&gt;";</span>
<a name="l00603"></a>00603       <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00604"></a>00604       $num_rows=mysql_result(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>,0,0);
<a name="l00605"></a>00605       <span class="keywordflow">if</span>($num_rows&gt;0) {
<a name="l00606"></a>00606          <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"UPDATE odb_candidats set id_table='0' where id_table='' $whereStatut"</span>;
<a name="l00607"></a>00607          <a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00608"></a>00608          echo <a class="code" href="inc-html_8php.html#af111db152a79e88015b3a80345d0cdd" title="affiche une boite de message">boite_important</a>(<span class="stringliteral">"Le num&amp;eacute;ro de table &amp;eacute;tait invalide pour &lt;b&gt;$num_rows&lt;/b&gt; candidat(e)s et a &amp;eacute;t&amp;eacute; automatiquement r&amp;eacute;initialis&amp;eacute;"</span>);
<a name="l00609"></a>00609       }
<a name="l00610"></a>00610    $nbErreurs+=$num_rows;
<a name="l00611"></a>00611 
<a name="l00612"></a>00612    <span class="comment">// verification doublons</span>
<a name="l00613"></a>00613    <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT nom, prenoms, ne_le, ne_en, ne_vers, count( prenoms ) AS nb\n"</span>
<a name="l00614"></a>00614          . <span class="stringliteral">" FROM odb_candidats\n"</span>
<a name="l00615"></a>00615          . <span class="stringliteral">" WHERE annee=$annee $whereStatut\n"</span>
<a name="l00616"></a>00616          . <span class="stringliteral">" GROUP BY nom, prenoms, ne_le, ne_en, ne_vers\n"</span>
<a name="l00617"></a>00617          . <span class="stringliteral">" ORDER BY nb DESC, nom ASC, prenoms ASC "</span>
<a name="l00618"></a>00618          ;
<a name="l00619"></a>00619    <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00620"></a>00620    $doublons=<span class="stringliteral">""</span>;
<a name="l00621"></a>00621    $cpt_types_doublons=0;
<a name="l00622"></a>00622    $cpt_nb_doublons=0;
<a name="l00623"></a>00623    <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00624"></a>00624       $nb=$row['nb'];
<a name="l00625"></a>00625       <span class="keywordflow">if</span>($nb&gt;1) {
<a name="l00626"></a>00626          $cpt_types_doublons++;
<a name="l00627"></a>00627          $cpt_nb_doublons+=$nb;
<a name="l00628"></a>00628          <span class="comment">//$doublons.="&lt;tr class='tr_liste'&gt;";</span>
<a name="l00629"></a>00629          $sql2=<span class="stringliteral">"SELECT id_saisie\n from odb_candidats\n where annee=$annee $whereStatut"</span>;
<a name="l00630"></a>00630          <span class="keywordflow">foreach</span>(array('nom<span class="charliteral">','</span>prenoms<span class="charliteral">','</span>ne_le<span class="charliteral">','</span>ne_en<span class="charliteral">','</span>ne_vers') as $col) {
<a name="l00631"></a>00631             $$col=$row[$col];
<a name="l00632"></a>00632             $doublons[$cpt_types_doublons].=<span class="stringliteral">"&lt;td&gt;"</span>.$$col.<span class="stringliteral">"&lt;/td&gt;"</span>;
<a name="l00633"></a>00633             $sql2.=<span class="stringliteral">" AND $col='"</span>.addslashes($$col).<span class="stringliteral">"'"</span>;
<a name="l00634"></a>00634          }
<a name="l00635"></a>00635          $doublons[$cpt_types_doublons].=<span class="stringliteral">"&lt;td&gt;&lt;small&gt;$nb : &lt;/small&gt;"</span>;
<a name="l00636"></a>00636          $result2=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>($sql2,__FILE__,__LINE__);
<a name="l00637"></a>00637          unset($doublon);
<a name="l00638"></a>00638          <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>=0;
<a name="l00639"></a>00639          <span class="keywordflow">while</span>($row2=mysql_fetch_array($result2)) {
<a name="l00640"></a>00640                 $id_saisie=$row2['id_saisie'];
<a name="l00641"></a>00641             $doublon[]=<span class="stringliteral">"&lt;A HREF='"</span>.generer_url_ecrire('odb_saisie').<span class="stringliteral">"&amp;annee=$annee&amp;step2=odb_candidats&amp;identifiant=id_saisie&amp;id="</span>.$row2['id_saisie'].<span class="stringliteral">"'&gt;$id_saisie&lt;/A&gt;"</span>;
<a name="l00642"></a>00642             <span class="keywordflow">if</span>(<a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>++&gt;0) $doublons_auto[]=$id_saisie;
<a name="l00643"></a>00643          }
<a name="l00644"></a>00644          <span class="keywordflow">if</span>(is_array($doublon))
<a name="l00645"></a>00645                 $doublons[$cpt_types_doublons].=implode(<span class="stringliteral">", "</span>, $doublon);
<a name="l00646"></a>00646          $doublons[$cpt_types_doublons].=<span class="stringliteral">"&lt;/td&gt;"</span>;
<a name="l00647"></a>00647       }
<a name="l00648"></a>00648    }
<a name="l00649"></a>00649    <span class="keywordflow">if</span>(is_array($doublons)) {
<a name="l00650"></a>00650       $cpt_nb_doublons-=$cpt_types_doublons;
<a name="l00651"></a>00651       <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>=<span class="stringliteral">"&lt;span&gt;Les &lt;b&gt;$cpt_nb_doublons&lt;/b&gt; doublons suivants ont &amp;eacute;t&amp;eacute; d&amp;eacute;tect&amp;eacute;s."</span>;
<a name="l00652"></a>00652       <a class="code" href="inc-pdf-attestations_8php.html#43e5b5a819fedbd12b8cf5421ba6985e">$titre</a>=<span class="stringliteral">"Veuillez corriger &lt;b&gt;le premier de chaque liste svp&lt;/b&gt;"</span>;
<a name="l00653"></a>00653       $thead=<span class="stringliteral">"&lt;th&gt;&lt;small&gt;Nom&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;Pr&amp;eacute;noms&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;N&amp;eacute;(e) le&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;N&amp;eacute;(e) en&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;N&amp;eacute;(e) vers&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;N&amp;deg; saisie&lt;/small&gt;&lt;/th&gt;"</span>;
<a name="l00654"></a>00654       <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>.=<a class="code" href="inc-html_8php.html#5f91efa37c4c6e04e1e2792cc0c37600" title="Affiche une table html.">odb_html_table</a>(<a class="code" href="inc-pdf-attestations_8php.html#43e5b5a819fedbd12b8cf5421ba6985e">$titre</a>,$doublons,$thead);
<a name="l00655"></a>00655       
<a name="l00656"></a>00656       <span class="keywordflow">if</span>(<a class="code" href="inc-regles__gestion_8php.html#abf23b66cd362adaa508de5bfb22706a" title="l&amp;#39;utilisateur est il admin ?">isAdmin</a>())
<a name="l00657"></a>00657          <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>.= <span class="stringliteral">"&lt;small&gt;&lt;dl id='doublons' style='cursor:help;'&gt;&lt;dt&gt;Correction automatique (pour l'administrateur)&lt;/dt&gt;&lt;dd&gt;&lt;i&gt;Supprimer les id_saisie suivants&lt;/i&gt;&lt;br/&gt;&lt;pre&gt;DELETE from odb_candidats WHERE annee=$annee AND id_saisie in(&lt;/pre&gt;"</span>.implode(', ',$doublons_auto).<span class="stringliteral">"&lt;br/&gt;)&lt;/dd&gt;&lt;/dl&gt;&lt;/small&gt;"</span>
<a name="l00658"></a>00658                                 . <span class="stringliteral">"&lt;/span&gt;\n"</span>
<a name="l00659"></a>00659                                 ;
<a name="l00660"></a>00660       echo <a class="code" href="inc-html_8php.html#af111db152a79e88015b3a80345d0cdd" title="affiche une boite de message">boite_important</a>(<a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>);
<a name="l00661"></a>00661       $nbErreurs+=$cpt_nb_doublons;
<a name="l00662"></a>00662         $jquery= &lt;&lt;&lt;FINSCRIPT
<a name="l00663"></a>00663 $(document).ready(function() {
<a name="l00664"></a>00664         $('#doublons').find('dd').hide().end().find('dt').click(function() {
<a name="l00665"></a>00665                 var suivant = $(<span class="keyword">this</span>).next();
<a name="l00666"></a>00666                 suivant.slideToggle();
<a name="l00667"></a>00667         });
<a name="l00668"></a>00668 });
<a name="l00669"></a>00669 FINSCRIPT;
<a name="l00670"></a>00670                 echo <a class="code" href="inc-html_8php.html#26ce7f961b7c017f444305029440e0d3" title="Ajoute du code javascript.">putJavascript</a>($jquery);
<a name="l00671"></a>00671    }
<a name="l00672"></a>00672 
<a name="l00673"></a>00673    <span class="comment">//Verification ville etablissement !=0</span>
<a name="l00674"></a>00674    <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a> = 'SELECT eta . id , etablissement , departement FROM odb_ref_etablissement eta , odb_ref_departement dep '
<a name="l00675"></a>00675         . ' WHERE id_ville = 0 '
<a name="l00676"></a>00676         . ' and dep . <span class="keywordtype">id</span> = eta . id_departement'
<a name="l00677"></a>00677         . ' order by departement, etablissement'
<a name="l00678"></a>00678         ;
<a name="l00679"></a>00679    <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00680"></a>00680    $nb_rows=mysql_num_rows(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>);
<a name="l00681"></a>00681    <span class="keywordflow">if</span>($nb_rows&gt;0) {
<a name="l00682"></a>00682       unset($tr);
<a name="l00683"></a>00683       $thead=<span class="stringliteral">"&lt;th&gt;D&amp;eacute;partement&lt;/th&gt;&lt;th&gt;&amp;Eacute;tablissement&lt;/th&gt;"</span>;
<a name="l00684"></a>00684       <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00685"></a>00685          $id=$row['<span class="keywordtype">id</span>'];
<a name="l00686"></a>00686          $eta=$row['etablissement'];
<a name="l00687"></a>00687          $dep=$row['departement'];
<a name="l00688"></a>00688          $tr[]=<span class="stringliteral">"&lt;td&gt;&lt;small&gt;$dep&lt;/small&gt;&lt;/td&gt;&lt;td&gt;&lt;small&gt;$eta (#$id)&lt;/small&gt;&lt;/td&gt;"</span>;
<a name="l00689"></a>00689       }
<a name="l00690"></a>00690       <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>=<a class="code" href="inc-html_8php.html#5f91efa37c4c6e04e1e2792cc0c37600" title="Affiche une table html.">odb_html_table</a>(<span class="stringliteral">"Les &lt;b&gt;$nb_rows&lt;/b&gt; &lt;b&gt;&amp;eacute;tablissements&lt;/b&gt; suivants ont une &lt;b&gt;ville&lt;/b&gt; invalide"</span>,$tr,$thead);
<a name="l00691"></a>00691       echo <span class="stringliteral">"$msg&lt;br/&gt;"</span>;
<a name="l00692"></a>00692    }
<a name="l00693"></a>00693    $nbErreurs+=$num_rows;
<a name="l00694"></a>00694 
<a name="l00695"></a>00695    <span class="comment">//Verification departement candidat = departement de son etablissement</span>
<a name="l00696"></a>00696    <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a> = 'select id_saisie, id_table, eta.etablissement, depcan.departement deptCan, depeta.departement deptEta'
<a name="l00697"></a>00697         . ' from odb_ref_etablissement eta, odb_candidats can, odb_ref_departement depcan, odb_ref_departement depeta'
<a name="l00698"></a>00698         . ' where eta.id=can.etablissement'
<a name="l00699"></a>00699         . ' and depeta.id=eta.id_departement'
<a name="l00700"></a>00700         . ' and depcan.id=can.departement'
<a name="l00701"></a>00701         . ' and can.departement!=eta.id_departement'
<a name="l00702"></a>00702         . <span class="stringliteral">" and can.annee=$annee"</span>
<a name="l00703"></a>00703         . $whereStatut
<a name="l00704"></a>00704         ;
<a name="l00705"></a>00705    <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00706"></a>00706    $nb_rows=mysql_num_rows(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>);
<a name="l00707"></a>00707    <a class="code" href="inc-pdf-attestations_8php.html#6a5a233adfaad0185a2b89ba6c4f3ae3">$colonnes</a>=array('id_saisie<span class="charliteral">','</span>id_table<span class="charliteral">','</span>etablissement<span class="charliteral">','</span>deptCan<span class="charliteral">','</span>deptEta');
<a name="l00708"></a>00708    <span class="keywordflow">if</span>($nb_rows&gt;0) {
<a name="l00709"></a>00709       unset($tr);
<a name="l00710"></a>00710       <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>=0;
<a name="l00711"></a>00711       $thead=<span class="stringliteral">"&lt;th&gt;&lt;small&gt;#Saisie&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;#Table&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;&amp;Eacute;tablissement&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;D&amp;eacute;partement&lt;br&gt;candidat&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;D&amp;eacute;partement&lt;br&gt;&amp;eacute;tabissement&lt;/small&gt;&lt;/th&gt;"</span>;
<a name="l00712"></a>00712       <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00713"></a>00713          <span class="keywordflow">foreach</span>(<a class="code" href="inc-pdf-attestations_8php.html#6a5a233adfaad0185a2b89ba6c4f3ae3">$colonnes</a> as $col)
<a name="l00714"></a>00714             $$col=$row[$col];
<a name="l00715"></a>00715          $id_saisie=<span class="stringliteral">"&lt;A HREF='"</span>.generer_url_ecrire('odb_saisie').<span class="stringliteral">"&amp;annee=$annee&amp;step2=odb_candidats&amp;identifiant=id_saisie&amp;id=$id_saisie'&gt;$id_saisie&lt;/A&gt;"</span>;
<a name="l00716"></a>00716          <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>++;
<a name="l00717"></a>00717          <span class="keywordflow">foreach</span>(<a class="code" href="inc-pdf-attestations_8php.html#6a5a233adfaad0185a2b89ba6c4f3ae3">$colonnes</a> as $col)
<a name="l00718"></a>00718             $tr[<a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>].=<span class="stringliteral">"&lt;td&gt;&lt;small&gt;"</span>.$$col.<span class="stringliteral">"&lt;/small&gt;&lt;/td&gt;"</span>;
<a name="l00719"></a>00719          <span class="comment">//$_SESSION['sql']['maj_departements'][]="UPDATE odb_candidats SET = WHERE = AND etablissement=$id_eta AND annee=$annee;\n";</span>
<a name="l00720"></a>00720       }
<a name="l00721"></a>00721       <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>=<a class="code" href="inc-html_8php.html#5f91efa37c4c6e04e1e2792cc0c37600" title="Affiche une table html.">odb_html_table</a>(<span class="stringliteral">"Les &lt;b&gt;$nb_rows&lt;/b&gt; candidats suivants ont un &lt;b&gt;d&amp;eacute;partement&lt;/b&gt; invalide et doivent &amp;ecirc;tre corrig&amp;eacute;s"</span>,$tr,$thead)
<a name="l00722"></a>00722          ;
<a name="l00723"></a>00723       echo <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>;
<a name="l00724"></a>00724    }
<a name="l00725"></a>00725    $nbErreurs+=$num_rows;
<a name="l00726"></a>00726 
<a name="l00727"></a>00727    <span class="comment">//Verification ville candidat = ville de son etablissement</span>
<a name="l00728"></a>00728    <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a> = 'SELECT dep.departement, eta.etablissement, eta.id id_etablissement, can.ville id_ville_can ,eta.id_ville id_ville_eta, vilcan.ville ville_candidat, vileta.ville ville_eta, count(*) nb'
<a name="l00729"></a>00729         . ' FROM odb_candidats can, odb_ref_etablissement eta, odb_ref_ville vilcan, odb_ref_departement dep, odb_ref_ville vileta'
<a name="l00730"></a>00730         . ' WHERE eta.id = can.etablissement'
<a name="l00731"></a>00731         . ' AND dep.id = can.departement'
<a name="l00732"></a>00732         . ' AND vilcan.id = can.ville'
<a name="l00733"></a>00733         . ' AND vileta.id = eta.id_ville'
<a name="l00734"></a>00734         . ' AND can.ville &lt;&gt; eta.id_ville'
<a name="l00735"></a>00735         <span class="comment">//. " and id_table!='0'"</span>
<a name="l00736"></a>00736         . <span class="stringliteral">" AND eta.etablissement not like 'CL%'"</span>
<a name="l00737"></a>00737         . $whereStatut
<a name="l00738"></a>00738         . ' group by departement, etablissement, ville_candidat, ville_eta'
<a name="l00739"></a>00739         . ' order by departement, etablissement, ville_candidat, ville_eta, id_table'
<a name="l00740"></a>00740         ;
<a name="l00741"></a>00741    <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00742"></a>00742    $nb_rows=mysql_num_rows(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>);
<a name="l00743"></a>00743    <a class="code" href="inc-pdf-attestations_8php.html#6a5a233adfaad0185a2b89ba6c4f3ae3">$colonnes</a>=array('departement<span class="charliteral">','</span>etablissement<span class="charliteral">','</span>ville_candidat<span class="charliteral">','</span>ville_eta<span class="charliteral">','</span>serie<span class="charliteral">','</span>nb');
<a name="l00744"></a>00744    <span class="keywordflow">if</span>($nb_rows&gt;0) {
<a name="l00745"></a>00745       unset($tr);
<a name="l00746"></a>00746       <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>=0;
<a name="l00747"></a>00747       $thead=<span class="stringliteral">"&lt;th&gt;&lt;small&gt;D&amp;eacute;partement&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;&amp;Eacute;tablissement&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;Ville&lt;br&gt;candidat&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;Ville&lt;br&gt;&amp;eacute;tabissement&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;S&amp;eacute;rie&lt;/small&gt;&lt;/th&gt;&lt;th&gt;&lt;small&gt;Nombre&lt;/small&gt;&lt;/th&gt;"</span>;
<a name="l00748"></a>00748       <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00749"></a>00749          $id_ville_can=$row['id_ville_can'];
<a name="l00750"></a>00750          $id_ville_eta=$row['id_ville_eta'];
<a name="l00751"></a>00751          $id_eta=$row['id_etablissement'];
<a name="l00752"></a>00752          <span class="keywordflow">foreach</span>(<a class="code" href="inc-pdf-attestations_8php.html#6a5a233adfaad0185a2b89ba6c4f3ae3">$colonnes</a> as $col)
<a name="l00753"></a>00753             $$col=$row[$col];
<a name="l00754"></a>00754          <span class="keywordflow">if</span>(substr_count(strtolower($etablissement),'cl')==0) {
<a name="l00755"></a>00755             <span class="comment">// ce n'est pas un candidat libre</span>
<a name="l00756"></a>00756             <a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>++;
<a name="l00757"></a>00757             <span class="keywordflow">foreach</span>(<a class="code" href="inc-pdf-attestations_8php.html#6a5a233adfaad0185a2b89ba6c4f3ae3">$colonnes</a> as $col)
<a name="l00758"></a>00758                $tr[<a class="code" href="resultats__ajournes__par__centre_8php.html#ea5d1e230cf3df250120025d801dc7c3">$cpt</a>].=<span class="stringliteral">"&lt;td&gt;&lt;small&gt;"</span>.$$col.<span class="stringliteral">"&lt;/small&gt;&lt;/td&gt;"</span>;
<a name="l00759"></a>00759             <a class="code" href="resultats__ajournes__par__centre_8php.html#082ba331d3cc45e8443c96d1131d5599">$_SESSION</a>['sql']['maj_villes'][]=<span class="stringliteral">"UPDATE odb_candidats SET ville=$id_ville_eta WHERE ville=$id_ville_can AND etablissement=$id_eta AND annee=$annee $whereStatut;\n"</span>;
<a name="l00760"></a>00760             <span class="comment">//echo "&lt;br&gt;$cpt : $sql";</span>
<a name="l00761"></a>00761             <span class="comment">//odb_query($sql,__FILE__,__LINE__);</span>
<a name="l00762"></a>00762          } <span class="keywordflow">else</span> $nb_rows--;
<a name="l00763"></a>00763       }
<a name="l00764"></a>00764       <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>=<a class="code" href="inc-html_8php.html#5f91efa37c4c6e04e1e2792cc0c37600" title="Affiche une table html.">odb_html_table</a>(<span class="stringliteral">"Les candidats des &lt;b&gt;$nb_rows&lt;/b&gt; lignes suivantes avaient une &lt;b&gt;ville&lt;/b&gt; invalide et peuvent &amp;ecirc;tre corrig&amp;eacute;s"</span>,$tr,$thead);
<a name="l00765"></a>00765       <span class="keywordflow">if</span>(<a class="code" href="inc-regles__gestion_8php.html#abf23b66cd362adaa508de5bfb22706a" title="l&amp;#39;utilisateur est il admin ?">isAdmin</a>()) <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>.= <span class="stringliteral">"&lt;A HREF='"</span>.generer_url_ecrire('odb_param').<span class="stringliteral">"'&gt;Cliquez ici pour les corriger&lt;/A&gt; &lt;small&gt;(vous devez le faire depuis le module &lt;A HREF='"</span>.generer_url_ecrire('odb_param').<span class="stringliteral">"'&gt;param&amp;egrave;tres&lt;/A&gt;)&lt;/small&gt;&lt;br/&gt;"</span>;
<a name="l00766"></a>00766       echo <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>;
<a name="l00767"></a>00767    }
<a name="l00768"></a>00768    $nbErreurs+=$nb_rows;
<a name="l00769"></a>00769 
<a name="l00770"></a>00770    <span class="comment">//Verification langues (series A1, A2, B)</span>
<a name="l00771"></a>00771    <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>=<span class="stringliteral">"SELECT id_saisie from odb_candidats where annee=$annee $whereStatut and (0"</span>;
<a name="l00772"></a>00772    <a class="code" href="resultats__ajournes__par__centre_8php.html#110fc80fcb224fbae884b1a3742c4924">$lien</a>=array();
<a name="l00773"></a>00773    <span class="keywordflow">foreach</span>($tab_referentiel['serie'] as $idSerie=&gt;$refSerie) {
<a name="l00774"></a>00774       <span class="keywordflow">if</span>($refSerie=='A1' || $refSerie=='A2' || $refSerie==<span class="charliteral">'B'</span>)
<a name="l00775"></a>00775          <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>.=<span class="stringliteral">" OR serie=$idSerie"</span>;
<a name="l00776"></a>00776    }
<a name="l00777"></a>00777    <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>.=<span class="stringliteral">") and (lv1=0 or lv2=0 or lv1=lv2) order by id_saisie"</span>;
<a name="l00778"></a>00778    <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00779"></a>00779    $nb_rows=mysql_num_rows(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>);
<a name="l00780"></a>00780    <span class="keywordflow">if</span>($nb_rows&gt;0) {
<a name="l00781"></a>00781       <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00782"></a>00782          $id_saisie=$row['id_saisie'];
<a name="l00783"></a>00783          <a class="code" href="resultats__ajournes__par__centre_8php.html#110fc80fcb224fbae884b1a3742c4924">$lien</a>[]=<span class="stringliteral">"&lt;A HREF='"</span>.generer_url_ecrire('odb_saisie').<span class="stringliteral">"&amp;annee=$annee&amp;step2=odb_candidats&amp;identifiant=id_saisie&amp;id=$id_saisie'&gt;$id_saisie&lt;/A&gt;"</span>;
<a name="l00784"></a>00784       }
<a name="l00785"></a>00785       $liens=implode(', ',<a class="code" href="resultats__ajournes__par__centre_8php.html#110fc80fcb224fbae884b1a3742c4924">$lien</a>);
<a name="l00786"></a>00786       <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>=<span class="stringliteral">"Les &lt;b&gt;$nb_rows&lt;/b&gt; candidats de s&amp;eacute;rie A1, A2 ou B suivants n'ont pas 2 langues vivantes diff&amp;eacute;rentes."</span>
<a name="l00787"></a>00787          . <span class="stringliteral">"&lt;br/&gt;&lt;small&gt;Cliquez sur leur numro de saisie pour effectuer la correction :&lt;br/&gt;$liens&lt;/small&gt;\n"</span>
<a name="l00788"></a>00788          ;
<a name="l00789"></a>00789       echo <a class="code" href="inc-html_8php.html#af111db152a79e88015b3a80345d0cdd" title="affiche une boite de message">boite_important</a>(<a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>);
<a name="l00790"></a>00790    }
<a name="l00791"></a>00791    $nbErreurs+=$nb_rows;
<a name="l00792"></a>00792 
<a name="l00793"></a>00793    <span class="comment">//Verification annee de naissance</span>
<a name="l00794"></a>00794    <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a> = 'select id_saisie, year( ne_le ) + CAST( ne_en AS <span class="keywordtype">unsigned</span> ) + CAST( ne_vers AS <span class="keywordtype">unsigned</span> ) ann '
<a name="l00795"></a>00795         . ' from odb_candidats'
<a name="l00796"></a>00796         . <span class="stringliteral">" where annee=$annee $whereStatut and (year( ne_le ) + CAST( ne_en AS unsigned ) + CAST( ne_vers AS unsigned )=0 "</span>
<a name="l00797"></a>00797         . ' or year( ne_le ) + CAST( ne_en AS <span class="keywordtype">unsigned</span> ) + CAST( ne_vers AS <span class="keywordtype">unsigned</span> )&gt;year(now())-10)'
<a name="l00798"></a>00798         . ' order by id_saisie'
<a name="l00799"></a>00799         ;
<a name="l00800"></a>00800    <a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00801"></a>00801    $nb_rows=mysql_num_rows(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>);
<a name="l00802"></a>00802    <span class="keywordflow">if</span>($nb_rows&gt;0) {
<a name="l00803"></a>00803       <span class="keywordflow">while</span>($row=mysql_fetch_array(<a class="code" href="inc-ezpdf_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)) {
<a name="l00804"></a>00804          $id_saisie=$row['id_saisie'];
<a name="l00805"></a>00805          <a class="code" href="resultats__ajournes__par__centre_8php.html#110fc80fcb224fbae884b1a3742c4924">$lien</a>[]=<span class="stringliteral">"&lt;A HREF='"</span>.generer_url_ecrire('odb_saisie').<span class="stringliteral">"&amp;annee=$annee&amp;step2=odb_candidats&amp;identifiant=id_saisie&amp;id=$id_saisie'&gt;$id_saisie&lt;/A&gt;"</span>;
<a name="l00806"></a>00806       }
<a name="l00807"></a>00807       $liens=implode(', ',<a class="code" href="resultats__ajournes__par__centre_8php.html#110fc80fcb224fbae884b1a3742c4924">$lien</a>);
<a name="l00808"></a>00808       <a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>=<span class="stringliteral">"Les &lt;b&gt;$nb_rows&lt;/b&gt; candidats suivants ont une &lt;b&gt;date de naissance&lt;/b&gt; invalide :&lt;br/&gt;"</span>
<a name="l00809"></a>00809          . <span class="stringliteral">"&lt;small&gt;Cliquez sur leur numro de saisie pour effectuer la correction :&lt;br/&gt;$liens&lt;/small&gt;\n"</span>
<a name="l00810"></a>00810          ;
<a name="l00811"></a>00811       echo <a class="code" href="inc-html_8php.html#af111db152a79e88015b3a80345d0cdd" title="affiche une boite de message">boite_important</a>(<a class="code" href="resultats__ajournes__par__centre_8php.html#9e168f4152c267835864153c54449583">$msg</a>);
<a name="l00812"></a>00812    }
<a name="l00813"></a>00813    $nbErreurs+=$num_rows;
<a name="l00814"></a>00814 
<a name="l00815"></a>00815    <span class="comment">//synchro id_table</span>
<a name="l00816"></a>00816    <a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a> = 'update odb_candidats can, odb_repartition rep'
<a name="l00817"></a>00817         . ' <span class="keyword">set</span> can.id_table=rep.id_table'
<a name="l00818"></a>00818         . ' where can.id_saisie=rep.id_saisie'
<a name="l00819"></a>00819         . <span class="stringliteral">" and can.annee=$annee"</span>
<a name="l00820"></a>00820         . <span class="stringliteral">" and rep.annee=$annee"</span>
<a name="l00821"></a>00821         . $whereStatut
<a name="l00822"></a>00822         ;
<a name="l00823"></a>00823    <a class="code" href="inc-odb_8php.html#cc73cdf19f49ae7162c99fd07a614e88" title="Execute une requete sql.">odb_query</a>(<a class="code" href="inc-pdf-attestations_8php.html#047170d6020a882807665812a27e2525">$sql</a>,__FILE__,__LINE__);
<a name="l00824"></a>00824    $num_rows=mysql_affected_rows();
<a name="l00825"></a>00825    <span class="keywordflow">if</span>($num_rows&gt;0)
<a name="l00826"></a>00826       echo <a class="code" href="inc-html_8php.html#af111db152a79e88015b3a80345d0cdd" title="affiche une boite de message">boite_important</a>(<span class="stringliteral">"La synchronisation des num&amp;eacute;ros de table &amp;eacute;tait incorrecte pour &lt;b&gt;$num_rows&lt;/b&gt; candidats"</span>);
<a name="l00827"></a>00827    $nbErreurs+=$num_rows;
<a name="l00828"></a>00828 
<a name="l00829"></a>00829    <span class="keywordflow">return</span> $nbErreurs;
<a name="l00830"></a>00830 }
<a name="l00831"></a>00831 
<a name="l00832"></a>00832 ?&gt;
</pre></div><hr size="1"><address style="text-align: right;"><small>Généré le Mon Mar 17 22:53:00 2008 pour Siou par&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
