#HTTP_HEADER{content-type:text/html;charset=#CHARSET}
#CACHE{2}

[(#REM)

	Les tags de notre article
	
	// ici mettre {" "} dans la boucle mots si on ne veut pas de virgule entre les tags, voir aussi dans le
	// javascript ci-dessous
]

[(#REM)
	Modifications Edd

	// utilisation des nouvelles feuilles de styles
	// ajout deplier/replier
	// ajout champs d'explication
	// internationalisation
]

<style type='text/css'>
	#popularTags {line-height:1.2em }
	#suggestions {margin:3px;width:300px}
	#popularTags span { background-color: #cccccc; cursor: pointer; margin:2px }
	#suggestions span { cursor: pointer; margin:2px }
	#popularTags span.selected { background-color: yellow; }
	#popularTags span.auto { background-color: #ccffcc; }
	#tags{width:200px}
</style>

<div style="background-color: #eee; text-style: justify; padding:5px; margin: 5px; margin-right:5px">

[(#REM)

	Les tags de notre article
	
	// ici mettre {" "} dans la boucle mots si on ne veut pas de virgule entre les tags, voir aussi dans le
	// javascript ci-dessous
]

<b><:opconfig:motclefs_ajouter:></b>


<p><:opconfig:motclefs_explique3:></p>

<div style="font-size: 0.7em;">
	<p><:opconfig:motclefs_explique4:></p>
	<p><:opconfig:motclefs_explique5:><br /><span style="background-color:#ffe2e2"><:opconfig:motclefs_explique6:></span></p>
</div>

<BOUCLE_a(ARTICLES){id_article = #ENV*{id_article} }{statut IN prop,publie,creat,prepa}>
<form method='get' action='[(#SELF|parametre_url{tags,""})]'>
[(#SELF|parametre_url{tags,""}|form_hidden)]

<table style="width:100%"><tr><td align='right' style="font-size: 0.7em;">
	<div style="width:50px"><:opconfig:motclefs2:></div>
</td><td>
	<input type='text' name='tags' autocomplete='off' id='tags'
	value="<BOUCLE_m(MOTS){type=tags}{id_article = #ENV*{id_article} }{" "}>[(#TITRE*|strcspn{' ,"'}|=={[(#TITRE*|strlen)]}|?{'',&quot;})][(#TITRE*|entites_html)][(#TITRE*|strcspn{' ,"'}|=={[(#TITRE*|strlen)]}|?{'',&quot;})]</BOUCLE_m>"  />
</td></tr>
<tr><td align='right' style="font-size: 0.7em;">
<span id='sug'></span>
</td><td>
<div id='suggestions' style="font-size: 0.7em;">
&nbsp;
</div>
</td></tr>
<tr><td colspan='2'>
	<div align="#LANG_RIGHT"><input type='submit' value='ok' />
</td></tr>
</table>

</form>
</BOUCLE_a>
<form method='get' action='[(#SELF|parametre_url{tags,""})]'>
[(#SELF|parametre_url{tags,""}|form_hidden)]

<table style="width:100%"><tr><td align='right' style="font-size: 0.7em;">
	<div style="width:50px"><:opconfig:motclefs2:></div>
</td><td>
	<input type='text' name='tags' autocomplete='off' id='tags'
	value="<BOUCLE_m1(MOTS){type=tags}{id_article = #ENV*{id_article} }{" "}>[(#TITRE*|strcspn{' ,"'}|=={[(#TITRE*|strlen)]}|?{'',&quot;})][(#TITRE*|entites_html)][(#TITRE*|strcspn{' ,"'}|=={[(#TITRE*|strlen)]}|?{'',&quot;})]</BOUCLE_m1>" />
</td></tr>
<tr><td align='right'>
<span id='sug'></span>
</td><td>
<div id='suggestions' style="font-size: 0.7em;">
&nbsp;
</div>
</td></tr>
<tr><td colspan='2'>
	<div align="#LANG_RIGHT"><input type='submit' value='ok' />
</td></tr>
</table>
</form>

<//B_a>


[(#REM)

	La liste des tags, dans des gentils < span >
	Idealement le addtag(this) serait ajoute par
	la fonction loadpopular ci-dessous

]

<div id='popularTags'>
<BOUCLE_tags(MOTS){type=tags}{par titre}><span style="display:none;visibility:hidden">#TITRE*</span>
</BOUCLE_tags>
</div>

</div>

[(#REM)

	Code partiellement copie du genial scuttle ; 

]
<script><!--

Array.prototype.contains = function (ele) {
    for (var i = 0; i < this.length; i++) {
        if (this[i] == ele) {
            return true;
        }
    }
    return false;
};

Array.prototype.remove = function (ele) {
    var arr = new Array();
    var count = 0;
    for (var i = 0; i < this.length; i++) {
        if (this[i] != ele) {
            arr[count] = this[i];
            count++;
        }
    }
    return arr;
};

function splittags(txt) {
	var temp = new Array();
	var r, i, debut;
	var compteur=1;

	if (txt.match(/^[ ,"]*$/))
		return new Array();

	while (r = txt.match(/(^| )"([^"]*)"(,| |$)/)) {
		debut = txt.search(r[0]);
		txt = txt.substring(0,debut)
			+ r[1]
			+ 'compteur'+compteur
			+ r[3]
			+ txt.substring(debut+r[0].length, 100000);
		temp['compteur'+compteur] = r[2];
		compteur++;
	}
	txt = txt.split(/[, ]+/);
	for (i=0; i<txt.length; i++) {
		if (txt[i].match('^compteur[0-9]+$')) {
			txt[i] = temp[txt[i]];
		}
	}
	return txt;
}

function jointags(a) {
	var tag, sp;
	for (var i = 0; i < a.length; i++) {
		tag = a[i];
		if (tag.split('"').length == 1
		&&(tag.split(' ').length > 1
			|| tag.split(',').length > 1
		)) {
			tag = '"'+tag+'"';
		}
		a[i] = tag;
	}

	return a.join(' ');  // ici mettre ' ' si on ne veut pas de virgule et ', ' dans le cas contraire
}



function addtag() {
    var thisTag = this.innerHTML;
    var taglist = document.getElementById('tags');
    var tags = splittags(taglist.value);
    
   var pop = new Array();
   var populartags = document.getElementById('popularTags').getElementsByTagName('span');
       
    //effacer la saisie 
   for (var i = 0; i < populartags.length; i++) {
		pop[i] = populartags[i].innerHTML ;
		}
   
    for (var i = 0; i < tags.length; i++) {
		if (!pop.contains(tags[i])) {
		tags = tags.remove(tags[i]);
		}
	}
   
    // If tag is already listed, remove it
    if (tags.contains(thisTag)) {
        tags = tags.remove(thisTag);
        this.className = 'unselected';
        
        
    // Otherwise add it
    } else {
        tags.push(thisTag);
        // tags.splice(0, 0, thisTag);
        this.className = 'selected';
    }
    
    taglist.value = jointags(tags) + ' ';
    document.getElementById('tags').focus();
}

function loadpopular() {
	var taglist = document.getElementById('tags');

	var tags = splittags(taglist.value);

	var populartags = document.getElementById('popularTags').getElementsByTagName('span');

	for (var i = 0; i < populartags.length; i++) {
		populartags[i]['onmousedown'] = addtag;
		if (tags.contains(populartags[i].innerHTML)) {
			populartags[i].className = 'selected';
		}
	}
document.onkeydown = document.onkeypress = document.onkeyup = handler ;
}


function handler(event) { var e=(event||window.event) //w3||ie
	var taglist = document.getElementById('tags');
	var tags = splittags(taglist.value);

	
	for (var i = 0; i < pop.length; i++) {
		pop[i].className = '';
		if (tags.contains(pop[i].innerHTML)) {
			pop[i].className = 'selected';
		}
	}
	
		if (e.type == 'keypress' && e.keyCode == 9) {
		e.preventDefault();
	
		susu=document.getElementById('suggestions').getElementsByTagName('span');
		document.write(susu.tosource());
		susu[0] = addtag ;
			}
			
			if (e.type == 'keypress' && e.keyCode == 32) {
			//effacer les suggestions
	var tab_sug = document.getElementById('suggestions') ;
	tab_sug.innerHTML='&nbsp;';
			}
		
		if (e.type == 'keyup') {
		//effacer les suggestions
		var tab_sug = document.getElementById('suggestions') ;
		tab_sug.innerHTML='&nbsp;';

		var saisie = tags.pop() ;
		
		var is_text = new RegExp('^[A-Za-z0-9 ���������������������-]+$', 'gi');
		var re = new RegExp('^'+saisie+'[A-Za-z0-9 ���������������������-]+$' , 'gi');
		
		if(saisie.match(is_text)){

			var i = 1 ;
			for (var j = 0; j < pop.length; j++) {
				//trouver les tags
				var tag_c = pop[j].innerHTML;
				if (tag_c.match(re) ) {
				pop[j].className = 'auto';
				
				//afficher des suggestions 
				var suggestion = document.createElement('span');
				suggestion.id = 'span'+i ;
				var titre = document.createTextNode(tag_c);
				document.getElementById('suggestions').appendChild(suggestion);	
				
				document.getElementById('span'+i).appendChild(titre);		
		
				suggestion['onmousedown'] = addtag;
				i=i+1;
				}
		}	}
			
}}
var pop = document.getElementById('popularTags').getElementsByTagName('span');
loadpopular();



// --></script>