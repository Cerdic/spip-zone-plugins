#CACHE{7200}
<?php

include_once _DIR_RESTREINT_ABS."base/abstract_sql.php";

if (!is_callable(sql_select)) {
  function sql_select($fields, $table, $cond) {
    return spip_abstract_select($fields, $table, $cond);
  }
}
if (!is_callable(sql_fetch)) {
  function sql_fetch($r) {
    return spip_abstract_fetch($r);
  }
}

$calendrier_mois=$_GET['calendrier_mois'];
$calendrier_annee=$_GET['calendrier_annee'];
$lang = '#LANG';
$oldlang = $GLOBALS['spip_lang'];
$GLOBALS['spip_lang'] = $lang;
$months = array('', _T('acs:agenda_janvier'), _T('acs:agenda_fevrier'), _T('acs:agenda_mars'),
	 _T('acs:agenda_avril'), _T('acs:agenda_mai'), _T('acs:agenda_juin'), _T('acs:agenda_juillet'),
	 _T('acs:agenda_aout'), _T('acs:agenda_septembre'), _T('acs:agenda_octobre'),
	 _T('acs:agenda_novembre'), _T('acs:agenda_decembre'));
$days = array(_T('acs:agenda_di'), _T('acs:agenda_lu'), _T('acs:agenda_ma'), _T('acs:agenda_me'), _T('acs:agenda_je'), _T('acs:agenda_ve'), _T('acs:agenda_sa'));
$GLOBALS['spip_lang'] = $oldlang;
if ($test_mini_agenda_deja_present!=1 &&!function_exists('mkdate')) {
	function mkdate($month, $day, $year) {
		return mktime(0, 0, 0, $month, $day, $year);
	}

	function preparation_URL($texte_URL,$mois_URL,$annee_URL) {
    $position = StrPos($texte_URL,"calendrier_mois");
    $texte_remplacement = "calendrier_mois=".$mois_URL."&amp;calendrier_annee=".$annee_URL;
    if ($position!==FALSE)
        {
        $texte_URL = substr_replace ($texte_URL,$texte_remplacement,$position);}
        else  { $presence = StrPos($texte_URL,"?");
                if ($presence === false)
                  {$texte_URL = $texte_URL."?".$texte_remplacement;}
                else
                  {$texte_URL = $texte_URL."&amp;".$texte_remplacement;}
              }
    return $texte_URL.'&lang=#LANG';
	}
}

if(isset($GLOBALS['var_nav_month'])) {
	$cal_day = mkdate($GLOBALS['var_nav_month'], 1, $GLOBALS['var_nav_year']);
} else {
	$cal_day = time();
}

$D = intval(date('d', $cal_day));
if (isset($calendrier_mois)) {
$M = $calendrier_mois;
} else {$M = intval(date('m', $cal_day));}
if (isset($calendrier_annee)) {
$Y = $calendrier_annee;
} else {$Y = intval(date('Y', $cal_day));}
$events = array();
$test_mini_agenda_deja_present = 1;

$datedebut = date("Ymd", mkdate($M, $D - 31, $Y));
$datefin = date("Ymd", mkdate($M, $D + 31, $Y));

// Articles publié ou modifiés
if (isset($GLOBALS['meta']['acsAgendaBulleVoirArticlesModifies']) && ($GLOBALS['meta']['acsAgendaBulleVoirArticlesModifies'] == 'oui'))
	$sql_modif = " OR (date_modif BETWEEN '$datedebut' AND '$datefin')";
$r = sql_select(array('id_article','date','date_modif','titre'), 'spip_articles', "statut='publie' AND ((date BETWEEN '$datedebut' AND '$datefin')$sql_modif)");
while($article = sql_fetch($r)) {
	$heure = ereg_replace("^.*([0-9]{2}):([0-9]{2}):([0-9]{2})$", "\\1h\\2", $article['date']);
	$date = ereg_replace("^([0-9]{4})-([0-9]{2})-([0-9]{2}).*$", "\\1\\2\\3", $article['date']);
	if (!isset($events[$date])) 
		$events[$date] = array();
	if (($date > $datedebut) && ($date < $datefin)) {
		$events[$date][ ] = array(
			'class' => 'publie',
			'type' => 'article',
			'heure' => $heure,
			'id' => $article['id_article'],
			'title' => $article['titre']);
	}	elseif(isset($sql_modif)) {
		$heure = ereg_replace("^.*([0-9]{2}):([0-9]{2}):([0-9]{2})$", "\\1h\\2", $article['date_modif']);
		$date = ereg_replace("^([0-9]{4})-([0-9]{2})-([0-9]{2}).*$", "\\1\\2\\3", $article['date_modif']);
		$events[$date][ ] = array(
			'class' => 'modifie',
			'type' => 'article',
			'heure' => $heure,
			'id' => $article['id_article'],
			'title' => $date.' '.$datedebut.' '.$datefin.' '.$article['titre']);
	}
}

// Breves, si actives dans SPIP
if ($GLOBALS['meta']['activer_breves'] == 'oui') {
	$r = sql_select(array('id_breve','date_heure','titre'), 'spip_breves', "statut='publie' AND date_heure BETWEEN '".date("Ymd", mkdate($M, $D - 31, $Y))."' AND '".date("Ymd", mkdate($M, $D + 31, $Y))."'");
	while($breve = sql_fetch($r)) {
		$heure = ereg_replace("^.*([0-9]{2}):([0-9]{2}):([0-9]{2})$", "\\1h\\2", $breve['date_heure']);
		$date = ereg_replace("^([0-9]{4})-([0-9]{2})-([0-9]{2}).*$", "\\1\\2\\3", $breve['date_heure']);
		if (!isset($events[$date])) 
			$events[$date] = array();
		$events[$date][ ] = array(
			'class' => 'breve',
			'type' => 'breve',
			'heure' => $heure,
			'id' => $breve['id_breve'],
			'title' => $breve['titre']);
	}
}

$mes = $months [$M];
if ($M==1){
    $calendrier_mois_moins=12;
    $calendrier_annee_moins=$Y-1;}
else {
    $calendrier_mois_moins=$M-1;
    $calendrier_annee_moins=$Y;}
if ($M==12){
    $calendrier_mois_plus=1;
    $calendrier_annee_plus=$Y+1;}
else {
    $calendrier_mois_plus=$M+1;
    $calendrier_annee_plus=$Y;}

$self = (isset($_GET['selfurl']) ? $_GET['selfurl'] : '#SELF');

?>

<script type="text/javascript">
<!--
var idBulleT;
var chrono = null;
var delai = "500";
var x,y;
var shiftx = -20;

if (self.innerHeight) // all except Explorer
{
	x = self.innerWidth;
	y = self.innerHeight;
}
else if (document.documentElement && document.documentElement.clientHeight)
	// Explorer 6 Strict Mode
{
	x = document.documentElement.clientWidth;
	y = document.documentElement.clientHeight;
}
else if (document.body) // other Explorers
{
	x = document.body.clientWidth;
	y = document.body.clientHeight;
}

//-->
</script>

<table width="100%" cellpadding="1" cellspacing="0" align="center" class="small_mini">
<tr class="calendar_this_month">
	<th colspan="7" valign="middle" class="calendar_header">
    <img id="img_agenda" src="#CHEMIN{images/searching.gif}" style="visibility: hidden;" align="#LANG_RIGHT" />
		<?php
		echo '<a id="agenda_prev" href="'.preparation_URL($self,$calendrier_mois_moins,$calendrier_annee_moins).'" title="Mois pr&eacute;c&eacute;dent" class="ajax"><img src="'.find_in_path('composants/agenda/images/fleche-left.png').'" alt="&lt;&lt;" /></a>&nbsp;&nbsp;<a href="spip.php?page=agenda&annee='.$Y.'&mois='.$M.'">'.$mes.' '.$Y.'</a>&nbsp;&nbsp;<a id="agenda_next" href="'.preparation_URL($self,$calendrier_mois_plus,$calendrier_annee_plus).'" title="Mois suivant" class="ajax"><img src="'.find_in_path('composants/agenda/images/fleche-right.png').'" alt="&gt;&gt;" /></a>';
		?>
	</th>
</tr>
<tr>
	<?php

	for($i = 1; $i < 8; $i++) {
		echo '<th width="14%" class="calendar_head_mini">'.$days[$i%7].'</th>';
	}
	$TempD = 1;
	if(date('w', mkdate($M, 1, $Y)) != 1) {
		echo '</tr><tr>';
		$tmp = '';
		while(date('w', mkdate($M, $TempD, $Y)) != 1) {
			$TempD--;
			$case = '<td width="14%" valign="top" class="calendar_not_this_month">';
			$case .= date('j', mkdate($M, $TempD, $Y));
			$date = date('Ymd', mkdate($M, $TempD, $Y));

			$case .= '</td>';
			$tmp = $case.$tmp;
		}
		echo $tmp;
	}
	$TempD = 1;
	while((date('m', mkdate($M, $TempD, $Y)) == $M) || (date('w', mkdate($M, $TempD, $Y)) != 1)) {
		if(date('w', mkdate($M, $TempD, $Y)) == 1) {
			echo '</tr><tr>';
		}
		echo '<td width="6%" valign="top" class="calendar_'.(date('m', mkdate($M, $TempD, $Y)) != $M ? 'not_' : '').'this_'.(date('Ymd', mkdate($M, $TempD, $Y)) == date('Ymd') ? 'day' : 'month').'">';
		$date = date('Ymd', mkdate($M, $TempD, $Y));
		if (isset($events[$date])) {
				$evt = '';
				foreach($events[$date] as $event) {
					$evt .= '<div class="'.$event['class'].'"><a href="spip.php?'.$event['type'].''.$event['id'].'&calendrier_mois='.$M.'&calendrier_annee='.$Y.'"><small>'.$event['heure'].'</small>: '.$event['title']."</a></div>\r";
				}
				echo '<span onmouseover="afficheBulle(\'bulle'.$date.'\', this)" onmouseout="cacheBulle(\'bulle'.$date.'\')">'.
					'<a href="?page=agenda&amp;annee='.$Y.'&amp;mois='.$M.'&amp;jour='.$TempD.'&amp;type=jour&amp;echelle=80" class="agenda_mini">'. date('j', mkdate($M, $TempD, $Y)) .'</a></span>'.
					'<div id="bulle'.$date.'" class="bulle" onmouseover="mouseOverBulle()" onmouseout="mouseOutBulle()">'.$evt.'</div>';
		}
		else {
			echo '<a>'.date('j', mkdate($M, $TempD, $Y)).'</a>';
		}
		echo '</td>';
		$TempD++;
	}
	?>
</tr>
</table>