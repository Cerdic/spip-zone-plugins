<BOUCLE_liste_shortcut_url_logs_detail(SHORTCUT_URLS){id_shortcut_url}>
<h1><:shortcut_url:titre_shortcut_url_log_detail:> #URL_SITE_SPIP/#TITRE</h1>


[<strong>(#ENV*{titre,#CLICK|singulier_ou_pluriel{shortcut_url:info_1_shortcut_url_click,shortcut_url:info_nb_shortcut_url_clicks}})</strong>]


<B_liste_shortcut_url_logs>
#ANCRE_PAGINATION
<div class="liste-objets sites syndic">
<table class='spip liste'>
<caption><strong class="caption"><:shortcut_url:titre_url_clicks:></strong></caption>
	<thead>
		<tr class='first_row'>
			<th class='statut' scope='col'>id</th>
			<th class='click_time' scope='col'><:shortcut_url:form_date_connect:></th>
			<th class='shorturl' scope='col'><:shortcut_url:form_url:></th>
			<th class='referrer' scope='col'><:shortcut_url:form_referrer:></th>
			<th class='user_agent' scope='col'><:shortcut_url:form_user_agent:></th>
			<th class='ip_address' scope='col'><:shortcut_url:form_ip_address:></th>
			<th class='country_code' scope='col'><:shortcut_url:form_country_code:></th>
		</tr>
	</thead>
	<tbody>
	<BOUCLE_liste_shortcut_url_logs(SHORTCUT_URLS_LOGS){id_shortcut_url}{pagination #ENV{nb,10}}>
		<tr class="[(#COMPTEUR_BOUCLE|alterner{row_odd,row_even})]">
			<td class='statut'>#ID_SHORTCUT_URLS_LOG</td>
			<td class='principale'>[(#DATE_MODIF|affdate)] [(#DATE_MODIF|affdate{'H:i:s'})]</td>
			<td class='principale'>#SHORTURL</td>
			<td class='principale'>#REFERRER</td>
			<td class='principale'>[(#USER_AGENT|couper{150})]</td>
			<td class='principale'>#IP_ADDRESS</td>
			<td class='principale'>#COUNTRY_CODE</td>
		</tr>
	</BOUCLE_liste_shortcut_url_logs>
	</tbody>
</table>
[<p class='pagination'>(#PAGINATION{prive})</p>]
</div>
</B_liste_shortcut_url_logs>[
<div class="liste-objets sites caption-wrap"><strong class="caption">(#ENV*{sinon,''})</strong>
<p><:shortcut_url::></div>
]<//B_liste_shortcut_url_logs>
<div class="liste-objets sites syndic">
<table class='spip liste'>
<caption><strong class="caption"><:shortcut_url:titre_liste_pays:></strong></caption>
	<thead>
		<tr class='first_row'>
			<th class='nom_pays' scope='col'><:shortcut_url:form_nom_pays:></th>
			<th class='click_time' scope='col'><:shortcut_url:form_click:></th>
		</tr>
	</thead>
	<tbody>
	<BOUCLE_liste_shortcut_url_logs_pays(SHORTCUT_URLS_LOGS){fusion country_code}{par country_code}{id_shortcut_url}>
		<BOUCLE_liste_pays(SHORTCUT_URLS_LOGS){country_code=#COUNTRY_CODE}{id_shortcut_url}> 
		#SET{nb_country, #TOTAL_BOUCLE}
		</BOUCLE_liste_pays>
		<tr class="[(#COMPTEUR_BOUCLE|alterner{row_odd,row_even})]">
			<td class='principale'>#COUNTRY_CODE</td>
			<td class='principale'>[(#GET{nb_country})]</td>
		</tr>
	</BOUCLE_liste_shortcut_url_logs_pays>
	</tbody>
</table>
</div>

<BOUCLE_si_plugins_d3js(CONDITION) {si #PLUGIN{D3JS}}>

<h2><:shortcut_url:titre_shortcut_url_graph_carte:></h2>
<script type="text/javascript">

$(document).ready(function($) {

	var m_width = $("#map_pays").width(),
		width = 538,
		height = 200,
		country,
		state;

	var projection = d3.geo.mercator()
		.scale(100)
		.translate([width / 2, height / 1.5]);

	var path = d3.geo.path()
		.projection(projection);

	var svg = d3.select("#map_pays").append("svg")
		.attr("preserveAspectRatio", "xMidYMid")
		.attr("viewBox", "0 0 " + width + " " + height)
		.attr("width", m_width)
		.attr("height", m_width * height / width);

	var path = d3.geo.path()
		.projection(projection);

	var g = svg.append("g");

	var tooltip = d3.selectAll(".d3_tooltip");

	var pays_on = ["DZA","AND","AUS","BEN","CAN","CHN","COL","COM","KOR","DJI","CIV","ETH","GAB","GNQ","GRD","MHL","ISL","JPN","JOR","KEN","LIE","MKD","MAR","MEX","MCO","MNE","NOR","NZL","DOM","COD","RUS","SRB","SGP","CHE","TTO","TUN","USA","UE"],
 		pays_on_long = {"DZA":"Algérie","AND":"Andorre","AUS":"Australie ","BEN":"Benin","CAN":"Canada","CHN":"Chine","COL":"Colombie","COM":"Comores","KOR":"Corée du Sud","DJI":"Djibouti","CIV":"Cote d&#8217;ivoire","ETH":"Ethiopie","GAB":"Gabon","GNQ":"Guinée Equatoriale","GRD":"Grenade","MHL":"République des Iles Marshall","ISL":"Islande","JPN":"Japon","JOR":"Jordanie","KEN":"Kenya","LIE":"Liechtenstein","MKD":"Macédoine","MAR":"Maroc","MEX":"Mexique","MCO":"Monaco","MNE":"Monténégro","NOR":"Norvège","NZL":"Nouvelle-Zélande","DOM":"République Dominicaine","COD":"République Démocratique du Congo","RUS":"Russie","SRB":"République de Serbie","SGP":"Singapour","CHE":"Suisse","TTO":"Trinidad et Tobaggo","TUN":"Tunisie","USA":"Etats-Unis","UE":"Union Européenne"};

	/**
 	* Récupérer le TopoJSON des pays
 	*/
	d3.json('[(#CHEMIN{json/regions.json})]', function(error, borders) {
		collection = topojson.feature(borders, borders.objects.maedi_pays);
		g.append("g")
		.attr("id", "countries")
		.selectAll("path")
		.data(collection.features)
		.enter()
		.append("path")
		.attr('class', function(d) {var classe = "pays"; return classe;})
		.attr("d", path)
		.on("mouseover", function (d,event) {
			if(jQuery.inArray(d.properties['ISO'],pays_on) != -1 || d.properties['EUMEMBER'] == 1){
					if(d.properties['EUMEMBER'] == 1){
							g.selectAll("path.ue").classed("hover", true);
							tooltip.html("<h3>"+pays_on_long.UE+"</h3>");
					}else{
							tooltip.html("<h3>"+pays_on_long[d.properties['ISO']]+"</h3>");
					}
					if(d3.event.clientX && d3.event.clientY)
							tooltip.style("left", (d3.event.clientX+20) + "px")
									.style("top",(d3.event.clientY+20)+ "px").style("opacity", "1");
			}
		})
		.on("mousemove", function (d) {
			if(d3.event.clientX && d3.event.clientY)
				tooltip.style("left", (d3.event.clientX + 20)+ "px")
						.style("top",(d3.event.clientY +20) + "px");
		})
		.on("mouseout", function (d) {
			if(d.properties['EUMEMBER'] == 1){
				g.selectAll("path.ue").classed("hover", false);
		}
			return tooltip.style("opacity", "0");
		});
	});

});
</script>

<div class="liste-objets sites syndic">
	<div id='map_pays'></div>
</div>


<h2><:shortcut_url:titre_shortcut_url_graph_pays:></h2>

<script type="text/javascript">

	$(document).ready(function($) {

		var json = [ 

		<BOUCLE_liste_shortcut_url_pays_pie(SHORTCUT_URLS_LOGS){fusion country_code}{par country_code}{id_shortcut_url}>
			<BOUCLE_liste_pays_pie(SHORTCUT_URLS_LOGS){country_code=#COUNTRY_CODE}{id_shortcut_url}> 
			#SET{nb_country, #TOTAL_BOUCLE}
			</BOUCLE_liste_pays_pie>
			{
				"label": "#COUNTRY_CODE",
				"value": [(#GET{nb_country})],
				"color": "#2484c1"
			},
		</BOUCLE_liste_shortcut_url_pays_pie>

		];

		var pie = new d3pie("d3pie_pays", {
			"size": {
				"canvasHeight": 560,
				"canvasWidth": 560
			},
			"data": {
			  "content": json
			},
			"labels": {
				"percentage": {
					"color": "#000000"
				}
			}
		});
	});

</script>

<div class="liste-objets sites syndic">
	<div id="d3pie_pays" class="d3pie_pays"></div>
</div>

<h2><:shortcut_url:titre_shortcut_url_graph_click:></h2>

<script type="text/javascript">

	$(document).ready(function($) {

			var json = [
				<BOUCLE_liste_shortcut_url_click_graph(SHORTCUT_URLS){id_shortcut_url}>
				<BOUCLE_shortcut_url_click_graph(SHORTCUT_URLS_LOGS){id_shortcut_url}{!par date_modif}>
					<BOUCLE_shortcut_url_dateclick_graph(SHORTCUT_URLS_LOGS){date_modif=#DATE_MODIF}>
						{
							"label": "[(#DATE_MODIF)]",
							"value": "#TOTAL_BOUCLE"
						},
					</BOUCLE_shortcut_url_dateclick_graph>
				</BOUCLE_shortcut_url_click_graph>
				</BOUCLE_liste_shortcut_url_click_graph>
			];

			var title_value = "Clicks";

			var margin = {top: 60, right: 60, bottom: 30, left: 60},
				width = 800 - margin.left - margin.right,
				height = 400 - margin.top - margin.bottom;

			var parseDate = d3.time.format("%Y-%m-%d %H:%M:%S").parse;
			var tooltipDate = d3.time.format("%e %b");

			var x = d3.time.scale()
				.range([0, width]);

			var y = d3.scale.linear()
				.range([height, 0]);

			var xAxis = d3.svg.axis()
				.scale(x)
				.tickSize(-height)
				.tickSubdivide(1);

			var yAxis = d3.svg.axis()
				.scale(y)
				.ticks(6)
				.orient("left");

			var line = d3.svg.line()
				.x(function(d) { return x(d.label); })
				.y(function(d) { return y(d.value); });

			var div = d3.select("body")
				.append("div")
				.attr("class", "tooltip")
				.style("opacity", 0);

			var svg = d3.select("#d3_click").append("svg")
				.attr("width", (width + margin.left + margin.right))
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

			json.forEach(function(d) {
				d.label = parseDate(d.label);
				d.value = +d.value;
			});

			x.domain(d3.extent(json, function(d) { return d.label; }));
			y.domain(d3.extent(json, function(d) { return d.value; }));

			svg.append("g")
				.attr("class", "x axis")
				.attr("transform", "translate(0," + height + ")")
				.call(xAxis);

			svg.append("g")
				.attr("class", "y axis")
				.call(yAxis)
				.append("text")
				.attr("transform", "rotate(-90)")
				.attr("y", 6)
				.attr("dy", ".71em")
				.style("text-anchor", "end")
				.text(title_value);

			svg.append("path")
				.datum(json)
				.attr("class", "line")
				.attr("d", line);

			svg.selectAll("dot")
				.data(json)
				.enter().append("circle")
				.attr("class", "circle")
				.attr("fill", "steelblue")
				.attr("r", 6)
				.attr("cx", function(d) { return x(d.label); })
				.attr("cy", function(d) { return y(d.value); })
				.on("mouseover", function(d) {
					div.transition()
						.duration(500)
						.style("opacity", 0);
					div.transition()
						.duration(200)
						.style("opacity", .9);
					div.html(tooltipDate(d.label) + "<br/>"  + d.value + " " + title_value)
						.style("left", (d3.event.pageX) + "px")
						.style("top", (d3.event.pageY - 28) + "px")
						.style("z-index", 5000);
				});

		});
</script>

<div class="liste-objets sites syndic">
	<div id="d3_click"></div>
</div>

</BOUCLE_si_plugins_d3js>
</BOUCLE_liste_shortcut_url_logs_detail>