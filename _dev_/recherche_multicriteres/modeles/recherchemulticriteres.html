<?php
/***************************************************************************\
 *  Recherche multicritères par mots-clés SPIP                             *
 *                                                                         *
 *  Copyright (c) 2005                                                     *
 *  Paul Sanches - http://www.netdeveloppeur.com                           *
 *  Adresse de publication de la contribution :	                           *
 *  http://www.netdeveloppeur.com                                          *
 *  Ce programme est un logiciel libre distribue sous licence GNU/GPL.     *
 *  Pour plus de details voir le fichier COPYING.txt                       *
\***************************************************************************/
?>
<BOUCLE_rubrique_search(RUBRIQUES) {id_rubrique}>
<?php
	$id_rubrique = '[(#ID_RUBRIQUE|texte_script)]';
?>
</BOUCLE_rubrique_search>
<?php
	if(!isset($id_rubrique)){
		$id_rubrique = 0;
	}
		
	$sql =  "SELECT spip_groupes_mots.id_groupe, spip_groupes_mots.titre AS titregroupe, spip_mots.id_mot,spip_mots.titre AS titremot ";
	$sql .= "FROM spip_rmc_rubs_groupes INNER JOIN spip_groupes_mots ON spip_rmc_rubs_groupes.id_groupe = spip_groupes_mots.id_groupe ";
	$sql .= "INNER JOIN spip_mots ON spip_mots.id_groupe  = spip_groupes_mots.id_groupe ";
	$sql .= "WHERE id_rubrique = $id_rubrique ";
	$sql .= "GROUP BY spip_groupes_mots.id_groupe,spip_groupes_mots.titre, spip_mots.id_mot,spip_mots.titre ";
	$sql .= "ORDER BY spip_groupes_mots.titre,spip_mots.titre";
		
	$result = mysql_query($sql);
	if ($result) {
		$id_grp_prec = 0;
		$i = 0;
		$sql1 = "SELECT colonnes AS nbcol, colonnes_rub AS nbcol_rub, taille_police AS taille, taille_police_rub AS taille_rub, couleur_police AS coul, couleur_police_rub AS coul_rub, couleur_bordure AS bord, couleur_bordure_rub AS bord_rub FROM spip_rmc_rubs_groupes_conf";
		$result1 = spip_query($sql1);
		$row1 = mysql_fetch_assoc($result1);
		extract($row1);
		if($id_rubrique != 0){
			$nbcol = $nbcol_rub;
			$taille = $taille_rub;
			$coul = $coul_rub;
			$bord = $bord_rub;
		}
		$nbselcreate = 0;
		$nbline = 0;
		while ($row = mysql_fetch_assoc($result)) {
			extract($row);
			
			if ($id_groupe != $id_grp_prec) {
				$i++;
				
				if ($id_grp_prec != 0) { 	
?>	
					</select>
<?php 			// if / else utile ?
					if ($nbselcreate == $nbcol) {
							$nbselcreate = 0;
?>
							</div>
<?php
					} else {
?>
						</div>
<?php
					}						
				} else {
?>	
				<form action="spip.php?page=rec_mc_result" method="post" id="form_mc" name="form_mc">
					<input type="hidden" name="id_rubrique" value="<?=$id_rubrique?>" />
					<div class="multicriteres" style="color:<?=$coul?>;">
						<h2>Recherche multi-crit&egrave;res</h2></div>
						<fieldset><legend>Listes des mots-cl&eacute;s </legend>
						<p><em>Maintenez la touche clavier &laquo;&nbsp;<abbr title="Controle">Ctrl</abbr>&nbsp;&raquo; enfonc&eacute;e pour s&eacute;lectionner plusieurs crit&egrave;res.</em></p>
					
		
					<div class="liste_mc" style="color:<?=$coul?>; background-color:<?=$bord?>">
<?php
				}
		// if / else utile ? :
				if ($nbselcreate == 0) { 
					$nbselcreate += 1 ;
?> 	
<?php 
				} else { 
					$nbselcreate += 1 ;
				} 
?>
					<div> 
					
						<p>
							<label for="idmot<?=$i?>"><?=$titregroupe?></label></p>
						<select name="idmot[]" id="idmot<?=$i?>" multiple="multiple" class="sel_mc">
<?php
			}
			$s = "SELECT id_mot_exclu FROM spip_rmc_mots_exclus WHERE id_mot_exclu=$id_mot AND id_rubrique=$id_rubrique";
			
			$r = spip_query($s);
			
			$rw = spip_fetch_array($r);
			
			if($rw['id_mot_exclu'] != $id_mot) {
?>
					<option value="<?=$id_mot?>"><?php echo supprimer_numero($titremot); ?></option>
<?php
			}
			$id_grp_prec = $id_groupe;
		}
	
		if ($id_grp_prec != 0) {
?>
				</select>
			</div>
<?php 
								# utile ? :
			if ($nbline != 0) { 
				while ($nbselcreate != $nbcol && $nbselcreate != 0) {
					$nbselcreate += 1;
?>
					<!--td bgcolor="#FFFFFF">&nbsp;</td-->
<?php
				}
			}					# fin utile ?
?>
			
			</div></fieldset>
			<fieldset class="options_mc">
			<legend>Options de recherche</legend>
				<p>
					<label for="nbjour">Chercher les articles de</label>
					<select id="nbjour" name="nbjour">
						<option value="0" selected="selected">- tous</option>
						<option value="7">- 7 jours</option>
						<option value="30">- 1 mois</option>
						<option value="9O">- 3 mois</option>
						<option value="365">- 12 mois</option>
					</select></p>
<?php
			if ($id_rubrique != 0) {
?>
				<p>
					<label for="onlyrub">Recherche limit&eacute;e &agrave; la rubrique en cours
					<input type="checkbox" value="1" name="onlyrub" id="onlyrub" /></label></p>
<?php
			}
?> 
				<p>
					<label for="allword">Tous les mots doivent &ecirc;tre pr&eacute;sents
					<input type="checkbox" value="1" id="allword" name="allword" /></label></p>	
			</fieldset>
			<p>
				<input type="hidden" value="<?=$id_rubrique?>" name="rubnum" />
				<input type="submit" value="Envoyer" class="button_mc" />
				<input type="reset" name="annuler" value="Annuler" class="submit button_mc" /></p>
		<p class="copyleft_mc"><a href="http://www.netdeveloppeur.com">D&eacute;velopp&eacute; par Net Developpeur</a></p>
		</form>
<?php
		}
		mysql_free_result($result);
		
	} else {
		echo "<hr />";
		echo "il n'y a pas de groupe de mots associ&eacute;s &agrave; cette rubrique : $id_rubrique<br>";
		echo "<hr />";	
	}
?>