#CACHE{0}
<?php

/*
   Comptage des clics
   Auteur chryjs (c) 2007
   Basé sur http://www.spip-contrib.net/Compter-les-clics-sur-les-liens
   et http://www.plugandspip.com/spip.php?article37
   Plugin pour spip 1.9.2
   Licence GNU/GPL
*/

//Sécurité : à vérifier...
//$id_syndic=$_GET['id_syndic'] ;
//$id_syndic_article=$_GET['id_syndic_article'] ;

// On se connecte à la base de données (en chargeant au passage les fonctions nécessaires à la suite)
// pas nécessaire puisque c est une page interprétée par spip
//include_once('ecrire/inc_version.php');
//include('ecrire/inc_connect.php');

// On voit si on a un identifiant soit de syndication soit d article syndiqué passé en variable
if (!empty($id_syndic)) {
	$r = spip_query("SELECT url_site AS url, clic_compteur AS clic_compteur_site,id_syndic FROM spip_syndic WHERE id_syndic='$id_syndic' LIMIT 1");
	$o = spip_fetch_array($r);
}
elseif (!empty($id_syndic_article)) {
	$r = spip_query("SELECT url, spip_syndic.clic_compteur AS clic_compteur_site, spip_syndic_articles.clic_compteur AS clic_compteur_site_article,spip_syndic.id_syndic FROM spip_syndic, spip_syndic_articles WHERE spip_syndic.id_syndic=spip_syndic_articles.id_syndic AND id_syndic_article='$id_syndic_article' LIMIT 1");
	$o = spip_fetch_array($r);
	// on incremente de suite le compteur lie a l article syndique
	if (spip_num_rows($r)<>0) spip_query("UPDATE LOW_PRIORITY spip_syndic_articles SET clic_compteur = clic_compteur + 1 WHERE id_syndic_article='$id_syndic_article' LIMIT 1");
}
// Sinon on renvoie un message d'erreur
else {
//	print("Erreur : aucun site ne correspond &agrave; la requ&ecirc;te");
?>
<:erreur_site:>
<?php
	exit;
}

if (spip_num_rows($r) == 0) {
//	print("Erreur : aucun site ne correspond &agrave; la requ&ecirc;te");
?>
<:erreur_site:>
<?php
	exit;
}

$remote_addr=$_SERVER["REMOTE_ADDR"]; // pour éviter les problemes de parser

// On incrémente le compteur du site dans tous les cas
if (empty($o[clic_compteur_site])) {
// avec la date du premier clic
spip_query("UPDATE LOW_PRIORITY spip_syndic SET clic_compteur = 1, clic_compteur_derniere_ip ='$remote_addr', clic_compteur_temps=NOW() WHERE id_syndic='$o[id_syndic]' LIMIT 1");
}
else {
// sans rien modifier
spip_query("UPDATE LOW_PRIORITY spip_syndic SET clic_compteur = clic_compteur + 1, clic_compteur_derniere_ip ='$remote_addr' WHERE id_syndic='$o[id_syndic]' LIMIT 1");
}

// Et on redirige (enfin) l'utilisateur vers l'URL du site (qu'on a passé en variable)
header("Location:$o[url]");

?>
