[(#REM) Plugin SpipBB - Licence GPL]
<?php
// permet la zolie mise en page comme dans l'espace admin
$spip_display=1;

include_spip("inc/presentation"); //encore pour les cadres

// On récup les infos du forum
include_spip('inc/spipbb'); // compat 192
$result = sql_select("*","spip_forum","id_forum=".$id_forum);
if ($row = sql_fetch($result)) $forum=$row;

//
// Modification du forum
//
$titre =  $_POST['titre'];
$texte =  $_POST['texte'];
$auteur =  $_POST['auteur'];
$email_auteur =  $_POST['email_auteur'];
$nom_site =  $_POST['nom_site'];
$url_site =  $_POST['url_site'];

if ($_POST['redirect']=='oui') { 

	if ($titre)	// pas de titre vide
		$forum['titre'] = corriger_caracteres($titre);
        
    if ($texte)	// pas de sujet vide
		$forum['texte'] = corriger_caracteres($texte);
        
// variables sans probleme
	$forum['auteur'] = corriger_caracteres($auteur);
	$forum['email_auteur'] = corriger_caracteres($email_auteur);
	$forum['nom_site'] = corriger_caracteres($nom_site); 
	$forum['url_site'] = vider_url($url_site);

	// l'entrer dans la base
    //$query = "UPDATE spip_forum SET
    //titre='".addslashes($forum['titre'])."',
    //texte='".addslashes($forum['texte'])."',
    //auteur='".addslashes($forum['auteur'])."',
    //email_auteur='".addslashes($forum['email_auteur'])."',
    //nom_site='".addslashes($forum['nom_site'])."',
    //url_site='".addslashes($forum['url_site'])."'
    //WHERE id_forum=".$id_forum;
    //sql_query($query) OR die($query);

	@sql_updateq('spip_forum', array(
			'titre' => addslashes($forum['titre']),
			'texte' => addslashes($forum['texte']),
			'auteur' => addslashes($forum['auteur']),
			'email_auteur' => addslashes($forum['email_auteur']),
			'nom_site' => addslashes($forum['nom_site']),
			'url_site' => addslashes($forum['url_site']) ),
			"id_forum='$id_forum'" );

    
    // et on redirige vers le fofo en question
    if ($forum['id_parent'] != 0) $id_parent=$forum['id_parent'];
    else $id_parent=$id_forum;
    header("Location: spip.php?page=voirsujet&id_forum=$id_parent");

}

// Le forum n'est modérable que par un admin ou par son auteur (du moins pour l'instant l'auteur ayant le même pseudo que l'auetur du thread
$statut=$GLOBALS['auteur_session']['statut'];
$nom_auteur_session=$GLOBALS['auteur_session']['nom'];

if ($forum['auteur']==$nom_auteur_session OR $statut=='0minirezo') { 
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html dir="#LANG_DIR" lang="#LANG">
<head> 
	<title>[(#NOM_SITE_SPIP|textebrut)] <:poster_message:></title>
	<INCLURE{fond=inc-forum-head}>
</head> 

<body id="posterfor" dir="#LANG_DIR">

<a name="haut"></a>
<div id="contenant"> <!-- Section contenant la page -->

	<INCLURE{fond=entete_BB}{id_article}>

	<div id="corps"> <!-- Section contenant les donnees -->
		[(#MODELE{spipbb_chemindefer}{id_article}{id_rubrique})]
		



	      <table class="spipforum">
	      		<thead>
        		<tr> 
          			<th colspan="2"><:poster_message:></th>
        		</tr>
        		</thead>
        		<tr> 
          			<td class="postsmiley"><INCLURE{fond=inc_tableau_smileys}{id_article}></td>
          			<td class="postformulaire"> 
          			<div class="tailformulaire">
          			<!-- Ce div est la  pour pallier l'illogisme qui fait que selon l'avancement dans le post on se trouve un coup avec .spip_encadrer autour de form et un coup l'inverse -->
          			<!-- Donc c'est lui qu'il faut dimmensionner et eventuellement centrer -->

				<div class="formulaire_spip formulaire_forum">

                                        <a id="formulaire_forum" name="formulaire_forum"></a>
                                        
                                        <? if ($_POST['modif']) {?>
                                        <form action="spip.php?page=editer&id_forum=<? echo $id_forum;?>" method="post"><div>
                                        <input type="hidden" name="id_forum" value="<? echo $id_forum;?>" />
                                        <input type="hidden" name="redirect" value="oui" />
                                        <input type="hidden" name="modif" value="1" />
                                        <input type="hidden" name="titre" value="<? echo $titre; ?>" />
                                        <input type="hidden" name="texte" value="<? echo $texte; ?>" />
                                        <input type="hidden" name="nom_site" value="<? echo $nom_site; ?>" />
                                        <input type="hidden" name="url_site" value="<? echo $url_site; ?>" />
                                        <input type="hidden" name="auteur" value="<? echo $auteur; ?>" />
                                        <input type="hidden" name="email_auteur" value="<? echo $email_auteur; ?>" />
                                        <fieldset class="previsu">
                                                <legend><:spip:previsualisation:></legend>
                                                <p>[<strong>(#ENV*{titre})</strong>][<em> - (#ENV*{auteur}|couper{80})</em>]</p>
                                                [(#ENV*{texte}|lignes_longues|spipbb_chatons)]
                                                [<p><a [href="(#ENV{url_site}|attribut_html)"] class="spip_out">(#ENV*{nom_site}|sinon{#ENV{url_site}|couper{80}})</a></p>]
                                                </fieldset>
                                        <input type='submit' class='fondo' name='confirmer' value='<:spip:bouton_valider:>' />
                                        </div></form> 
                                        <br />
                                        
                                        <? } else { 
                                $s = sql_select("*","spip_forum","id_forum=".$id_forum);
                             if ($t = sql_fetch($s))
                            $titre =  $t['titre'];
                            $texte =  $t['texte'];
                            $auteur =  $t['auteur'];
                            $email_auteur =  $t['email_auteur'];
                            $nom_site =  $t['nom_site'];
                            $url_site =  $t['url_site'];
                        }
                    ?>

                                        <form action="spip.php?page=editer&id_forum=<? echo $id_forum;?>" method="post"><div>
                                        <input type="hidden" name="id_forum" value="<? echo $id_forum;?>" />
                                        <input type="hidden" name="redirect" value="non" />
                                        <input type="hidden" name="modif" value="1" />

                                        <fieldset>
                                        <legend><:form_pet_message_commentaire:></legend>
                                        <p><label for="titre"><:forum_titre:></label>
                                        <input type="text" class="forml" name="titre" id="titre" value="<? echo $titre; ?>" size="40" /></p>

                                        <label><:forum_texte:></label>
                                        <p><small><:info_creation_paragraphe:></small></p>
                                        <? echo barre_textarea($texte,12,40); ?>

                                        <fieldset>
                                        <legend><:forum_lien_hyper:></legend>
                                        <p><:forum_page_url:></p>
                                        <p><label for="nom_site"><:forum_titre:></label>
                                        <input type="text" class="forml" name="nom_site" id="nom_site" size="40" value="<? echo $nom_site; ?>" /></p>
                                        <p><label for="url_site"><:forum_url:></label>
                                        <input type="text" class="forml" name="url_site" id="url_site" style="text-align: left;" dir="ltr" size="40" value="<? echo $url_site; ?>" /></p>
                                        </fieldset>

                                        <fieldset>
                                        <legend><:forum_qui_etes_vous:></legend>
                                        <p><label for="auteur"><:forum_votre_nom:></label>
                                        <input type="text" class="forml" name="auteur" id="auteur" value="<? echo $auteur; ?>" size="40"[ readonly="(#ENV{readonly})"] /></p>
                                        <p><label for="email_auteur"><:forum_votre_email:></label>
                                        <input type="text" class="forml" name="email_auteur" id="email_auteur" value="<? echo $email_auteur; ?>" size="40"[ readonly="(#ENV{readonly})"] /></p>
                                        </fieldset>

                                        [(#REM) Piege a robots spammeurs ]
                                        <p style='display:none;'><label for="nobot"><:antispam_champ_vide:></label>
                                        <input type="text" name="nobot" id="nobot" value="#ENV{nobot}" size="10" /></p>

                                        <input type='submit' class='fondo' name='confirmer' value='<:spip:bouton_valider:>' />
                                        
                                        </div>
                                        </form>

                                        </div>

				</div>
          			</td>
        		</tr>
      		</table>

	</div> <!-- Fin de la section "corps" -->

	<INCLURE{fond=pied_BB}{id_article}{id_forum}>

	[(#REM) Pied de page standard SPIP]
	<INCLURE{fond=inc-pied}{skel=#SQUELETTE}>

</div><!-- fin de la Section contenant -->

</body>

</html>

 <?} 
 else { echo "<:spipbb:droit_editer:>";
 echo "<meta http-equiv='refresh' content='0; url=Javascript:history.go(-1)'>";
 }?>
 
