#CACHE{0}
<?php
// La ligne suivante permet d'intercepter si le formulaire vient d'etre valide, auquel cas on redirige vers la page d'affichage des elements en la mettant a jour
if ($redirect==oui) {
	echo "<meta http-equiv='refresh' content='0; url=spip.php?page=profile&id_auteur=$id_auteur&id_rubrique=$id_rubrique&var_mode=recalcul'>";
}

if (!$auteur_session){ //Si pas logge, on affiche le formulaire de login'
?> 
<INCLURE{connexion}{id_rubrique}>
<?php exit; }
 
 // permet la zolie mise en page comme dans l'espace admin
$spip_display=1;

include("ecrire/inc/presentation.php"); //encore pour les cadres
$statut=$auteur_session['statut'];
$id_auteur_session=$auteur_session['id_auteur'];
$auteur=unserialize(spipbb_get_auteur_infos($id_auteur_session));
//Si admin ou redacteur, renvoie sur la page de gestion de leurs infos dans l'espace prive
//if ($statut=="0minirezo" OR $statut=="1comite") {
//	 header("Location: ./ecrire/?exec=auteurs_edit&amp;id_auteur=$id_auteur_session");
//	 }

// Debut du script repris et simplifie de ecrire/exec/auteur_infos.php
//
// Modification (et creation si besoin)
//
if ($modif) { 
	if ($nom)	// pas de nom vide
		$auteur['nom'] = corriger_caracteres($nom);


	// changement de pass, a securiser en jaja ?
	if ($new_pass AND ($statut != '5poubelle') AND $auteur['login'] AND $auteur['source'] == 'spip') {
		if ($new_pass != $new_pass2)
			$echec .= "<br />"._T('info_passes_identiques');
		else if ($new_pass AND strlen($new_pass) < 6)
			$echec .= "<br />"._T('info_passe_trop_court');
		else {
			$modif_login = true;
			$auteur['new_pass'] = $new_pass;
		}
	}


	if ($modif_login) {
		include_ecrire('/inc/session.php');
		zap_sessions ($auteur['id_auteur'], true);
		if ($id_auteur_session == $auteur['id_auteur'])
			supprimer_session($GLOBALS['spip_session']);
	}


	// variables sans probleme
	$auteur['bio'] = corriger_caracteres($bio);
	$auteur['pgp'] = corriger_caracteres($pgp);
	$auteur['nom_site'] = corriger_caracteres($nom_site_auteur); // attention mix avec $nom_site_spip ;(
	$auteur['url_site'] = vider_url($url_site);

	if ($new_pass) {
		$htpass = generer_htpass($new_pass);
		$alea_actuel = creer_uniqid();
		$alea_futur = creer_uniqid();
		$pass = md5($alea_actuel.$new_pass);
		$query_pass = " pass='$pass', htpass='$htpass', alea_actuel='$alea_actuel', alea_futur='$alea_futur', ";
		effacer_low_sec($auteur['id_auteur']);
	} else
		$query_pass = '';

	// recoller les champs du extra
	if ($champs_extra) {
		include_spip("inc/extra");
		$extra = extra_recup_saisie("auteurs");
		$add_extra = ", extra = '".addslashes($extra)."'";
	} else
		$add_extra = '';

	// l'entrer dans la base
	if (!$echec) {
		if (!$auteur['id_auteur']) { // creation si pas d'id
			spip_query("INSERT INTO spip_auteurs (nom) VALUES ('temp')");
			$auteur['id_auteur'] = spip_insert_id();
			$id_auteur = $auteur['id_auteur'];

		}

		$query = "UPDATE spip_auteurs SET $query_pass
			nom='".addslashes($auteur['nom'])."',
			login='".addslashes($auteur['login'])."',
			bio='".addslashes($auteur['bio'])."',
			email='".addslashes($auteur['email'])."',
			nom_site='".addslashes($auteur['nom_site'])."',
			url_site='".addslashes($auteur['url_site'])."',
			pgp='".addslashes($auteur['pgp'])."',
			statut='".addslashes($auteur['statut'])."'
			$add_extra
			WHERE id_auteur=".$auteur['id_auteur'];
		if (!function_exists('sql_query')) include_spip('inc/spipbb_192');
		sql_query($query) OR die($query);
	}
	
	// Subtilite, spip passe avant le php, donc la page est creee avant la mise a jour, donc l'avatar n'est pas a jour si on ne recharge pas la page !
if(!echec){header("Location: spip.php?page=profile&id_auteur=$id_auteur_session&id_rubrique=$id_rubrique");}
}	
	
// Si visiteur (et verification de la correspondance des $id_auteurs) afficher la page.
if ($auteur_session AND $auteur_session['id_auteur']==$id_auteur) { 
?>

	<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

  <BOUCLE_auteur_principal(AUTEURS){id_auteur}{tout}>
  <html lang="#LANG">
  <head>
  <title><:spipbb:profil:> #NOM</title>
  <INCLURE{fond=inc-forum-head}>
  </head>
  
<body id="profilmod" dir="#LANG_DIR">
<div id="contenant"> <!-- Section contenant la page -->

	<INCLURE{fond=entete_BB}{id_rubrique}>

	<div id="corps"><!-- Section contenant les donnees -->
		
		<hr class="clr" /> <!-- Permet l'affichage correctement pour certaines versions de safari -->

		[(#MODELE{spipbb_chemindefer}{id_rubrique})]

		<div id="detail"> <!-- Section pour mise en forme specifique des informations d'un utilisateur -->
 			<h2><:spipbb:profil:> #NOM</h2>
			[<div id="avatar"> <!--Section de l'avatar-->
				<h3><:spipbb:avatar:></h3>
                                (#LOGO_AUTEUR||reduire_image{150,150}|sinon{ 
                                        [(#NOM|spipbb_afficher_avatar{''})]  
                                })
			</div>]
			<div id="information"> <!-- Section  des informations -->
			<h3><:spipbb:paramprofil:></h3>
 <?php if ($echec){
	echo debut_cadre_relief(true);
	echo '<img src="'.find_in_path('images/warning.gif').'" alt="'._T('spipbb:info_avertissement').'" width="48" height="48" style="float:left" />';
	echo "<font color='red'>$echec <br />"._T('spipbb:info_recommencer')."</font>";
	echo fin_cadre_relief(true);
	echo "<br />";
}
  echo debut_cadre_formulaire('',true);
  echo "<form action='spip.php?page=profile' method='post'>";
  echo "<input type='hidden' name='id_auteur' value=\"$id_auteur\" />";
  echo "<input type='hidden' name='id_rubrique' value=\"$id_rubrique\" />";
  echo "<input type='hidden' name='redirect' value=\"oui\" />";   
  echo "<input type='hidden' name='modif' value=\"1\" />";

  //
  // Infos personnelles
  //
  echo "<div class='serif'>";
  	echo debut_cadre_relief("ecrire/img_pack/fiche-perso-24.png",true);
  	echo _T('spipbb:titre_cadre_signature_obligatoire'); 
  	echo "("._T('spipbb:entree_nom_pseudo').")<br/>";
  	echo "<input type='text' name='nom' class='formo' value=\"".entites_html($auteur['nom'])."\" size='40' /><br />";
	echo "<b>"._T('spipbb:entree_adresse_email')."</b>";
	if ($statut == "0minirezo") {
		echo "<br/><input type='text' name='email' class='formo' value=\"".entites_html($auteur['email'])."\" size='40' /><br />\n";}
	else {
		echo "&nbsp;: <tt>".$auteur['email']."</tt>";
		echo "<br />("._T('spipbb:info_reserve_admin').")\n";
		echo "<br />"; }
	echo "<b>"._T('spipbb:entree_infos_perso')."</b><br/>";
	echo "("._T('spipbb:entree_biographie').")<br/>";
	echo "<textarea name='bio' class='forml' rows='4' cols='40'>";
	echo entites_html($auteur['bio']);
	echo "</textarea>\n";
	if ($champs_extra) {
		include_spip("inc/extra");
		extra_saisie($auteur['extra'], 'auteurs', 'inscription'); }
		echo fin_cadre_relief(true);
		echo "<br />";
        
  	if ($options == "avancees") {
  		echo debut_cadre_relief("cadenas-24.png",true);
	  	echo "<b>"._T('spipbb:entree_cle_pgp')."</b><br/>";
	  	echo "<textarea name='pgp' class='forml' rows='4' cols='40'>";
	  	echo entites_html($auteur['pgp']);
	  	echo "</textarea>\n";
	  	echo fin_cadre_relief(true);
	  	echo "<br />"; }
	else {
		echo "<input type='hidden' name='pgp' value=\"".entites_html($auteur['pgp'])."\" />"; }
	
	echo debut_cadre_relief("site-24.png",true);
	echo "<b>"._T('spipbb:entree_nom_site')."</b><br/>";
	echo "<input type='text' name='nom_site_auteur' class='forml' value=\"".entites_html($auteur['nom_site'])."\" size='40' /><br />\n";
	echo "<b>"._T('spipbb:entree_url')."</b><br/>";
  	echo "<input type='text' name='url_site' class='forml' value=\"".entites_html($auteur['url_site'])."\" size='40' />\n";
  	echo fin_cadre_relief(true);
  	echo "<br />";
    
    echo "<b><:spipbb:lieu:> :</b><br /><input name=\"suppl_Localisation\" class=\"forml\" value=\"[(#EXTRA|extra{Localisation}|entites_html)]\" size=\"40\" type=\"text\" /><br />";
    echo "<b><:spipbb:interet:> :</b><br /><input name=\"suppl_Emploi\" class=\"forml\" value=\"[(#EXTRA|extra{Emploi}|entites_html)]\" size=\"40\" type=\"text\" /><br />";
    echo "<b><:spipbb:loisirs:> :</b><br /><input name=\"suppl_Loisirs\" class=\"forml\" value=\"[(#EXTRA|extra{Loisirs}|entites_html)]\" size=\"40\" type=\"text\" /><br />";
    echo "<b><:spipbb:numero_icq:> :</b><br /><input name=\"suppl_Numero_ICQ\" class=\"forml\" value=\"[(#EXTRA|extra{Numero_ICQ}|entites_html)]\" size=\"40\" type=\"text\" /><br />";
    echo "<b><:spipbb:nom_aim:> :</b><br /><input name=\"suppl_Nom_AIM\" class=\"forml\" value=\"[(#EXTRA|extra{Nom_AIM}|entites_html)]\" size=\"40\" type=\"text\" /><br />";
    echo "<b><:spipbb:nom_yahoo:> :</b><br /><input name=\"suppl_Nom_Yahoo\" class=\"forml\" value=\"[(#EXTRA|extra{Nom_Yahoo}|entites_html)]\" size=\"40\" type=\"text\" /><br />";
    echo "<b><:spipbb:nom_MSNM:> :</b><br /><input name=\"suppl_Nom_MSNM\" class=\"forml\" value=\"[(#EXTRA|extra{Nom_Yahoo}|entites_html)]\" size=\"40\" type=\"text\" /><br />";
    if ($statut=="6forum" OR $statut=="1comite"){ // ça c'est que pour ceux qui ont pas accès à leur page d'auteur dans l'admin
        echo "<b><:spipbb:url_avatar:> :</b><br /><input name=\"suppl_avatar\" class=\"forml\" value=\"[(#EXTRA|extra{avatar}|propre|entites_html)]\" size=\"40\" type=\"text\" /><br />";
    }
    echo "<b><:spipbb:signature:> :</b><br /><textarea name=\"suppl_signature\" class=\"forml\" rows=\"5\" cols=\"40\">[(#EXTRA|extra{signature}|entites_html)]</textarea>";

	// le visiteur ne peut editer son login et mais peut editer son pass, modifier les valeurs selon les besoins  
		$edit_login = false;
		$edit_pass = true;
	// Je presume que c'est pour eviter de modifier ses coordonnees en cas d'utilisation d'un ldap
	if ($auteur[source] != 'spip') {
		$edit_login = false;
		$edit_pass = false; }

	echo debut_cadre_relief("base-24.png",true);
	// Avertissement en cas de modifs de ses propres donnees
	if ($edit_login OR $edit_pass) {
	echo debut_cadre_enfonce(true);
	echo '<img src="'.find_in_path('images/warning.gif').'" alt="'._T('spipbb:info_avertissement').'" width="48" height="48" align="right" />';
	echo "<b>"._T('spipbb:texte_login_precaution')."</b>\n";
	echo fin_cadre_enfonce(true);
	echo "<br />"; }

	// Un redacteur n'a pas le droit de modifier son login !
	if ($edit_login) {
		echo "<b>"._T('spipbb:item_login')."</b> ";
		echo "<font color='red'>("._T('spipbb:texte_plus_trois_car').")</font> :<br/>";
		echo "<input type='text' name='login' class='formo' value=\"".entites_html($auteur['login'])."\" size='40' /><br />\n"; }
	else {
		echo "<fieldset style='padding:5'><legend><b>"._T('spipbb:item_login')."</b><br/></legend><br/><b>".$auteur['login']."</b> ";
		echo "<i> ("._T('spipbb:info_non_modifiable').")</i><br />"; }

	// On ne peut modifier le mot de passe en cas de source externe (par exemple LDAP)
	if ($edit_pass) {
		echo "<b>"._T('pass_nouveau_pass')."</b> ";
		echo "<font color='red'>("._T('spipbb:info_plus_cinq_car').")</font> :<br/>";
		echo "<input type='password' name='new_pass' class='formo' value=\"\" size='40' /><br/>\n";
		echo _T('spipbb:info_confirmer_passe')."<br />";
		echo "<input type='password' name='new_pass2' class='formo' value=\"\" size='40' /><br />\n";
	}
	if (!$edit_login) {
		echo "</fieldset>";
	}
	echo fin_cadre_relief(true);
	echo "<br />";

	echo "<div align='center'><input type='submit' class='fondo' name='Valider' value='"._T('bouton_valider')."' /></div>";

echo "</div>";
echo "</form>";
echo fin_cadre_formulaire(true); ?>
			</div> <!-- Fin de la section des informations -->
			
			<div id="communication"> <!--Section contenant les elements de communication-->
				<!-- On garde cette section pour l'instant au cas ou on en ait besoin. La page est exactement sur le meme modele que la page profil_BB -->
				<!-- A savoir qu'elle est utile dans la mise en forme par css spipbblike -->
			</div>
			
		</div><!-- Fin de la section detail -->

	</div><!-- Fin de la section Corps -->

<INCLURE{fond=pied_BB}{id_rubrique}>

</div> <!-- Fin de la section contenant -->
</body>
</html>
</BOUCLE_auteur_principal>
<:aucun_auteur:>
<//B_auteur_principal>
<?php
} else header("Location: spip.php?page=profile&id_auteur=$id_auteur_session&id_rubrique=$id_rubrique"); // Ca c'est si un p'tit malin essaye d'editer le profile d'un autre...
?>
