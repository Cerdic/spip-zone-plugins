<B_prix>
<div class="liste prix">
<table class="spip liste ordonner_rang_lien liste_items prix_objets"
	id="prix_choisis"
	data-lien="[(#OBJET|concat{'/',#ID_OBJET}|attribut_html)]">
	[<caption>
		<strong class="caption">
			(#ENV*{titre,#GRAND_TOTAL|singulier_ou_pluriel{prix_objets:info_1_prix,prix_objets:info_nb_prix}})
			</strong>
	</caption>]
	<thead>
		<tr class='first_row'>
			<th class='prix' scope='col'><:prix_objets:info_prix:></th>
			<th class='statut' scope='col'><:prix_objets:choix_devise:></th>
			<th class='taxes' scope='col'><:prix_objets:taxes:></th>
			<th class='titre' scope='col'><:ecrire:info_titre:></th>
			<th class='titre' scope='col'><:prix_objets:info_actions:></th>
		</tr>
	</thead>
	<tbody class="sortable">
	<BOUCLE_prix(DATA){source tableau, #ENV{prix_choisis}} {par rang_lien, titre, prix_ht}>
	[(#VALEUR|table_valeur{prix_ht}|!={0.00}|?{
		#SET{prix,#VALEUR|table_valeur{prix_ht}}
		#SET{taxes,<:prix_objets:prix_ht:>}
		,
		#SET{prix,#VALEUR|table_valeur{prix}}
		#SET{taxes,<:prix_objets:prix_ttc:>}
	})]
		<tr class="[(#COMPTEUR_BOUCLE|alterner{row_odd,row_even})]" id="prix#ID_PRIX_OBJET">
			<td>#GET{prix}</td>
			<td>[(#VALEUR|table_valeur{code_devise}|traduire_devise)]</td>
			<td>#GET{taxes}</td>
			<td>#VALEUR{titre}</td>
			<td>
				<span class="deplacer-prix" data-rang="#RANG_LIEN">
					<img src='#CHEMIN_IMAGE{deplacer-16.png}'
					width='16'
					height='16'
					alt='<:medias:ordonner_ce_document|attribut_html:>'
					title='<:medias:ordonner_ce_document|attribut_html:>' />
				</span>
				<a
					class="ajax"
					href="[(#URL_ACTION_AUTEUR{
						eliminer_prix,#ID_PRIX_OBJET,[(#SELF|parametre_url{retour_action,oui})]
						})]#edition_prix"
					title="<:spip:lien_supprimer:>">
					<img src="#CHEMIN_IMAGE{supprimer-12.png}" />
				</a>
			</td>
		</tr>
	</BOUCLE_prix>
	</tbody>
</table>
</div>
</B_prix>

<script type="text/javascript">
/* Gestion du tri des listes de documents et de leur enregistrement */

	$(function($){

	if ($.fn.sortable) {
		$(".liste.prix .ordonner_rang_lien[data-lien]").find('.sortable').each(function () {

			// détruire / recréer le sortable à chaque appel ajax
			if ($(this).has('.ui-sortable').length) {
				$(this).sortable('destroy');
			}
			// pas de tri possible s'il n'y a qu'un seul élément.
			if ($(this).find('tr').length < 2) {
				$(this).find('.deplacer-document').hide();
				return true; // continue
			} else {
				$(this).find('.deplacer-document').show();
			}
			$(this).sortable({
				/*axis: "y",*/ /* minidoc a un affichage en case */
				placeholder: ".ui-state-highlight",
				cursor: "move",
				containment: "parent",
				tolerance: "pointer",
				update: function (event, ui) {
					var items = $(this);
					var item = ui.item;
					var liste = items.sortable('toArray');
					var ordre = [];

					$.each(liste, function(i, id) {
						if (id) {
							ordre.push( id.substring(4) ); // prix123 => 123
						}
					});

					// l'objet lié est indiqué dans l'attribut data-lien sur la liste
					var lien = items.parents(".liste_items.prix_objets").data("lien").split("/");
					var objet_lie = lien[0];
					var id_objet_lie = lien[1];
					var action = '[(#VAL{ordonner_prix_objets}|generer_url_action{"", 1})]';
					var params = {
						objet_source: 'prix_objet',
						objet_lie: objet_lie,
						id_objet_lie: id_objet_lie,
						ordre: ordre,
					};

					$.ajax({
						url: action,
						data: params,
						dataType: 'json',
						cache: false,
					}).done(function(data) {

						var couleur_origine = item.css('background-color');
						var couleur_erreur = $("<div class='remove'></div>").css('background-color');
						var couleur_succes = $("<div class='append'></div>").css('background-color');

						if (data.errors.length) {
							items.sortable('cancel');
							item.css({backgroundColor: couleur_erreur}).animate({backgroundColor: couleur_origine}, 'normal', function(){
								item.css({backgroundColor: ''});
							});
						} else {
							item.css({backgroundColor: couleur_succes}).animate({backgroundColor: couleur_origine}, 'normal', function(){
								item.css({backgroundColor: ''});
							});
							items.parent().find('.tout_desordonner').show();
						}
					});
				}
			});
			// bouton "désordonner"
			if ($(this).parent().find('.deplacer-document[data-rang!=0]').length) {
				$(this).parent().find('.tout_desordonner').show();
			} else {
				$(this).parent().find('.tout_desordonner').hide();
			}
		});
	}
});
</script>
