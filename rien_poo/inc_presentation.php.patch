1917,1918c1917
< 
< function barre_onglets($rubrique, $onglet){
---
> function definir_barre_onglets($rubrique) {
1921c1920
< 	debut_onglet();
---
> 	$onglets=array();
1923,1927c1922,1924
< 	if ($rubrique == "statistiques") {
< 	//	onglet(_T('onglet_evolution_visite_mod'), generer_url_ecrire("statistiques_visites",""), "evolution", $onglet, "statistiques-24.gif");
< 	//	onglet(_T('titre_liens_entrants'), generer_url_ecrire("statistiques_referers",""), "referers", $onglet, "referers-24.gif");
< 	}
< 	if ($rubrique == "repartition") {
---
> 	switch($rubrique) {
> 	case 'statistiques_repartition':
> 	case 'repartition':
1929,1930c1926,2012
< 			onglet(_T('onglet_repartition_rubrique'), "statistiques_repartition.php", "rubriques", $onglet, "rubrique-24.gif");
< 			onglet(_T('onglet_repartition_lang'), generer_url_ecrire("statistiques_lang",""), "langues", $onglet, "langues-24.gif");
---
> 			$onglets['rubriques']=array(
> 				'libelle' => 'onglet_repartition_rubrique',
> 				'icone' => 'rubrique-24.gif');
> 			$onglets['langues']=array(
> 				'libelle' => 'onglet_repartition_lang',
> 				'icone' => 'langues-24.gif');
> 		}
> 	break;
> 
> 	case 'rep_depuis':
> 		$onglets['statistiques_lang']=array(
> 			'libelle' => 'icone_repartition_actuelle');
> 		$onglets['debut']=array(
> 			'libelle' => 'onglet_repartition_debut',
> 			'url' => generer_url_ecrire("statistiques_lang","critere=debut"));
> 	break;
> 
> 	case 'stat_depuis':
> 		$onglets['popularite']=array(
> 			'libelle' => 'icone_repartition_actuelle',
> 			'url' => generer_url_ecrire("statistiques_repartition",""));
> 		$onglets['debut']=array(
> 			'libelle' => 'onglet_repartition_debut',
> 			'url' => generer_url_ecrire("statistiques_repartition","critere=debut"));
> 	break;
> 
> 	case 'stat_referers':
> 		$onglets['jour']=array(
> 			'libelle' => 'date_aujourdhui',
> 			'url' => generer_url_ecrire("statistiques_referers",""));
> 		$onglets['veille']=array(
> 			'libelle' => 'date_hier',
> 			'url' => generer_url_ecrire("statistiques_referers","jour=veille"));
> 	break;
> 
> 	case 'administration':
> 		$onglets['sauver']=array(
> 			'libelle' => 'onglet_save_restaur_base',
> 			'url' => generer_url_ecrire("admin_tech",""),
> 			'icone' => 'base-24.gif');
> 		$onglets['effacer']=array(
> 			'libelle' => 'onglet_affacer_base',
> 			'url' => generer_url_ecrire("admin_effacer",""),
> 			'icone' => 'supprimer.gif');
> 	break;
> 
> 	//??????
> 	case 'auteur':
> 		$onglets['auteur']=array(
> 			'libelle' => 'onglet_auteur',
> 			'url' => generer_url_ecrire("auteurs_edit","id_auteur=$id_auteur"),
> 			'icone' => 'auteur-24.gif');
> 		$onglets['infos']=array(
> 			'libelle' => 'onglet_informations_personnelles',
> 			'url' => generer_url_ecrire("auteurs_infos","id_auteur=$id_auteur"),
> 			'icone' => 'fiche-perso-24.gif');
> 	break;
> 
> 	case 'configuration':
> 		$onglets['contenu']=array(
> 			'libelle' => 'onglet_contenu_site',
> 			'url' => generer_url_ecrire("configuration"),
> 			'icone' => 'racine-site-24.gif');
> 		$onglets['interactivite']=array(
> 			'libelle' => 'onglet_interactivite',
> 			'url' => generer_url_ecrire("config_contenu"),
> 			'icone' => 'forum-interne-24.gif');
> 		$onglets['fonctions']=array(
> 			'libelle' => 'onglet_fonctions_avances',
> 			'url' => generer_url_ecrire("config_fonctions"),
> 			'icone' => 'image-24.gif');
> 	break;
> 
> 	case 'config_lang':
> 		$onglets['langues']=array(
> 			'libelle' => 'info_multilinguisme',
> 			'url' => generer_url_ecrire("config_lang"),
> 			'icone' => 'langues-24.gif');
> 		$onglets['multi']=array(
> 			'libelle' => 'info_langue_principale',
> 			'url' => generer_url_ecrire("config_multilang"),
> 			'icone' => 'traductions-24.gif');
> 		if ($GLOBALS['meta']['multi_articles'] == "oui" OR $GLOBALS['meta']['multi_rubriques'] == "oui") {
> 			$onglets['fichiers']=array(
> 				'libelle' => 'module_fichiers_langues',
> 				'url' => generer_url_ecrire("lang_raccourcis"),
> 				'icone' => 'traductions-24.gif');
1932,1942c2014
< 	}
< 
< 	if ($rubrique == "rep_depuis") {
< 		onglet(_T('icone_repartition_actuelle'), generer_url_ecrire("statistiques_lang",""), "popularite", $onglet);
< 		onglet(_T('onglet_repartition_debut'), generer_url_ecrire("statistiques_lang","critere=debut"), "debut", $onglet);
< 
< 	}
< 
< 	if ($rubrique == "stat_depuis") {
< 		onglet(_T('icone_repartition_actuelle'), "statistiques_repartition.php", "popularite", $onglet);
< 		onglet(_T('onglet_repartition_debut'), "statistiques_repartition.php?critere=debut", "debut", $onglet);
---
> 	break;
1944c2016,2018
< 	}
---
> 	// inutilise
> 	case 'suivi_forum':
> 	break;
1946,1948d2019
< 	if ($rubrique == "stat_referers") {
< 		onglet(ucfirst(_T('date_aujourdhui')), generer_url_ecrire("statistiques_referers",""), "jour", $onglet);
< 		onglet(ucfirst(_T('date_hier')), generer_url_ecrire("statistiques_referers","jour=veille"), "veille", $onglet);
1951,1954c2022
< 	if ($rubrique == "administration"){
< 		onglet(_T('onglet_save_restaur_base'), generer_url_ecrire("admin_tech"), "sauver", $onglet, "base-24.gif");
< 		onglet(_T('onglet_affacer_base'), generer_url_ecrire("admin_effacer"), "effacer", $onglet, "supprimer.gif");
< 	}
---
> 	$onglets = pipeline('ajouter_onglets', $onglets, $rubrique);
1956,1977c2024,2025
< 	if ($rubrique == "auteur"){
< 		onglet(_T('onglet_auteur'), generer_url_ecrire("auteurs_edit","id_auteur=$id_auteur"), "auteur", $onglet, "auteur-24.gif");
< 		onglet(_T('onglet_informations_personnelles'), generer_url_ecrire("auteur_infos","id_auteur=$id_auteur"), "infos", $onglet, "fiche-perso-24.gif");
< 	}
< 
< 	if ($rubrique == "configuration"){
< 		onglet(_T('onglet_contenu_site'), generer_url_ecrire("configuration"), "contenu", $onglet, "racine-site-24.gif");
< 		onglet(_T('onglet_interactivite'), generer_url_ecrire("config-contenu"), "interactivite", $onglet, "forum-interne-24.gif");
< 		onglet(_T('onglet_fonctions_avances'), generer_url_ecrire("config-fonctions"), "fonctions", $onglet, "image-24.gif");
< 	}
< 
< 	if ($rubrique == "config_lang") {
< 		onglet(_T('info_langue_principale'), generer_url_ecrire("config-lang"), "langues", $onglet, "langues-24.gif");
< 		onglet(_T('info_multilinguisme'), generer_url_ecrire("config-multilang"), "multi", $onglet, "traductions-24.gif");
< 		if ($GLOBALS['meta']['multi_articles'] == "oui" OR $GLOBALS['meta']['multi_rubriques'] == "oui") {
< 			onglet(_T('module_fichiers_langues'), generer_url_ecrire("lang_raccourcis"), "fichiers", $onglet, "traductions-24.gif");
< 		}
< 	}
< 
< 	if ($rubrique == "suivi_forum"){
< 		onglet(_T('onglet_messages_publics'), generer_url_ecrire("controle_forum","page=public"), "public", $onglet, "forum-public-24.gif");
< 		onglet(_T('onglet_messages_internes'), generer_url_ecrire("controle_forum","page=interne"), "interne", $onglet, "forum-interne-24.gif");
---
> 	return $onglets;
> }
1979,1982c2027,2029
< 		$query_forum = "SELECT * FROM spip_forum WHERE statut='publie' AND texte='' LIMIT 1";
< 		$result_forum = spip_query($query_forum);
< 		if ($row = spip_fetch_array($result_forum))
< 			onglet(_T('onglet_messages_vide'), generer_url_ecrire("controle_forum","page=vide"), "vide", $onglet);
---
> function barre_onglets($rubrique, $ongletCourant){
> 	$onglets= definir_barre_onglets($rubrique);
> 	if(count($onglets)==0) return;
1984,1987c2031
< 		$query_forum = "SELECT * FROM spip_forum WHERE statut='prop' LIMIT 1";
< 		$result_forum = spip_query($query_forum);
< 		if ($row = spip_fetch_array($result_forum))
< 			onglet(_T('texte_statut_attente_validation'), generer_url_ecrire("controle_forum","page=prop"), "prop", $onglet);
---
> 	debut_onglet();
1988a2033,2036
> 	foreach($onglets as $exec => $onglet) {
> 		$url= $onglet['url'] ? $onglet['url'] : generer_url_ecrire($exec);
> 		onglet(_T($onglet['libelle']), $url,
>  			$exec, $ongletCourant, $onglet['icone']);
1990d2037
< 
1994d2040
< 
2237c2283
< 	echo http_script('',generer_url_ecrire("js_menu_rubriques.php","date=$date_maj&spip_ecran=$spip_ecran&dir=$spip_lang_rtl"),'');
---
> 	echo http_script('',generer_url_ecrire("js_menu_rubriques","date=$date_maj&spip_ecran=$spip_ecran&dir=$spip_lang_rtl"),'');
2253a2300
> 	definir_barre_boutons();
2254a2302
> 	debut_corps_page();
2280c2328,2511
< // fonction envoyant la double serie d'icones de redac
---
> // definir la liste des boutons du haut
> function definir_barre_boutons() {
> 	global $boutons_admin;
> 
> 	global $REQUEST_URI, $HTTP_HOST, $adresse_site;
> 	$adresse_site = $GLOBALS['meta']["adresse_site"];
> 	if (!$adresse_site) {
> 			$adresse_site = "http://$HTTP_HOST".substr($REQUEST_URI, 0, strpos($REQUEST_URI, "/" . _DIR_RESTREINT_ABS));
> 			ecrire_meta("adresse_site", $adresse_site);
> 			ecrire_metas();
> 	}
> 	if (strlen($adresse_site)<10) $adresse_site = _DIR_RACINE;
> 
> 	global $spip_lang, $spip_lang_rtl, $spip_lang_left, $spip_lang_right;
> 
> 	$boutons_admin=array(
> 		'accueil' => array(
> 			'icone' => 'asuivre-48.png',
> 			'libelle' => 'icone_a_suivre'
> 		),
> 		'naviguer' => array(
> 			'icone' => "documents-48$spip_lang_rtl.png",
> 			'libelle' => 'icone_edition_site',
> 		),
> 		'forum_admin' => array(
> 			'icone' => 'messagerie-48.png',
> 			'libelle' => 'titre_forum',
> 		),
> 		'auteurs' => array(
> 			'icone' => 'redacteurs-48.png',
> 			'libelle' => 'icone_auteurs',
> 			'menu' => null,
> 		)
> 	);
> 
> 	if ($GLOBALS['connect_statut'] == "0minirezo"
> 		AND $GLOBALS['meta']["activer_statistiques"] != 'non') {
> 		$boutons_admin['statistiques_visites']=array(
> 			'icone' => 'statistiques-48.png',
> 			'libelle' => 'icone_statistiques_visites',
> 		);
> 	}
> 	if ($GLOBALS['connect_statut'] == '0minirezo'
> 		AND $GLOBALS['connect_toutes_rubriques']) {
> 		$boutons_admin['configuration']=array(
> 			'icone' => 'administration-48.png',
> 			'libelle' => 'icone_configuration_site',
> 		);
> 	}
> 	$boutons_admin['espacement']=null;
> 	$urlAide= generer_url_ecrire('aide_index')."&amp;var_lang=$spip_lang";
> 	$boutons_admin['aide_index']=array(
> 			'icone' => 'aide-48'.$spip_lang_rtl.'.png',
> 			'libelle' => 'icone_aide_ligne',
> 			'url' => $urlAide,
> 			'url2' => "javascript:window.open('$urlAide', 'aide_spip', 'scrollbars=yes,resizable=yes,width=740,height=580');",
> 			'target' => 'aide_spip'
> 	);
> 	$boutons_admin['visiter']=array(
> 			'icone' => "visiter-48$spip_lang_rtl.png",
> 			'libelle' => 'icone_visiter_site',
> 			'url' => $adresse_site
> 	);
> 
> 	// les sous menu des boutons, que si on est admin
> 	if ($GLOBALS['connect_statut'] == '0minirezo'
> 		AND $GLOBALS['connect_toutes_rubriques']) {
> 
> 	// sous menu edition
> 
> 	$sousmenu=array();
> 
> 	$nombre_articles = spip_num_rows(spip_query("SELECT art.id_article FROM spip_articles AS art, spip_auteurs_articles AS lien WHERE lien.id_auteur = '".$GLOBALS['connect_id_auteur']."' AND art.id_article = lien.id_article LIMIT 1"));
> 	if ($nombre_articles > 0) {
> 		$sousmenu['articles_page']=array(
> 			'libelle' => "icone_tous_articles",
> 			'icone' => "article-24.gif");
> 	}
> 
> 	if ($GLOBALS['meta']["activer_breves"] != "non") {
> 		$sousmenu['breves']=array(
> 			'libelle' => "icone_breves",
> 			'icone' => "breve-24.gif");
> 	}
> 
> 	if ($GLOBALS['options'] == "avancees"){
> 		$articles_mots = $GLOBALS['meta']['articles_mots'];
> 		if ($articles_mots != "non") {
> 			$sousmenu['mots_tous']=array(
> 				'libelle' => "icone_mots_cles",
> 				'icone' => "mot-cle-24.gif");
> 		}
> 
> 		$activer_sites = $GLOBALS['meta']['activer_sites'];
> 		if ($activer_sites<>'non')
> 			$sousmenu['sites_tous']=array(
> 				'libelle' => "icone_sites_references",
> 				'icone' => "site-24.gif");
> 
> 		if (@spip_num_rows(spip_query("SELECT * FROM spip_documents_rubriques LIMIT 1")) > 0) {
> 			$sousmenu['documents_liste']=array(
> 				'libelle' => "icone_doc_rubrique",
> 				'icone' => "doc-24.gif");
> 		}
> 	}
> 	$boutons_admin['naviguer']['sousmenu']= $sousmenu;
> 	
> 	// sous menu forum
> 
> 	$sousmenu=array();
> 
> 	if ($GLOBALS['meta']['forum_prive_admin'] == 'oui')
> 		$sousmenu['forum_admin']=array(
> 			'libelle' => "icone_forum_administrateur",
> 			'icone' => "forum-admin-24.gif");
> 
> 	$sousmenu['controle_forum']=array(
> 		'libelle' => "icone_suivi_forums",
> 		'icone' => "suivi-forum-24.gif");
> 	$sousmenu['controle_petition']=array(
> 		'libelle' => "icone_suivi_pettions",
> 		'icone' => "suivi-petition-24.gif");
> 	
> 	$boutons_admin['forum_admin']['sousmenu']= $sousmenu;
> 
> 	// sous menu auteurs
> 
> 	$boutons_admin['auteurs']['sousmenu']= array(
> 		'auteurs_edit' => array(
> 			'libelle' => "icone_informations_personnelles",
> 			'icone' => "fiche-perso-24.gif",
> 			'urlArg' => 'id_auteur='.$GLOBALS['connect_id_auteur']
> 		),
> 		'auteur_infos' => array(
> 			'libelle' => "icone_creer_nouvel_auteur",
> 			'icone' => "auteur-24.gif",
> 			'urlArg' => 'new=oui'
> 		)
> 	);
> 
> 	// sous menu statistiques
> 	
> 	$sousmenu=array(
> 		'espacement' => null,
> 		'statistiques_repartition' => array(
> 			'libelle' => "icone_repartition_visites",
> 			'icone' => "rubrique-24.gif")
> 	);
> 
> 	if ($GLOBALS['meta']['multi_articles'] == 'oui'
> 		OR $GLOBALS['meta']['multi_rubriques'] == 'oui')
> 		$sousmenu['statistiques_lang']=array(
> 			'libelle' => "onglet_repartition_lang",
> 			'icone' => "langues-24.gif");
> 
> 	$sousmenu['statistiques_referers']=array(
> 		'libelle' => "titre_liens_entrants",
> 		'icone' => "referers-24.gif");
> 
> 	$boutons_admin['statistiques_visites']['sousmenu']= $sousmenu;
> 	
> 	// sous menu configuration
> 
> 	$sousmenu=array(
> 		'config_lang' => array(
> 			'libelle' => "icone_gestion_langues",
> 			'icone' => "langues-24.gif"),
> 		'espacement' => null
> 	);
> 
> 	if ($GLOBALS['options'] == "avancees") {
> 		$sousmenu['admin_tech']=array(
> 			'libelle' => "icone_maintenance_site",
> 			'icone' => "base-24.gif");
> 		$sousmenu['admin_vider']=array(
> 			'libelle' => "onglet_vider_cache",
> 			'icone' => "cache-24.gif");
> 	} else {
> 		$sousmenu['admin_tech']=array(
> 			'libelle' => "icone_sauver_site",
> 			'icone' => "base-24.gif");
> 	}
> 
> 	$boutons_admin['configuration']['sousmenu']= $sousmenu;
2281a2513,2525
> 	} // fin si admin
> 
> 	$boutons_admin = pipeline('ajouter_boutons', $boutons_admin);
> }
> 
> function definir_barre_gadgets() {
> 	global $barre_gadgets;
> 	$barre_gadgets= array(
> 						  // ?????????
> 	);
> }
> 
> // fonction envoyant la double serie d'icones de redac
2283,2285c2527
< 	global $couleur_foncee;
< 	global $couleur_claire;
< 	global $REQUEST_URI, $HTTP_HOST;
---
> 	global $couleur_foncee, $couleur_claire, $adresse_site;
2295,2304c2537,2538
< 	$adresse_site = $GLOBALS['meta']["adresse_site"];
< 	if (!$adresse_site) {
< 			$adresse_site = "http://$HTTP_HOST".substr($REQUEST_URI, 0, strpos($REQUEST_URI, "/" . _DIR_RESTREINT_ABS));
< 			ecrire_meta("adresse_site", $adresse_site);
< 			ecrire_metas();
< 	}
< 
< 	if (strlen($adresse_site)<10) $adresse_site = _DIR_RACINE;
< 
< 	if ($spip_ecran == "large") $largeur = 974; else $largeur = 750;
---
> 	if ($spip_ecran == "large") $largeur = 974;
> 	else $largeur = 750;
2315,2325c2549,2560
< if ($spip_display == "4") {
< 	// Icones principales
< 	echo "<ul>";
< 	echo "<li><a href='./'>"._T('icone_a_suivre')."</a>";
< 	echo "<li><a href='" . generer_url_ecrire("naviguer") . "'>"._T('icone_edition_site')."</a>";
< 	echo "<li><a href='" . generer_url_ecrire("forum_admin"). "'>"._T('titre_forum')."</a>";
< 	echo "<li><a href='" . generer_url_ecrire("auteurs") . "'>"._T('icone_auteurs')."</a>";
< 	echo "<li><a href=\"$adresse_site/\">"._T('icone_visiter_site')."</a>";
< 	echo "</ul>";
< }
< else {
---
> 	if ($spip_display == "4") {
> 		// Icones principales
> 		echo "<ul>";
> 		echo "<li><a href='./'>"._T('icone_a_suivre')."</a>";
> 		echo "<li><a href='" . generer_url_ecrire("naviguer") . "'>"._T('icone_edition_site')."</a>";
> 		echo "<li><a href='" . generer_url_ecrire("forum_admin"). "'>"._T('titre_forum')."</a>";
> 		echo "<li><a href='" . generer_url_ecrire("auteurs") . "'>"._T('icone_auteurs')."</a>";
> 		echo "<li><a href=\"$adresse_site/\">"._T('icone_visiter_site')."</a>";
> 		echo "</ul>";
> 
> 		return;
> 	}
2340,2349c2575,2583
< 	icone_bandeau_principal (_T('icone_a_suivre'), './', "asuivre-48.png", "asuivre", $rubrique, "", "asuivre", $sous_rubrique);
< 	icone_bandeau_principal (_T('icone_edition_site'), generer_url_ecrire("naviguer"), "documents-48$spip_lang_rtl.png", "documents", $rubrique, "", "rubriques", $sous_rubrique);
< 	icone_bandeau_principal (_T('titre_forum'), generer_url_ecrire("forum_admin"), "messagerie-48.png", "redacteurs", $rubrique, "", "forum-interne", $sous_rubrique);
< 	icone_bandeau_principal (_T('icone_auteurs'), generer_url_ecrire("auteurs"), "redacteurs-48.png", "auteurs", $rubrique, "", "redacteurs", $sous_rubrique);
< 	if ($connect_statut == "0minirezo"  AND $GLOBALS['meta']["activer_statistiques"] != 'non') {
< 		//bandeau_barre_verticale();
< 		icone_bandeau_principal (_T('icone_statistiques_visites'), generer_url_ecrire("statistiques_visites"), "statistiques-48.png", "suivi", $rubrique, "", "statistiques", $sous_rubrique);
< 	}
< 	if ($connect_statut == '0minirezo' and $connect_toutes_rubriques) {
< 		icone_bandeau_principal (_T('icone_configuration_site'), generer_url_ecrire("configuration"), "administration-48.png", "administration", $rubrique, "", "configuration", $sous_rubrique);
---
> 	foreach($GLOBALS['boutons_admin'] as $page => $detail) {
> 		if($page=='espacement') {
> 			echo "<td> &nbsp; </td>";
> 		} else {
> 			icone_bandeau_principal (_T($detail['libelle']),
> 				$detail['url']?$detail['url']:generer_url_ecrire($page),
> 				$detail['icone'], $page, $rubrique, $detail['url2'],
> 				$page, $sous_rubrique);
> 		}
2351,2361d2584
< 
< 	echo "<td> &nbsp; </td>";
< 
< 	icone_bandeau_principal (_T('icone_aide_ligne'), "javascript:window.open('" . generer_url_ecrire("aide_index","var_lang=$spip_lang") .
< 				 "', 'aide_spip', 'scrollbars=yes,resizable=yes,width=740,height=580');",
< 		"aide-48".aide_lang_dir($spip_lang,$spip_lang_rtl).".png",
< 		"vide", "", generer_url_ecrire("aide_index","var_lang=$spip_lang"),
< 		"aide-en-ligne", $sous_rubrique);
< 
< 	icone_bandeau_principal (_T('icone_visiter_site'), $adresse_site, "visiter-48$spip_lang_rtl.png", "visiter","", "visiter", $sous_rubrique);
< 
2364,2366d2586
< 
< 
< 
2368c2588
< 	
---
> 
2371c2591
< 	
---
> 
2372a2593,2594
> 
> 	$decal=0;
2375,2419d2596
< 	
< 	if ($rubrique == "asuivre"){
< 		$class = "visible_au_chargement";
< 	} else {
< 		$class = "invisible_au_chargement";
< 	}
< 	$decal = largeur_icone_bandeau_principal(_T('icone_a_suivre'));
< 
< 
< 	if ($rubrique == "documents"){
< 		$class = "visible_au_chargement";
< 	} else {
< 		$class = "invisible_au_chargement";
< 	}
< 	if ($connect_statut == "0minirezo" AND $connect_toutes_rubriques) {
< 		echo "<div class='$class' id='bandeaudocuments' style='position: absolute; $spip_lang_left: ".$decal."px;'><div class='bandeau_sec'><table class='gauche'><tr>\n";
< 		//icone_bandeau_secondaire (_T('icone_rubriques'), generer_url_ecrire("naviguer",""), "rubrique-24.gif", "rubriques", $sous_rubrique);
< 
< 		$nombre_articles = spip_num_rows(spip_query("SELECT art.id_article FROM spip_articles AS art, spip_auteurs_articles AS lien WHERE lien.id_auteur = '$connect_id_auteur' AND art.id_article = lien.id_article LIMIT 1"));
< 		if ($nombre_articles > 0) {
< 			icone_bandeau_secondaire (_T('icone_tous_articles'), generer_url_ecrire("articles_page"), "article-24.gif", "articles", $sous_rubrique);
< 		}
< 
< 		/*if ($options == "avancees") {
< 			if ($connect_statut == "0minirezo") $req_where = " AND articles.statut IN ('prepa','prop','publie')"; 
< 			else $req_where = " AND articles.statut IN ('prop','publie')"; 
< 			$nombre_versions = spip_num_rows(spip_query("
< 				SELECT versions.*, articles.statut, articles.titre
< 				FROM spip_versions AS versions, spip_articles AS articles 
< 				WHERE versions.id_article = articles.id_article AND versions.id_version > 1$req_where LIMIT 1"));
< 			if ($nombre_versions > 0 OR 1==1) {
< 				icone_bandeau_secondaire (_T('icone_suivi_revisions'), generer_url_ecrire("suivi_revisions",""), "historique-24.gif", "revisions", $sous_rubrique);
< 			}
< 		}*/
< 
< 		$activer_breves=$GLOBALS['meta']["activer_breves"];
< 		if ($activer_breves != "non"){
< 			icone_bandeau_secondaire (_T('icone_breves'), generer_url_ecrire("breves"), "breve-24.gif", "breves", $sous_rubrique);
< 		}
< 
< 		if ($options == "avancees"){
< 			$articles_mots = $GLOBALS['meta']['articles_mots'];
< 			if ($articles_mots != "non") {
< 				icone_bandeau_secondaire (_T('icone_mots_cles'), generer_url_ecrire("mots_tous"), "mot-cle-24.gif", "mots", $sous_rubrique);
< 			}
2421,2438c2598,2599
< 			$activer_sites = $GLOBALS['meta']['activer_sites'];
< 			if ($activer_sites<>'non')
< 				icone_bandeau_secondaire (_T('icone_sites_references'), generer_url_ecrire("sites_tous"), "site-24.gif", "sites", $sous_rubrique);
< 
< 			if (@spip_num_rows(spip_query("SELECT * FROM spip_documents_rubriques LIMIT 1")) > 0) {
< 				icone_bandeau_secondaire (_T('icone_doc_rubrique'), generer_url_ecrire("documents_liste"), "doc-24.gif", "documents", $sous_rubrique);
< 			}
< 		}
< 		echo "</tr></table></div></div>";
< 	}
< 
< 	$decal = $decal + largeur_icone_bandeau_principal(_T('icone_edition_site'));
< 
< 
< 	
< 	
< 	if ($connect_statut == "0minirezo" AND $connect_toutes_rubriques) {
< 		if ($rubrique == "redacteurs") {
---
> 	foreach($GLOBALS['boutons_admin'] as $page => $detail) {
> 		if ($rubrique == $page) {
2444,2512c2605,2614
< 			echo "<div class='$class' id='bandeauredacteurs' style='position: absolute; $spip_lang_left: ".$decal."px;'><div class='bandeau_sec'><table class='gauche'><tr>\n";
< 				if ($GLOBALS['meta']['forum_prive_admin'] == 'oui') icone_bandeau_secondaire (_T('icone_forum_administrateur'), generer_url_ecrire("forum_admin","admin=admin"), "forum-admin-24.gif", "privadm", $sous_rubrique);
< 
< 				icone_bandeau_secondaire (_T('icone_suivi_forums'), generer_url_ecrire("controle_forum"), "suivi-forum-24.gif", "forum-controle", $sous_rubrique);
< 				icone_bandeau_secondaire (_T('icone_suivi_pettions'), generer_url_ecrire("controle_petition"), "suivi-petition-24.gif", "suivi-petition", $sous_rubrique);
< 
< 			echo "</tr></table></div></div>";
< 	
< 	}
< 	
< 	$decal = $decal + largeur_icone_bandeau_principal(_T('icone_discussions'));
< 	
< 	if ($connect_statut == "0minirezo" AND $connect_toutes_rubriques) {
< 		if ($rubrique == "auteurs") {
< 			$class = "visible_au_chargement";
< 		} else {
< 			$class = "invisible_au_chargement";
< 		}
< 		echo "<div class='$class' id='bandeauauteurs' style='position: absolute; $spip_lang_left: ".$decal."px;'><div class='bandeau_sec'><table class='gauche'><tr>\n";
< 		icone_bandeau_secondaire (_T('icone_informations_personnelles'), generer_url_ecrire("auteurs_edit","id_auteur=$connect_id_auteur"), "fiche-perso-24.gif", "perso", $sous_rubrique);
< 		icone_bandeau_secondaire (_T('icone_creer_nouvel_auteur'), generer_url_ecrire("auteur_infos","new=oui"), "auteur-24.gif", "xxx", $sous_rubrique);
< 	
< 		echo "</tr></table></div></div>";
< 	}	
< 
< 	
< 	
< 	$decal = $decal + largeur_icone_bandeau_principal(_T('icone_auteurs'));
< 
< 	// decalage pour barre verticale
< 	// $decal = $decal + 11;
< 
< 	if ($connect_statut == "0minirezo" AND $connect_toutes_rubriques AND $GLOBALS['meta']["activer_statistiques"] != 'non') {
< 		if ($rubrique == "suivi") {
< 			$class = "visible_au_chargement";
< 		} else {
< 			$class = "invisible_au_chargement";
< 		}
< 		echo "<div class='$class' id='bandeausuivi' style='position: absolute; $spip_lang_left: ".$decal."px;'><div class='bandeau_sec'><table class='gauche'><tr>\n";
< 		if ($connect_toutes_rubriques) bandeau_barre_verticale();
< 
< 		icone_bandeau_secondaire (_T('icone_repartition_visites'), generer_url_ecrire("statistiques_repartition.php"), "rubrique-24.gif", "repartition", $sous_rubrique);
< 		if ($GLOBALS['meta']['multi_articles'] == 'oui' OR $GLOBALS['meta']['multi_rubriques'] == 'oui')
< 			icone_bandeau_secondaire (_T('onglet_repartition_lang'), generer_url_ecrire("statistiques_lang"), "langues-24.gif", "repartition-langues", $sous_rubrique);
< 		icone_bandeau_secondaire (_T('titre_liens_entrants'), generer_url_ecrire("statistiques_referers"), "referers-24.gif", "referers", $sous_rubrique);
< 
< 		echo "</tr></table></div></div>";
< 
< 		$decal = $decal + largeur_icone_bandeau_principal(_T('icone_suivi_actualite'));
< 	
< 	}
< 
< 
< 	if ($connect_statut == '0minirezo' and $connect_toutes_rubriques) {
< 		if ($rubrique == "administration") {
< 			$class = "visible_au_chargement";
< 		} else {
< 			$class = "invisible_au_chargement";
< 		}
< 			echo "<div class='$class' id='bandeauadministration' style='position: absolute; $spip_lang_left: ".$decal."px;'><div class='bandeau_sec'><table class='gauche'><tr>\n";
< 			icone_bandeau_secondaire (_T('icone_gestion_langues'), generer_url_ecrire("config-lang"), "langues-24.gif", "langues", $sous_rubrique);
< 	
< 			bandeau_barre_verticale();
< 			if ($options == "avancees") {
< 				icone_bandeau_secondaire (_T('icone_maintenance_site'), generer_url_ecrire("admin_tech"), "base-24.gif", "base", $sous_rubrique);
< 				icone_bandeau_secondaire (_T('onglet_vider_cache'), generer_url_ecrire("admin_vider"), "cache-24.gif", "cache", $sous_rubrique);
< 			}
< 			else {
< 				icone_bandeau_secondaire (_T('icone_sauver_site'), generer_url_ecrire("admin_tech"), "base-24.gif", "base", $sous_rubrique);
---
> 		$sousmenu= $detail['sousmenu'];
> 		if($sousmenu) {
> 			echo "<div class='$class' id='bandeau$page' style='position: absolute; $spip_lang_left: ".$decal."px;'><div class='bandeau_sec'><table class='gauche'><tr>\n";
> 		
> 			foreach($sousmenu as $souspage => $sousdetail) {
> 				if($souspage=='espacement') {
> 					echo "<td class='separateur'></td>\n";
> 				} else {
> 					icone_bandeau_secondaire (_T($sousdetail['libelle']), generer_url_ecrire($sousdetail['url']?$sousdetail['url']:$souspage, $sousdetail['urlArg']), $sousdetail['icone'], $souspage, $sous_rubrique);
> 				}
2515,2516c2617,2619
< 
< 
---
> 		}
> 		
> 		$decal += largeur_icone_bandeau_principal(_T($detail['libelle']));
2949a3053,3056
> function debut_corps_page() {
> 	global $couleur_foncee;
> 	global $connect_id_auteur;
>   
