#CACHE{0}
<BOUCLE_diogene(DIOGENES){id_diogene}>
#SET{complements,#OPTIONS_COMPLEMENTS|unserialize}
</BOUCLE_diogene>
[(#REM)
	Si un id_gis on affiche la carte tout le temps
]
[(#ENV{id_gis}|intval|oui)
	#SET{geo_affiche,oui}
]
[(#REM)
	Si pas d'id_gis on regarde la conf
]
[(#ENV{id_gis}|intval|non)
	#SET{geo_affiche,oui}
	[(#GET{complements}|table_valeur{geo_cacher}|=={on}|oui)
		#SET{geo_affiche,non}	
	]
]
<li class="fieldset diogene_geo" id="diogene_geo">
<fieldset>
	<h3 class="legend"><:diogene_geo:form_legend:></h3>
	[<p class="reponse_formulaire reponse_formulaire_ok"><:diogene_geo:message_postion_auto:>(#ENV{position_auto}|oui)</p>]
	<div class="choix">
		<input type="checkbox" value="on"[(#GET{geo_affiche}|=={oui}|oui)checked="checked"] id="gis_afficher" name="gis_afficher" />
		<label for="gis_afficher"><:diogene_geo:label_geo_afficher:></label> 
	</div>
	<ul class="ul_info_gis">
		[(#ENV{id_gis}|oui)
			[(#SAISIE{case, gis_supprimer,
				label=<:diogene_geo:label_supprimer_gis:>})]
		]
		<li class="editer editer_carte">
			<div id="geomap" name="formMap" style="width: 100%; height: 350px"></div>
				<script type="text/javascript">
				<!--
				var form_map;
				var annuler_geocoder = 0;
				[(#ENV{recherche}|!={non}|oui|et{#CONFIG{gis/geocoder}|oui})
				[(#SET{geocoder,oui})]
				var geocoder;]
				
				(function($){
					[(#GET{geo_affiche}|=={non}|oui)
						$('.ul_info_gis').hide();	
					]
					$('#gis_afficher').change(function(){
						if($(this).is(':checked')){
							$('.ul_info_gis').slideDown('slow',function(){
								var container = $('#geomap');
								form_map.resizeTo(container.width(),container.height());
								var lat = $("#champ_lat").val()?$("#champ_lat").val() : #ENV{lat,#CONFIG{gis/lat,0}};
								var lon = $("#champ_lon").val()?$("#champ_lon").val() : #ENV{lat,#CONFIG{gis/lon,0}};
								form_map.setCenter(new mxn.LatLonPoint(lat,lon));
							});
						}else{
							$('.ul_info_gis').slideUp();
						}
					});
					var maj_inputs = function(map,data,action) {
						[(#GET{geocoder}|oui)
						if (action != 'geocoding') {
							var f = geocoder.geocode(data);
						}]
						var zoom = map.getZoom();
						$("#champ_zoom").val(zoom);
						if(action == 'click'){
							$("#champ_lat").val(data.lat);
							$("#champ_lon").val(data.lon);
							annuler_geocoder = 1;
							form_map.setCenter(data);
							marker = new mxn.Marker(data);
						}
						else if(annuler_geocoder != 1){
							if(data.point == 'undefined'){
								$("#champ_lat").val(data.lat);
								$("#champ_lon").val(data.lon);
								form_map.setCenter(data);
								marker = new mxn.Marker(data);
							}else{
								$("#champ_lat").val(data.point.lat);
								$("#champ_lon").val(data.point.lon);
								form_map.setCenter(data.point);
								marker = new mxn.Marker(data.point);
							}
						}
						form_map.removeAllMarkers();
						form_map.addMarker(marker);
					}
					
					[(#GET{geocoder}|oui)
					function geocode(query) {
						$('#champ_adresse').val(query.street);
						$('#champ_code_postal').val(query.postcode);
						$('#champ_ville').val(query.locality);
						$('#champ_region').val(query.region);
						$('#champ_pays').val(query.country);
						maj_inputs(form_map,query,'geocoding');
						[(#ENV{id_gis}|non)
						$('#champ_gis_titre').val(query.locality + ", " + query.region + ", " + query.country);]
					}]
				
					var init_map = function() {
						// creer la carte
						var map_container = 'geomap';
						if($('#'+map_container).size()>0){
							form_map = new mxn.Mapstraction(map_container,'[(#REM|gis_api_utilisee)]');
							form_map.setCenterAndZoom(new mxn.LatLonPoint(#ENV{lat,#CONFIG{gis/lat,0}},#ENV{lon,#CONFIG{gis/lon,0}}),#ENV{zoom,#CONFIG{gis/zoom,0}});
							form_map.addControls({
								pan: true,
								zoom: '#CONFIG{gis/control,large}',
								map_type: true
							});
							[(#GET{geocoder}|oui)
							// geocoder
							geocoder = new mxn.Geocoder('[(#REM|gis_api_utilisee)]',geocode);]
							
							[(#ENV{lat}|oui)
							point = new mxn.LatLonPoint([(#ENV{lat})],[(#ENV{lon})]);
							marker = new mxn.Marker(point);
							form_map.addMarker(marker);]
							
							// mettre a jour les coordonnees quand on clique la carte
							form_map.click.addHandler(function(name, source, args) {
								annuler_geocoder = 0;
								var pos = args.location;
								maj_inputs(form_map,pos,'click');
							});
							
							// mettre Ã  jour le zoom quand on le modifie
							form_map.changeZoom.addHandler(function(name, source, args) {
								var zoom = source.getZoom();
								if ($("#champ_zoom").val() > 0) {
									$("#champ_zoom").val(zoom);
								}
							});
							
							[(#GET{geocoder}|oui)
							// geocoder si clic...
							$('a#gis_rechercher').css("cursor","pointer").click(function(){
								var address = {};
								address.address = $("#champ_gis_adresse").attr("value");
								annuler_geocoder = 0;
								geocoder.geocode(address);
							});
					
							// ne pas soumettre le formulaire si on presse Entree depuis le champ de recherche
							$('#champ_gis_adresse').keypress(function(e){
								if (e.which == 13) {
									$('a#gis_rechercher').trigger("click");
									return false;
								}
							});]
							
							$('#champ_gis_supprimer').change(function(){
								if($(this).is(':checked')){
									$('#diogene_geo li').not('.editer_gis_supprimer').slideUp();
								}else{
									$('#diogene_geo li').not('.editer_gis_supprimer').slideDown();
								}
							});
							
							[(#ENV{id_gis}|non|et{#CONFIG{gis/geolocaliser_user_html5}|=={on}}|oui)
							gis_get_navigator_location(form_map,#ENV{zoom,#CONFIG{gis/zoom,0}});]
						}
					};
				
					$(function(){
						init_map();
					});
					
				})(jQuery);
				-->
				</script>
			</li>
		[(#SAISIE{hidden,id_gis})]
		[(#GET{geocoder}|oui)
		<li class="rechercher_adresse">
			<label for="champ_gis_adresse"><:gis:label_rechercher_address:></label>
			<input type="text" class="text nomulti" name="champ_gis_adresse" id="champ_gis_adresse" value="" />
			<a id="gis_rechercher"><:info_rechercher:></a>
		</li>]
		[(#SAISIE{input,lat,
			label=<:gis:lat:>,
			class=nomulti,
			obligatoire=oui})]
		[(#SAISIE{input,lon,
			label=<:gis:lon:>,
			class=nomulti,
			obligatoire=oui})]
		[(#SAISIE{input,zoom,
			label=<:gis:zoom:>,
			size=2,
			maxlength=2,
			class=nomulti,
			obligatoire=oui,
			defaut=''})]
		[(#SAISIE{input,gis_titre,
			defaut=#INFO_TITRE{#OBJET,#ID_OBJET},
			label=<:diogene_geo:gis_info_titre:>,
			obligatoire=oui})]
		[(#SAISIE{textarea,gis_descriptif,
			label=<:diogene_geo:gis_info_descriptif:>,
			rows=5})]
		[(#CONFIG{gis/adresse}|=={on}|?{#SET{input_type,input},#SET{input_type,hidden}})]
		[(#SAISIE{#GET{input_type},adresse,
			label=<:gis:label_adress:>})]
		[(#SAISIE{#GET{input_type},code_postal,
			label=<:gis:label_code_postal:>})]
		[(#SAISIE{#GET{input_type},ville,
			label=<:gis:label_ville:>})]
		[(#SAISIE{#GET{input_type},region,
			label=<:gis:label_region:>})]
		[(#SAISIE{#GET{input_type},pays,
			label=<:gis:label_pays:>})]
	</ul>
</fieldset>
</li>