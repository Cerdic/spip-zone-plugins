<?php
/**
 * Déclarations relatives à la base de données
 *
 * @plugin    Statistiques des objets éditoriaux
 * @copyright 2016
 * @author    tcharlss
 * @licence   GNU/GPL
 * @package   SPIP\Statistiques_objets\Base
 */

if (!defined('_ECRIRE_INC_VERSION')) {
		return;
}


/**
 * Déclarer les tables supplémentaires de statistiques
 *
 * Par défaut, SPIP n'enregistre que les visites des objets dans spip_visites_objets.
 * On prend en compte tous les objets éditoriaux avec une table générique spip_visites_objets.
 *
 * Déclare les tables :
 * - spip_visites_objets
 * - spip_referers_objets
 *
 * @pipeline declarer_tables_auxiliaires
 * @param array $tables_auxiliaires
 *     Description des tables auxiliaires
 * @return array
 *     Description complétée des tables auxiliaires
 */
function statsobjets_declarer_tables_auxiliaires($tables_auxiliaires) {

	$spip_visites_objets = array(
		"date" => "DATE NOT NULL",
		"id_objet" => "int UNSIGNED NOT NULL",
		"visites" => "int UNSIGNED DEFAULT '0' NOT NULL",
		"maj" => "TIMESTAMP"
	);

	$spip_visites_objets_key = array(
		"PRIMARY KEY" => "date, id_objet"
	);

	$spip_referers_objets = array(
		"id_objet" => "int UNSIGNED NOT NULL",
		"referer_md5" => "bigint UNSIGNED NOT NULL",
		"referer" => "VARCHAR (255) DEFAULT '' NOT NULL",
		"visites" => "int UNSIGNED NOT NULL",
		"maj" => "TIMESTAMP"
	);

	$spip_referers_objets_key = array(
		"PRIMARY KEY" => "id_objet, referer_md5",
		"KEY referer_md5" => "referer_md5"
	);

	$tables_auxiliaires['spip_visites_objets'] = array(
		'field' => &$spip_visites_objets,
		'key' => &$spip_visites_objets_key
	);
	$tables_auxiliaires['spip_referers_objets'] = array(
		'field' => &$spip_referers_objets,
		'key' => &$spip_referers_objets_key
	);

	return $tables_auxiliaires;
}
