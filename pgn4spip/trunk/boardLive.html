<html>
<!--
/**********************************************************************************
 * @Subject board live animation of chess game in real-time from live.pgn
 * @package pgn4spip plugin to embed pgn4web Chessboard in a SPIP 2.x article
 * @version 2.61.0
 * @copyright copyright (c) 2012 Matt Chesstale 
 * @license GNU General Public License version 3
 * @language HTML, Javascript
 *
 * @history	This HTML module is called by the interpretation of [pgn] tag
 *			Merge pgn4web\board.html and pgn4web\live-compact.html
 * @credits Paolo Casaschi's pgn4web\live-compact.html for blackberry screen
 * 			pgn4web live broadcast based on pgn4web javascript chessboard
 * @ref		http://pgn4web.casaschi.net
 * @help	http://localhost/spip/plugins/pgn4spip/boardLive.html?help=true
 **********************************************************************************/
-->
<head>
<!-- Solve empty first line of moves in horizontal mode due to IE8 overflow-x:hidden bug 
	 Force IE8 in IE7 mode. IE9 stays in IE9 mode.
  -->
<meta http-equiv="X-UA-Compatible" content="IE=7, IE=9" >
<title>pgn4spip live broadcast</title>

<!-- was <link href="pgn4web/live-compact.css" type="text/css" rel="stylesheet" /> -->
<style type="text/css">
<!-- @import url("pgn4web/fonts/pgn4web-font-LiberationSans.css");
@import url("pgn4web/fonts/pgn4web-font-ChessSansPiratf.css"); -->
@import url ("#CHEMIN{pgn4web/fonts/pgn4web-font-LiberationSans.css}")
@import url ("#CHEMIN{pgn4web/fonts/pgn4web-font-ChessSansPiratf.css}")

html,
body {
  margin: 0;
  padding: 0;
}

body {
  font-family: 'pgn4web Liberation Sans', sans-serif;
  font-size: 13px;
  color: #615F54;
  background: #EDE8D5;
}

a {
  text-decoration: none;
  color: black;
}

.boardTable {
  border-style: double;
  border-color: black;
  border-width: 3px;
}
.pieceImage,
.whiteSquare,
.blackSquare,
.highlightWhiteSquare,
.highlightBlackSquare {
}

.selectControl {
/* a "width" attribute here must use the !important flag to override default settings */
  width: 450px !important;
  color: #615F54;
  font-size: 13px;
  padding: 2px;
  border-style: solid;
  border-width: 1px;
  border-color: #CFCBB3;
  background-color: #EDE8D5;
}

.optionSelectControl {
  background-color: #EDE8D5;
}

.buttonControlPlay,
.buttonControlStop,
.buttonControl {
/* a "width" attribute here must use the !important flag to override default settings */
  font-size: 13px;
  text-align: center;
  vertical-align: middle;
}

.buttonControlSpace {
/* a "width" attribute here must use the !important flag to override default settings */
}

.searchPgnButton {
/* a "width" attribute here must use the !important flag to override default settings */
}

.searchPgnExpression {
/* a "width" attribute here must use the !important flag to override default settings */
}

.header,
.headerNosize,
.headerHighlighted,
.headerHighlightedNosize,
.helplinkNosize,
.helplinkNosizeHighlighted,
.comment {
  text-decoration: none;
  font-family: 'pgn4web Liberation Sans', sans-serif; /* fixes IE9 body css issue */
}

.header,
.headerHighlighted {
  font-size: 13px;
}

.move,
.variation,
.comment {
  font-size: 12px;
  line-height: 1.4em;
}

.move,
.variation,
.commentMove {
  font-family: 'pgn4web ChessSansPiratf', 'pgn4web Liberation Sans', sans-serif;
}

.move,
.variation {
  text-decoration: none;
}

.helplinkNosize {
  color: #BFBAA5;
}

.header,
.headerNosize,
.variation {
  color: #615F54 !important;
}

.move
 {
  color: #000000 !important;
}

a.variation {
  color: #615F54 !important;
}

.comment {
  color: #A19D8B;
}

.headerHighlighted,
.headerHighlightedNosize,
.moveOn,
.variationOn {
  color: black;
  background: #F0F0F0; <!-- was #F8CCA0; -->
}

.movebox {
  scrollbar-base-color: #E8E3D0;
  text-align: justify;
}

</style>

<link rel="shortcut icon" href="#CHEMIN{pgn4web/pawn.ico}" />
<script src="#CHEMIN{pgn4web/pgn4web.js}" type="text/javascript"></script>
<script src="#CHEMIN{pgn4web/fide-lookup.js}" type="text/javascript"></script>
<script type="text/javascript">

var sexEncodingCharSet = "$0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_";
var pieceSizeOptions = new Array(20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 52, 56, 60, 64, 72, 80, 88, 96, 112, 128, 144, 300);

oldMovesDisplay = "";
showMoves = gup("showMoves");
if ((showMoves == "true")  || (showMoves == "t")) { oldMovesDisplay = "justified"; }
if ((showMoves == "false") || (showMoves == "f")) { oldMovesDisplay = "hidden"; }
if ((movesDisplay = gup("movesDisplay")) === "") {
  movesDisplay = oldMovesDisplay === "" ? "hidden" : oldMovesDisplay;
}
if (movesDisplay == "f") { movesDisplay = "figurine"; }
if (movesDisplay == "t") { movesDisplay = "text"; }
if (movesDisplay == "h") { movesDisplay = "hidden"; }
if (movesDisplay == "n") { movesDisplay = "nosymbols"; } // "nosymbols" option is undocumented
if (movesDisplay == "p") { movesDisplay = "puzzle"; }
if ((movesDisplay == "justified") || (movesDisplay == "j")) { movesDisplay = "figurine"; } // backward compatibility
if ((movesDisplay != "figurine") && (movesDisplay != "nosymbols") && (movesDisplay != "puzzle") && (movesDisplay != "text") && (movesDisplay != "hidden")) { movesDisplay = "figurine"; }

blockChessInformantNAGSymbols = ((movesDisplay != "figurine") && ((movesDisplay != "puzzle")));

SetHighlightOption(true);
SetShortcutKeysEnabled(true);

if ((squareSize = gup("squareSize")) === "") { squareSize = 28; }
else { squareSize = parseInt(squareSize, 10); }
if (squareSize < 20) { squareSize = 20; }

if ((highlightMode = gup("highlightMode")) === "") { highlightMode = "square"; }
if (highlightMode == "b") { highlightMode = "border"; }
if (highlightMode == "n") { highlightMode = "none"; }
if (highlightMode == "s") { highlightMode = "square"; }
borderSize = highlightMode == "border" ? Math.floor(0.05 * squareSize) : 0;

if ((lightColor = gup("lightColorName")) === "") {
  if ((lightColor = "#" + gup("lightColorHex")) == "#") {
    if ((lightColor = "#" + sex2hex(gup("lightColorSex"))) == "#") { lightColor = "#EFF4EC"; }
  }
}
if ((darkColor  = gup("darkColorName"))  === "") {
  if ((darkColor  = "#" + gup("darkColorHex"))  == "#") {
    if ((darkColor  = "#" + sex2hex(gup("darkColorSex")))  == "#") { darkColor  = "#C6CEC3"; }
  }
}
if ((highlightColor  = gup("highlightColorName")) === "") {
  if ((highlightColor  = "#" + gup("highlightColorHex"))  == "#") {
    if ((highlightColor  = "#" + sex2hex(gup("highlightColorSex")))  == "#") { highlightColor  = "#DAF4D7"; }
  }
}
if ((highlightMode == 'none') || (highlightColor == 'none') || (highlightColor == '#none')) {
  highlightMode = 'none';
  borderSize = 0;
  highlightLightColor = lightColor;
  highlightDarkColor = darkColor;
  clearShortcutSquares("D", "7");
} else {
  highlightLightColor = highlightColor;
  highlightDarkColor = highlightColor;
}

// was SetImagePath("pgn4web/alpha/26");
pieceSize = gup("pieceSize");
if ((pieceSize === "") || IsMatchFirst(pieceSize, "default")) { pieceSize = defaultPieceSize(squareSize); }
else { pieceSize = parseInt(pieceSize, 10); }
if (pieceSize > (squareSize - 2 * borderSize)) { pieceSize = defaultPieceSize(squareSize - 2 * borderSize); }

if ((pieceFont = gup("pieceFont")) === "") {
  if ((pieceFont = gup("font")) === "") // left for compatibility with older version
    { pieceFont = "default"; }
}
if (pieceFont == "a") { pieceFont = "alpha"; }
if (pieceFont == "m") { pieceFont = "merida"; }
if (pieceFont == "u") { pieceFont = "uscf"; }
if (pieceFont == "s") { pieceFont = "svgchess"; } // undocumented option
if ((pieceFont == "random") || (pieceFont == "r")) {
  randomPiece = Math.floor(Math.random() * 3);
  switch (randomPiece) {
    case 1: pieceFont = "merida"; break;
    case 2: pieceFont = "uscf"; break;
    default: pieceFont = "alpha"; break;
  }
}
if ((pieceFont == "default") || (pieceFont == "d")) {
  if (pieceSize < 28) { pieceFont = "uscf"; }
  else {
    if (pieceSize > 39) { pieceFont = "merida"; }
    else { pieceFont = "alpha"; }
  }
}

// undocumented option
if ((pieceFontRoot = gup("pieceFontRoot")) !== "") {
  if (pieceFontRoot.charAt(pieceFontRoot.length - 1) != "/") { pieceFontRoot += "/"; }
}
else
	pieceFontRoot = "('find_in_path(lib/pgn4web/)";

SetImagePath("" + pieceFontRoot + pieceFont + "/" + pieceSize);
if (pieceFont == "svgchess") {
  SetImagePath("" + pieceFontRoot + pieceFont);
  SetImageType("svg");
}

if ((boardBorderColor = gup("boardBorderColorName")) === "") {
  if ((boardBorderColor = "#" + gup("boardBorderColorHex")) == "#") {
    if ((boardBorderColor = "#" + sex2hex(gup("boardBorderColorSex"))) == "#") { boardBorderColor = "#000000"; }
  }
}

if ((boardShadowColor = gup("boardShadowColorName")) === "") {
  if ((boardShadowColor = "#" + gup("boardShadowColorHex")) == "#") {
    boardShadowColorSex = gup("boardShadowColorSex");
    if ((boardShadowColorSex == "transparent") || (boardShadowColorSex == "t")) {
      boardShadowColor = "transparent";
    } else if ((boardShadowColorSex == "border") || (boardShadowColorSex == "b")) {
      boardShadowColor = "border";
    } else {
      if ((boardShadowColor = "#" + sex2hex(gup("boardShadowColorSex"))) == "#") { boardShadowColor = "transparent"; }
    }
  }
}
if ((boardShadowColor ==  "border") || (boardShadowColor ==  "b") ||
    (boardShadowColor == "#border") || (boardShadowColor == "#b")) {
  boardShadowColor = boardBorderColor;
}
if ((boardShadowColor ==  "transparent") || (boardShadowColor ==  "t") ||
    (boardShadowColor == "#transparent") || (boardShadowColor == "#t")) {
  boardShadowColor = "transparent";
}

if ((backgroundColor = gup("backgroundColorName")) === "") {
  if ((backgroundColor = "#" + gup("backgroundColorHex")) == "#") {
    backgroundColorSex = gup("backgroundColorSex");
    if ((backgroundColorSex == "transparent") || (backgroundColorSex == "t")) {
      backgroundColor = "transparent";
    } else {
      if ((backgroundColor = "#" + sex2hex(gup("backgroundColorSex"))) == "#") { backgroundColor = "#FFFFFF"; }
    }
  }
}
if ((backgroundColor ==  "transparent") || (backgroundColor ==  "t") ||
    (backgroundColor == "#transparent") || (backgroundColor == "#t")) {
  backgroundColor = "transparent";
}

if ((highlightMoveColor  = gup("highlightMoveColorName")) === "") {
  if ((highlightMoveColor  = "#" + gup("highlightMoveColorHex"))  == "#") {
    highlightMoveColorSex = gup("highlightMoveColorSex");
    if ((highlightMoveColorSex == "background") || (highlightMoveColorSex == "b")) {
      highlightMoveColor = "background";
    } else {
      if ((highlightMoveColor  = "#" + sex2hex(highlightMoveColorSex)) == "#") { highlightMoveColor = "#DAF4D7"; }
    }
  }
}
if ((highlightMoveColor ==  "background") || (highlightMoveColor ==  "b") ||
    (highlightMoveColor == "#background") || (highlightMoveColor == "#b")) {
  highlightMoveColor = backgroundColor;
}

if ((framePadding = gup("framePadding")) === "") { framePadding = 0;}
else { framePadding = parseInt(framePadding, 10); }

if ((fontHeaderSize = percentFixFromUrl( gup("fontHeaderSize") )) === "") { fontHeaderSize = "16"; }
if ((fontHeaderColor = gup("fontHeaderColorName")) === "") {
  if ((fontHeaderColor = "#" + gup("fontHeaderColorHex")) == "#") {
    if ((fontHeaderColor = "#" + sex2hex(gup("fontHeaderColorSex"))) == "#") { fontHeaderColor = "#000000"; }
  }
}

if ((fontMovesSize = percentFixFromUrl( gup("fontMovesSize") )) === "") { fontMovesSize = "16"; }
if ((fontMovesColor = gup("fontMovesColorName")) === "") {
  if ((fontMovesColor = "#" + gup("fontMovesColorHex")) == "#") {
    if ((fontMovesColor = "#" + sex2hex(gup("fontMovesColorSex"))) == "#") { fontMovesColor = "#000000";}
  }
}

if ((fontCommentsSize = percentFixFromUrl( gup("fontCommentsSize") )) === "") { fontCommentsSize = "moves"; }
if (fontCommentsSize == "m") { fontCommentsSize = "moves"; }
if ((fontCommentsColor = gup("fontCommentsColorName")) === "") {
  if ((fontCommentsColor = "#" + gup("fontCommentsColorHex")) == "#") {
    if ((fontCommentsColor = "#" + sex2hex(gup("fontCommentsColorSex"))) == "#") { fontCommentsColor = "#808080"; }
  }
}

if ((fontVariationsSize = percentFixFromUrl( gup("fontVariationsSize") )) === "") { fontVariationsSize = "comments"; }
if (fontVariationsSize == "c") { fontVariationsSize = "comments"; }
if ((fontVariationsColor = gup("fontVariationsColorName")) === "") {
  if ((fontVariationsColor = "#" + gup("fontVariationsColorHex")) == "#") {
    if ((fontVariationsColor = "#" + sex2hex(gup("fontVariationsColorSex"))) == "#") { fontVariationsColor = "comments"; }
  }
}

SetAutostartAutoplay(false);	// CFG autoplayMode is not taken in consideration in live mode
SetAutoplayNextGame(false);		// as it was always "none"

if (gup("delay") === "") { SetAutoplayDelay(1000); } // milliseconds
else { SetAutoplayDelay(gup("delay")); }

// use init_Game to avoid overlap with existing global var initialGame in pgn4web.js
if ((init_Game = gup("initialGame")) === "") {
  init_Game = "first";
} else {
  if (init_Game == "f") { init_Game = "first"; }
  if (init_Game == "l") { init_Game = "last"; }
  if (init_Game == "r") { init_Game = "random"; }
}
SetInitialGame(init_Game);
SetInitialVariation(0);	// initialVariation not taken in consideration in live mode
//						  always_Halfmove
SetInitialHalfmove("end", true); // CFG initialHalfmove not taken in consideration in live mode

oldButtonsDisplay = "";
showButtons = gup("showButtons");
if ((showButtons == "true")  || (showButtons == "t")) { oldButtonsDisplay = "custom"; }
if ((showButtons == "false") || (showButtons == "f")) { oldButtonsDisplay = "hidden"; }
if ((buttonsDisplay = gup("buttonsDisplay")) === "") {
  buttonsDisplay = oldButtonsDisplay === "" ? "hidden" : oldButtonsDisplay;
}
if (buttonsDisplay == "c") { buttonsDisplay = "custom"; }
if (buttonsDisplay == "h") { buttonsDisplay = "hidden"; }
if (buttonsDisplay == "s") { buttonsDisplay = "standard"; }
if ((buttonsDisplay != "custom") && (buttonsDisplay != "standard")) { buttonsDisplay = "hidden"; }

 // head, num, chEvent, chSite, chRound, chWhite, chBlack, chResult, chDate
SetGameSelectorOptions(null,     true, 0, 0, 0, 18, 18, 3, 10); // Nbr of characters by field
// SetGameSelectorOptions(null, false, 0, 0, 0, 15, 15, 3, 10); // in board.html

if (buttonsDisplay == "custom") {

  if ((controlBackgroundColor = gup("controlBackgroundColorName")) === "") {
    if ((controlBackgroundColor = "#" + gup("controlBackgroundColorHex")) == "#") {
      controlBackgroundColorSex = gup("controlBackgroundColorSex");
      if (controlBackgroundColorSex == "default") {
          controlBackgroundColor = "#default";
      } else if (controlBackgroundColorSex == "d") {
            controlBackgroundColor = "#d";
      } else {
        if ((controlBackgroundColor = "#" + sex2hex(controlBackgroundColorSex)) == "#") {
          controlBackgroundColor = "#default";
        }
      }
    }
  }

  if ((controlBackgroundColor == "d") || (controlBackgroundColor == "#d")) { controlBackgroundColor = "default"; }
  if (controlBackgroundColor == "#default") { controlBackgroundColor = "default"; }

  if (controlBackgroundColor == "default") { buttonsDisplay = "standard"; }

  if ((controlTextColor = gup("controlTextColorName")) === "") {
    if ((controlTextColor = "#" + gup("controlTextColorHex")) == "#") {
      if ((controlTextColor = "#" + sex2hex(gup("controlTextColorSex"))) == "#") { controlTextColor = "#000000"; }
    }
  }

} else {
  controlBackgroundColor = "default";
  controlTextColor = "#000000";
}

oldCommentsDisplay = "";
if (IsMatchFirst(gup("showCommentsOnSeparateLines"), "true")) { oldCommentsDisplay = "newline"; }
if (IsMatchFirst(gup("showComments"), "false")) { oldCommentsDisplay = "hidden"; }
if ((commentsDisplay = gup("commentsDisplay")) === "") {
  commentsDisplay = oldCommentsDisplay === "" ? "inline" : oldCommentsDisplay;
}
if (commentsDisplay == "h") { commentsDisplay = "hidden"; }
if (commentsDisplay == "i") { commentsDisplay = "inline"; }
if (commentsDisplay == "n") { commentsDisplay = "newline"; }

switch (commentsDisplay) {
  case "hidden":
    SetCommentsIntoMoveText(false);
    SetCommentsOnSeparateLines(false);
    break;
  case "newline":
    SetCommentsIntoMoveText(true);
    SetCommentsOnSeparateLines(true);
    break;
  case "inline":
  default:
    SetCommentsIntoMoveText(true);
    SetCommentsOnSeparateLines(false);
    break;
}

frameHeight = gup("frameHeight");
switch (frameHeight) {
  case "b":
  case "board":
    frameHeight = "";
    fixFrameHeightToBoard = true;
    break;
  case "p":
  case "page":
    if (window.innerHeight) { frameHeight = window.innerHeight; }
    else if (document.documentElement && document.documentElement.clientHeight) { frameHeight = document.documentElement.clientHeight; }
    else if (document.body && document.body.clientHeight) { frameHeight = document.body.clientHeight; }
    else { frameHeight = ""; }
    fixFrameHeightToBoard = false;
    break;
  case "":
    fixFrameHeightToBoard = false;
    break;
  default:
    frameHeight = parseInt(frameHeight, 10);
    if (isNaN(frameHeight)) { frameHeight = ""; }
    fixFrameHeightToBoard = false;
    break;
}

frameWidth = gup("frameWidth");
switch (frameWidth) {
  case "b":
  case "board":
    frameWidth = "";
    fixFrameWidthToBoard = true;
    break;
  case "p":
  case "page":
    frameWidth = "";
    textWidth = "100%";
    fixFrameWidthToBoard = false;
    break;
  case "":
    fixFrameWidthToBoard = false;
    break;
  default:
    frameWidth = parseInt(frameWidth, 10);
    if (isNaN(frameWidth)) { frameWidth = ""; }
    fixFrameWidthToBoard = false;
    break;
}

demoFlag = IsMatchFirst(gup("demo"), "true") || IsMatchFirst(gup("refreshDemo"), "true");
alertFlag = demoFlag; 

if ((refreshMinutes = gup("refreshMinutes")) === "")
{
	refreshMinutes = 1;
}
else
{
	testMinutes = refreshMinutes + "";
	if ((testMinutes.match(/[^0-9\.]/)) || (refreshMinutes === 0))
	{
		if (alertFlag)
		{
			alert("ERROR: refreshMinutes parameter must be a positive number.\n" +
			  "Supplied " + testMinutes + "; defaulting to 1.");
		}
		refreshMinutes = 1;
	}
}

pgnFile_default = detectBaseLocation() ?
    location.protocol + "//" + location.hostname + location.pathname.replace(/\/[^\/]*$/, "/pgn4web/live/live.pgn") :
    "pgn4web/live/live.pgn";
// accepts pgnData as alias for pgnFile for consistency with board.html
if ((pgnFile = gup("pgnData")) === "") 
{
	if ((pgnFile = gup("pgnFile")) === "")
	{
		pgnFile = pgnFile_default;
	}
}

if (IsMatchFirst(gup("help"), "true"))
{
	developer_help(); 
}
GenHtml();
SetPgnUrl(pgnFile);
SetImageType("png");
//                                                    LiveBroadcastSteppingMode
SetLiveBroadcast(refreshMinutes, alertFlag, demoFlag, true); // autoplay from current position to the lastest

// End of main javascript

// Write the new style and body of the HTML page
function GenHtml()
{
	document.write(CustomStyleSheet());
	document.write(GenBody());
}

// Redefine the custom function initially empty in pgn4web.js to manage clocks
function customFunctionOnCheckLiveBroadcastStatus()
{
    if (theObj = document.getElementById("GameLiveStatus")) {
		theObj.innerHTML = ((numberOfGames === 1) && (PlyNumber === 0) && (!gameFEN[currentGame])) && (!gameWhite[currentGame]) && (!gameBlack[currentGame])? "" : theObj.title;
    }
	if (spanClockRefresh = document.getElementById("GameLiveLastRefreshed")) 
		spanClockRefresh.innerHTML = LiveBroadcastLastRefreshedLocal.match(/\d\d:\d\d:\d\d/); // locale "HH:MM:SS" only
	if (spanClockServer = document.getElementById("GameLiveLastModifiedServer")) 
	{
		if (spanClockServer.innerHTML == "unavailable")
			spanClockServer.innerHTML = "off"; // Shorter keyword max 8 characters as "HH:MM:SS"
		else
		{
			clockServer = new Date(spanClockServer.innerHTML);				// GMT time server-side
			spanClockServer.innerHTML = clockServer.toLocaleTimeString();	// Locale "HH:MM:SS"
		}
	}
}

// write updated CSS stylesheet with new values overriding the one at the top of the file
function CustomStyleSheet()
{
	var newStyleSheet = '<style type="text/css"> \n';
	var nlCss = '; }\n';

	if ((movesDisplay == "figurine") || (movesDisplay == "nosymbols") || (movesDisplay == "puzzle")) {
	  newStyleSheet += 'body, .header, .comment { font-family: \'pgn4web Liberation Sans\', sans-serif; } \n';
	  newStyleSheet += '.move, .variation, .commentMove { font-family: \'pgn4web ChessSansPiratf\', \'pgn4web Liberation Sans\', sans-serif; } \n';
	}

	newStyleSheet += 'body { background: ' + backgroundColor + '; padding: ' + framePadding + nlCss;

	newStyleSheet += '.pieceImage { width: ' + pieceSize + '; height: ' + pieceSize + nlCss;
	var widthHeight = 	'width: '  + (squareSize - 2 * borderSize) + 'px; ' + 
						'height: ' + (squareSize - 2 * borderSize) + 'px; ';						
	if (highlightMode == 'border')
	{
		var borderStyleWidth = 'border-style: solid; border-width: ' + borderSize + 'px; ';
		newStyleSheet += '.whiteSquare { '			+ widthHeight + 'background: ' + lightColor + '; ' +
					   borderStyleWidth + 'border-color: '	+ lightColor + nlCss;
		newStyleSheet += '.blackSquare { '			+ widthHeight + 'background: ' + darkColor + '; ' +
					   borderStyleWidth + 'border-color: ' + darkColor + nlCss;
		newStyleSheet += '.highlightWhiteSquare { ' + widthHeight + 'background: ' + lightColor + '; ' +
					   borderStyleWidth + 'border-color: ' + highlightLightColor + nlCss;
		newStyleSheet += '.highlightBlackSquare { ' + widthHeight + 'background: ' + darkColor + '; ' +
					   borderStyleWidth + 'border-color: ' + highlightDarkColor + nlCss;
	}
	else 
	{
		newStyleSheet += '.whiteSquare { ' 			+ widthHeight + 'background: ' + lightColor + nlCss;
		newStyleSheet += '.blackSquare { ' 			+ widthHeight + 'background: ' + darkColor + nlCss;
		newStyleSheet += '.highlightWhiteSquare { ' + widthHeight + 'background: ' + highlightLightColor + nlCss;
		newStyleSheet += '.highlightBlackSquare { ' + widthHeight + 'background: ' + highlightDarkColor + nlCss;
	}

	newStyleSheet += '.boardTable { border-color: ' + boardBorderColor + nlCss;

	if (boardShadowColor != 'transparent')
	{
		newStyleSheet += '.boardTable { ' +
			'box-shadow: 0px 0px ' + Math.ceil(squareSize / 2) + 'px ' + boardShadowColor + nlCss;
	}

	if (!fontHeaderSize.match(/[^0-9]/)) {
		fontHeaderSize += 'px';
		newStyleSheet += 'body, table { font-size: ' + fontHeaderSize + nlCss;
	}
	newStyleSheet += '.header { color: ' + fontHeaderColor + '; font-size: ' + fontHeaderSize + nlCss;

	if (!fontMovesSize.match(/[^0-9]/)) { fontMovesSize += 'px'; }
	newStyleSheet += '.move { color: ' + fontMovesColor + '; font-size: ' + fontMovesSize + nlCss;

	if (!fontCommentsSize.match(/[^0-9]/)) { fontCommentsSize += 'px'; }
		newStyleSheet += '.comment, .variation { ' +
					   ' color: ' + fontCommentsColor + ';' +
					   ' font-size: ' + (fontCommentsSize == 'moves' ? fontMovesSize : fontCommentsSize) + nlCss;

	if (!fontVariationsSize.match(/[^0-9]/)) { fontCommentsSize += 'px'; }
	if (fontVariationsColor !== 'comments')
	{
		newStyleSheet += '.variation, a.variation {  color: ' + fontVariationsColor + nlCss;
	}
	if (fontVariationsSize !== 'comments')
	{
		newStyleSheet += '.variation {  font-size: ' + fontVariationsSize + nlCss;
	}

	//  newStyleSheet += 'a.move:hover, a.variation:hover { ' +
	//                   ' background: ' + (highlightMoveColor == 'none' ? backgroundColor : highlightMoveColor) + nlCss;

	newStyleSheet += '.moveOn, .variationOn { ' +
					' background: ' + (highlightMoveColor == 'none' ? backgroundColor : highlightMoveColor) + nlCss;

	  if ((controlBackgroundColor != 'default') && (controlBackgroundColor != '#default'))
	  {
		controlFontSize = Math.floor(squareSize / 2.5);
		newStyleSheet += '.buttonControl, .buttonControlPlay, .buttonControlStop { ' +
						 '-webkit-appearance: none; ' +
						 'border-style: solid; ' +
						 'border-width: 0px; ' +
						 'border-radius: 0px; ' +
						 'border-color: ' + backgroundColor + '; ' +
						 'background-color: ' + controlBackgroundColor + '; ' +
						 'color: ' + controlTextColor + '; ' +
						 'font-size: ' + controlFontSize + 'px; ' +
						 'text-align: center; ' +
						 'vertical-align: middle' + nlCss;

		newStyleSheet += '.selectControl { ' +
						 // was '-webkit-appearance: none; ' + // Do not hide the arrow to select games
						 'padding: 3px; ' +
						 'border-style: solid; ' +
						 'border-width: 1px; ' +
						 'border-radius: 0px; ' +
						 'border-color: ' + backgroundColor + '; ' +
						 'background-color: ' + controlBackgroundColor + '; ' +
						 'color: ' + controlTextColor + '; ' +
						 'font-size: 13px' + nlCss; // was 'font-size: ' + controlFontSize + 'px; ' + ' } \n';

		newStyleSheet += '.optionSelectControl { background-color: ' + controlBackgroundColor + nlCss;
	  }
	newStyleSheet += '</style> \n';

	return newStyleSheet;
}

function defaultPieceSize(squareSize) {
  targetPieceSize = Math.floor(0.8 * squareSize);
  for (ii=(pieceSizeOptions.length-1); ii>=0; ii--) {
    if (pieceSizeOptions[ii] <= targetPieceSize) { return pieceSizeOptions[ii]; }
  }
  return pieceSizeOptions[0];
}

function percentFixFromUrl( text ) {
  text += ''; // makes sure text is a string
  return text.replace(/pct$/,'%').replace(/p$/,'%'); // 100pct and 100p both mean 100%
}

function sex2hex(sex) {
  if (sex === "") { return ""; }
  sex += "";
  var dec = 0;
  var cnt;
  for (cnt=0; cnt<sex.length; cnt++) {
    dec <<= 6;
    dec += sexEncodingCharSet.indexOf(sex.charAt(cnt));
  }
  var hex = dec.toString(16).toUpperCase() + "";
  while (hex.length < 6) { hex = "0" + hex; }
  return hex;
}

  function customFunctionOnPgnTextLoad() {

    document.getElementById("playersDetails").className =
      LiveBroadcastStarted ? "headerHighlighted" : "header";
    document.getElementById("statusDetails").className =
      ((!LiveBroadcastStarted) || (LiveBroadcastEnded)) ? "headerHighlighted" : "header";
    document.getElementById("additionalMessage").innerHTML =
      LiveBroadcastEnded ? ", click H6 for the next event" : "";

    // cope with occasional failures to load the live PGN data
    if ((LiveBroadcastDelay !== 0) && (LiveBroadcastTicker > 0) && (!LiveBroadcastFoundOldGame)) {
      thisCurrentGame = currentGame;
      SetInitialGame(init_Game);
      SetInitialVariation(0);
      setCurrentGameFromInitialGame();
      if (currentGame != thisCurrentGame) {
        SetInitialHalfmove("end",true);
        Init();
        GoToInitialHalfmove();
      }
    }

  }

  function customFunctionOnPgnGameLoad()
  {
    objectsToTitle = ["GameEvent", "GameSite", "GameDate", "GameWhite", "GameBlack"];
    for (ii in objectsToTitle) {
      if (theObj = document.getElementById(objectsToTitle[ii])) { theObj.title = theObj.innerHTML; }
    }
    if (timeControl = customPgnHeaderTag("TimeControl")) {
      if (theObj = document.getElementById("GameWhiteClock")) { theObj.title = "timecontrol: " + timeControl; }
      if (theObj = document.getElementById("GameBlackClock")) { theObj.title = "timecontrol: " + timeControl; }
    } else {
      if (theObj = document.getElementById("GameWhiteClock")) { theObj.title = ""; }
      if (theObj = document.getElementById("GameBlackClock")) { theObj.title = ""; }
    }
	document.getElementById("roundDetails").innerHTML = ((gameRound[currentGame] !==  undefined) &&
		(gameRound[currentGame] !== "") &&
		(gameRound[currentGame] !=  "*") &&
		(gameRound[currentGame] !=  "?")) ? "&nbsp;(" + gameRound[currentGame] + ")" : "";

	var spanGameResult = document.getElementById("GameResult");
	if (spanGameResult)
	{
		spanGameResult.title = (gameTermination = customPgnHeaderTag("Termination")) ? 
			"termination: " + gameTermination : "";

		if (gameResult[currentGame] !== undefined) 
		{
			spanGameResult.className = ((gameResult[currentGame] == "*") || (gameResult[currentGame] == "?")) ?
				"headerNosize" : "headerHighlightedNosize";
		}
		else
		{
			spanGameResult.className = "headerNosize";
			spanGameResult.innerHTML = "";
		}
	}
    var divGam = document.getElementById("GameText");
    if (divGam)
	{
		if ((divGam.scrollHeight !== undefined) && (divGam.scrollTop !== undefined) && ((!LiveBroadcastFoundOldGame) || (LiveBroadcastOldCurrentPlyLast && (LiveBroadcastOldCurrentPly < StartPly+PlyNumber))))
			divGam.scrollTop = divGam.scrollHeight;	
	}
  }

// Display systemMessage (inline) if pgn4webMessage is empty
function customFunctionOnMove()
{
	var stsBar = customPgnCommentTag("pgn4web", "pgn4webMessage");
	document.getElementById("systemMessage").style.display = (stsBar !== "") ? "none" : "inline";
}
 
var timeoutOnceReadPgnLive = null;
// Hide div messageLine. Run once refreshPgnSource() after the delay of 111 ms. Make visible div messageLine
function checkForNewLiveEvent()
{
	document.getElementById("messageLine").style.visibility = "hidden";
	if (timeoutOnceReadPgnLive)
	{ 
		clearTimeout(timeoutOnceReadPgnLive);
		timeoutOnceReadPgnLive = null;
	}
	// started as timeout otherwise some browser could suppress visual feedback
	// timeoutOnceReadPgnLive = setTimeout('refreshPgnSource();document.getElementById("messageLine").style.visibility = "visible";', 111); // original code
	timeoutOnceReadPgnLive = setTimeout(function(){GuiReadPgnLive()}, 111); // Run once after delay in ms
}

// Call refreshPgnSource then make visible the div messageLine
function GuiReadPgnLive()
{
	refreshPgnSource(); // while the div messageLine has been hidden
	var divStsBar = document.getElementById("messageLine");
	divStsBar.style.visibility = "visible"; // Restore the visibility of the div
}
  
  function customShortcutKey_Shift_1() {
    if (typeof(openFidePlayerUrl) == "function") {
      openFidePlayerUrl(gameWhite[currentGame], customPgnHeaderTag('WhiteFideId'));
    }
  }

  function customShortcutKey_Shift_2() {
    if (typeof(openFidePlayerUrl) == "function") {
      openFidePlayerUrl(gameBlack[currentGame], customPgnHeaderTag('BlackFideId'));
    }
  }

// @return	true if the option matches with the value or the first character of the value
// @in:		option the value of the option
//			value	the value for comparison
function IsMatchFirst(option, value)
{
	if (option == value)
		return true;
	if (option == value.charAt(0))
		return true;
	return false;
}

function gup(name) {

  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  // commented below to match first occurrence (to avoid users overruling setting)
  // regexS = regexS+"(?!.*"+regexS+")"; // matches the LAST occurrence
  var regex = new RegExp( regexS, "i" );
  var results = regex.exec( window.location.href );
  if (results !== null) { return decodeURIComponent(results[1]); }

  // allows for short version of the URL parameters, for instance sC matches squareColor
  compact_name = name.charAt(0);
    for (i=1; i<name.length; i++) {
      if (name.charAt(i).match(/[A-Z]/)) { compact_name = compact_name + name.charAt(i).toLowerCase(); }
    }
  name = compact_name;

  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  regexS = "[\\?&]"+name+"=([^&#]*)";
  // commented below to match first occurrence (to avoid users overruling setting)
  // regexS = regexS+"(?!.*"+regexS+")"; // matches the LAST occurrence
  regex = new RegExp( regexS, "i" );

  results = regex.exec( window.location.href );
  if (results !== null) { return decodeURIComponent(results[1]); }

  return "";
}

function developer_help()
{
 alert("pgn4web live.html parameters" + "\n" +
    " - pgnData = " + pgnFile + "; PGN file to load (default " + pgnFile_default + ")" + "\n" +
    " - initialGame = " + init_Game + "; initial game to load, a number or first, last, random or a search string (default 1)" + "\n" +
    " - refreshMinutes = " + refreshMinutes + "; refresh interval in minutes, decimals allowed (default 1)" + "\n" +
    " - showComments = " + commentsIntoMoveText + "; (default false)" + "\n" +
    " - refreshDemo = " + demoFlag + "; sets live demo mode (default false)" + "\n" +
    " - help = true; prints this help (default false)");
}

function user_help()
{
  plural = refreshMinutes != 1 ? "s" : "";
  demoString = demoFlag ? "demo mode enabled" + "\n" : "";

  helpText = "Chess games live broadcast using pgn4web v" + pgn4web_version + "\n" +
    "\n" +
    "Games are automatically updated every " +
    refreshMinutes + " minute" + plural  + " from the remote file " +
    "(" + pgnFile + "). " +
    "If the shown game is kept at the last available move, " +
    "upon refresh the chessboard steps forward automatically " +
    "to the game's latest position. " +
    "The refresh stops once all games are finished. " +
    "If no games are shown, just wait for the live broadcast to start. " +
    "There is no need to reload the webpage to refresh games, " +
    "but it's possible to manually force a refresh by clicking on square H6." + "\n" +
    "\n" +
    "Chessboard squares are input buttons controlling games display (full list by clicking square G8), including:" + "\n" +
    "\n" +
    "A1 / H1: game start / end" + "\n" +
    "D1 / E1: move back / forwards" + "\n" +
    "A3 / H3: load first / last game" + "\n" +
    "C3 / F3: load previous / next game" + "\n" +
    "A6 / B6: pause / restart live broadcast automatic refresh" + "\n" +
    "C6 / F6: jump to previous / next finished game" + "\n" +
    "D6 / E6: jump to previous / next unfinished game" + "\n" +
    "H6: force games refresh during live broadcast" + "\n" +
    "A8: debug info" + "\n" +
    "G8 / H8: shortcut squares help / pgn4web help" + "\n" +
    "\n" +
    "Please note all squares are listed assuming White on bottom, plese adjust square labels if the chessboard is flipped." + "\n" +
    "\n" +
    "Press OK for more pgn4web help information" +
    "\n ";

  if (confirm(helpText)) { displayHelp(); }
}

// @Return the HTML body if the chessboard with horizontal GameText at its right or below statusDetails if vertical
function GenBody()
{
	// PHP heredoc-like in javascript: 1. Select HTML code in NotePad++. 2. Regular expression "(.)$" -> "\1\"
	// to add a backslash at the end of each line of the HTML code. Extended mode \n\n -> \n\\\n
	var htmlBody ='<body><center>\
<!-- need the external table to force height of 360 (see blackberry background issue) -->\
<!-- width=100% was 460 is the max width for a 480 wide screen allowing for scrollbars -->\
<!-- was height=360 is the max height for a 360 tall screen. cellpadding=0 was 5 -->\
<table id="outerTable" width=100% cellpadding=0 cellspacing=0 border=0>\
<tr><td align=center valign=top>\
\
<!-- 450 = 460 outerTable width - 2 * 5 cellpadding -->\
<table width=400 cellpadding=0 cellspacing=0 border=0>\
<tr>\
	<td align=left valign=middle style="padding-bottom: 4px;">\
	<div id="GameSelector"></div>\
	</td>\
	<td width=30 align=left valign=middle style="padding-left:1px;">\
		<div style="wi\dth: 30px; height: 1.3em; line-height: 1.3em; overflow: hidden; white-space: nowrap;">\
		<a id="helplink" class="helplinkNosize" href="javascript: user_help();" onFocus="this.blur()" title="pgn4web live broadcast help">help</a>\
		</div>\
	</td>\
</tr>\
</table>\
\
<!-- width = 100% was same 450 width as above -->\
<table id="eventDetails" class="header" width=100% cellpadding=0 cellspacing=0 border=0>\
<tr>\
	<td width=100 align=left valign=middle style="padding: 3px;">\
	<div id="GameSite" style="width: 94px; height: 1.3em; line-height: 1.3em; overflow: hidden; white-space: nowrap;"></div>\
	</td>\
	<td width=250 align=center valign=middle style="padding: 3px;">\
	<div style="width: 244px; height: 1.3em; line-height: 1.3em; overflow: hidden;"><span id="GameEvent"></span><span id="roundDetails"></span></div>\
	</td>\
	<td width=100 align=right valign=middle style="padding: 3px;">\
	<div id="GameDate" style="width: 94px; height: 1.3em; line-height: 1.3em; overflow: hidden"></div>\
	</td>\
</tr>\
</table>\
\
<!-- width = 100% was same 450 width as above -->\
<table id="playersDetails" class="header" width=100% cellpadding=0 cellspacing=0 border=0>\
<tr>\
	<td width=65 align=left valign=middle style="padding: 3px;">\
	<div id="GameWhiteClock" style="width: 59px; height: 1.3em; line-height: 1.3em; overflow: hidden; white-space: nowrap;"></div>\
	</td>\
	<td width=320 align=center valign=middle style="padding: 3px;">\
	<div style="width: 314px; height: 1.3em; line-height: 1.3em; overflow: hidden; white-space: nowrap;">\
	<span id="GameWhite"></span>\
	&nbsp;&nbsp;&nbsp;\
	<span id="GameBlack"></span>\
	</div>\
	</td>\
	<td width=65 align=right valign=middle style="padding: 3px;">\
	<div id="GameBlackClock" style="width: 59px; height: 1.3em; line-height: 1.3em; overflow: hidden; white-space: nowrap;"></div>\
	</td>\
</tr>\
</table>\
\
<!-- width = 100% was same 450 width as above -->\
<table width=100% cellpadding=0 cellspacing=0 border=0>\
<tr>\
	<!-- 240 chessboard size = 8 * (26 square size + 2 * (2 square border)) -->\
	<!-- width=246 = (chessboard size) + (6 right padding) -->\
	<td id="tdGameBoard" width=';

	var htmlTdGameBoardEnd =' valign=top style="padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 6px;">\
	<span id="GameBoard"></span>\
	</td>';
	
	var htmlTdGameTextStart ='\
	<!-- was width= right column width 204 = (460 outer cell width) - (246 left column width) - (2 * 5 cellpaddding) -->\
	<td id="tdGameText" align=left valign=top style="padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;">\
	<!-- height 240 = chessboard size -->\
	<!-- was width:199px; = table cell size - 5 padding. style="height: 208px; " = 26 * 8 was style="height: 240px; " -->';

	var htmlEndTableBoard ='\
<tr>\
</table>';

	// In div messageLine, remove style="overflow: hidden; " hidding GameLiveStatus during first moves in IE8
	var htmlStatusDetails = '<!-- width = 100% was same 450 width as above -->\
<table id="statusDetails" class="header" width=100% cellpadding=0 cellspacing=0 border=0>\
<tr>\
	<td width=40 align=left valign=middle style="padding:1px;">\
		<div style="width: 40px; height: 1.3em; line-height: 1.3em; overflow: hidden; white-space: nowrap;">\
		<span id="GameResult" class="headerNosize"></span>\
		</div>\
	</td>\
	<td width=52px style="padding:1px; font-size:13px;" valign=middle>\
		<div style="width:52px; height: 1.3em; line-height: 1.3em; overflow: hidden; white-space: nowrap;">\
		<span id="GameLiveLastRefreshed" style="float:right; clear:both;" title="Last refreshed" />\
		</div>\
	</td>\
	<td width=300px style="padding:1px;  font-size:13px;" align=left valign=middle>\
		<div id="messageLine" style="height: 1.3em; line-height: 1.3em; white-space: nowrap;">\
		<span id="pgn4webMessage"></span>\
		<span id="systemMessage"><span id="GameLiveStatus"></span><span id="additionalMessage"></span></span>\
		</div>\
	</td>\
	<td width=52px style="padding:1px; font-size:13px;" valign=middle>\
		<div style="width:52px; height: 1.3em; line-height: 1.3em; overflow: hidden; white-space: nowrap;">\
		<span id="GameLiveLastModifiedServer" style="float:right; clear:both;" title="Last modified on server" />\
		</div>\
	</td>\
</tr>\
</table>\
\
</td></tr>';

	var htmlEndOuterTableBody = '\
</table>\
</center>\
</body>';

	var horizontalLayout = IsMatchFirst(gup("horizontalLayout"), "true");
	if (horizontalLayout)
	{	// Set the width of the chessboard according to the number of squares
		var widthBoard = squareSize * 8;
		htmlBody += widthBoard.toString() + "px align=left" + htmlTdGameBoardEnd;

		// Align the height of the list of moves with the height of the chessboard
		htmlBody += htmlTdGameTextStart;
		var heightBoard = squareSize * 8;
		// style="overflow-x: hidden; overflow-y: auto;" does not display the first line of moves in IE8
		// see meta IE=7 in the head
		htmlBody += '<div class="movebox" id="GameText" style="height: ' + heightBoard.toString() + 'px; ' +
					'padding-right: 5px; overflow-x: hidden; overflow-y: auto;"></div></td>' + htmlEndTableBoard;
		htmlBody += htmlStatusDetails + htmlEndOuterTableBody;
	}
	else
	{	// Set the full width for the chessboard that is centered
		htmlBody += "100% align=center" + htmlTdGameBoardEnd + htmlEndTableBoard;
		htmlBody += htmlStatusDetails;	// Below statusDetails, ...
		htmlBody += '<tr>' + htmlTdGameTextStart; // create a new row in outerTable for vertical GameText
		htmlBody += '<div class="movebox" id="GameText" style="height: 100%; ' +
					'padding-right: 5px; overflow-x: hidden; overflow-y: auto;"></div></td></tr>';
		htmlBody += htmlEndOuterTableBody;
	}
	return htmlBody;
}
</script>
</head>
</html>
