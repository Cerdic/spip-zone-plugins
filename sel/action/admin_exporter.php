<?phpif (!defined("_ECRIRE_INC_VERSION")) return;function action_admin_exporter_dist() {    $securiser_action = charger_fonction('securiser_action', 'inc');    $arg = $securiser_action();	if ($arg=='u') action_admin_exporter_utilisateurs();}function action_admin_exporter_utilisateurs() {		$sep = "\t";		$alaligne = "\n";				$schema_insert = "";		$schema_insert.= _T('snb:login').$sep;		$schema_insert.= _T('snb:email').$sep;		$schema_insert.= _T('snb:prenom').$sep;					$schema_insert.= _T('snb:nom').$sep;		$schema_insert.= _T('snb:acces').$sep;				$schema_insert.= _T('snb:adresse').$sep; // agréger adresse 1 et 2 dans cette case		$schema_insert.= _T('snb:code_postal').$sep;		$schema_insert.= _T('snb:ville').$sep;		$schema_insert.= _T('snb:pays').$sep;		$schema_insert.= _T('snb:seljeu').$sep;				$schema_insert.= _T('snb:correspondance').$sep;			$schema_insert.= $alaligne;			if( $_GET['tri']) $ob[0] = $_GET['tri'];		if(is_array($ob) && $_GET['senstri']) $ob[0] .= ' DESC';				$liste = sql_select(array('id_auteur','login','email','prenom','nom','acces','adresse1','adresse2','code_postal','ville','pays'),array('spip_auteurs'),'','',$ob);		while ($res = sql_fetch($liste)) {			$sels = sql_select(array('DISTINCT spip_correspondances.id_sel','nom'),'spip_correspondances LEFT OUTER JOIN spip_sels ON spip_correspondances.id_sel = spip_sels.id_sel','spip_correspondances.id_auteur = '.sql_quote($res['id_auteur']));			$nbsels_auteur = sql_count($sels);			$organisations = sql_select(array('spip_correspondances.id_sel','nom'),'spip_correspondances LEFT OUTER JOIN spip_organisations ON spip_correspondances.id_organisation = spip_organisations.id_organisation', array('spip_correspondances.id_organisation != 0','spip_correspondances.id_auteur = '.sql_quote($res['id_auteur'])));			$nborgs_auteur = sql_count($organisations);			if (session_get('acces')=='4admin_general') {				$i = 1;				$lessels = '';				$tabidsel = array();				while ($res_sels = sql_fetch($sels)) {					if ($res_sels['id_sel']==0) $lessels.= _T('sel:jeu');					$lessels.= $res_sels['nom'];					$tabidsel[] = $res_sels['id_sel'];					if ($i < $nbsels_auteur) $lessels .= ' - ';					$i++;				}				$j = 1;				$lesorgs = '';				while ($res_orgs = sql_fetch($organisations)) {					$lesorgs.= $res_orgs['nom'];					if (in_array($res_orgs['nom'],$tabidsel)) $lesorgs.= _T('sel:pour').' : ';					if ($j < $nborgs_auteur) $lesorgs .= ' - ';					$j++;				}											}			if (session_get('acces')=='3admin_local') {				// récupérer les sels de session_id_auteur, et filtrer ls utilisateurs en fonction de ces SEL			}			$schema_insert.= $res['login'].$sep;			$schema_insert.= $res['email'].$sep;			$schema_insert.= $res['prenom'].$sep;						$schema_insert.= $res['nom'].$sep;						switch ($res['acces']) {				case '0nouveau':					$schema_insert.= _T('sel:0nouveau').$sep;					break;								case '1utilisateur_ok':					$schema_insert.= _T('sel:1utilisateur_ok').$sep;					break;				case '2utilisateur_ko':					$schema_insert.= _T('sel:2utilisateur_ko').$sep;					break;				case '3admin_local':					$schema_insert.= _T('sel:3admin_local').$sep;					break;										case '4admin_general':					$schema_insert.= _T('sel:4admin_general').$sep;					break;								}				$schema_insert.= $res['adresse1'].' '.$res['adresse2'].$sep;			$schema_insert.= $res['code_postal'].$sep;			$schema_insert.= $res['ville'].$sep;			$schema_insert.= $res['pays'].$sep;			$schema_insert.= $lessels.$sep;					$schema_insert.= $lesorgs.$sep;				$schema_insert.= $alaligne;						}					$schema_insert = (is_string($schema_insert)) ? 		iconv("UTF-8", "Windows-1252//TRANSLIT", $schema_insert) : $schema_insert; 									$schema_insert = str_replace($sep."$", "", $schema_insert);		$schema_insert .= $sep.$alaligne;		$schema_insert = trim($schema_insert);					$type_fichier = "vnd.ms-excel";		$extension = "xls";		$date_maintenant = date('Y-m-d H:i');		header('Content-Type:application/xhtml+xml; charset=iso-8859-1');		header("Content-Type: application/$type_fichier");		header("Content-Disposition: attachment; filename=liste_utilisateurs_".$date_maintenant.".xls");		header("Pragma: no-cache");		header("Expires: 0");		print($schema_insert);	}?>