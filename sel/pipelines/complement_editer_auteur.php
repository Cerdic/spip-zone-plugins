<?phpfunction sel_editer_contenu_objet($flux){	$spip_branche_principale = substr($GLOBALS[spip_version_branche], 0, 1);	if ($flux['args']['type']=='auteur') {		// $flux['data'] = preg_replace("%(<form method='post')%is","<form method='post' onsubmit='codeAdresse()'",$flux['data']);			$complement_auteur_identite = recuperer_fond('formulaires/inc-auteur-identite', $flux['args']['contexte']);		if ($spip_branche_principale==3) $flux['data'] = preg_replace('%(<li class="editer editer_nom (.*?)</li>)%is',''."\n".$complement_auteur_identite, $flux['data']);		if ($spip_branche_principale==2) $flux['data'] = preg_replace('%(<li class="editer_nom (.*?)</li>)%is',''."\n".$complement_auteur_identite, $flux['data']);		if ($spip_branche_principale==3) $flux['data'] = preg_replace('%(<li class="editer editer_bio(.*?)</li>)%is','',$flux['data']);		if ($spip_branche_principale==2) $flux['data'] = preg_replace('%(<li class="editer_bio(.*?)</li>)%is','',$flux['data']);				if ($spip_branche_principale==3) $flux['data'] = preg_replace('%(<li class="editer editer_email(.*?)</li>)%is','',$flux['data']);		if ($spip_branche_principale==2) $flux['data'] = preg_replace('%(<li class="editer_email(.*?)</li>)%is','',$flux['data']);		if ($spip_branche_principale==3) $flux['data'] = preg_replace('%(<li class="editer editer_pgp(.*?)</li>)%is','',$flux['data']);		if ($spip_branche_principale==2) $flux['data'] = preg_replace('%(<li class="editer_pgp(.*?)</li>)%is','',$flux['data']);				// utilisateur non certifié --> pas d'accès aux statuts des utilisateurs :		// champ acces : '0nouveau' et statut : '6forum' (visiteur)				// utilisateur certifié  --> pas d'accès aux statuts des utilisateurs		// champ acces : 1utilisateur_ok et champ statut : 1comite (rédacteur)				// utilisateur refusé  --> pas d'accès aux statuts des utilisateurs		// champ acces : '2utilisateur_ko' et statut : '6forum' (visiteur)				// administrateur local du catalogue --> accès aux statuts des utilisateurs (menu normal), mais pas la case à cocher "webmestre"		// champ acces : 3admin_local et champ statut : '1comite' (rédacteur)				// admistrateur général du catalogue --> --> accès à tout, menu + case à cocher.		// champ acces : 4admin_general et champ statut : '0minirezo' (admin, éventuellement webmestre)							if (!test_espace_prive()) {			if ($spip_branche_principale==3) $flux['data'] = preg_replace("%(<div class='notice'>(.*?)</div>)%is",'', $flux['data']);					if ($spip_branche_principale==2) $flux['data'] = preg_replace("%(<em class='attention'>(.*?)</em>)%is",'', $flux['data']);		}		$flux['data'] = preg_replace("%(<label for='new_pass2'(.*?)</label>)%is",'$1'.'<br />'."\n", $flux['data']);				if (in_array($GLOBALS[auteur_session][statut],array('','1comite','6forum')))		{				if ($spip_branche_principale==3) $flux['data'] = preg_replace("%(<li class='editer editer_statut'>(.*?)</script>(.*?)</li>)%is","",$flux['data']);			if ($spip_branche_principale==2) $flux['data'] = preg_replace("%(<li class='editer_statut'>(.*?)</li>)%is","",$flux['data']);		}		// Pour les sessions d'admin non webmestre (admin local du catalogue), on cache la case droit webmestre		// Pour les sessions d'admin webmestre (admin global du catalogue), on la met en changeant son label				if (($GLOBALS[auteur_session][statut]=='0minirezo') && ($GLOBALS[auteur_session][webmestre]=='non'))		{			$flux['data'] = preg_replace('%(<div class="choix choix-webmestre(.*?)</div>)%is','',$flux['data']);		}		if (($GLOBALS[auteur_session][statut]=='0minirezo') && ($GLOBALS[auteur_session][webmestre]=='oui'))		{			if ($spip_branche_principale==3) $flux['data'] = preg_replace('%(<label for="webmestre">(.*?)</label>)%is','<label for="webmestre">'._T('auteur:info_admin_statuer_webmestre').'</label>',$flux['data']);			if ($spip_branche_principale==2) $flux['data'] = preg_replace("%(<label for='webmestre'>(.*?)</label>)%is","<label for='webmestre'>"._T('auteur:info_admin_statuer_webmestre').'</label>',$flux['data']);		}				$flux['data'] = preg_replace("%(<li class='editer_liens_sites fieldset'>(.*?)</fieldset>(.*?)</li>)%is","",$flux['data']);		$complement_auteur_contact = recuperer_fond('formulaires/inc-auteur-contact', $flux['args']['contexte']);		$flux['data'] =    preg_replace('%(<fieldset>(.*?)</fieldset>)%isU', '$1'."\n".$complement_auteur_contact, $flux['data']);		// $complement_sels = recuperer_fond('formulaires/inc-liste_sels', $flux['args']['contexte']);		// $flux['data'] =    preg_replace('%(<fieldset>(.*?)</fieldset>)%isU', '$1'."\n".$complement_sels, $flux['data']);		$complement_organisations = recuperer_fond('formulaires/inc-liste_organisations', $flux['args']['contexte']);		$flux['data'] =    preg_replace('%(<fieldset>(.*?)</fieldset>)%isU', '$1'."\n".$complement_organisations, $flux['data']);				} // Vos identifiants de connexion...			return $flux;}// $flux['data'] = preg_replace('%(<li(.*?)editer_statut|editer_bio|editer_pgp(.*?)>(.*?)</li>)%is'...function sel_formulaire_charger($flux){    if ($flux['args']['form'] == 'editer_auteur'){		$valeurs = formulaires_editer_objet_charger('auteur', $id_auteur, '', '', $retour, '');				if ($flux['data']['id_auteur']=='oui') {			$flux['data']['statut'] = '6forum';			$flux['data']['acces'] = '0nouveau';			$flux['data']['sels0'] = '';			$flux['data']['corresp_tous_sel'] = '';			$flux['data']['org'] = array();			// pour une modif, faire requete sur spip_organisations et construire le tableau org[1,2,3...] = id_organisation			// (sauter le 0 du tableau car se base sur #COMPTEUR_BOUCLE)		}	}	return $flux;	}function sel_formulaire_verifier($flux){    if ($flux['args']['form'] == 'editer_auteur'){		$oblig = array('nom','prenom','email', 'new_login', 'new_pass', 'adresse1','code_postal','ville','pays','tel1','sels0');		foreach($oblig as $ch) if (_request($ch)=='') {			$erreurs[$ch] = _T('sel:formerr_oblig');			$flux['data'][$ch] = $erreurs[$ch];		};		if (!email_valide(_request('email'))) {			$erreurs['email'] = _T('sel:formerr_email_format');			$flux['data']['email'] = $erreurs['email'];					};		$mails = sql_select('email','spip_auteurs');		while($r = sql_fetch($mails)){			if (_request('email') == $r['email']) {				$erreurs['email'] = _T('sel:formerr_email_existe');				$flux['data']['email'] = $erreurs['email'];								}		}    }    return $flux;}function sel_formulaire_traiter($flux){    if ($flux['args']['form'] == 'editer_auteur'){		$id_auteur = $flux['data']['id_auteur'];		$upd = sql_updateq('spip_auteurs', array(			'prenom'=> _request('prenom'),			'acces'	=> _request('acces'),			'adresse1' => _request('adresse1'),			'adresse2' => _request('adresse2'),			'code_postal' => _request('code_postal'),			'ville' => _request('ville'),			'pays' => _request('pays'),			'tel1' => _request('tel1'),			'tel2' => _request('tel2'),			'lon' => _request('lon'),			'lat' => _request('lat'),			'commentaires' => _request('commentaires'),			'inscription'	=> date('Y-m-d'),					), 'id_auteur=' . intval($id_auteur));		if ($upd) $flux['data']['message_ok'] = "Bravo !";		if (!$upd) $flux['data']['message_erreur'] = "Raté.....";				// On ajoute les liaisons sels et organisations + éventuelles liaisons		$i = 0;		while (_request('sels'.$i) != '') {					$var_sel = 'sels'.$i;					$request_sel = _request($var_sel);					preg_match("#<N°[0-9]{1,}>$#",$request_sel,$n_id);			$id_sel = substr($n_id[0],4);			$id_sel = substr($id_sel,0,-1); 			$i++;			// on récupère l'ensemble des case cochées org[xx]			$tab_org = _request('org');						if (_request('corresp_tous_sel')=='oui') {				if (is_array($tab_org)) {								// on teste qu'on ait bien au moins 1 organisation					foreach($tab_org as $id_org) {						// si oui, on vérifie que les lignes ne soient pas déjà						// dans la table et si ok, insertq dans spip_correspondances pour chaque organisation						if (sql_countsel('spip_correspondances','id_auteur = '.sql_quote($id_auteur).'and id_sel = '.sql_quote($id_sel).'and id_organisation = '.sql_quote($id_org))==0) {							sql_insertq('spip_correspondances',array('id_auteur'=>$id_auteur,'id_sel'=>$id_sel,'id_organisation'=>$id_org));						};						// Ensuite, on regarde si on trouve dans spip_correspondances						// des trios qui ne figurent pas dans le form.						// cas 1 : on trouve pour un auteur et un sel qui ne change pas, une organisation différente						// cas 2 : on trouve pour un auteur et une organisation qui ne changent pas, un sel différent						// cas 3 : on trouve pour un auteur une organisation et un sel qui ont changés						// if (sql_countsel('spip_correspondances','id_auteur = '.sql_quote($id_auteur).'and id_sel = '.sql_quote($id_sel).'or id_organisation != '.sql_quote($id_org))!=0) {						//}					// Dans ce cas, ça signifie qu'on fait une mise à jour,					// il faut supprimer ces lignes de la base.					// : A FAIRE qd on fera la fiche en modif					}				}			} else { // si la case corresp_tous_sel n'a pas été cochée : on regarde les SEL à l'unité				$j = 0;				// debug				while (_request('sels_corresp'.$j) != '') {					$var_sel = 'sels_corresp'.$j;							$request_sel = _request($var_sel);							preg_match("#<N°[0-9]{1,}>$#",$request_sel,$n_id);					$id_selcorresp = substr($n_id[0],4);					$id_selcorresp = substr($id_selcorresp,0,-1);														// on regarde si le sel en cours ($id_sel) en fait partie					// et on teste qu'il y ait bien au moins 1 organisation					// si oui, insertq id_auteur ($id_auteur) $id (en cours) org[#ID_ORGANISATION] (de chaque organisation)										if (($id_sel == $id_selcorresp) and (is_array($tab_org))) {											foreach($tab_org as $id_org) {							if (sql_countsel('spip_correspondances','id_auteur = '.sql_quote($id_auteur).'and id_sel = '.sql_quote($id_selcorresp).'and id_organisation = '.sql_quote($id_org))==0) {								sql_insertq('spip_correspondances',array('id_auteur'=>$id_auteur,'id_sel'=>$id_selcorresp,'id_organisation'=>$id_org));							}						}									}					$j++;				} 								if ((!is_array($tab_org)) and $j<=1) {					// S'il n'y a ni case corresp_tous_sel ni précision de SELS pour correspondances dans les input sels_corresp					// on est dans le cas d'adhésions simples, donc des couples id_auteur / id_sel : insertq dans spip_correspondance					if (sql_countsel('spip_correspondances','id_auteur = '.sql_quote($id_auteur).'and id_sel = '.sql_quote($id_sel).'and id_organisation = NULL')==0) {						sql_insertq('spip_correspondances',array('id_auteur'=>$id_auteur,'id_sel'=>$id_sel,'id_organisation'=>NULL));					}					// si les valeurs reçues du form ne sont pas dans la table, et suppression dans le cas contraire (rien dans le form mais présence dans la table).					// A FAIRE quand on en sera à la fiche modif											}			}								} // Fin examen SELs autocompletion				// Connecter le nouvel inscrit : include_spip('inc/auth');		// -----------------------------------------------------------		// cette fonction renvoie la ligne spip_auteur de cet auteur ss forme de tableau, mais ne fait pas de connexion		// $flux['data']['auteur_auth'] = auth_identifier_login(_request('new_login'), _request('new_pass'));				$connect_auteur = auth_identifier_login(_request('new_login'), _request('new_pass'));		if (is_array($connect_auteur)) auth_loger($auteur);				include_spip('inc/autoriser');		if (!autoriser('ecrire')){			$h = generer_url_action('logout','logout=prive&url='.urlencode(self()));		}						// $GLOBALS[visiteur_session] = auth_identifier_login(_request('new_login'), _request('new_pass'));		// $GLOBALS[auteur_session] = auth_identifier_login(_request('new_login'), _request('new_pass'));		// $GLOBALS[_REQUEST][var_login] = _request('new_login');		// $GLOBALS[_REQUEST][password] = {6df83cca986b0bbd250660a40d24bf45b08137c05bed2890953036a9cd6b94ae;45b8428151faea0cccf65e6dac5e0d7e0d2709af26f9018c51617b9ed2d65ea8}		// debug : spip_log($flux['data']['auteur_auth'],'nn');		if (!test_espace_prive()) $flux['data']['redirect'] = 'spip.php?page=avatar&id_auteur='.$id_auteur;;		    };	    return $flux;}?>