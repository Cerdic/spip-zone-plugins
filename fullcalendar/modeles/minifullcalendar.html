[(#REM) L'appel depuis un article se fait par < minifullcalendarXX >, alors id_minifullcalendar=XX
 ou par un modele CROCHET(# MODELE{minifullcalendar}{id_minifullcalendar=XX})CROCHET 
]

<?php

	$id = '[(#ENV{id_minifullcalendar, #CONFIG{fullcalendar/mini_id, 0}}|texte_script)]';

	# Quelle source de donnée ?

	$req = sql_select('type', 'spip_fullcalendar_main', 'id_fullcalendar='.intval($id));
	$num_calendar = sql_count($req);

	if(!$num_calendar) return; # il n'y as pas de gabonnais au numéro demandé...

	else {

		$row=sql_fetch($req);

		switch($row['type']){

			# AGENDA D'UNE RUBRIQUE

			case 'rub':
			# Récupère l'id de la rubrique pour cet agenda ...
			$result = sql_select('lien', 'spip_fullcalendar_events', 'id_fullcalendar='.intval($id));
			$row = sql_fetch($result);
			if(!$row['lien']) return;

			# Récupère les article liés à cette rubrique
			$events='events: [';

			$req = sql_select(
					array(
							"A.id_article",
							"A.titre",
							"A.date",
							"A.date_redac" ),
					array(
							"spip_articles AS A",
							"spip_rubriques AS R" ),
					array(
							"A.statut='publie'",
							"A.id_rubrique='".intval($row['lien'])."'",
							"A.id_rubrique=R.id_rubrique" ),
					"",
					"A.date ASC");
			$num_events = sql_count($req);
			if($num_events)
					while ($row = sql_fetch($req)) {

							$date = explode('-',substr($row['date'],0,10));
							$date_fin = explode('-',substr($row['date_redac'],0,10));
							$start = explode(':',substr($row['date'],11,5));
							$end = explode(':',substr($row['date_redac'],11,5));

							$url="url:'spip.php?article".$row['id_article']."',";
							if($date!='0000-00-00'&&$date_fin!='0000-00-00')
							$events.="{title: '".texte_script(supprimer_numero($row['titre']))."',start:new Date(parseInt('".$date[0]."',10) , parseInt('".($date[1]-1)."',10) , parseInt('".$date[2]."',10), parseInt('".$start[0]."',10) , parseInt('".$start[1]."',10)),end: new Date(parseInt('".$date_fin[0]."',10), parseInt('".($date_fin[1]-1)."',10), parseInt('".$date_fin[2]."',10), parseInt('".$end[0]."',10), parseInt('".$end[1]."',10)),$url allDay: false},";
					}
			$events=substr($events,0,strlen($events)-1);
			$events.=']';

			break;


			# AGENDA BASE SUR LES ARTICLES

			case 'article':

			# Récupère l'id du mot clé de cet agenda ...
			$result = sql_select('lien', 'spip_fullcalendar_events', 'id_fullcalendar='.intval($id));
			$row = sql_fetch($result);
			if(!$row['lien']) return;

			# Récupère les article liés à ce mot clé
			$events='events: [

			';

			$req = sql_select(
				array(
					"A.id_article",
					"A.titre",
					"A.date",
					"A.date_redac" ),
				array(
					"spip_articles AS A",
					"spip_mots_articles AS M" ),
				array(
					"A.statut='publie'",
					"M.id_mot='".intval($row['lien'])."'",
					"A.id_article=M.id_article" ),
				"",
				"A.date ASC");

			$num_events = sql_count($req);
			if($num_events)
				while ($row = sql_fetch($req)) {

					$date = explode('-',substr($row['date'],0,10));
					$date_fin = explode('-',substr($row['date_redac'],0,10));
					$start = explode(':',substr($row['date'],11,5));
					$end = explode(':',substr($row['date_redac'],11,5));

					$url="url:'spip.php?article".$row['id_article']."',";
					if($date!='0000-00-00'&&$date_fin!='0000-00-00')
					$events.="{title: '".texte_script(supprimer_numero($row['titre']))."',start:new Date(parseInt('".$date[0]."',10) , parseInt('".($date[1]-1)."',10) , parseInt('".$date[2]."',10), parseInt('".$start[0]."',10) , parseInt('".$start[1]."',10)),end: new Date(parseInt('".$date_fin[0]."',10), parseInt('".($date_fin[1]-1)."',10), parseInt('".$date_fin[2]."',10), parseInt('".$end[0]."',10), parseInt('".$end[1]."',10)),$url allDay: false},";
				}
			$events=substr($events,0,strlen($events)-1);
			$events.=']';

			break;

			# AGENDA MySQL

			case 'mysql':

			# Récupère les style css

			$result = sql_select(array('id_style', 'bgcolor', 'textcolor', 'bordercolor'), 'spip_fullcalendar_styles', 'id_style', '', '');
			while ( $row = sql_fetch($result)){
				$style[$row['id_style']]['back'] = $row['bgcolor'];
				$style[$row['id_style']]['text'] = $row['textcolor'];
				$style[$row['id_style']]['bord'] = $row['bordercolor'];
			}
			sql_free($result);

			$events='events: [';

			$result = sql_select(array('titre', 'start', 'end', 'lien', 'id_style'), 'spip_fullcalendar_events', 'id_fullcalendar='.intval($id), '', 'start ASC');
			while ( $row = sql_fetch($result)){

				$date = explode('-',substr($row['start'],0,10));
				$date_fin = explode('-',substr($row['end'],0,10));
				$start = explode(':',substr($row['start'],11,5));
				$end = explode(':',substr($row['end'],11,5));

				if(strlen(trim($row['lien'])))
					$url="url:'".trim($row['lien'])."',";
				else
					$url='';

				if($row['id_style']>0){
					$class=",backgroundColor: '".$style[$row['id_style']]['back']."', textColor: '".$style[$row['id_style']]['text']."', borderColor: '".$style[$row['id_style']]['bord']."'";
				} else $class='';

				$events.="{title: '".texte_script($row['titre'])."',start: new Date(parseInt('".$date[0]."',10), parseInt('".($date[1]-1)."',10), parseInt('".$date[2]."',10), parseInt('".$start[0]."',10), parseInt('".$start[1]."',10)),end: new Date(parseInt('".$date_fin[0]."',10), parseInt('".($date_fin[1]-1)."',10), parseInt('".$date_fin[2]."',10), parseInt('".$end[0]."',10), parseInt('".$end[1]."',10)), $url allDay: false $class},";
			}
			sql_free($result);
			$events=substr($events,0,strlen($events)-1);
			$events.=']';
			break;

			# AGENDA GOOGLE

			case 'google':

			# Choppe la clé Google dans le seul évènement de cet agenda ...
			$result = sql_select('lien', 'spip_fullcalendar_events', 'id_fullcalendar='.intval($id));
			$row = sql_fetch($result);
			if(!strlen($row['lien'])) return;

			$URL_AGENDA = "http://www.google.com/calendar/feeds/".$row['lien']."/public/basic";

			$events = "events: $.fullCalendar.gcalFeed('".$URL_AGENDA."'),

			eventClick: function(event) {
			// opens events in a popup window
			window.open(event.url, 'gcalevent', 'width=700,height=600');
			return false;
			},

			loading: function(bool) {
				if (bool) {
					$('#loading').show();
				}else{
					$('#loading').hide();
				}
			}
			";

			break;
			default:
		}

		# Récupère les variable Paramètres / CFG

		$aspectRatio 				= "[(#ENV{aspectRatio,#CONFIG{fullcalendar/aspectRatio,'1.35'}}|texte_script)]";
		$useTheme 					= "[(#ENV{useTheme,#CONFIG{fullcalendar/useTheme,true}}|texte_script)]";
		$useTheme					= ($useTheme=='true')? 'theme: true,' : '' ;
		$weekends 					= "[(#ENV{weekends,#CONFIG{fullcalendar/miniweekends,false}}|texte_script)]";
		$defaultView 				= "[(#ENV{defaultView,#CONFIG{fullcalendar/defaultView,month}}|texte_script)]";

		$headerLeft 				= "[(#CONFIG{fullcalendar/miniheaderLeft, 'today'}|texte_script)]";
		$headerCenter 				= "[(#CONFIG{fullcalendar/miniheaderCenter, 'title'}|texte_script)]";
		$headerRight 				= "[(#CONFIG{fullcalendar/miniheaderRight, 'prev,next'}|texte_script)]";
		$firstDay					= "[(#CONFIG{fullcalendar/firstDay, '1'}|texte_script)]";
		$month_titleFormat 			= "[(#CONFIG{fullcalendar/minimonth_titleFormat, 'MMM yy'}|texte_script)]";
		$month_columnFormat 		= "[(#CONFIG{fullcalendar/minimonth_columnFormat, 'ddd'}|texte_script)]";
		$month_timeFormat 			= "[(#CONFIG{fullcalendar/minimonth_timeFormat, ''}|texte_script)]";
		#$week_titleFormat 			= "[(#CONFIG{fullcalendar/week_titleFormat, 'd [(#VAL{91}|chr)]MMMM[(#VAL{93}|chr)] [(#VAL{91}|chr)] yyyy[(#VAL{93}|chr)][(#VAL{123}|chr)]  -  d MMMM yyyy[(#VAL{125}|chr)]' }|texte_script)]";
		$week_titleFormat 			= "[(#CONFIG{fullcalendar/week_titleFormat, 'd MMMM  yyyy{  -  d MMMM yyyy}'}|texte_script)]";
		$week_columnFormat 			= "[(#CONFIG{fullcalendar/week_columnFormat, 'dddd d'}|texte_script)]";
		$week_timeFormat_basic	 	= "[(#CONFIG{fullcalendar/week_timeFormat_basic, 'H(:mm)'}|texte_script)]";
		$week_timeFormat_agenda 	= "[(#CONFIG{fullcalendar/week_timeFormat_agenda, 'H(:mm)'}|texte_script)]";
		$day_titleFormat 			= "[(#CONFIG{fullcalendar/day_titleFormat, 'dddd d MMMM yyyy'}|texte_script)]";
		$day_columnFormat			= "[(#CONFIG{fullcalendar/day_columnFormat, 'dddd d MMMM'}|texte_script)]";
		$day_timeFormat_basic 		= "[(#CONFIG{fullcalendar/day_timeFormat_basic, 'H:mm{ - H:mm}'}|texte_script)]";
		$day_timeFormat_agenda		= "[(#CONFIG{fullcalendar/day_timeFormat_agenda, 'H:mm{ - H:mm}'}|texte_script)]";

		$rand = rand(0,1000);

		# Génère le fullcalendar avec tous ses paramètres ...
		print "
		<script type='text/javascript'>
		$(document).ready(function() {
			if( ! $('#minicalendar".$rand."').data('fullcalendar_set') ) {
				$('#minicalendar".$rand."').fullCalendar({
					".$useTheme."
					firstDay: ".$firstDay.",
					defaultView: '".$defaultView."',
					aspectRatio: ".$aspectRatio.",
					header: { left: '".$headerLeft."', center: '".$headerCenter."', right: '".$headerRight."' },
					editable: false,
					allDayText: 'Journée',
					".$events.",
					weekends: ".$weekends.",
					titleFormat: {
						month: '".$month_titleFormat."',
						week: \"".$week_titleFormat."\",
						day: '".$day_titleFormat."'
					},
					columnFormat: {
						month: '".$month_columnFormat."',
						week: '".$week_columnFormat."',
						day: '".$day_columnFormat."'
					},
					timeFormat: {
						month:      \"".$month_timeFormat."\",
						agendaDay:  \"".$day_timeFormat_agenda."\",
						agendaWeek: \"".$week_timeFormat_agenda."\",
						basicWeek:  \"".$week_timeFormat_basic."\",
						basicDay:   \"".$day_timeFormat_basic."\",
						'': 'H(:mm)'
					},
					eventMouseover: function(event, jsEvent, view) {
						if (view.name !== 'agendaDay') {
							$(jsEvent.target).attr('title', event.title);
						}
					}
				});
			}
			$('#minicalendar".$rand."').data('fullcalendar_set', 1);

		});
		</script>

		<div id='minicalendar".$rand."' class='minicalendar'></div>

		";

	}
?>

<style type="text/css">
<!--
.minicalendar {
	width: #CONFIG{fullcalendar/mini_width, 200}px;
	margin: 0 auto;
	font-size: 10px;
}
.minicalendar .fc-header-title {
	font-size: #CONFIG{fullcalendar/mini_font, 1}em;
	padding-top:5px;
	white-space: normal !important;
}
.minicalendar .fc-view-month .fc-event, .fc-view-agendaWeek .fc-event {
	font-size: 0;
	overflow: hidden;
	height: 2px;
}
.minicalendar.fc-view-agendaWeek .fc-event-vert {
	font-size: 0;
	overflow: hidden;
	width: 2px !important;
}
.minicalendar .fc-agenda-axis {
	width: 20px !important;
	font-size: .7em;
}

.minicalendar .fc-button-content {
	padding: 0;
}
-->
</style>
