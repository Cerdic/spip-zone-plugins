#CACHE{0}
<!-- squelette catalogue/transaction.html -->
[(#REM) 
	On récupère le titre de la variante, la liste des options et le prix.
	Plutot que de passer ces variables en POST, on les passe en variables de session.

	L'objectif de ce squelette est donc d'initialiser un certain nombre de variables par des SET
	avant d'appeler l'article qui contient la fiche d'inscription
	
	On a fait une version simplifiée pour la fiche en une seule passe.
]

[(#REM) On récupère le numéro de la variante depuis le formulaire "fiche" ]
[(#SET{choix_variante, [(#EVAL{_request('id_variante')})]})]


[(#REM) On récupère le tabelau des options depuis le formulaire "fiche" ]
[(#SET{choix_options, [(#EVAL{_request('id_option')})]})]


[(#REM) On récupère les détails de la variante ]
<BOUCLE_v(VARIANTES){id_variante=#GET{choix_variante}}>

	[(#SESSION_SET{variante, #TITRE})]
	[(#SET{montant_variante, #PRIX_HT})]
	
	[(#REM) On récupère l'article parent de la variante ]
	<BOUCLE_a(ARTICLES){id_article}>
	[(#SESSION_SET{titre_formule, #TITRE})]
	</BOUCLE_a>
	</B_a>
		[(#REM) Si on ne trouve pas d'article attaché à cette variante... ]
		[(#SESSION_SET{titre_formule, <:catalogue:neant:>})]
	<//B_a>
	
	
</BOUCLE_v>
</B_v>
	[(#REM) Si on ne trouve pas de variante... ]
	[(#SESSION_SET{variante, <:catalogue:neant:>})]
	[(#SET{montant_variante, <:catalogue:neant:>})]
<//B_v>


[(#REM) Même calcul sur les options ]
<BOUCLE_options(POUR){tableau #GET{choix_options}}>
<BOUCLE_o(OPTIONS){id_option=#VALEUR}>
[(#SET{liste_options, 
	[(#GET{liste_options,''})]
	[(#_options:COMPTEUR_BOUCLE|!={1}|oui), ]
	[(#TITRE)]
})]
[(#SET{montant_options, 
	[(#EVAL{
		[(#GET{montant_options,0})]+[(#PRIX_HT|sinon{0})]
	})]
})]
</BOUCLE_o>
</BOUCLE_options>


[(#SESSION_SET{montant_total, [(#EVAL{[(#GET{montant_variante,0})]+[(#GET{montant_options,0})]})]})]
[(#SESSION_SET{liste_options, [(#GET{liste_options, <:catalogue:neant:>})]})]

[(#REM) Maintenant qu'on a toutes les variables, on appelle la fiche d'inscription... ]
[(#INCLURE{fond=article,id_article=79,env})]