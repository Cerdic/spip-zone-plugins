#CACHE{1}
#SET{virgule,","} [(#REM) utile pour les explodes]
<!--
*****Cahier de texte pour Spip: Bonbon !
*****Réalisé par Bertrand MARNE (bmarne à ac-creteil.fr)
*****Sous licence GPL (enfin bon, c'est bonbonware...)
*****CopyLeft en juin 2007
***Saisie du cahier de texte. Cette page prend des paramètres:
Par GET:
id_classex où x est un nombre= id du mot-clé de la classe x (il peut y avoir plusieurs classes
classes= nombres de classes associées à ces fiches
plusclasse= réafficher le formulaire avec un sélecteur de classe de plus
moinsclasse= réafficher le formulaire avec un sélecteur de classe en moins
id_matiere= id du mot-clé de la matière
id_groupe= id du groupe
classe_matière= quand la classe et la matière sont déterminées
id_article=contient un id_article que l'on veut dupliquer (ou modifier)
Par POST:
date_seance= date de la séance au format d/m/Y
contenu_seance= le texte du contenu de la séance
date_devoirx où x est un nombre= date du devoir n°x donné lors de la séance
contenu_devoirx où x est un nombre= contenu du devoir n°x donné lors de la séance
devoirs= nombre de devoirs-1 liés à la séance
plusdate= rafficher le formulaire avec un champs devoirs+date en plus.
doc_seance_XXX= où XXX est un id_doc. quand on duplique une séance les docs d'id_documents=XXX où doc_seance_XXX est défini sont conservés, les autres enlevés.
doc_devoirXXX_YYY= où YYY est un id_doc. XXX est le n° du devoir concerné (pas son ID). quand on duplique une séance les docs d'id_documents=YYY où doc_devoirXXX_YYY est défini sont conservés, les autres enlevés.

enregistrer_fiche= quand la fiche est validée
modifier_fiche= quand la fiche est remplie, mais que le contenu doit être modifié
effacer_fiche=quand la fiche doit être effacée. Les devoirs le seront aussi !
-->

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<title>#NOM_SITE_SPIP: Saisie dans le cahier de texte en ligne</title>

[(#REM)Inclusion du pied de page]
<INCLURE{fond=cahier-de-texte-en-tete}>

</head>
<body>
<div id="NoMenu">
	<div id="EntetePage">
			<ul class="boutons">
				<li><a href="#URL_PAGE{cahier-de-texte-accueil}" title="Retourner à la page d'accueil du cahier de texte"><img src="#CHEMIN{images/dialog-ok-upside-down.png}" alt="icône" vspace="2" align="middle">Accueil du cahier de texte</a></li>
				<li><a href="#URL_PAGE{cahier-de-texte-affichage,nb=20}"><img src="#CHEMIN{images/system-search.png}" alt="icône" vspace="2" align="middle">Afficher les 20 dernières séances</a></li>
<?php if ($auteur_session) {?>
				<li><a href="#URL_PAGE{cahier-de-texte-saisie}&id_auteur=<?php echo $auteur_session['id_auteur']; ?>" title="Écrire le contenu d'une séance et ses devoirs éventuels"><img src="#CHEMIN{images/accessories-text-editor.png}" alt="icône" vspace="2" align="middle">Saisir une séance</a></li>
				<li><a href="#URL_PAGE{cahier-de-texte-affichage,senschrono=1}&id_auteur=<?php echo $auteur_session['id_auteur']; ?>" title="Aller voir ses propres entrées du cahier de texte"><img src="#CHEMIN{images/edit-find.png}" alt="icône" vspace="2" align="middle">Afficher ses séances</a></li>
<?php }// fin du if auteur session ?>
			</ul>
[(#REM)Vérification de l'authentification]
<?php if ($auteur_session) {
//paramètres de session utilisés:
	$auteur=$auteur_session['nom'];
	$id_auteur=$auteur_session['id_auteur'];
	echo "<p class='authentifie'>$auteur (si vous n'êtes pas $auteur, <a href=\"";
?>#URL_LOGOUT<?php
	echo "\" title=\"déconnexion immédiate !\">cliquez ici</a>)</p>\n";

//------------------------------------------------------------
//Dans tous les cas, on récupère les paramètres du formulaire:
//------------------------------------------------------------

//récupération des paramettres (GET et POST)
	//echo "liste des GET\n";
	//print_r($_GET);
	//echo "liste des POST\n";
	//print_r($_POST);
	$id_article=($_GET['id_article']);
	$classes=($_GET['classes']);
	for ($count=0; $count<=$classes; $count++) {
		$id_classe[$count]=($_GET["id_classe$count"]);
	};//les classes ont été placées dans le tableau $id_classe[]
	$id_groupe=($_GET["id_groupe"]);
	$id_matiere=($_GET["id_matiere"]);

	$date_seance=(stripslashes($_POST['date_seance']));
	$contenu_seance=(stripslashes(html_entity_decode($_POST['contenu_seance'])));
	$devoirs=($_POST['devoirs']);
	for ($count=0; $count<=$devoirs; $count++) {
		$date_devoir[$count]=($_POST["date_devoir$count"]);
		$contenu_devoir[$count]=(stripslashes(html_entity_decode($_POST["contenu_devoir$count"])));
	};//les dates ont été placées dans $date_devoir[], les contenus dans $contenu_devoir[]

//Si le id_matière n'est pas défini, on essaie d'aider un peu en le prédéfinissant... C'est tj qq sec de gagnées pour le prof qui saisis.

	if ((!$id_matiere) and ($_GET['id_auteur']==$auteur_session['id_auteur'])) { ?>
		<BOUCLE_TrouveMatiere_auteur(ARTICLES){titre_mot="Description de séance"}{id_auteur=#ENV{id_auteur}}{!par date}{0,1}><BOUCLE_TrouveMot_Matiere(MOTS){id_article}{type=Matières}><?php $id_matiere='[(#ID_MOT|texte_script)]';?></BOUCLE_TrouveMot_Matiere></BOUCLE_TrouveMatiere_auteur>
	<?php };// fin du if pas id_matiere et id_auteur

//si on demande à dupliquer ou modifier un article: on récupère les données de l'article (si elles ne sont pas déjà présentes en GET)
	if (!$id_classe[0] and $id_article and !$_POST['enregistrer_fiche'] and !$_POST['modifier_fiche'] and !$_POST['valider_fiche']) {
		$count=-1;
?>
<BOUCLE_TrouveClasses_id_article(MOTS){id_article}{type=Classes}><?php
		$count++;
		$id_classe[$count]='[(#ID_MOT|texte_script)]';
?></BOUCLE_TrouveClasses_id_article>
		<?php $classes=$count; ?>
<BOUCLE_TrouveGroupe_id_article(MOTS){id_article}{type=Sous groupes de classes}><?php
		$id_groupe='[(#ID_MOT|texte_script)]';
?></BOUCLE_TrouveGroupe_id_article>
<BOUCLE_TrouveMatiere_id_article(MOTS){id_article}{type=Matières}><?php
		$id_matiere='[(#ID_MOT|texte_script)]';
?></BOUCLE_TrouveMatiere_id_article>
<?php
	}//fin du not classe0 et if id_article

//si on demande à dupliquer ou modifier un article *et qu'on a choisi classe et matière*: on récupère les données de l'article

	if (($_GET['classe_matiere'] or $_GET['effacer_fiche']) and $id_article){ //si la matière est validée on récupère le contenu de la séance
?>
<BOUCLE_Trouve_Infos_Seance_id_article(ARTICLES){id_article}>[

(#REM) On récupère la liste des documents liés à l'article

		]<BOUCLE_Documents_originaux_Seances(DOCUMENTS){id_article}>[(#SET{liste_docs_seance,#GET{liste_docs_seance}|bonbon_fusion_tableau{#ARRAY{#COMPTEUR_BOUCLE,#ID_DOCUMENT}}})]</BOUCLE_Documents_originaux_Seances>[

(#REM) On récupère dans le surtitre la liste des documents qui ont été copié dans cette séance (quand on veut ajouter des documents sans les remettre sur le serveur

		][(#SET{liste_docs_copies_seance,[(#GET{virgule}|explode{[(#SURTITRE*|bonbon_matches_id_document)]})]})]
		<BOUCLE_Copies_Documents_Seances(DOCUMENTS){id_document IN #GET{liste_docs_copies_seance}}>[(#SET{liste_docs_seance,#GET{liste_docs_seance}|bonbon_fusion_tableau{#ARRAY{#COMPTEUR_BOUCLE,#ID_DOCUMENT}}})]</BOUCLE_Copies_Documents_Seances><?php
		
		if (!$_POST['enregistrer_fiche'] and !$_POST['modifier_fiche'] and !$_POST['valider_fiche']) {
			//les autres infos sur la séance (seulement s'il n'y a pas eu potientiellement des modifs !): 
			$date_seance='[(#DATE|affdate{d/m/Y}|texte_script)]';
			$contenu_seance='[(#TEXTE*|texte_script)]';
		}
		$devoirs=-1;?>
	<BOUCLE_Trouve_Infos_Devoirs_id_article(ARTICLES){titre_mot="Devoirs à faire"}{ps==#ENV{id_article}}><?php
		$devoirs++;
		$compteur_doc_devoirs=0;
		$liste_docs_Devoirs="";?>[

(#REM) On récupère la liste des documents liés à l'article

		]<BOUCLE_Documents_originaux_Devoirs(DOCUMENTS){id_article}><?php
			$compteur_doc_devoirs++;
			$liste_docs_Devoirs[$compteur_doc_devoirs]='[(#ID_DOCUMENT)]'; ?>[(#SET{liste_docs_devoirs,#GET{liste_docs_devoirs}|bonbon_fusion_tableau{#ARRAY{#COMPTEUR_BOUCLE,#ID_DOCUMENT}}})]</BOUCLE_Documents_originaux_Devoirs>[

(#REM) On récupère dans le surtitre la liste des documents qui ont été copié dans cette séance (quand on veut ajouter des documents sans les remettre sur le serveur

		][(#SET{liste_docs_copies_Devoirs,[(#GET{virgule}|explode{[(#SURTITRE*|bonbon_matches_id_document)]})]})]
		<BOUCLE_Copies_Documents_Devoirs(DOCUMENTS){id_document IN #GET{liste_docs_copies_Devoirs}}><?php
			$compteur_doc_devoirs++;
			$liste_docs_Devoirs[$compteur_doc_devoirs]='[(#ID_DOCUMENT)]'; ?>[(#SET{liste_docs_devoirs,#GET{liste_docs_devoirs}|bonbon_fusion_tableau{#ARRAY{#COMPTEUR_BOUCLE,#ID_DOCUMENT}}})]</BOUCLE_Copies_Documents_Devoirs>[
(#REM) On met dans un tableau la liste des devoirs		
		]<?php
		$liste_des_listes_de_docs[$devoirs] = $liste_docs_Devoirs;

		if (!$_POST['enregistrer_fiche'] and !$_POST['modifier_fiche'] and !$_POST['valider_fiche']) {

			//les autres infos sur le devoir (seulement s'il n'y a pas eu potientiellement des modifs !): 
			$date_devoir[$devoirs]='[(#DATE|affdate{d/m/Y}|texte_script)]';
			$contenu_devoir[$devoirs]='[(#TEXTE*|texte_script)]';
			$id_devoirs[$devoirs]='[(#ID_ARTICLE|texte_script)]';
		}
	?></BOUCLE_Trouve_Infos_Devoirs_id_article>
</BOUCLE_Trouve_Infos_Seance_id_article>
<?php
		if ($devoirs==-1) $devoirs="";
	}//fin du if classe_matiere and id_article


//boutons qui ont été pressés pour ajouter des options
//une classe de plus ?
	if($_GET['plusclasse']){
		$classes++;
	};
//une classe de moins ? (la dernière choisie)
	if($_GET['moinsclasse']){
		$classes--;
	};
	if($_POST['plusdate']){
		$devoirs++;
	};

//quelques strings bien utiles préparées à l'avance: (à partir des numéros d'id)
	if ($_POST['enregistrer_fiche'] or $_POST['valider_fiche'] or $_GET['classe_matiere'] or $_GET['effacer_fiche']) {
?>
[(#REM)Nom de la matière]
<BOUCLE_DireMatiere(MOTS){type="Matières"}><?php if ('[(#ID_MOT|texte_script)]'==$id_matiere) {$matiere_titre='[(#TITRE)]';} ?></BOUCLE_DireMatiere>
<?php $premiere_classe="";
for ($count=0; $count<=$classes; $count++) {?>
[(#REM)Nom de la ou les classes]
<BOUCLE_DireClasse(MOTS){type="Classes"}><?php if ('[(#ID_MOT|texte_script)]'==$id_classe[$count]) { $classes_titre .='[(#TITRE)]'; if (($count+1)<=$classes) $classes_titre .= ", "; if (!$premiere_classe) $premiere_classe='[(#TITRE)]'; } ?></BOUCLE_DireClasse>
<?php } //fin du for count classes
if ($id_groupe!=0) { $groupe_titre .= " (";?>
[(#REM)Nom du groupe s'il y a... Il est encadré par une parenthèse]
<BOUCLE_DireGroupe(MOTS){type="Sous groupes de classes"}><?php if ('[(#ID_MOT|texte_script)]'==$id_groupe) { $groupe_titre .='[(#TITRE)]'; } ?></BOUCLE_DireGroupe>
<?php $groupe_titre .= ")"; }//fin du if id_groupe?>
<?php
	$titre_matiere_classe="en $matiere_titre avec les $classes_titre$groupe_titre&nbsp;:";
	$titre_contenu_seance="Le $date_seance, $titre_matiere_classe";
	$fragment_titre_devoir=", par les $classes_titre$groupe_titre en $matiere_titre&nbsp;:";
	$fleche="->";
	}

//----------------------------------------------------------------------
//Si l'utilisateur veut effacer une fiche  dans la base (c'est confirmé)
//----------------------------------------------------------------------
	if ($_GET['effacer_fiche'] and ($_GET['effacer_fiche']!="a_confirmer")){
		$liste_des_id_a_jetter[0]=$id_article;
		$nb_trucs_a_jeter=$devoirs+1;
		for ($count=1; $count<=$nb_trucs_a_jeter; $count++) {
			$liste_des_id_a_jetter[$count]=$id_devoirs[$count-1];
		};
		for ($count=0; $count<=$nb_trucs_a_jeter; $count++) {
			//l'article et les devoirs sont mis à la poubelle
			$sql ="UPDATE spip_articles SET statut='poubelle' WHERE id_article=$liste_des_id_a_jetter[$count]";
			$result = spip_query($sql);
			echo ("<!--update ps: $result-->\n");
		}
?>
	<h1>La fiche est définitivement effacée</h1>
			<br class="clear" />	
	</div>
	<div id="Contenu"><div class="bloc">
			<p><strong>Ne revenez pas en arrière, mais choisissez&nbsp;:</strong></p>
			<p><a href="[(#URL_PAGE{cahier-de-texte-saisie})]<?php
	echo ("&id_matiere=$id_matiere");
	for ($count=0; $count<=$classes; $count++) {
		echo("&id_classe$count=".$id_classe[$count]);
	};
	if ($classes>0) echo ("&classes=$classes");
			?>" title="Écrire le contenu d'une séance et ses devoirs éventuels"><img src="#CHEMIN{images/accessories-text-editor.png}" alt="icône" vspace="2" align="middle">Saisir une autre fiche</a>&nbsp;| <a href="#URL_PAGE{cahier-de-texte-affichage,senschrono=1}&id_auteur=<?php echo($auteur_session['id_auteur']);?>" title="Afficher les séances que l'on a déjà saisies"><img src="#CHEMIN{images/edit-find.png}" alt="icône" vspace="2" align="middle">Afficher ses séances</a>&nbsp;|<a href="[(#URL_PAGE{cahier-de-texte-accueil})]" title="retour à l'accueil"><img src="#CHEMIN{images/logo-mini2-22.png}" alt="icône" vspace="2" align="middle">Retourner à l'accueil</a></p>
		</div>
	</div></div>

[(#REM)Inclusion du pied de page]
<INCLURE{fond=cahier-de-texte-pied}>

</div>
</body>
</html>
<?php	break;
	}; //fin du if effacer fiche sans que ce soit "à confirmer"


//------------------------------------------------------------------------------
//Si l'utilisateur a écrit une fiche puis validée ou s'il veut effacer une fiche
//------------------------------------------------------------------------------

//Si la fiche est enregistrée (enregistrée mais non à modifier)
	if (($_GET['effacer_fiche']=="a_confirmer") or ($_POST['enregistrer_fiche'] and !($_POST['modifier_fiche']))){
//On l'affiche pour vérification...
//todo: afficher avec la CSS Spip
?>
	<h1>Voici la fiche que vous <?php
		if ($_GET['effacer_fiche']) {echo "voulez effacer";}
		else {
			echo "avez "; 
			if ($id_article) {echo "dupliquée";}
			 else {echo "remplie";};
		}
?>&nbsp;:</h1>
			<br class="clear" />	
	</div>
	<div id="Contenu"><div class="bloc">
		<div id="documents">
			<h3 class="titre"><?php echo $titre_contenu_seance?></h3>
			<div class="texte"><?php echo propre($contenu_seance);?></div>[

(#REM) Si la séance est dupliquée/Modifiée, on affiche les documents qui sont liés à la séance...

]
<BOUCLE_On_Affiche_les_Docs_seance_dupliquee_verif(ARTICLES){id_article}>[

(#REM) On affiche les documents liés à la séance

		]<B_Documents_Seances_verif>
			<div class="documents-seance">
				<h4 class="documents-seance"><b>>></b>&nbsp;Documents déjà joints à la séance&nbsp;:</h4>
		<BOUCLE_Documents_Seances_verif(DOCUMENTS){id_document IN #GET{liste_docs_seance}}{"&nbsp;| "}{par titre}>
				<?php if ($_POST['doc_seance_'.'[(#ID_DOCUMENT)]']) {?><a href="#URL_DOCUMENT">[(#LOGO_DOCUMENT||image_reduire{22,22})]&nbsp;[(#TITRE|sinon{#FICHIER|basename})] (<em>#TYPE_DOCUMENT</em> de [(#TAILLE|taille_en_octets)])</a>
				<?php }// fin du if le document est conservé?>
		</BOUCLE_Documents_Seances_verif>
			</div>
		</B_Documents_Seances_verif>
</BOUCLE_On_Affiche_les_Docs_seance_dupliquee_verif>
<?php //si il y a des devoirs
if ($contenu_devoir[0]!="") {
?>
			<hr>
			<div>
				<h4 class="devoirs">Devoirs des<?php echo(" $classes_titre$groupe_titre&nbsp;:")?></h4>
<?php //Pour chaque devoir:
 for ($count=0; $count<=$devoirs; $count++) {
	$liste_docs_Devoir = $liste_des_listes_de_docs[$count]; ?>
				<div class="devoirs"><h5 class="devoirs"><b>>></b>&nbsp;Devoir pour le <?php echo $date_devoir[$count]?>&nbsp;:</h5>
				<span><?php echo propre($contenu_devoir[$count]);?></span>[

(#REM) Si la fiche est dupliquée/Modifiée, on affiche les documents qui sont liés au devoir...

		]<B_Documents_Devoir_verif><?php
			if ($liste_docs_Devoir) {?>
			<div class="documents-seance">
				<b>>>></b>&nbsp;Documents déjà joints à ce devoir&nbsp;:
			<?php } //fin du if liste_docs_Devoir ?>
		<BOUCLE_Documents_Devoir_verif(DOCUMENTS){id_document IN #GET{liste_docs_devoirs}}{par titre}><?php
//On vérifie parmis les docs liés aux (tous) devoirs de la fiche qu'ils correspondent au devoir: on vérifie que l'id_document est bien dans le tableau des docs liés à ce devoir.
				reset($liste_docs_Devoir);
				$ok=false;
				while(list ($key, $val) = each ($liste_docs_Devoir)) {
					if ($val=='[(#ID_DOCUMENT)]') $ok="ok";
				}
				if ($ok) {
					 if ($_POST['doc_devoir'.$count.'_'.'[(#ID_DOCUMENT)]']) { ?><a href="#URL_DOCUMENT">[(#LOGO_DOCUMENT||image_reduire{22,22})]&nbsp;[(#TITRE|sinon{#FICHIER|basename})] (<em>#TYPE_DOCUMENT</em> de [(#TAILLE|taille_en_octets)])</a>&nbsp;| 
					<?php }//fin du if doc_devoirXXX_YYY ?>
				<?php } //fin du if liste_docs_Devoir ?>
		</BOUCLE_Documents_Devoir_verif><?php
			if ($liste_docs_Devoir) {?>
			</div>
			<?php } //fin du if liste_docs_Devoir ?>
		</B_Documents_Devoir_verif>
		</div><br />
<?php } //fin du for count devoirs?>
			</div>
<?php } //fin du if contenu_devoir?>
		</div>
	<div><?php
//Si l'utilisateur veut modifier la fiche (pas l'effacer)
	if (!$_GET['effacer_fiche']) {?>
	<form name="modifier" method="post">
<?php
//préparation du formulaire
//on récupère tous les paramètres et on les remet dans le formulaire en POST cachés
		$post=$_POST;
		while (list($key,$val)=each($post)) {
			if ($key!="enregistrer_fiche") {
?>
		<input type="Hidden" <?php echo 'name="'.$key.'" value="'.htmlentities($val).'"'; ?>>
<?php			}//fin du if key
		}//fin du while $key $val?>
	<!--Modifier la fiche -->
		<input type="Submit" name="modifier_fiche" value="Modifier la fiche">
		<input type="Submit" name="valider_fiche" value="Confirmer l'enregistrement de la fiche (elle ne sera plus modifiée)">
	</form>
<?php	} //fin du if not effacer fiche
// L'utilisateur veut effacer la fiche, on lui demande confirmation
	else {?>
	<form name="effacer" method="get">
		<input type="hidden" name="page" value="cahier-de-texte-saisie">
		<input type="hidden" name="id_article" value="#ENV{id_article}">
		<input type="Submit" name="effacer_fiche" value="Confirmer l'effacement de la fiche ci-dessus (c'est définitif !)">
	</form>
<?php	} //fin du else if not effacer fiche (donc du if effacer fiche)
?>
	
<?php
} //fin du if enregistrer ficher et pas modifier fiche
	else {

//------------------------------------------------------------------
//L'utilisateur veut enregistrer la fiche défintivement dans la base
//------------------------------------------------------------------

	if ($_POST['valider_fiche']) {
?>[
(#REM) année scolaire
][
	(#SET{annee_scolaire,[(#ENV{date}|bonbon_annee_scolaire)]})

]<BOUCLE_Contexte_RubriqueCDT(RUBRIQUES){titre=="Cahier de texte en-ligne"}{0,1}>[
(#REM)Vérifier si il existe déjà une sous rubrique du cahier de texte pour l'année en cours
	]<BOUCLE_Verifie_RubriqueAnnee(RUBRIQUES){id_parent}{titre=#GET{annee_scolaire}}{0,1}><?php
		$id_rub_cdt='[(#ID_RUBRIQUE|texte_script)]'; //id_rub_cdt contient l'id de la sous-rubrique pour l'année en cours
?></BOUCLE_Verifie_RubriqueAnnee></B_Verifie_RubriqueAnnee>[
	
	(#SET{descriptif_rubrique,"Cahier de texte de l'année scolaire "})
][
	(#SET{descriptif_rubrique,[(#GET{descriptif_rubrique}|concat{#GET{annee_scolaire},"\n\n{{Cette rubrique ne doit pas être renommée}}. Sinon, les enregistrements du cahier de texte de l'année en cours seront perdus"})]})
]<?php
//Si la rubrique pour l'année en cours n'existe pas, on la crée !
		$sql = "INSERT INTO spip_rubriques (titre, id_parent, descriptif , statut, date) 
		VALUES ('[(#GET{annee_scolaire}|texte_script)]','[(#_Contexte_RubriqueCDT:ID_RUBRIQUE|texte_script)]','[(#GET{descriptif_rubrique}|texte_script)]', 'publie',NOW())";
	
		$result = spip_query($sql);
		$id_rubrique=spip_insert_id();
		$id_rub_cdt=$id_rubrique;
?>
		la sous-rubrique #GET{annee_scolaire} a été créée pour gérer le cahier de texte de cette année scolaire. Ne l'effacez pas, ne la renommez pas et laissez la dans la rubrique Cahier de texte !
	<//B_Verifie_RubriqueAnnee>
</BOUCLE_Contexte_RubriqueCDT>
			<h1>La fiche <?php if ($id_article) {echo "dupliquée ";}; ?>est définitivement enregistrée&nbsp;:</h1>
			<br class="clear" />	
	</div>
	<div id="Contenu"><div class="bloc">[

(#REM) Si la séance est dupliquée/Modifiée, on enregistre dans le surtitre les documents qui sont liés à la séance...

]
<BOUCLE_On_Affiche_les_Docs_seance_dupliquee_enregistrement(ARTICLES){id_article}>[

(#REM) On récupère dans le surtitre les documents de la liste

		]<BOUCLE_Documents_Seances_enregistrement(DOCUMENTS){id_document IN #GET{liste_docs_seance}}{par titre}>
				<?php
			if ($_POST['doc_seance_'.'[(#ID_DOCUMENT)]']) {
				$surtitre_avec_docs = $surtitre_avec_docs."<doc".'[(#ID_DOCUMENT)]'."> ";
			}// fin du if le document est conservé?>
		</BOUCLE_Documents_Seances_enregistrement>
</BOUCLE_On_Affiche_les_Docs_seance_dupliquee_enregistrement>
<?php

//insertion de l'article du contenu du cours dans la base

//On prépare la date:
	$date_base_seance = date ("Y-m-d H:i:s", mktime(0,0,0,substr($date_seance,3,2),substr($date_seance,0,2),substr($date_seance,6,4)));

//le contenu
	$sql = "INSERT INTO spip_articles (titre, texte, id_rubrique, statut, date, surtitre) 
	VALUES ('".addslashes($titre_contenu_seance)."','".addslashes($contenu_seance)."','$id_rub_cdt', 'publie', '".addslashes($date_base_seance)."','".addslashes($surtitre_avec_docs)."')";
	
	$result = spip_query($sql);
	$id_contenu_seance=spip_insert_id();
	echo ("<!--$result article n°$id_contenu_seance-->\n");
	
	// auteur
	$sql = "INSERT INTO spip_auteurs_articles (id_auteur, id_article) VALUES (" . $id_auteur . ", " . $id_contenu_seance . ")";
	$result = spip_query($sql);
	echo ("<!--auteur: $result-->\n");
//ajout des mots-clés
	//le mot-clé qui définit que c'est le contenu d'une séance
	//d'abord on récupère son id:?>
<BOUCLE_Dire_id_mot_contenu(MOTS){titre="Description de séance"}><?php $id_identif_contenu='[(#ID_MOT)]'?></BOUCLE_Dire_id_mot_contenu>
<?php	//Puis on associe le mot à l'article
	$sql = "INSERT INTO spip_mots_articles (id_mot, id_article) VALUES (" . $id_identif_contenu . ", " . $id_contenu_seance . ")";
		$result = spip_query($sql);
		echo ("<!--identifiant de l'article: $result-->\n");
	//les classes
	for ($count=0; $count<=$classes; $count++) {
		$sql = "INSERT INTO spip_mots_articles (id_mot, id_article) VALUES (" . $id_classe[$count] . ", " . $id_contenu_seance . ")";
		$result = spip_query($sql);
		echo ("<!--classe: $result-->\n");
	}
	//le groupe éventuel:
	if ($id_groupe!=0) {
		$sql = "INSERT INTO spip_mots_articles (id_mot, id_article) VALUES (" . $id_groupe . ", " . $id_contenu_seance . ")";
		$result = spip_query($sql);
		echo ("<!--groupe: $result-->\n");
	}
	//la matière:
	$sql = "INSERT INTO spip_mots_articles (id_mot, id_article) VALUES (" . $id_matiere . ", " . $id_contenu_seance . ")";
	$result = spip_query($sql);
	echo ("<!--matière: $result-->\n<p>La séance est enregistrée...</p>\n");

//insertion des articles de devoirs s'il y a

if ($contenu_devoir[0]!="") {
	$liste_devoirs_contenu ="{{Devoirs donnés:}}\n\n";
	//d'abord on récupère l'id du mot-clé qui désigne les devoirs:?>
	<BOUCLE_Dire_id_mot_devoir(MOTS){titre="Devoirs à faire"}><?php $id_identif_devoir='[(#ID_MOT)]'?></BOUCLE_Dire_id_mot_devoir>
	<?php
	//Puis pour chaque devoir:
	for ($count=0; $count<=$devoirs; $count++) {
		$liste_docs_Devoir = $liste_des_listes_de_docs[$count];
		$surtitre_avec_docs="";?>[

(#REM) Si la fiche est dupliquée/Modifiée, on enregistre dans le surtitre les documents qui sont liés au devoir...

		]<BOUCLE_Documents_Devoir_enregistrement(DOCUMENTS){id_document IN #GET{liste_docs_devoirs}}{par titre}><?php
//On vérifie parmis les docs liés aux (tous) devoirs de la fiche qu'ils correspondent au devoir: on vérifie que l'id_document est bien dans le tableau des docs liés à ce devoir.
				reset($liste_docs_Devoir);
				$ok=false;
				while(list ($key, $val) = each ($liste_docs_Devoir)) {
					if ($val=='[(#ID_DOCUMENT)]') $ok="ok";
				}
				if ($ok) {
					 if ($_POST['doc_devoir'.$count.'_'.'[(#ID_DOCUMENT)]']) { 
						$surtitre_avec_docs = $surtitre_avec_docs."<doc".'[(#ID_DOCUMENT)]'."> ";
					 }//fin du if doc_devoirXXX_YYY ?>
				<?php } //fin du if liste_docs_Devoir ?>
		</BOUCLE_Documents_Devoir_enregistrement><?php
		//détermine la date au format de la base
		$date_base_devoir = date ("Y-m-d H:i:s", mktime(0,0,0,substr($date_devoir[$count],3,2),substr($date_devoir[$count],0,2),substr($date_devoir[$count],6,4)));
		//insère le devoir avec titre, contenu, date et surtout un PS qui renvoie au contenu
		$sql = "INSERT INTO spip_articles (titre, texte, id_rubrique, statut, date, ps, surtitre) 
		VALUES ('".addslashes("Devoir à faire pour le $date_devoir[$count]$fragment_titre_devoir")."','".addslashes($contenu_devoir[$count])."','$id_rub_cdt', 'publie', '".addslashes($date_base_devoir)."','".addslashes("[Donné $titre_contenu_seance$fleche$id_contenu_seance]")."','".addslashes($surtitre_avec_docs)."')";
		
		$result = spip_query($sql);
		$id_contenu_devoir[$count]=spip_insert_id();
		echo ("<!--$result article n°$id_contenu_devoir[$count]-->\n");

		
		//devoir n°
		$dev_no=$count+1;
		//préparation de la chaîne à inclure dans le contenu:
		$liste_devoirs_contenu .= "- [Devoir n°$dev_no pour le $date_devoir[$count]$fleche$id_contenu_devoir[$count]]\n";
		
		// auteur
		$sql = "INSERT INTO spip_auteurs_articles (id_auteur, id_article) VALUES (" . $id_auteur . ", " . $id_contenu_devoir[$count] . ")";
		$result = spip_query($sql);
		echo ("<!--auteur: $result-->\n");
		//ajout des mots-clés
		//le mot-clé qui définit que c'est le contenu d'une séance
		//Puis on associe le mot à l'article
		$sql = "INSERT INTO spip_mots_articles (id_mot, id_article) VALUES (" . $id_identif_devoir . ", " . $id_contenu_devoir[$count] . ")";
			$result = spip_query($sql);
			echo ("<!--identifiant de l'article: $result-->\n");
		//les classes
		for ($countc=0; $countc<=$classes; $countc++) {
			$sql = "INSERT INTO spip_mots_articles (id_mot, id_article) VALUES (" . $id_classe[$countc] . ", " . $id_contenu_devoir[$count] . ")";
			$result = spip_query($sql);
			echo ("<!--classe: $result-->\n");
		}
		//le groupe éventuel:
		if ($id_groupe!=0) {
			$sql = "INSERT INTO spip_mots_articles (id_mot, id_article) VALUES (" . $id_groupe . ", " . $id_contenu_devoir[$count] . ")";
			$result = spip_query($sql);
			echo ("<!--groupe: $result-->\n");
		}
		//la matière:
		$sql = "INSERT INTO spip_mots_articles (id_mot, id_article) VALUES (" . $id_matiere . ", " . $id_contenu_devoir[$count] . ")";
		$result = spip_query($sql);
		echo ("<!--matière: $result-->\n<p>Enregistrement du devoir n°$dev_no</p>\n");
	}//fin du for chaque devoir
	echo ("<p>Devoirs enregistrés...</p>\n");
} //fin du if contenu_devoir

//rajout des références aux devoirs dans le PS du contenu de la séance
		$sql ="UPDATE spip_articles SET ps='".addslashes($liste_devoirs_contenu)."' WHERE id_article=$id_contenu_seance";
		$result = spip_query($sql);
		echo ("<!--update ps: $result-->\n");
?>
			<p><strong>Ne revenez pas en arrière, mais choisissez&nbsp;:</strong></p>
			<p><a href="#URL_PAGE{cahier-de-texte-affichage-seance,var_mode=recalcul}&id_article=<?php echo ($id_contenu_seance); ?>" title="visualiser et ajouter des documents joints à cette séance ou ses devoirs" onClick="javascript:window.open(this.href,'affichage', 'scrollbars=yes, resizable=yes, width=740, height=580'); return false;">
					<img src="#CHEMIN{images/x-office-spreadsheet.png}" alt="icône" vspace="2" align="middle">
				Visualiser et/ou ajouter des documents à cette séance et ses devoirs
				</a></p>
			<p><a href="#URL_PAGE{cahier-de-texte-saisie}&id_article=<?php echo ($id_contenu_seance); ?>" title="Faire une copie de la séance que vous venez de saisir, pour une autre classe/groupe"><img src="#CHEMIN{images/go-jump.png}" alt="icône" vspace="2" align="middle">Dupliquer la séance pour une autre classe/groupe</a>&nbsp;| <a href="#URL_PAGE{cahier-de-texte-saisie}<?php
	echo ("&id_matiere=$id_matiere");
	for ($count=0; $count<=$classes; $count++) {
		echo("&id_classe$count=".$id_classe[$count]);
	};
	if ($classes>0) echo ("&classes=$classes");
			?>" title="Écrire le contenu d'une séance et ses devoirs éventuels"><img src="#CHEMIN{images/accessories-text-editor.png}" alt="icône" vspace="2" align="middle">Saisir une autre fiche</a>&nbsp;| <a href="#URL_PAGE{cahier-de-texte-affichage,senschrono=1}&id_auteur=<?php echo($auteur_session['id_auteur']);?>&classe=<?php echo($premiere_classe); ?>&matiere=<?php echo($matiere_titre);?>" title="Afficher les séances que l'on a déjà saisies"><img src="#CHEMIN{images/edit-find.png}" alt="icône" vspace="2" align="middle">Afficher ses séances</a>&nbsp;|<a href="#URL_PAGE{cahier-de-texte-accueil}" title="retour à l'accueil"><img src="#CHEMIN{images/logo-mini2-22.png}" alt="icône" vspace="2" align="middle">Retourner à l'accueil</a></p>
		</div>		
	</div></div>

[(#REM)Inclusion du pied de page]
<INCLURE{fond=cahier-de-texte-pied}>

</div>
</body>
</html>
<?php
break;}// Fin du if valider fiche

//---------------------------------------------------
//L'utilisateur veut remplir une fiche ou la modifier
//---------------------------------------------------

//--------------------------------
//Primo: remplir classe et matière
//--------------------------------

?>
	<h1><?php if ($id_article) {echo "Modifier";} else {echo "Remplir";}; ?> une fiche du cahier de texte</h1>
		<h2><?php echo($titre_matiere_classe);?></h2>
			<br class="clear" />	
	</div>
	<div id="Contenu"><div class="bloc"><div class="moyen-bloc">
<?php
if(!$_GET['classe_matiere']){
?>
	<!--Selecteur de classe et matière-->
		<form name="classe_matiere" method="get">
		<input type="hidden" name="page" value="cahier-de-texte-saisie">
<?php	if ($id_article) echo "<input type=\"hidden\" name=\"id_article\" value=\"$id_article\">";?>
		<fieldset>
			<legend><?php if ($id_article) {echo "Modifier ";}; ?>Classe<?php if ($classes>0) echo "s"?>&nbsp;:</legend>
<?php //Une ou plusieurs classes
if ($classes>0) echo ("Regroupement de classes&nbsp;:");
for ($count=0; $count<=$classes; $count++) {
?>
			<select id="classe<?php echo $count;?>" name="id_classe<?php echo $count;?>" size="1">
[(#REM)On extrait toutes les classes de Spip]
<BOUCLE_ToutesLesClasses(MOTS){type="Classes"}{par titre}>
				<option value="#ID_MOT"<?php if ($id_classe[$count]=='[(#ID_MOT|texte_script)]') echo " selected=selected";?>>#TITRE</option>
</BOUCLE_ToutesLesClasses>
			</select>
<?php } //fin du for count classes

//S'il y a plus d'une classe:

if ($classes>0) {
?>
			<input type="Submit" value="Retirer une classe" name="moinsclasse">
<?php } //fin du if classe?>

			<input type="hidden" name="classes" value="<?php echo $classes;?>">
			<input type="Submit" value="Rajouter une classe" name="plusclasse">
			Groupe&nbsp;:<select id="groupe" name="id_groupe" size="1">
				<option value="0">Pas de groupe</option>
[(#REM)On extrait tous les groupes de Spip]
<BOUCLE_ToutesLesGroupes(MOTS){type="Sous groupes de classes"}{par titre}>
				<option value="#ID_MOT"<?php if ($id_groupe=='[(#ID_MOT|texte_script)]') echo " selected=selected";?>>#TITRE</option>
</BOUCLE_ToutesLesGroupes>
			</select>
		</fieldset>
		<fieldset>
			<legend><?php if ($id_article) {echo "Modifier ";}; ?>Matière&nbsp;:</legend>
			<select id="matiere" name="id_matiere" size="1">
[(#REM)On extrait toutes les matières de Spip]
<BOUCLE_ToutesLesMatieres(MOTS){type="Matières"}{par num titre}{par titre}>
				<option value="#ID_MOT"<?php if ($id_matiere=='[(#ID_MOT|texte_script)]') echo " selected=selected";?>>#TITRE</option>
</BOUCLE_ToutesLesMatieres>
			</select>
			</fieldset>
			<input type="hidden" name="id_auteur" value="<?php echo $id_auteur;?>">
			<input type="Submit" value="<?php if ($id_article) {echo "Modifier";} else {echo "Valider";}; ?> classe<?php if ($classes>0) echo "s"?> et matière" name="classe_matiere">
		</form>
<?php
}//fin du ifnot classe-matiere

//----------------------------------------------------------------------
//Secundo: remplir le contenu (quand classes et matières sont renseignés)
//----------------------------------------------------------------------


if($_GET['classe_matiere']){
?>
	<div>
	<!--Contenu de la séance-->
		<FORM NAME="contenu" method="post">
		<input type="hidden" name="page" value="cahier-de-texte-saisie">
			<fieldset>
			<legend><?php if ($id_article) {echo "Modifier le ";}; ?>Contenu de la séance</legend>
			<p class="dates">Séance du <INPUT TYPE="text" ID="date_seance" NAME="date_seance" VALUE="<?php if (!$date_seance) echo date("d/m/Y"); else echo $date_seance;?>" SIZE=12></p><?php
	include_spip('inc/barre');
	echo afficher_barre("document.getElementById('contenu_seance')"); ?>
			<textarea id="contenu_seance" name="contenu_seance" cols="60" rows="5"><?php echo $contenu_seance;?></textarea>[

(#REM) Si la séance est dupliquée/Modifiée, on affiche les documents qui sont liés à la séance...

		]<B_Documents_Seances_saisie>
			<div class="documents-seance">
				<h4 class="documents-seance"><b>>></b>&nbsp;Documents déjà joints à la séance&nbsp;:</h4>
				(décochez ceux que vous ne voulez pas conserver associés à cette séance)<br />
		<BOUCLE_Documents_Seances_saisie(DOCUMENTS){id_document IN #GET{liste_docs_seance}}{"&nbsp;| "}{par titre}>
				<input type="checkbox" name="doc_seance_#ID_DOCUMENT" <?php if ($_POST['doc_seance_'.'[(#ID_DOCUMENT)]'] or !$_POST['modifier_fiche']) echo "CHECKED"; ?> title="cochez pour conserver le document, décochez pour l'enlever"><a href="#URL_DOCUMENT">[(#LOGO_DOCUMENT||image_reduire{22,22})]&nbsp;[(#TITRE|sinon{#FICHIER|basename})] (<em>#TYPE_DOCUMENT</em> de [(#TAILLE|taille_en_octets)])</a>
		</BOUCLE_Documents_Seances_saisie>
			</div>
		</B_Documents_Seances_saisie>
			</fieldset>
	<!--Devoirs à faire -->
			<fieldset>
			<legend><?php if ($id_article) {echo "Modifier les ";}; ?>Devoirs</legend>

<?php for ($count=0; $count<=$devoirs; $count++) {
	$liste_docs_Devoir = $liste_des_listes_de_docs[$count]; ?>
			<p>À faire pour le <INPUT TYPE="text" class="date_calendrier" NAME="date_devoir<?php echo $count;?>" VALUE="<?php if (!$date_devoir[$count]) echo date("d/m/Y"); else echo $date_devoir[$count];?>" SIZE=12></p><?php
	echo afficher_barre("document.getElementById('contenu_devoir$count')"); ?>
			<textarea id="contenu_devoir<?php echo $count;?>" name="contenu_devoir<?php echo $count;?>" cols="60" rows="5"><?php echo $contenu_devoir[$count];?></textarea>[

(#REM) Si la fiche est dupliquée/Modifiée, on affiche les documents qui sont liés au devoir...

		]<B_Documents_Devoir_saisie><?php
			if ($liste_docs_Devoir) {?>
			<div class="documents-seance">
				<h4 class="documents-seance"><b>>></b>&nbsp;Documents déjà joints à ce devoir&nbsp;:</h4> 
				(décochez ceux que vous ne voulez pas conserver associés à cette séance)<br />
			<?php } //fin du if liste_docs_Devoir ?>
		<BOUCLE_Documents_Devoir_saisie(DOCUMENTS){id_document IN #GET{liste_docs_devoirs}}{par titre}><?php
//On vérifie parmis les docs liés aux (tous) devoirs de la fiche qu'ils correspondent au devoir: on vérifie que l'id_document est bien dans le tableau des docs liés à ce devoir.
				reset($liste_docs_Devoir);
				$ok=false;
				while(list ($key, $val) = each ($liste_docs_Devoir)) {
					if ($val=='[(#ID_DOCUMENT)]') $ok="ok";
				}
				if ($ok) { ?>
				<input type="checkbox" name="doc_devoir<?php echo $count;?>_#ID_DOCUMENT" <?php if ($_POST['doc_devoir'.$count.'_'.'[(#ID_DOCUMENT)]'] or !$_POST['modifier_fiche']) echo "CHECKED"; ?> title="cochez pour conserver le document, décochez pour l'enlever"><a href="#URL_DOCUMENT">[(#LOGO_DOCUMENT||image_reduire{22,22})]&nbsp;[(#TITRE|sinon{#FICHIER|basename})] (<em>#TYPE_DOCUMENT</em> de [(#TAILLE|taille_en_octets)])</a>
				<?php } //fin du if liste_docs_Devoir ?>
		</BOUCLE_Documents_Devoir_saisie><?php
			if ($liste_docs_Devoir) {?>
			</div>
			<?php } //fin du if liste_docs_Devoir ?>
		</B_Documents_Devoir_saisie>
<?php }//fin du for count devoirs?>
			<input type="hidden" name="devoirs" value="<?php echo $devoirs;?>">
			<input type="Submit" value="Rajouter un devoir pour une autre date" name="plusdate">
			</fieldset>[
(#REM) On ne parle de docs joints que si on est aps en train de dupliquer ou modifier une fiche.
][
	(#ENV{id_article}|?{'',' '})
			<p>Vous pourrez ajouter des documents joints à la séance ou aux devoirs après les avoir enregistrés</p>]
			<br>
	<!--validation-->
			<input type="Submit" value="Enregistrer dans le cahier de texte" name="enregistrer_fiche">
		</form>
<?php }//fin du if classe-matiere?>
<?php } // fin du if enregistrer-fiche?>
	</div></div></div>

<?php
if($_GET['classe_matiere']) {
?>[
(#REM)Affichage des dernières entrées dans le cahier de texte en fonction du contexte (dans le GET)
][

(#REM) On se place dans le contexte de la rubrique du cahier de texte de l'année
]
<BOUCLE_Contexte_RubriqueCDT_affichage(RUBRIQUES){titre=="Cahier de texte en-ligne"}{0,1}{tout}>[
(#REM) On détermine quelle est l'année scolaire que l'on veut afficher
][	(#SET{annee_rubrique,[(#ENV{date}|bonbon_annee_scolaire)]})
][	(#ENV{annee_scolaire}|?{' ',''})
		#SET{annee_rubrique,#ENV{annee_scolaire}}
	]<BOUCLE_AnneeScol(RUBRIQUES){id_parent}{titre=#GET{annee_rubrique}}{!par titre}{0,1}>[

(#REM) On prépare une liste des artciles parmis lesquels faire la requête. Cette liste sera «stockée» dans {!doublons requete}. Ceci atomise les requêtes avec des Regexp et évite les trop grosses requêtes SQL. Merci à Cédric Morin pour l'idée.

][
(#REM) on selectionne ceux qui ont la bonne les classes, bon auteur et bonne rubrique
]<BOUCLE_PrepaClasses(ARTICLES){id_rubrique}{id_auteur ?}{id_mot=#ENV{id_classe0}}{doublons Prepa_Classes_auteur}></BOUCLE_PrepaClasses>[
(#REM) on selectionne ceux qui ont la bonne matière
]<BOUCLE_Prepa_Matiere(ARTICLES){id_mot=#ENV{id_matiere}}
{!doublons Prepa_Classes_auteur}{doublons Prepa_Matiere}></BOUCLE_Prepa_Matiere>[
(#REM) on choisi les articles qui sont du bon groupe
]<BOUCLE_Prepa_Groupes(ARTICLES){id_mot==#ENV{id_groupe,.}}{!doublons Prepa_Matiere}{doublons requete}></BOUCLE_Prepa_Groupes>[

(#REM) {!doublons requete} est donc un critère qui sélectionne tous les articles qui correspondent aux restrictions de groupe, date, matière et même auteur s'il y a. Sans reitérer les commandes SQL.

][
(#REM)On restrient la requête aux descriptions de séances en suivant le même modèle que précédement.
]<BOUCLE_QueSeances(ARTICLES){titre_mot="Description de séance"}{!doublons requete}{doublons QueSeances}></BOUCLE_QueSeances>[
(#REM) {!doublons QueSeances} est donc un critère qui sélectionne toutes les Descriptions de séances qui correspondent aux restrictions de groupe, date, matière et même auteur s'il y a. Sans reitérer les commandes SQL.
]<B_Seances>
<div class="bloc">
<h2>Dernières entrées du même type dans le cahier de textes&nbsp;:</h2>
<BOUCLE_Seances(ARTICLES){!doublons QueSeances}{!par date}{0,10}{'
<br clear="left">
<hr>'}>
		<INCLURE(session.php){fond=cahier-de-texte-une-seance}{id_article=#ID_ARTICLE}{admin_fiche=non}>
</BOUCLE_Seances>
<br clear="all">
</div>
</B_Seances>
<p>Pas encore d'entrées du même type trouvées dans le cahier de texte...</p>
<//B_Seances>
	</BOUCLE_AnneeScol>
</BOUCLE_Contexte_RubriqueCDT_affichage>
<?php
	if (!($_POST['enregistrer_fiche'])) {
?>
<hr>
[(#REM)Inclusion de la noisette de selection]
<INCLURE{fond=cahier-de-texte-selection}>

<?php 
	}//fin du if not enregistrer_fiche
}//fin du if classe-matiere?>	
	</div>

[(#REM)Inclusion du pied de page]
<INCLURE{fond=cahier-de-texte-pied}>
</div>


  [(#REM)Fin de la zone à athentification]
  <?php } else { ?>

<h1>Cette partie est en accès restreint</h1>
#LOGIN_PUBLIC

<?php } ?>
</body>
</html>