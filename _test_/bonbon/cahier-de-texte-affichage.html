#CACHE{300}
[(#ENV{id_auteur}|?{' ',''})#CACHE{1}]
<!--
*****Cahier de texte pour Spip: Bonbon !
*****Réalisé par Bertrand MARNE (bmarne à ac-creteil.fr)
*****Sous licence GPL (enfin bon, c'est bonbonware...)
*****CopyLeft en juin 2007
***Affichage d'extraits du cahier de texte, cette page prend les paramètres suivants (en GET):
classe= le nom d'une classe (attention il faut qu'il y ait identité avec le mot clé de la classe)
groupe= le nom du groupe (attention il faut qu'il y ait identité avec le mot clé du groupe)
matiere= le nom de la matière (attention il faut qu'il y ait identité avec le mot clé de la matière)
id_auteur= l'id_auteur d'un auteur (un professeur)
date_debut=début de la période considérée (sinon c'est depuis le début de l'année en cours)
date_debut=fin de la période considérée (sinon c'ets jusqu'en 9999, ce qui devrait suffire jusqu'au bug de l'an 10000)
Les dates sont au format YYYY-MM-DD
devoirs_seuls= si cet argument est donné, alors seuls les devoirs s'affichent.
Si les deux arguments sont données (seances_seules et devoirs_seul rien ne s'affiche !)
annee_scolaire= définit quelle année scolaire (sous le format XXXX%2FYYYY comme par exemple 2006%2F2007). Si ce n'est pas défini, c'est l'année scolaire la plus récente qui s'affiche. Note: %2F est un slash (/) encodé pour aller dans l'url.
nb=nombre maxi d'entrées listées (par défaut 20 entrées...)
senschrono= si 1 les séance sont en chronologique inverse, si 0 dans le sens chrono.
-->
[
(#REM) On se place dans le contexte de la rubrique du cahier de texte de l'année
]
<BOUCLE_Contexte_RubriqueCDT(RUBRIQUES){titre=="Cahier de texte en-ligne"}{0,1}{tout}>
	<BOUCLE_AnneeScol(RUBRIQUES){id_parent}{titre==#ENV{annee_scolaire,.}}{!par titre}{0,1}>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<title>#NOM_SITE_SPIP: Cahier de texte</title>

[
(#REM)Inclusion du pied de page
]
<INCLURE{fond=cahier-de-texte-en-tete}>

</head>
<body>
<div id="NoMenu">
	<div id="EntetePage">
			<ul class="boutons">
				<li><a href="#URL_PAGE{cahier-de-texte-accueil}" title="Retourner à la page d'accueil du cahier de texte"><img src="#CHEMIN{images/dialog-ok-upside-down.png}" alt="icône" vspace="2" align="middle">Accueil du cahier de texte</a></li>
				<li><a href="#URL_PAGE{cahier-de-texte-affichage,nb=20}"><img src="#CHEMIN{images/system-search.png}" alt="icône" vspace="2" align="middle">Afficher les 20 dernieres séances</a></li>
<?php if ($auteur_session) {?>
				<li><a href="#URL_PAGE{cahier-de-texte-saisie}&id_auteur=<?php echo $auteur_session['id_auteur'];?>" title="Écrire le contenu d'une séance et ses devoirs éventuels"><img src="#CHEMIN{images/accessories-text-editor.png}" alt="icône" vspace="2" align="middle">Saisir une séance</a></li>
				<li><a href="#URL_PAGE{cahier-de-texte-affichage,senschrono=1}&id_auteur=<?php echo $auteur_session['id_auteur'];?>" title="Aller voir ses propres entrées du cahier de texte"><img src="#CHEMIN{images/edit-find.png}" alt="icône" vspace="2" align="middle">Afficher ses séances</a></li>
<?php }//fin du if auteur session ?>
				<li><a href="#requete" title="Faire une requête précise sur le contenu du cahier de texte"><img src="#CHEMIN{images/edit-find-replace.png}" alt="icône" vspace="2" align="middle">Faire une requête précise</a>
			</ul>
[(#REM)Vérification de l'authentification]
<?php if ($auteur_session) {
//paramètre de session utilisés:
	$auteur=$auteur_session['nom'];
	$id_auteur=$auteur_session['id_auteur'];
	echo "<p class='authentifie'>$auteur (si vous n'êtes pas $auteur, <a href=\"";
?>#URL_LOGOUT<?php
	echo "\" title=\"déconnexion immédiate !\">cliquez ici</a>)</p>\n";}?>

			<h1>Cahier de texte (#NOM_SITE_SPIP)</h1>
			<br class="clear" />
[(#ENV{devoirs_seuls}|?{' ',''})
		<h2>Devoirs à faire</h2>]
		<p>[Classe de (#ENV{classe}) ][(#ENV{groupe}) ][en (#ENV{matiere}) ]<B_Prof>Professeur&nbsp;: <BOUCLE_Prof(AUTEURS){id_auteur}>#NOM</BOUCLE_Prof></p>
		<p>[à partir du (#ENV{date_debut}|affdate) ][jusqu'au (#ENV{date_fin}|affdate)]</p>
	</div>
	<div id="Contenu">
[

(#REM) On prépare une liste des artciles parmis lesquels faire la requête. Cette liste sera «stockée» dans {!doublons requete}. Ceci atomise les requêtes avec des Regexp et évite les trop grosses requêtes SQL. Merci à Cédric Morin pour l'idée.

][
(#REM) on selectionne ceux qui ont la bonne les classes et l'auteur (s'il y a)
]<BOUCLE_PrepaClasses(ARTICLES){id_rubrique}{id_auteur ?}{titre_mot==#ENV{classe,.}}{doublons Prepa_Classes_auteur}></BOUCLE_PrepaClasses>[
(#REM) on selectionne ceux qui ont la bonne matière
]<BOUCLE_Prepa_Matiere(ARTICLES){id_rubrique}{titre_mot==#ENV{matiere,.}}
{!doublons Prepa_Classes_auteur}{doublons Prepa_Matiere}></BOUCLE_Prepa_Matiere>[
(#REM) Idem pour les dates 
]<BOUCLE_PrepaDates(ARTICLES){id_rubrique}{date>=#ENV{date_debut,.}}{date<=#ENV{date_fin,9999-12-01 03:25:02}}{!doublons Prepa_Matiere}{doublons Date}></BOUCLE_PrepaDates>[
(#REM) on choisi les articles qui sont du bon groupe
]<BOUCLE_Prepa_Groupes(ARTICLES){id_rubrique}{titre_mot==#ENV{groupe,.}}{!doublons Date}{doublons requete}></BOUCLE_Prepa_Groupes>[

(#REM) {!doublons requete} est donc un critère qui sélectionne tous les articles qui correspondent aux restrictions de groupe, date, matière et même auteur s'il y a. Sans reitérer les commandes SQL.

]<?php
//Si on ne demande pas que les devoirs, on affiche les séances
if (!($_GET['devoirs_seuls'])) {
?>[
(#REM)On restrient la requête aux descriptions de séances en suivant le même modèle que précédement.
]<BOUCLE_QueSeances(ARTICLES){id_rubrique}{titre_mot="Description de séance"}{!doublons requete}{doublons QueSeances}></BOUCLE_QueSeances>[
(#REM) {!doublons QueSeances} est donc un critère qui sélectionne toutes les Descriptions de séances qui correspondent aux restrictions de groupe, date, matière et même auteur s'il y a. Sans reitérer les commandes SQL.
]<B_Seances>
<div class="apres"><a href="[(#SELF|parametre_url{'senschrono',[(#ENV{senschrono}|?{0,1})]})]" title="inverser l'ordre de classement des séances">inverser l'ordre chronologique</a></div><br clear="all" />
#ANCRE_PAGINATION
<BOUCLE_Seances(ARTICLES){id_rubrique}{!doublons QueSeances}{par #ENV{tri}}{pagination #ENV{nb,20}}{par date}{inverse #ENV{senschrono}}>
		<INCLURE(session.php){fond=cahier-de-texte-une-seance}{id_article=#ID_ARTICLE}>
</BOUCLE_Seances>
[<div class="apres">Pages&nbsp;: (#PAGINATION{page_precedent_suivant})</div>]
</B_Seances>
<?php
} //fin du if !devoirs_seuls
?>
<?php
//Si on ne demande que les devoirs, on les affiche comme un tableau (pratique !)
if (($_GET['devoirs_seuls'])) {
?>[
(#REM)On restrient la requête aux devoirs en suivant le même modèle que précédement.
]<BOUCLE_QueDevoirs(ARTICLES){id_rubrique}{titre_mot="Devoirs à faire"}{!doublons requete}{doublons QueDevoirs}></BOUCLE_QueDevoirs>[
(#REM) {!doublons QueDevoirs} est donc un critère qui sélectionne toutes les Devoirs à faire qui correspondent aux restrictions de groupe, date, matière et même auteur s'il y a. Sans reitérer les commandes SQL.
]<B_Devoirs>
#ANCRE_PAGINATION
		<table width="100%" border=1 class="spip">
			<tr>
				<th>Pour le</th>
				[(#ENV{classe}|?{'',<th>Classe</th>})]
				[(#ENV{groupe}|?{'',<th>Groupe</th>})]
				[(#ENV{matiere}|?{'',<th>Matière</th>})]
				<th>Devoir</th>
				[(#ENV{id_auteur}|?{'',<th>Professeur</th>})]
				<th>Donné le</th>
			</tr>

<BOUCLE_Devoirs(ARTICLES){id_rubrique}{!doublons QueDevoirs}{par #ENV{tri}}{pagination #ENV{nb,20}}{!par date}>
			<tr class="[(#COMPTEUR_BOUCLE|alterner{'row_odd','row_even'})]">
				<td>[(#DATE|affdate)]</td>
				[(#ENV{classe}|?{'',<td>})]
				<BOUCLE_classes(MOTS){id_article}{type="Classes"}{"&nbsp;- "}>[(#ENV{classe}|?{'',#TITRE})]</BOUCLE_classes>
				[(#ENV{classe}|?{'',</td>})]
				[(#ENV{groupe}|?{'',<td>})]
				<BOUCLE_groupes(MOTS){id_article}{type="Sous groupes de classes"}{"&nbsp;- "}>[(#ENV{groupe}|?{'',#TITRE})]</BOUCLE_groupes>
				[(#ENV{groupe}|?{'',</td>})]
				[(#ENV{matiere}|?{'',<td>})]
				<BOUCLE_matieres(MOTS){id_article}{type="Matières"}{"&nbsp;- "}>[(#ENV{matiere}|?{'',#TITRE})]</BOUCLE_matieres>
				[(#ENV{matiere}|?{'',</td>})]
				<td class="#EDIT{texte}">
					[(#TEXTE)]
				<B_Documents_Devoir_seuls> [<i>Docs&nbsp;:</i> 
				<BOUCLE_Documents_Devoir_seuls(DOCUMENTS){id_article}{"&nbsp;|"}>
					<span class="#EDIT{fichier}">[(#LOGO_DOCUMENT|#URL_DOCUMENT||image_reduire{22,22}|inserer_attribut{'title',[(#TITRE|sinon{#FICHIER|basename})]})]</span>
				</BOUCLE_Documents_Devoir_seuls>]
				</B_Documents_Devoir_seuls>
				</td>
				[(#ENV{id_auteur}|?{'',<td>})]
				<BOUCLE_profs(AUTEURS){id_article}{"&nbsp;- "}>[(#ENV{id_auteur}|?{'',#NOM})]</BOUCLE_profs>
				[(#ENV{id_auteur}|?{'',</td>})]
				<td>[

(#REM) On cherche ne l'id de la séance au cours de laquelle le devoir a été donné, puis on affiche un lien vers se devoir (la date de la séance).

][(#SET{id_seance,[(#PS*|bonbon_matches_id_article)]})]
				<BOUCLE_Seance_de_devoir(ARTICLES){id_article=#GET{id_seance}}>
				<a href="[(#URL_PAGE{cahier-de-texte-affichage-seance,id_article=#ID_ARTICLE})]" title="Afficher les détails de la séance au cours de laquelle le devoir a été donné" onClick="javascript:window.open(this.href,'affichage', 'scrollbars=yes, resizable=yes, width=740, height=580'); return false;">[(#DATE|affdate)]</a>
				</BOUCLE_Seance_de_devoir>
				</td>
			</tr>
</BOUCLE_Devoirs>
		</table>
[<div class="apres">Pages&nbsp;: (#PAGINATION{page_precedent_suivant})</div>]
</B_Devoirs>
<?php
} //fin du if devoirs_seuls
?>
	<br clear="All">
	<hr>
[(#REM)Inclusion de la noisette de selection]
<INCLURE{fond=cahier-de-texte-selection}>
	</div>

[(#REM)Inclusion du pied de page]
<INCLURE{fond=cahier-de-texte-pied}>


</div>

</body>
</html>
	</BOUCLE_AnneeScol>
</BOUCLE_Contexte_RubriqueCDT>