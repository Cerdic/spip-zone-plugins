#CACHE{30*24*60*60}
#SET{virgule,","} [(#REM) utile pour les explodes]
<!--
*****Cahier de texte pour Spip: Bonbon !
*****Réalisé par Bertrand MARNE (bmarne à ac-creteil.fr)
*****Sous licence GPL (enfin bon, c'est bonbonware...)
*****CopyLeft en juin 2007
***Affichage d'extraits du cahier de texte, cette page prend les paramètres suivants (en GET):
classe= le nom d'une classe (attention il faut qu'il y ait identité avec le mot clé de la classe)
groupe= le nom du groupe (attention il faut qu'il y ait identité avec le mot clé du groupe)
matiere= le nom de la matière (attention il faut qu'il y ait identité avec le mot clé de la matière)
id_auteur= l'id_auteur d'un auteur (un professeur)
date_debut=début de la période considérée (sinon c'est depuis le début de l'année en cours)
date_debut=fin de la période considérée (sinon c'ets jusqu'en 9999, ce qui devrait suffire jusqu'au bug de l'an 10000)
Les dates sont au format YYYY-MM-DD
devoirs_seuls= si cet argument est donné, alors seuls les devoirs s'affichent.
Si les deux arguments sont données (seances_seules et devoirs_seul rien ne s'affiche !)
annee_scolaire= définit quelle année scolaire (sous le format XXXX%2FYYYY comme par exemple 2006%2F2007). Si ce n'est pas défini, c'est l'année scolaire la plus récente qui s'affiche. Note: %2F est un slash (/) encodé pour aller dans l'url.
nb=nombre maxi d'entrées listées (par défaut 20 entrées...)
senschrono= si 1 les séance sont en chronologique inverse, si 0 dans le sens chrono.
-->[

(#REM) On se place dans le contexte de la rubrique du cahier de texte de l'année
]
<BOUCLE_Contexte_RubriqueCDT(RUBRIQUES){titre=="Cahier de texte en-ligne"}{0,1}{tout}>[
(#REM) On détermine quelle est l'année scolaire que l'on veut afficher
][	(#SET{annee_rubrique,[(#ENV{date}|bonbon_annee_scolaire)]})
][	(#ENV{annee_scolaire}|?{' ',''})
		#SET{annee_rubrique,#ENV{annee_scolaire}}
	]<BOUCLE_AnneeScol(RUBRIQUES){id_parent}{titre=#GET{annee_rubrique}}{!par titre}{0,1}>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<title>#NOM_SITE_SPIP: Cahier de texte</title>

[
(#REM)Inclusion du pied de page
]
[(#INCLURE{fond=cahier-de-texte-en-tete})]

</head>
<body>
<div id="NoMenu">
	<div id="EntetePage">
			<ul class="boutons">
				<li><a href="#URL_PAGE{cahier-de-texte-accueil}" title="Retourner à la page d'accueil du cahier de texte"><img src="#CHEMIN{images/dialog-ok-upside-down.png}" alt="icône" vspace="2" align="middle">Accueil du cahier de texte</a></li>
				<li><a href="[(#URL_PAGE{cahier-de-texte-affichage,nb=20}|parametre_url{var_mode,calcul})]" title="afficher les dernières entrées du cahier de texte"><img src="#CHEMIN{images/system-search.png}" alt="icône" vspace="2" align="middle">Afficher les 20 dernieres séances</a></li>
<?php if ($auteur_session) {?>
				<li><a href="#URL_PAGE{cahier-de-texte-saisie}&id_auteur=<?php echo $auteur_session['id_auteur'];?>" title="Écrire le contenu d'une séance et ses devoirs éventuels"><img src="#CHEMIN{images/accessories-text-editor.png}" alt="icône" vspace="2" align="middle">Saisir une séance</a></li>
				<li><a href="[(#URL_PAGE{cahier-de-texte-affichage,senschrono=1}|parametre_url{var_mode,calcul})]&id_auteur=<?php echo $auteur_session['id_auteur'];?>" title="Aller voir ses propres entrées du cahier de texte"><img src="#CHEMIN{images/edit-find.png}" alt="icône" vspace="2" align="middle">Afficher ses séances</a></li>
<?php }//fin du if auteur session ?>
				<li><a href="#requete" title="Faire une requête précise sur le contenu du cahier de texte"><img src="#CHEMIN{images/edit-find-replace.png}" alt="icône" vspace="2" align="middle">Faire une requête précise</a>
			</ul>
[(#REM)Vérification de l'authentification]
<?php if ($auteur_session) {
//paramètre de session utilisés:
	$auteur=$auteur_session['nom'];
	$id_auteur=$auteur_session['id_auteur'];
	echo "<p class='authentifie'>$auteur (si vous n'êtes pas $auteur, <a href=\"";
?>#URL_LOGOUT[(#SET{var_mode,"calcul"})]<?php
	echo "\" title=\"déconnexion immédiate !\">cliquez ici</a>)</p>\n";}?>

			<h1>Cahier de texte (#NOM_SITE_SPIP)</h1>
			<br class="clear" />
[(#ENV{devoirs_seuls}|?{' ',''})
		<h2>Devoirs à faire</h2>]
		<p>[Classe de (#ENV{classe}) ][(#ENV{groupe}) ][en (#ENV{matiere}) ]<B_Prof>Professeur&nbsp;: <BOUCLE_Prof(AUTEURS){id_auteur}>#NOM</BOUCLE_Prof></p>
		<p>[à partir du (#ENV{date_debut}|affdate) ][jusqu'au (#ENV{date_fin}|affdate)]</p>
	</div>
	<div id="Contenu">
	<div class="cahier textes">
<p class="apres"><a href="[(#SELF|parametre_url{'senschrono',[(#ENV{senschrono}|?{0,1})]})]" title="inverser l'ordre de classement des séances">inverser l'ordre chronologique</a></p>
<br clear="all" />
<!--Liste des classes-->
		<div class="onglets-horizontaux">
			<span class="onglet inactif" style="background: bisque;">Classes&nbsp;&rarr; </span>
#SET{classe_env,#ENV{classe,''}}#SET{compteur,0}
<BOUCLE_ToutesLesClasses_affichage(MOTS){type="Classes"}{par titre}><BOUCLE_Que_les_classes_avec_article(ARTICLES){id_rubrique}{id_auteur?}{id_mot}{0,1}>[
		(#SET{compteur,[(#GET{compteur}|plus{1})]})
][
(#REM) La classe par défaut est la première. Si il n'y a pas de classe dans #ENV alors, c'est la classe par défaut qui est choisie
][
		(#GET{compteur}|=={1}|?{' ',''})
		#SET{classe_defaut,#_ToutesLesClasses_affichage:TITRE}
		[
		(#GET{classe_env}|?{'',' '})
			#SET{classe_env,#_ToutesLesClasses_affichage:TITRE}
		]
][
		(#SET{select,''})
][
		(#GET{classe_env}|=={#_ToutesLesClasses_affichage:TITRE}|?{' ',''})#SET{select,'on '}
]			<a href="[(#SELF|parametre_url{'classe',#_ToutesLesClasses_affichage:TITRE}|parametre_url{matiere,''}|parametre_url{var_mode,#GET{var_mode}})]" title="Afficher le cahier de texte de la [(#_ToutesLesClasses_affichage:TITRE|textebrut)]" class="onglet #GET{select}" onmouseover="this.className='onglet #GET{select}  hover'" onmouseout="this.className='onglet #GET{select}'">#_ToutesLesClasses_affichage:TITRE</a>
</BOUCLE_Que_les_classes_avec_article></BOUCLE_ToutesLesClasses_affichage>

<!-- les groupes-->
			<span class="onglet inactif" style="background: bisque;">Groupes&nbsp;&rarr; </span>
<BOUCLE_Les_Groupes(MOTS){type="Sous groupes de classes"}{par titre}><BOUCLE_Que_les_groupes_avec_article(ARTICLES){id_rubrique}{id_auteur?}{id_mot}{titre_mot=#ENV{classe,#GET{classe_defaut}}}{0,1}>[
		(#SET{select,''})
][
		(#ENV{groupe}|=={#_Les_Groupes:TITRE}|?{' ',''})#SET{select,'on '}
]			<a href="[(#SELF|parametre_url{'groupe',#_Les_Groupes:TITRE}|parametre_url{var_mode,#GET{var_mode}})]" title="Afficher le cahier de texte de la #ENV{classe,#GET{classe_defaut}} - #_Les_Groupes:TITRE" class="onglet #GET{select}" onmouseover="this.className='onglet #GET{select}  hover'" onmouseout="this.className='onglet #GET{select}'">#_Les_Groupes:TITRE</a>
</BOUCLE_Que_les_groupes_avec_article></BOUCLE_Les_Groupes>[
		(#ENV{groupe}|?{' ',''})<a href="[(#SELF|parametre_url{'groupe',''})]" title="Afficher le cahier de texte de tous les groupes de la #ENV{classe,#GET{classe_defaut}}" class="onglet" onmouseover="this.className='onglet  hover'" onmouseout="this.className='onglet'">Les deux groupes</a>
]
		</div>
		<br clear="all">[

	(#REM) Hack un peu sale pour éviter de faire une noisette de plus:
	La boucle ToutesLesMatieres_affichage ne doit s'exécuter que si la matière est définie dans #ENV ou si on ne demande pas que les devoirs.
	Si ces conditions sont réunies, on définit affichage_matiere avec la valeur de #ID_RUBRIQUE
	On englobe la boucle à conditionner (ToutesLesMatieres_affichage) dans une boucle qui teste qu'affichage_matiere est bien une rubrique

][
	(#SET{affichage_matiere,0})
][
	(#ENV{devoirs_seuls}|?{'',' '})#SET{affichage_matiere,#ID_RUBRIQUE}
][
	(#ENV{matiere}|?{' ',''})#SET{affichage_matiere,#ID_RUBRIQUE}
]<BOUCLE_Test_si_devoirs_ou_matiere(RUBRIQUES){id_rubrique=#GET{affichage_matiere}}{0,1}>
<!--Liste des matières-->
		<div class="onglets-verticaux">
			<span class="onglet inactif" style="background: bisque;"><center>Matières<br />&darr;</center></span>
#SET{matiere_env,#ENV{matiere,''}}
<BOUCLE_ToutesLesMatieres_affichage(MOTS){type="Matières"}{par titre}><BOUCLE_Que_les_matieres_avec_article(ARTICLES){id_rubrique}{id_auteur?}{id_mot}{titre_mot=#ENV{classe,#GET{classe_defaut}}}{0,1}>[
(#REM) La matiere par défaut est la première qui a une fiche qui correspond à la classe par défaut. Si il n'y a pas de matiere dans #ENV alors, c'est la matiere par défaut qui est choisie
][
		(#GET{matiere_defaut}|?{'',' '})
		#SET{matiere_defaut,#_ToutesLesMatieres_affichage:TITRE}
		[
		(#GET{matiere_env}|?{'',' '})
			#SET{matiere_env,#_ToutesLesMatieres_affichage:TITRE}
		]
][
		(#SET{select,''})
][
		(#GET{matiere_env}|=={#_ToutesLesMatieres_affichage:TITRE}|?{' ',''})#SET{select,'on '}
]			<a href="[(#SELF|parametre_url{'matiere',#_ToutesLesMatieres_affichage:TITRE}|parametre_url{var_mode,#GET{var_mode}})]" title="Afficher le cahier de texte de la [(#ENV{classe,#GET{classe_defaut}}|textebrut)] en [(#_ToutesLesMatieres_affichage:TITRE|textebrut)]"  class="onglet #GET{select}" onmouseover="this.className='onglet #GET{select} hover'" onmouseout="this.className='onglet #GET{select}'">[(#_ToutesLesMatieres_affichage:TITRE)]</a>
</BOUCLE_Que_les_matieres_avec_article></BOUCLE_ToutesLesMatieres_affichage>
		</div>
</BOUCLE_Test_si_devoirs_ou_matiere>[

(#REM) On prépare une liste des artciles parmis lesquels faire la requête. Cette liste sera «stockée» dans {!doublons requete}. Ceci atomise les requêtes avec des Regexp et évite les trop grosses requêtes SQL. Merci à Cédric Morin pour l'idée.

][
(#REM) on selectionne ceux qui sont dans la bonne rubrique (année), ont la bonne les classes et l'auteur (s'il y a)
]<BOUCLE_PrepaClasses(ARTICLES){id_rubrique}{id_auteur ?}{titre_mot=#ENV{classe,#GET{classe_defaut}}}{doublons Prepa_Classes_auteur}></BOUCLE_PrepaClasses>[
(#REM) on selectionne ceux qui ont la bonne matière
]<BOUCLE_Prepa_Matiere(ARTICLES){titre_mot=#ENV{matiere,#GET{matiere_defaut}}}
{!doublons Prepa_Classes_auteur}{doublons Prepa_Matiere}></BOUCLE_Prepa_Matiere>[

(#REM) On prépare une variable Spip "matiere_ou_non". Elle va déterminer quelle pile (!doublon) va être utilisée dans la boucle date: si on veut les devoirs et qu'on a pas défini de matière on utilise la pile des classes (puisqu'aucun critère de matière n'est necessaire), sinon on utilise la pile matière

][
	(#SET{matiere_ou_non,'Prepa_Matiere'})
][
	(#ENV{devoirs_seuls}|?{' ',''})
		#SET{matiere_ou_non,'Prepa_Classes_auteur'}
][
	(#ENV{matiere}|?{' ',''})
		#SET{matiere_ou_non,'Prepa_Matiere'}
][
(#REM) Idem pour les dates 
]<BOUCLE_PrepaDates(ARTICLES){date>=#ENV{date_debut,"1900-01-01 00:00:00"}}{date<=#ENV{date_fin,"9999-12-01 03:25:02"}}{!doublons #GET{matiere_ou_non}}{doublons Date}></BOUCLE_PrepaDates>[
(#REM) on choisi les articles qui sont du bon groupe
]<BOUCLE_Prepa_Groupes(ARTICLES){titre_mot==#ENV{groupe,.}}{!doublons Date}{doublons requete}>[(#SET{tableau_fiches,#GET{tableau_fiches}|bonbon_fusion_tableau{#ARRAY{#COMPTEUR_BOUCLE,#ID_ARTICLE}}})]</BOUCLE_Prepa_Groupes>[

(#REM) #GET{tableau_fiches} contient donc tous les articles qui correspondent aux restrictions de groupe, date, matière et même auteur s'il y a. Sans reitérer les commandes SQL.
Puis, on implode ce tableau pour le transmettre sous forme de liste aux noisettes

][
	(#SET{liste_fiches,[(#GET{virgule}|implode{#GET{tableau_fiches}})]})
][
	(#REM) Si on ne veut pas que les devoirs, on inclu la noisette qui affiche les séances
][(#ENV{devoirs_seuls}
	|?{'',' '})
	<INCLURE{fond=cahier-de-texte-requete-seances}{liste_fiches=#GET{liste_fiches}}{self=#SELF}{matiere_defaut=#GET{matiere_defaut}}{id_rubrique=#ID_RUBRIQUE}{senschrono=#ENV{senschrono}}>
][
	(#REM) Si on veut que les devoirs, on inclu la noisette qui affiche les devoirs
]
[(#ENV{devoirs_seuls}
	|?{' ',''})
	<INCLURE{fond=cahier-de-texte-requete-devoirs}{liste_fiches=#GET{liste_fiches}}{self=#SELF}{matiere_defaut=#GET{matiere_defaut}}{id_rubrique=#ID_RUBRIQUE}{matiere_ou_non=#GET{matiere_ou_non}}{senschrono=#ENV{senschrono}|choixsiegal{'',1,0}}>
]
	</div>
	<br clear="All">
	<hr>
[(#REM)Inclusion de la noisette de selection]
[(#INCLURE{fond=cahier-de-texte-selection})]
	</div>

[(#REM)Inclusion du pied de page]
[(#INCLURE{fond=cahier-de-texte-pied})]


</div>

</body>
</html>
	</BOUCLE_AnneeScol>
</BOUCLE_Contexte_RubriqueCDT>