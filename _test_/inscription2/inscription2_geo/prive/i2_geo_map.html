[(#REM) Ne pas prendre les latitude/longitude dans le #ENV, 
des fois qu'elles ne soient pas valides et feraient planter la carte]

<BOUCLE_auteurs(AUTEURS){id_auteur}{tout}>
	[(#SET{latitude,[(#LATITUDE|sinon{#CONFIG{geomap/latitude,0.0}})]})]
	[(#SET{longitude,[(#LONGITUDE|sinon{#CONFIG{geomap/longitude,0.0}})]})]
</BOUCLE_auteurs>
</B_auteurs>
	[(#SET{latitude,#CONFIG{geomap/latitude,0.0}})]
	[(#SET{longitude,#CONFIG{geomap/longitude,0.0}})]
<//B_auteurs>

<script type="text/javascript">
	var loadmap = function(){
		if (GBrowserIsCompatible()) {
		    // create the map
		    var map = new GMap2(jQuery("#formMap")[0]);
		    map.addControl(new GLargeMapControl());
		    map.addControl(new GMapTypeControl());
			pointM = new GLatLng(#GET{latitude},#GET{longitude});
			marker = new GMarker(pointM,{draggable:true});
			map.setCenter(pointM,#CONFIG{geomap/zoom,0.0}, G_NORMAL_MAP);
			map.addOverlay(marker);
		    // creamos el evento para crear nuevos marcadores
		    GEvent.addListener(map, "click", function(overlay, point){
				map.clearOverlays();
				zoom = map.getZoom();
				if (point) {
					markerM = new GMarker(point,{draggable:true});
					map.addOverlay(markerM);
					map.panTo(point);
					jQuery('#formMap').parents('form').find('input[name=latitude]').val(point.y);
					jQuery('#formMap').parents('form').find('input[name=longitude]').val(point.x);
					GEvent.addListener(markerM, "dragend", function(){
						var pointM = markerM.getPoint();
						zoom = map.getZoom();
						jQuery('#formMap').parents('form').find('input[name=latitude]').val(pointM.y);
						jQuery('#formMap').parents('form').find('input[name=longitude]').val(pointM.x);
				    });
				}
		    });
			GEvent.addListener(marker, "dragend", function(){
				var pointM = marker.getPoint();
				zoom = map.getZoom();
				jQuery('#formMap').parents('form').find('input[name=latitude]').val(pointM.y);
				jQuery('#formMap').parents('form').find('input[name=longitude]').val(pointM.x);
		    });
		} else{
		    alert("<:geomap:erreur_api_browser:>");
		}
	}
	loadmap();
	onAjaxLoad(loadmap);
</script>