<style>
/* jqModal base Styling courtesy of;
	Brice Burgess <bhb@iceburg.net> */
.jqmWindow {
    display: none;
    
    position: fixed;
    top: 17%;
    left: 50%;
    
    margin-left: -300px;
    width: 600px;
    
    background-color: #EEE;
    color: #333;
    border: 1px solid black;
    padding: 12px;
}

* html .jqmWindow {
    position: absolute;
    top: 0%;
	left:0%;
	z-index:3500;
}

.jqmOverlay { background-color: #000; }

* div.jqmOverlay {
    position: fixed;
    top: 0px;
	left:0px;
	z-index:3499;
}

/* Background iframe styling for IE6. Prevents ActiveX bleed-through (<select> form elements, etc.) */
* iframe.jqm {position:absolute;top:0;left:0;z-index:-1;
	width: expression(this.parentNode.offsetWidth+'px');
	height: expression(this.parentNode.offsetHeight+'px');
}

*html.jqm {position:absolute;z-index:0;
}
div.jqmConfirm input[type="submit"] { padding: 4px; margin: 10px 30px; background: #000; color: #FFF; border: 1px solid #AAA; }

/* jqModal confirm CSS courtesy of;
   Alexandre Plennevaux <alexandre@pixeline.be>,
   Brice Burgess <bhb@iceburg.net> */
div.jqmConfirm { /* contains + positions the alert window */
  display: none;
  
  position: fixed;
  top: 17%;
  width: 100%;
}
    
* html div.jqmConfirm {
    position: absolute;
    top: 17%;
	left: 30%;
	width: 40%;
}

div.jqmConfirmWindow {
  height:auto;
  width: auto;
  margin: auto;
  
  max-width:400px;
  padding: 0 10px 10px;
  
  background:#FFF;
  border:1px dotted #FFF;
}

.jqmConfirmTitle{
  margin:5px 2px;
  height:20px;
  color:#000;
  background:#FFF;
}
.jqmConfirmTitle h1{
  margin:5px 2px;
  padding-left:5px;
  padding:0;
  font-size:14px;
  text-transform:capitalize;
  letter-spacing:-1px;
  font-weight:bold;
  color:#000;

  float:left;
  height:20px;
}

div.jqmConfirm .jqmClose em{display:none;}
div.jqmConfirm .jqmClose {
  width:20px;
  height:20px;
  display:block;
  float:right;
  clear:right;
  background:transparent url(confirm/close_icon_double.png) 0 0 no-repeat;
}

div.jqmConfirm a.jqmClose:hover{ background-position: 0 -20px; }

div.jqmConfirmContent{
  border-top:px;
  color:#000;
  font:11px/14pt arial;
  padding:5px 20px 5px;
  margin:5px;
  border:1px dotted #111;
  letter-spacing:0px;
  background:#FFF url(confirm/darkgrid.png);
}

.clearfix:after {
    content: "."; 
    display: block; 
    height: 0; 
    clear: both; 
    visibility: hidden;
}

.clearfix {display: inline-block;}

* html .clearfix {height: 1%;}
.clearfix {display: block;}


input, select {
background-color:#E4E4E4;
background-position:center bottom;
border:1px solid #C0CAD4;
float:none;
font-family:Verdana,Arial,Sans,sans-serif;
font-size:11px;
padding:3px;
}

tr.row { background:#FFF8DC; }
tr.even { background:#AFF5DF; }

td {padding:3px}

a:hover{font-weight:bold;}
	
.cadre-info {margin-bottom:10px}
	
</style>

<script src="#CHEMIN{javascript/jqModal.js}" type="text/javascript"></script>
<script type="text/javascript">
/* Overriding Javascript's Alert Dialog */
function confirm(msg,callback) {
  $('#confirm')
    .jqmShow()
    .find('p.jqmConfirmMsg')
      .html(msg)
    .end()
    .find(':submit:visible')
      .click(function(){
        if(this.value == 'yes')
          (typeof callback == 'string') ?
            window.location.href = callback :
            callback;
        $('#confirm').jqmHide();
      });
}

// trigger a confirm whenever links of class alert are pressed.
$().ready(function() {
  $('#confirm').jqm({overlay: 88, modal: true, trigger: false});
  
  // trigger a confirm whenever links of class alert are pressed.
  $('a.confirm').click(function() { 
    confirm('',this.href); 
    return false;
  });
});
</script>

<div style="margin-top : 15pt; margin-left : 15pt; font-size: 8pt;">

<div style="float:left; ">
	<?php
	debut_boite_info();
	?>
	<div id='raccourcis' style="width:150pt; text-align: left; margin-top:5px;padding:5px" >
		<strong><:inscription2:raccourcis:></strong>
		<ul style='text-align: left; list-style-type:none'>
			<li style="margin-top:5px"><a href="?exec=ajouter_adherent"><:inscription2:ajouter_adherent:></a></li>
			<li style="margin-top:5px"><a href="?exec=cfg&cfg=inscription2"><:inscription2:configuration:></a></li>
			<li style="margin-top:5px"><a class ="confirm" href="?exec=inscription2_adherents&act=net"><:inscription2:nettoyer_tables:></a></li>
		
		</ul>
	</div>

	<?php
		fin_boite_info();
		if(defined('_DIR_PLUGIN_ABONNEMENT')){
		debut_boite_info();
	?>
	<div style="width:150pt; text-align: left; margin-top:5px;padding:5px" >
		<strong>Abonnements</strong>
		<ul style='text-align: left; list-style-type:none'>
		<li style="margin-top:5px"><a class ="cellule-h" href="?exec=abonnement_tous">Abonnements</a></li>
		<li style="margin-top:5px"><a class ="cellule-h" href="?exec=cfg&cfg=abonnement_relances">Relances</a></li>
		<li style="margin-top:5px"><a class ="cellule-h" href="?exec=cfg&cfg=abonnement">Emails de confirmation</a></li>
		</ul>
	</div>
	
	<style>
	tr.prospect { background:#F0DCF4; }
	tr.abonne { background:#DCF3F4; }
	tr.relance { background:#AFF5DF; }
	tr.relance2 { background:#AFF5DF; }
	tr.relance3 { background:#AFF5DF; }
	tr.relance4 { background:#AFF5DF; }
	tr.sorti { background:#E6EAC9; }
	tr.erreur_bank { background:#FFF8DC; }
	</style>
	
	<?php
		fin_boite_info();
		}
	?>


	<div style="width:150pt; text-align: left;">
		<ul style='text-align: left;'>
		<img src="#CHEMIN{'images/admin-12.gif'}" title="<:inscription2:fiche_adherent:>"> Admin<br/>
		<img src="#CHEMIN{'images/redac-12.gif'}" title="<:inscription2:fiche_adherent:>"> Auteur<br/>
		<img src="#CHEMIN{'images/adherent-12.gif'}" title="<:inscription2:fiche_adherent:>"> Adherent<br/>
		<img src="#CHEMIN{'images/aconf-12.gif'}" title="<:inscription2:fiche_adherent:>"> A confirmer<br/>
		<img src="#CHEMIN{'images/defaut-12.gif'}" title="<:inscription2:fiche_adherent:>"> Autre<br/>
		</ul>
	</div>
	
</div>	

<div style="margin:0% 2% 2% 23%">
	<h2><strong><:inscription2:liste_adherents:></strong></h2>
	<div style="margin:10px 0px;height:40px" >
		<div style="float:right" >
		<form method="post" action="?exec=inscription2_adherents">
		<input type="text" name="valeur" onfocus='this.value=""' size="10" value="<:info_rechercher:>">
		<select name="case" id="case">
			<option value="id">ID</option>
		<?php
			foreach(lire_config('inscription2') as $cle => $val){
				if($val!= '' and ereg("^.+_table$", $cle)){
					$cle = str_replace("_table", "", $cle);
					echo "<option value='$cle'>"._T('inscription2:'.$cle)."</option>";
				}
			}
		?>
		</select>
		<input type="submit" value="<:info_rechercher:>" />
		</form>
		</div>
	<?php
	include_spip('base/abstract_sql');
	
	$url = "?exec=inscription2_adherents";
	//supprimer un auteur ou nettoyer 
	$id=_request('id');
	$act=_request('act');
	
	//rechercher
	$valeur=_request('valeur');
	$case=_request('case');
	if($case == 'username') $case = 'login';
	if (isset($valeur)) {
		if($case=='id'){
			$critere="a.id_auteur='$valeur'";
		}else
			$critere="$case='$valeur'"; 
	}else
		$critere="a.id_auteur<>'0'"; 
		
	//pagination
	$max_par_page=30;
	$debut=_request('debut');
	if (empty($debut)) 
		$debut=0; 
	
	//ordre
	$ordre =_request('ordre');
	$desc = _request('desc');
	
	if(empty($ordre))
		$ordre = 'id_auteur '.$desc;
	else
		$ordre .= ' '.$desc;
	
	if($desc=='DESC')
		$desc = 'ASC';
	else
		$desc = 'DESC';
	

	//$url = $url.'&debut='.$debut;
	
	//supprimer un auteur
	if(!empty($id) and $act=='sup'){
		spip_query("DELETE FROM spip_auteurs WHERE id_auteur='$id'");
		spip_query("DELETE FROM spip_auteurs_elargis WHERE id_auteur='$id'");
		spip_query("DELETE FROM spip_zones_auteurs WHERE id_auteur='$id'");
		spip_query("DELETE FROM spip_auteurs_listes WHERE id_auteur='$id'");
	}

	//nettoyer la table
	if($act=='net'){
		$desc = spip_abstract_showtable('spip_auteurs_elargis', '', true);
		foreach($desc['field'] as $cle =>$val){
			if(!(lire_config('inscription2/'.$cle) or lire_config('inscription2/'.$cle.'_fiche') 
				or lire_config('inscription2/'.$cle.'_fiche_mod') or lire_config('inscription2/'.$cle.'_table')) 
				and $cle != 'id' and $cle != 'id_auteur' and $cle != 'spip_listes_format')
				$a = spip_query('ALTER TABLE spip_auteurs_elargis DROP COLUMN '.$cle);
		}
	}

	$lettre = array();
		$qlettre = spip_query(
	'select distinct upper(left(a.nom,1)) l, count(*) from spip_auteurs a left join spip_auteurs_elargis b on a.id_auteur = b.id_auteur group by l order by l');
		$count = 0;
		while ($rlettre = spip_fetch_array($qlettre, SPIP_NUM)) {
			$lettre[$rlettre[0]] = $count;
			$count += intval($rlettre[1]);
		}

	foreach ($lettre as $key => $val) {
				if ($val == $debut)
					echo "<b>$key</b> ";
				else
					echo "<a href='".parametre_url($url,'debut',$val)."'>$key</a> ";
			}
	
	?>
	
	</div>

	<table class="cadre-r" style="clear:right; margin-left:10pt;padding:5px">
	<tr style="background-color : #E0E0E0 ;">
	<?php
		
	echo '<td><strong><a href="'.$url.'&ordre=id_auteur&desc='.$desc.'">ID</a></strong></td>';
	if(lire_config('inscription2/nom_table')){
		echo '<td><strong><a href="'.$url.'&ordre=nom&desc='.$desc.'">'._T('inscription2:nom').'</a></strong></td>';
		$table_auteurs[] = "a.nom";
	}
	if(lire_config('inscription2/prenom_table')){
		echo '<td><strong><a href="'.$url.'&ordre=prenom&desc='.$desc.'">'._T('inscription2:prenom').'</a></strong></td>';
		$table_auteurs[] = "b.prenom";
	}
	if(lire_config('inscription2/email_table')){
		$table_auteurs[] = "a.email";
	}
	foreach(lire_config('inscription2') as $cle => $val){
		if($val!= '' and ereg("^.+_table$", $cle) and $cle!='nom_table' and $cle!='prenom_table' and $cle!='email_table'){
			$cle = str_replace("_table", "", $cle);
			if($cle == 'bio' or $cle == 'statut' or $cle == 'username')
				if($cle == 'username')
					$table_auteurs[] = "a.login";
				else				
					$table_auteurs[] = "a.".$cle;
			elseif($cle == 'pays')
				$table_auteurs[] = "c.pays";
			else
				$table_auteurs[] = "b.".$cle;
			if($cle =='username')
				echo '<td><strong><a href="'.$url.'&ordre=login&desc='.$desc.'">'._T('inscription2:'.$cle).'</a></strong></td>';
			else
				echo '<td><strong><a href="'.$url.'&ordre='.$cle.'&desc='.$desc.'">'._T('inscription2:'.$cle).'</a></strong></td>';
		}
	}
	echo '<td colspan="2" style="text-align:center;"><strong><a href="'.$url.'&ordre=statut&desc='.$desc.'">'._T('inscription2:action_adherent').'</a></strong></td>';
	echo '<td><strong>'._T('inscription2:supprimer_adherent_red').'</strong></td>';
	echo '</tr>';
	
	$table_auteurs[] = 'a.id_auteur';
	$table_auteurs[] = 'a.statut';
	
	if(lire_config('inscription2/pays_table'))
		$query = "SELECT ".join(", ",$table_auteurs)." FROM spip_auteurs a LEFT JOIN spip_auteurs_elargis b 
			ON b.id_auteur = a.id_auteur LEFT JOIN spip_pays c ON b.pays=c.id  WHERE $critere ORDER BY $ordre LIMIT $debut,$max_par_page";
	else 
		$query = "SELECT ".join(", ",$table_auteurs)." FROM spip_auteurs a LEFT JOIN spip_auteurs_elargis b 
			ON b.id_auteur = a.id_auteur  WHERE $critere ORDER BY $ordre LIMIT $debut,$max_par_page";
	$query = spip_query ($query);
	
	$i=0;
	while ($data = spip_fetch_array($query)) {	
		
		//switch statut
		if($i%2 == 0){
		 $class='row';
		 } 
		 else {
		 $class='even';
		 }
		
		echo '<tr class="'.$class.'">';
		
		if(!empty($data['id_auteur']))
			echo '<td>'.$data['id_auteur'].'</td>';
		else 
			echo '<td> </td>';
		
		if(lire_config('inscription2/nom_table') or lire_config('inscription2/email_table')){
			if(!empty($data['nom']) and !empty($data['email']))
				echo '<td><a href="mailto:'.$data['email'].'">'.$data['nom'].'</a></td>';
			elseif(!empty($data['nom']))
				echo '<td>'.$data['nom'].'</td>';
			elseif(!empty($data['email']))
				echo '<td><a href="mailto:'.$data['email'].'">'.$data['email'].'</a></td>';
			else
				echo '<td> </td>';
		}
		if(lire_config('inscription2/prenom_table')){
			if(!empty($data['prenom']))
				echo '<td>'.$data['prenom'].'</td>';
			else
				echo '<td> </td>';
		}
		foreach(lire_config('inscription2') as $cle => $val){
			if($val!= '' and ereg("^.+_table$", $cle) and $cle!='nom_table' and $cle!='prenom_table' and $cle!='email_table'){
				$cle = str_replace("_table", "", $cle);
				if($cle == 'username')
					$cle = 'login';
				if(!empty($data[$cle]))
					echo '<td>'.$data[$cle].'</td>';
				else 
					echo '<td> </td>';
			}
		}
		echo '<td><a href="?exec=editer_adherent&id='.$data['id_auteur'].'"><img src="'._DIR_PLUGIN_INSCRIPTION2.'/images/edit-12.gif" title="'._T('inscription2:editer_adherent').'"></a></td>';
		
		if($data['statut']=='0minirezo')
			$url_logo = '"'._DIR_PLUGIN_INSCRIPTION2.'/images/admin-12.gif"';
		elseif($data['statut']=='1comite')
			$url_logo = '"'._DIR_PLUGIN_INSCRIPTION2.'/images/redac-12.gif"';
		elseif($data['statut']=='6forum')
			$url_logo = '"'._DIR_PLUGIN_INSCRIPTION2.'/images/adherent-12.gif"';
		elseif($data['statut']=='aconfirmer')
			$url_logo = '"'._DIR_PLUGIN_INSCRIPTION2.'/images/aconf-12.gif"';
		else
			$url_logo = '"'._DIR_PLUGIN_INSCRIPTION2.'/images/defaut-12.gif"';
			
		echo '<td><a href="?exec=auteur_infos&id_auteur='.$data['id_auteur'].'"><img src='.$url_logo.' title="'._T('inscription2:fiche_adherent').'"></a></td>';
		if($data['statut'] != '0minirezo' and $data['statut'] != '1comite')
			echo '<td><a href="?exec=inscription2_adherents&id='.$data['id_auteur'].'&act=sup" class="confirm"><img src="'._DIR_PLUGIN_INSCRIPTION2.'/images/poubelle-12.gif" title="'._T('inscription2:supprimer_adherent').'"></a></td>';
		else 
			echo '<td><img src="'._DIR_PLUGIN_INSCRIPTION2.'/images/interdit-12.gif" title="'._T('inscription2:supprimer_adherent').'"></td>';
		echo '</tr>';
	$i++;	
	}
	?>
	</table>	

	<div style="margin:10px;font-size:0.7em">
	<?php
	$query = spip_query("SELECT COUNT(*) FROM spip_auteurs a WHERE $critere");
	$query = spip_fetch_array($query);
	$nombre_selection = $query['COUNT(*)'];
	$pages=intval($nombre_selection/$max_par_page) + 1;

	if ($pages != 1)	{
		for ($i=0;$i<$pages;$i++)	{ 
			$position= $i * $max_par_page;
			if ($position == $debut)	{
				echo '<strong>'.$position.' </strong>';
			}
			else {
				echo '<a href="'.generer_url_ecrire("inscription2_adherents","debut=$position&ordre=$ordre").'">'.$position.'</a> ';
			}
		}
	}	
	
	?>
	</div>

</div>

</div>


<!-- Confirm Dialog -->
<div class="jqmConfirm" id="confirm">

	<div id="ex3b" class="jqmConfirmWindow">
    <div class="jqmConfirmTitle clearfix">
    <h1>Confirmation </h1><a href="#" class="jqmClose"><em>Close</em></a>
	</div>
  
	<div class="jqmConfirmContent">
	<p class="jqmConfirmMsg"></p>
	<p>êtes vous sûr(e) de voloir continuer?</p>
	<p>Toutes les modifications seront irreversibles!!!</p>
	</div>
  
	<input type="submit" value="no" />
	<input type="submit" value="yes" />  
</div>