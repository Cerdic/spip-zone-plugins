#CACHE{0}
[<link rel="stylesheet" media="all" type="text/css" href="(#CHEMIN{css/jqModal_confirm.css}|direction_css)" />]

<script src="#CHEMIN{javascript/jqModal.js}" type="text/javascript"></script>
<script type="text/javascript">
/* Overriding Javascript's Alert Dialog */
function confirm(msg,callback) {
	$('#confirm')
		.jqmShow()
		.find('p.jqmConfirmMsg')
		.html(msg)
		.end()
		.find(':submit:visible')
		.click(function(){
			if(this.value == 'yes')
				(typeof callback == 'string') ?
				window.location.href = callback :
				callback;
			$('#confirm').jqmHide();
		});
}

// trigger a confirm whenever links of class alert are pressed.
$().ready(function() {
  $('#confirm').jqm({overlay: 88, modal: true, trigger: false});
  
  // trigger a confirm whenever links of class alert are pressed.
  $('a.confirm').click(function() { 
    confirm('',this.href); 
    return false;
  });
});
</script>


<div id="conteneur">

<div id="menu">
	#INCLURE{fond=prive/menu_inscription2}	
</div>

<div id="principal" class="inscription2_liste">
	<div id="tetiere" >
	
	<div style="margin-bottom:5px">
	<form method="post" action="#SELF">
		[(#SELF|form_hidden)]
		<input class="search_field fondl" type="text" name="valeur" onfocus='this.value=""' value="[(#ENV{valeur}|?{#ENV{valeur},<:info_rechercher:>})]" />
		<select name="case" id="case" class="fondl" style="padding:2px">
			#SET{case,#ENV{case}}
			<BOUCLE_recherchefields(POUR){tableau #CONFIG{inscription2}}{valeur = 'on'}>
			[(#CLE|match{_table}|oui)
				[(#SET{cle,[(#CLE|replace{'_table',''})]})]
				[(#GET{cle}|=={#GET{case}}|oui)
					<option value='#GET{cle}' selected>[(#VAL{inscription2:}|concat{#GET{cle}}|_T)]</option>
				]
				[(#GET{cle}|=={#GET{case}}|non)
					<option value='#GET{cle}'>[(#VAL{inscription2:}|concat{#GET{cle}}|_T)]</option>
				]
			]
			</BOUCLE_recherchefields>
		</select>
		<input type="submit" class="fondo" value="<:info_rechercher:>" />
		</form><a href='[(#SELF|parametre_url{debut,''}|parametre_url{ordre,''}|parametre_url{desc,''})]'> tous</a>
	</div>
	<?php
	include_spip('base/abstract_sql');
	
	$url = self();
	//supprimer un auteur ou nettoyer 
	$id=_request('id');
	$act=_request('act');
	
	//rechercher
	$valeur=_request('valeur');
	$case=_request('case');

	if (isset($valeur)) {
		if($case=='id'){
			$critere="id_auteur='$valeur'";
		}
		elseif($case=='email'){
			$critere="email='$valeur'";
		}else
			$critere="$case LIKE '$valeur%'";
	}else{
		$critere="id_auteur<>'0'"; 
		//que les abonnes si le plugin est actif
		if(defined('_DIR_PLUGIN_ABONNEMENT') AND _request('statut_abonnement') !='tous') $critere = $critere." AND b.statut_abonnement IN ('prospect','sorti','abonne','relance') [AND b.statut_abonnement='(#ENV{statut_abonnement})']" ;
		}
		
	//pagination
	$max_par_page=30;
	$debut=_request('debut_auteurs_elargis')?_request('debut_auteurs_elargis') : 0;
	
	//ordre
	$ordre =_request('ordre');
	$desc = _request('desc');
	
	if(empty($ordre)){
		$ordre = 'id_auteur '.$desc;
		//plutot trier par maj (a creer) 
		if(defined('_DIR_PLUGIN_ABONNEMENT') AND lire_config('inscription2/creation') ) $ordre = 'creation DESC';
	}else{
		$ordre .= ' '.$desc;
	}
	
	if($desc=='DESC')
		$desc = 'ASC';
	else
		$desc = 'DESC';
	
	//supprimer un auteur
	if(!empty($id) and $act=='sup'){
		$row = sql_getfetsel("statut","spip_auteurs","id_auteur='$id'");
		
		if($row['statut'] !='0minirezo' and $row['statut'] !='1comite')
			sql_delete("spip_auteurs","id_auteur='$id'");

		sql_updateq("spip_auteurs",array('statut'=>'5poubelle'),"id_auteur='$id'");
		sql_delete("spip_auteurs_elargis","id_auteur='$id'");
                
        if(defined('_DIR_PLUGIN_ACCESRESTREINT'))
            sql_delete("spip_zones_auteurs","id_auteur='$id'");

        if(defined('_DIR_PLUGIN_SPIPLISTES'))
            sql_delete("spip_auteurs_listes","id_auteur='$id'");
	}

	//nettoyer la table
	if($act=='net'){
		$desc = sql_showtable('spip_auteurs_elargis', '', true);
		foreach($desc['field'] as $cle =>$val){
			if(!(lire_config('inscription2/'.$cle) or lire_config('inscription2/'.$cle.'_fiche') 
				or lire_config('inscription2/'.$cle.'_fiche_mod') or lire_config('inscription2/'.$cle.'_table')) 
				and $cle != 'id' and $cle != 'id_auteur' and $cle != 'spip_listes_format')
				$a = spip_query('ALTER TABLE spip_auteurs_elargis DROP COLUMN '.$cle);
		}
	}
	?>
	
	</div>

	
	[(#SET{ordre,[(#SELF|parametre_url{'ordre'})]})]
	[(#ENV{desc}|=={'-1'}|?{[(#SET{desc,1})],[(#SET{desc,-1})]})]
	<INCLURE{fond=prive/table_adherent_auteur}{id_auteur}{ajax}{ordre=#GET{ordre}}{env}>
	
	</div>
</div>

<!-- Confirm Dialog -->
<div class="jqmConfirm" id="confirm">
	<div id="ex3b" class="jqmConfirmWindow">
	    <div class="jqmConfirmTitle clearfix">
	    	<h1>Confirmation </h1><a href="#" class="jqmClose"><em>Close</em></a>
		</div>
		<div class="jqmConfirmContent">
			<p class="jqmConfirmMsg"></p>
			<:inscription2:confirmation:>
		</div>
		<input type="submit" value="no" />
		<input type="submit" value="yes" /> 
	</div>
</div>