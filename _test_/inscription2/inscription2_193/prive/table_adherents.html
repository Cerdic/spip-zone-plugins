[<link rel="stylesheet" media="all" type="text/css" href="(#CHEMIN{css/jqModal_confirm.css}|direction_css)" />]

<script src="#CHEMIN{javascript/jqModal.js}" type="text/javascript"></script>
<script type="text/javascript">
/* Overriding Javascript's Alert Dialog */
function confirm(msg,callback) {
	$('#confirm')
		.jqmShow()
		.find('p.jqmConfirmMsg')
		.html(msg)
		.end()
		.find(':submit:visible')
		.click(function(){
			if(this.value == 'yes')
				(typeof callback == 'string') ?
				window.location.href = callback :
				callback;
			$('#confirm').jqmHide();
		});
}

// trigger a confirm whenever links of class alert are pressed.
	$().ready(function() {
  $('#confirm').jqm({overlay: 88, modal: true, trigger: false});
  
  // trigger a confirm whenever links of class alert are pressed.
  $('a.confirm').click(function() { 
    confirm('',this.href); 
    return false;
  });
});
</script>


<div id="conteneur">

<div id="menu">
		
	[(#PLUGIN{ABONNEMENT}|?{' ',''})
		#INCLURE{fond=inc/menu_abonnement}	
	]
	[(#PLUGIN{ABONNEMENT}|?{'',' '})
		#INCLURE{fond=prive/menu_inscription2}	
	]
</div>

<div id="principal">
	<div id="tetiere" >
		<div style="float:right" >
		[(#PLUGIN{ABONNEMENT}|?{' ',''})
			[(#INCLURE{fond=inc/statuts_forms}{statut_abonnement=[(#ENV{statut_abonnement})]} )]
		]
		
		</div>
	
	<div style="margin-bottom:5px">
	<form method="post" action="?exec=inscription2_adherents">
		[(#SELF|form_hidden)]
		<input class="search_field fondl" type="text" name="valeur" onfocus='this.value=""' value="<:info_rechercher:>" />
		<select name="case" id="case" class="fondl" style="padding:2px">
		<?php
			$case=_request('case');
			foreach(lire_config('inscription2') as $cle => $val){
				if($val!= '' and $cle!='id_table' and ereg("^.+_table$", $cle)){
					$cle = str_replace("_table", "", $cle);
					if ($cle == $case){
						echo "<option value='$cle' selected>"._T('inscription2:'.$cle)."</option>";
					}
					else{
						echo "<option value='$cle'>"._T('inscription2:'.$cle)."</option>";					
					}
				}
			}
		?>
		</select>
		<input type="submit" class="fondo" value="<:info_rechercher:>" />
		</form>
	</div>
	<?php
	include_spip('base/abstract_sql');
	
	$url = "?exec=inscription2_adherents";
	//supprimer un auteur ou nettoyer 
	$id=_request('id');
	$act=_request('act');
	
	//rechercher
	$valeur=_request('valeur');
	$case=_request('case');

	if (isset($valeur)) {
		if($case=='id'){
			$critere="a.id_auteur='$valeur'";
		}else
			$critere="$case='$valeur'"; 
	}else{
		$critere="a.id_auteur<>'0'"; 
		//que les abonnes si le plugin est actif
		if(defined('_DIR_PLUGIN_ABONNEMENT') AND _request('statut_abonnement') !='tous') $critere = $critere." AND b.statut_abonnement IN ('prospect','sorti','abonne','relance') [AND b.statut_abonnement='(#ENV{statut_abonnement})']" ;
		}
		
	//pagination
	$max_par_page=30;
	$debut=_request('debut_auteurs_elargis')?_request('debut_auteurs_elargis') : 0;
	
	//ordre
	$ordre =_request('ordre');
	$desc = _request('desc');
	
	if(empty($ordre)){
		$ordre = 'id_auteur '.$desc;
		//plutot trier par maj (a creer) 
		if(defined('_DIR_PLUGIN_ABONNEMENT') AND lire_config('inscription2/creation') ) $ordre = 'creation DESC';
	}else{
		$ordre .= ' '.$desc;
	}
	
	if($desc=='DESC')
		$desc = 'ASC';
	else
		$desc = 'DESC';
                
	//$url = $url.'&debut='.$debut;
	
	//supprimer un auteur
	if(!empty($id) and $act=='sup'){
		$row = sql_getfetsel("statut","spip_auteurs","id_auteur='$id'");
		
		if($row['statut'] !='0minirezo' and $row['statut'] !='1comite')
			sql_delete("spip_auteurs","id_auteur='$id'");

		sql_updateq("spip_auteurs",array('statut'=>'5poubelle'),"id_auteur='$id'");
		sql_delete("spip_auteurs_elargis","id_auteur='$id'");
                
        if(defined('_DIR_PLUGIN_ACCESRESTREINT'))
            sql_delete("spip_zones_auteurs","id_auteur='$id'");

        if(defined('_DIR_PLUGIN_SPIPLISTES'))
            sql_delete("spip_auteurs_listes","id_auteur='$id'");
	}

	//nettoyer la table
	if($act=='net'){
		$desc = sql_showtable('spip_auteurs_elargis', '', true);
		foreach($desc['field'] as $cle =>$val){
			if(!(lire_config('inscription2/'.$cle) or lire_config('inscription2/'.$cle.'_fiche') 
				or lire_config('inscription2/'.$cle.'_fiche_mod') or lire_config('inscription2/'.$cle.'_table')) 
				and $cle != 'id' and $cle != 'id_auteur' and $cle != 'spip_listes_format')
				$a = spip_query('ALTER TABLE spip_auteurs_elargis DROP COLUMN '.$cle);
		}
	}

	$lettre = array();
		$qlettre = spip_query('select distinct upper(left(a.nom,1)) l, count(*) from spip_auteurs a left join spip_auteurs_elargis b on a.id_auteur = b.id_auteur group by l order by l');
		$count = 0;
		while ($rlettre = sql_fetch($qlettre)) {
			$lettre[$rlettre[0]] = $count;
			$count += intval($rlettre[1]);
		}

	foreach ($lettre as $key => $val) {
				if ($val == $debut)
					echo "<b>$key</b> ";
				else
					echo "<a href='".parametre_url($url,'debut',$val)."'>$key</a> ";
			}
		echo "<a href='[(#SELF|parametre_url{debut,''})]'> tous</a> ";
	?>
	
	</div>
	<form method="post" action="#">
	<table class="cadre-r">
	<thead>
		<tr>
	<?php
	echo '<td><strong><a href="'.$url.'&amp;ordre=id_auteur&amp;desc='.$desc.'"> <img src="'._DIR_PLUGIN_INSCRIPTION2.'images/admin-12.gif" alt="admin" /></a></strong></td>';
	
	foreach(lire_config('inscription2') as $cle => $val){
		if($val!= '' and ereg("^.+_table$", $cle) and $cle!='nom_table'){
			$cle = str_replace("_table", "", $cle);
			if($cle == 'bio' or $cle == 'statut' or $cle == 'login' or $cle == 'email' or $cle == 'nom')
				$table_auteurs[] = "a.".$cle;
			elseif($cle == 'pays')
				$table_auteurs[] = "c.pays";
			elseif($cle == 'pays_pro')
				$table_auteurs[] = "d.pays as pays_pro";
			else
				$table_auteurs[] = "b.".$cle;
			echo '<td><strong><a href="'.parametre_url(parametre_url($url,'ordre',$cle),'desc',$desc).'">'._T('inscription2:'.$cle).'</a></strong></td>';
		}
	}
	//abonnement
	if(defined('_DIR_PLUGIN_ABONNEMENT')){
		echo '<td><a href="#"><strong>Produit</strong></a></td>';
		echo '<td><a href="#"><strong>&Eacute;ch&eacute;ance / quantit&eacute;</strong></a></td>';
		$table_auteurs[] = 'b.statut_abonnement';
	}
	
	echo '<td colspan="3" style="text-align:center;"><strong><a href="'.parametre_url(parametre_url($url,'ordre','statut'),'desc',$desc).'">'._T('inscription2:action_adherent').'</a></strong></td>';
	echo '</tr>';
	echo '</thead>';
	
	//$table_auteurs[] = 'b.id_auteur';
	$table_auteurs[] = 'a.id_auteur';
	$table_auteurs[] = 'a.statut';
		
	if(lire_config('inscription2/pays_table') && lire_config('inscription2/pays_pro_table')) {
		$query = sql_select(join(", ",$table_auteurs),
			"spip_auteurs a 
			LEFT JOIN `spip_auteurs_elargis` b ON b.id_auteur = a.id_auteur
			left join spip_geo_pays c on b.pays=c.id_pays left join spip_geo_pays d on b.pays_pro=d.id_pays",
			"$critere ORDER BY $ordre LIMIT $debut,$max_par_page");
		}
	elseif(lire_config('inscription2/pays_table'))
		$query = sql_select(join(", ",$table_auteurs),"spip_auteurs a LEFT JOIN `spip_auteurs_elargis` b 
			ON b.id_auteur = a.id_auteur LEFT JOIN spip_geo_pays c ON b.pays=c.id_pays","$critere ORDER BY $ordre LIMIT $debut,$max_par_page");
	else
		$query = sql_select(join(", ",$table_auteurs),"spip_auteurs a LEFT JOIN `spip_auteurs_elargis` b 
			ON b.id_auteur = a.id_auteur","$critere ORDER BY $ordre LIMIT $debut,$max_par_page");
		
	$i=0;
	while ($data = sql_fetch($query)) {
		//switch statut
		if($i%2 == 0){
			$class='row';
		} 
		else {
			$class='even';
		}
		//var_dump($data);die();
		if(!empty($data['statut_abonnement'])) $class = $data['statut_abonnement'] ;
		
		if($data['statut']=='0minirezo')
			$url_logo = '"'._DIR_PLUGIN_INSCRIPTION2.'/images/admin-12.gif"';
		elseif($data['statut']=='1comite')
			$url_logo = '"'._DIR_PLUGIN_INSCRIPTION2.'/images/redac-12.gif"';
		elseif($data['statut']=='6forum')
			$url_logo = '"'._DIR_PLUGIN_INSCRIPTION2.'/images/adherent-12.gif"';
		elseif($data['statut']=='aconfirmer')
			$url_logo = '"'._DIR_PLUGIN_INSCRIPTION2.'/images/aconf-12.gif"';
		else
			$url_logo = '"'._DIR_PLUGIN_INSCRIPTION2.'/images/defaut-12.gif"';
		
		echo '<tr class="'.$class.'">';
		$id = $data['id'] ;
		if(!empty($data['id_auteur']))
			echo '<td><a href="'.generer_url_ecrire('auteur_infos','id_auteur='.$data['id_auteur']).'"><img src='.$url_logo.' alt="'._T('inscription2:fiche_adherent').'" /></a></td>';
		else 
			echo '<td> </td>';
		
		foreach(lire_config('inscription2') as $cle => $val){
			if($val!= '' and ereg("^.+_table$", $cle)){
				$cle = str_replace("_table", "", $cle);
				if($cle == 'username'){
					$cle = 'login';
					echo '<td>'.$data['login'].'plop</td>';
				}
				
				if($cle == 'sexe'){
					if(!empty($data['sexe'])){
						$civilite = ($data['sexe'] == 'M')? 'M<sup>r</sup>' : 'M<sup>me</sup>';
						echo '<td>'.$civilite.'</td>';
					}
					else
						echo '<td>N/A</td>';
				}
				else if($cle == 'email'){
					if(!empty($data[$cle])){
						echo '<td><a href="mailto:'.$data['email'].'">'.$data['email'].'</a></td>';
					}
					else{
						echo '<td> </td>';
					}
				}
				else if(!empty($data[$cle]))
					echo '<td>'.$data[$cle].'</td>';
				else 
					echo '<td> </td>';
			}
		}
		//abonnement
		if(defined('_DIR_PLUGIN_ABONNEMENT')){
			$abonnement = sql_fetch(spip_query("select a.libelle, b.validite from `spip_abonnements` a join `spip_auteurs_elargis_abonnements` b where a.id_abonnement=b.id_abonnement and b.id_auteur_elargi='$id'" ));
			$au_numero = sql_fetch(spip_query("select count(id_article) as 'n' from `spip_auteurs_elargis_articles` a where a.id_auteur_elargi='$id'" ));
			if($abonnement["libelle"] =="" AND $au_numero["n"] > 0){
				$libelle = "achat au numero" ;
				$validite = $au_numero["n"] ;
			}else{
				$libelle = $abonnement["libelle"] ;
				$validite = $abonnement["validite"] ;
			}
			echo '<td>'.$libelle.'</td>';
			echo '<td>'.$validite.'</td>';
		}
		
		echo '<td><a href="'.generer_url_ecrire('auteur_infos','id_auteur='.$data['id_auteur']).'"><img src="'._DIR_PLUGIN_INSCRIPTION2.'/images/edit-12.gif" alt="'._T('inscription2:editer_adherent').'" /></a></td>';	
		
		if($data['statut'] != '0minirezo' and $data['statut'] != '1comite')
			echo '<td><a href="'.generer_url_ecrire('inscription2_adherents','id='.$data['id_auteur'].'&act=sup').'" class="confirm"><img src="'._DIR_PLUGIN_INSCRIPTION2.'/images/poubelle-12.gif" alt="'._T('inscription2:supprimer_adherent').'" /></a></td>';
		else 
			echo '<td><img src="'._DIR_PLUGIN_INSCRIPTION2.'/images/interdit-12.gif" alt="'._T('inscription2:supprimer_adherent').'" /></td>';
			echo '<td><input type="checkbox" name="check_aut[]" /></td>' ;
		echo '</tr>';
		$i++;	
	}
	?>
	</table>	
	</form>

	[<div style="margin-left:25%">(#PLUGIN{ABONNEMENT}|?{' ',''})
		#INCLURE{fond=inc/pied_abonnement}</div>
	]
	
	<div id="pagination" class="pagination">
		<BOUCLE_auteurs_elargis(AUTEURS_ELARGIS spip_auteurs){par #ENV{ordre}}{pagination 30}>
		</BOUCLE_auteurs_elargis>
		#PAGINATION
		</B_auteurs_elargis>
	</div>

	</div>
</div>

<!-- Confirm Dialog -->

<div class="jqmConfirm" id="confirm">
	<div id="ex3b" class="jqmConfirmWindow">
	    <div class="jqmConfirmTitle clearfix">
	    	<h1>Confirmation </h1><a href="#" class="jqmClose"><em>Close</em></a>
		</div>
		<div class="jqmConfirmContent">
			<p class="jqmConfirmMsg"></p>
			<:inscription2:confirmation:>
		</div>
		<input type="submit" value="no" />
		<input type="submit" value="yes" /> 
	</div>
</div>