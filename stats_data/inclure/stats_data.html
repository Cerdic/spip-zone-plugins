#CACHE{0}
[(#REM)
Afficher des stats en plus dans l'admin avec des boucles data :
- Le nombre de visites sur la période (en ce moment | aujourd'hui | hier )
- Les articles lus sur la période, ordonnés par nombre de visites
	Array
		a2192 => Array
			visites => 1557
	
		a58360 => Array
			visites => 787
	
- Les domaines affluents (éventuellement d'un article) et leurs liens entrant, ordonnés par leur nombre de visites.
	Array
		monsite => Array
			visites => 1
			0 => http://www.monsite.net/Organisations.html
	
		google => Array
			visites => 4
			0 => http://www.google.ca/
			1 => http://www.google.ht/
			2 => http://www.google.co.in/
			3 => http://www.google.de/
]

[(#REM) Régler la date (actuellement, aujourd'hui, hier) ]

[(#REM) Aujourd'hui : date du jour ]
#SET{date,#DATE|affdate{Y-m-d}}

[(#REM) Actuellement : date du fichier de visite le plus recemment modifié ]
<BOUCLE_derniere_visite(DATA){si #ENV{jour}|non}{source ls,#CHEMIN{tmp/visites}/*}{!par mtime}{0,1}>
#SET{date,#VAL{Y-m-d H:i:s}|date{#MTIME}}
#SET{maj,#GET{date}}
</BOUCLE_derniere_visite>

[(#REM) Hier : date de la veille ]
[(#ENV{jour}|=={veille}|oui) #SET{date,#VAL{Y-m-d}|date{#VAL{-1 day}|strtotime} ]

[(#REM) Peupler les tableaux de stats (articles, domaines affluents) ]

#SET{articles_lus,#ARRAY}
#SET{sites_affluents,#ARRAY}

#SET{reg_domaine,"^[a-zA-Z_-]+://([a-zA-Z]+\.)?([a-zA-Z]+\.)?((?!com|co)[a-zA-Z0-9-_]+)\.((?:com|co)\.)?([a-zA-Z]{2,3})"}
	
[(#REM) Actuellement : Parcourir les fichiers dans tmp/visites et récuperer les données dans deux tableaux (articles lus et sites affluents) ]

<BOUCLE_visites(DATA){source ls,#CHEMIN{tmp/visites}/*}{si #ENV{jour}|non}><BOUCLE_visite(DATA){source file,#FILE}><BOUCLE_pages_vues(DATA){source table,#VALEUR|unserialize}>

#SET{type,#CLE|explode{"	"}|table_valeur{0}}
#SET{id,#CLE|explode{"	"}|table_valeur{1}}
#SET{referrer,#CLE|explode{"	"}|table_valeur{2}}

[(#REM)
	Récupérer les articles lus ordonnés par nombre de visites
]
[(#GET{type}|=={article}|oui)
	
	[(#ENV{id_article}|non)
		#SET{valeurs_actuelles,#GET{articles_lus}|table_valeur{a#GET{id}}|sinon{#ARRAY}}
		#SET{nb_visites,#GET{articles_lus}|table_valeur{a#GET{id}}|table_valeur{visites}|plus{1}}
		#SET{valeurs_actuelles,#GET{valeurs_actuelles}|array_merge{#ARRAY{visites,#GET{nb_visites}}}}
		
		#SET{ajout,#ARRAY{a#GET{id},#GET{valeurs_actuelles}}}
		#SET{articles_lus,#GET{articles_lus}|array_merge{#GET{ajout}}}
	]
	[(#ENV{id_article}|oui)
		[(#ENV{id_article}|=={#GET{id}}|oui)
			#SET{valeurs_actuelles,#GET{articles_lus}|table_valeur{a#GET{id}}|sinon{#ARRAY}}
			#SET{nb_visites,#GET{articles_lus}|table_valeur{a#GET{id}}|table_valeur{visites}|plus{1}}
			#SET{valeurs_actuelles,#GET{valeurs_actuelles}|array_merge{#ARRAY{visites,#GET{nb_visites}}}}
			
			#SET{ajout,#ARRAY{a#GET{id},#GET{valeurs_actuelles}}}
			#SET{articles_lus,#GET{articles_lus}|array_merge{#GET{ajout}}}
		]
	]
]

[(#REM)
	Récupérer les sites affluents ordonnés par leur nombre de visites, et garder les referrers.
]
[(#GET{referrer}|oui)
	#SET{domaine,#GET{referrer}|match{#GET{reg_domaine},"i",3}}
	
	[(#ENV{id_article}|non)
		#SET{valeurs_actuelles,#GET{sites_affluents}|table_valeur{#GET{domaine}}|sinon{#ARRAY}}
		
		#SET{nb_visites,#GET{sites_affluents}|table_valeur{#GET{domaine}}|table_valeur{visites}|plus{1}}
		#SET{valeurs_actuelles,#GET{valeurs_actuelles}|array_merge{#ARRAY{visites,#GET{nb_visites}}}}
	
		#SET{ajout,#ARRAY{#GET{domaine},#GET{valeurs_actuelles}|push{#GET{referrer}}}}
		#SET{sites_affluents,#GET{sites_affluents}|array_merge{#GET{ajout}}}
	]
	[(#ENV{id_article}|=={#GET{id}}|oui)
		#SET{valeurs_actuelles,#GET{sites_affluents}|table_valeur{#GET{domaine}}|sinon{#ARRAY}}
		
		#SET{nb_visites,#GET{sites_affluents}|table_valeur{#GET{domaine}}|table_valeur{visites}|plus{1}}
		#SET{valeurs_actuelles,#GET{valeurs_actuelles}|array_merge{#ARRAY{visites,#GET{nb_visites}}}}
		
		#SET{ajout,#ARRAY{#GET{domaine},#GET{valeurs_actuelles}|push{#GET{referrer}}}}
		#SET{sites_affluents,#GET{sites_affluents}|array_merge{#GET{ajout}}}
	]
]
</BOUCLE_pages_vues></BOUCLE_visite></BOUCLE_visites>
#SET{visites,#TOTAL_BOUCLE}
</B_visites>
	
	[(#REM)
		Cas alternatif avec période précisée : on regarde non pas dans les fichiers de session mais dans la BDD.
		A refaire avec la boucle date stats_referers_to_array du plugin statistiques ?
	]

	[(#REM) Aujourd'hui / hier = boucle data sql pour obtenir les infos à la date demandée. ]
	
	#SET{reqd,#VAL{"select * from spip_visites where date='LADATE' order by maj desc limit 0,1"}|replace{LADATE,#GET{date}}}
	
	<BOUCLE_visites_jour(DATA){si #ENV{jour}}{source sql,#GET{reqd}}>
	#SET{visites,#VISITES}
	#SET{maj,#MAJ}
	
	[(#SET{req,select * from spip_visites_articles where date=[(#DATE|affdate{Y-m-d}|_q)] order by visites desc})]
	
	#SET{demain,#VAL{Y-m-d}|date{#VAL{+1 day}|strtotime{#DATE|strtotime}}
	[(#SET{select,[(#VAL{"select visites_JOUR visites, referer"}|replace{JOUR,[(#ENV{jour})]})]})]
	[(#SET{periode,[(#VAL{"visites_JOUR"}|replace{JOUR,[(#ENV{jour})]})]})]
	
	[(#SET{req_affluents,[(#GET{select})] from spip_referers where [(#GET{periode})] > 0 order by [(#GET{periode})] desc })]
	
	#SET{demain,#VAL{Y-m-d}|date{#VAL{+1 day}|strtotime{#MAJ|strtotime}}}
	
	[(#ENV{id_article}|oui)
		[(#SET{req,select * from spip_visites_articles where date=[(#DATE|affdate{Y-m-d}|_q)] and id_article=[(#ENV{id_article})] order by visites desc})]
		[(#SET{req_affluents,select * from spip_referers_articles where maj > [(#MAJ|affdate{Y-m-d}|_q)] and maj < [(#GET{demain}|_q)] and id_article=[(#ENV{id_article})]})]
	]
	
	</BOUCLE_visites_jour>
	
	[(#REM)
		<hr>
		[(#GET{req})]
		<hr>
		[(#GET{req_affluents})]
		<hr>
	]
	<BOUCLE_articles_jour(DATA){source sql,#GET{req}}>
		
		#SET{valeurs_actuelles,#GET{articles_lus}|table_valeur{a#ID_ARTICLE}|sinon{#ARRAY}}
		
		#SET{nb_visites,#GET{articles_lus}|table_valeur{a#ID_ARTICLE}|table_valeur{visites}|plus{#VISITES}}
		#SET{valeurs_actuelles,#GET{valeurs_actuelles}|array_merge{#ARRAY{visites,#GET{nb_visites}}}}
		
		#SET{ajout,#ARRAY{a#ID_ARTICLE,#GET{valeurs_actuelles}}}
		#SET{articles_lus,#GET{articles_lus}|array_merge{#GET{ajout}}}
		
	</BOUCLE_articles_jour>
	
	#SET{domaines,#ARRAY}
	#SET{valeurs_actuelles,#ARRAY}
	<BOUCLE_affluents_jour_(DATA){source sql,#GET{req_affluents}}>
		#SET{domaine,#REFERER|match{#GET{reg_domaine},"i",3}}
		
		#SET{valeurs_actuelles,#GET{sites_affluents}|table_valeur{#GET{domaine}}|sinon{#ARRAY}}
		#SET{nb_visites,#GET{sites_affluents}|table_valeur{#GET{domaine}}|table_valeur{visites}|plus{#VISITES}}
		#SET{valeurs_actuelles,#GET{valeurs_actuelles}|array_merge{#ARRAY{visites,#GET{nb_visites}}}}
		
		#SET{ajout,#ARRAY{#GET{domaine},#GET{valeurs_actuelles}|push{#REFERER}}}
		#SET{sites_affluents,#GET{sites_affluents}|array_merge{#GET{ajout}}}
	</BOUCLE_affluents_jour_>
	
<//B_visites>

[(#ENV{id_article}|oui) #SET{visites,#GET{articles_lus}|table_valeur{a#ENV{id_article}}|table_valeur{visites}} ]


[(#REM)
	Affichage final des données enregistrées dans les tableaux.
]

<style type="text/css">
#data_stats{
	margin:0 0 40px 0;
}
#data_stats li > p{
	margin-left:10px;
}
#data_stats > li {
	float:left;
	width:33%;
	list-style-type:none;
	text-align:center;
}
#data_stats ul{
	margin:0;
	padding:0;
	list-style-type:none;
}
.stats_valeur{
	margin-top: 0.3em;
	font-size:3.8em;
	font-weight:bold;
	line-height: 1em;
}
.stats_visites #data_stats > li{
	height:250px;
	overflow:auto;
}
.onglets_simple ul li{
	display:inline;
}
.valeur{
	max-height:500px;
	overflow:auto;
	text-align:left;
}
.stats_contenu p{
	margin:0 0 20px 0;
}
</style>

[(#REM) Menu date ]

<div class="onglets_simple clearfix">
	<ul>
		<li>[(#SELF|parametre_url{jour,''}|lien_ou_expose{En ce moment,[(#ENV{jour,''}|non)],ajax})]</li>
		<li>[(#SELF|parametre_url{jour,jour}|lien_ou_expose{<:date_aujourdhui|ucfirst:>,#ENV{jour,''}|=={jour},ajax})]</li>
		<li>[(#SELF|parametre_url{jour,veille}|lien_ou_expose{<:date_hier|ucfirst:>,#ENV{jour,''}|=={veille},ajax})]</li>
	</ul>
</div>

[(#REM) Afficher les tableaux ]

[(#REM)
[<pre><code>(#GET{articles_lus}|print_r{1})</code></pre>]
[<pre style="height:300px;overflow:auto"><code>(#GET{sites_affluents}|print_r{1})</code></pre>]
]

<div id="conteneur_stats">
	
	[(#REM) Afficher la date ]
	
	[<h2><a href="[(#SELF|parametre_url{id_article,''})]">(#GET{date}|affdate)</a><small title="Dernière mise à jour le [(#GET{maj}|affdate)] [ (#GET{maj}|affdate{H\hi s})s]"> — [ (#GET{maj}|affdate{H\hi})</small>]</h2>]
	
	[(#REM) Afficher les données du tableau ]
	
	<ul id="data_stats">
		
		#SET{stat,#GET{visites}|number_format{0,""," "}}
		#SET{milliers,#GET{stat}|match{(\d+ )(\d)\d\d,u,1}}
		#SET{centaines,#GET{stat}|match{(\d+) (\d)\d\d,u,2}}
		[(#GET{milliers}|oui)
			#SET{stat_court,#GET{milliers}|trim|concat{","}|concat{#GET{centaines}&nbsp;K}|replace{",0"}}
		]
		[(#GET{milliers}|non)
			#SET{stat_court,#GET{stat}}
		]
		<li>
			<div class="stats_contenu" style="padding-right:20px;">
				<div class="stats_valeur" title="[(#GET{stat})] visites">[(#GET{stat_court})]</div>
				<p><strong>visite[(#GET{stat}|>{1}|?{s})] [(#ENV{jour}|non)<br><small>en&nbsp;cours</small>]</strong></p>
			</div>
		</li>
		
		#SET{stat,#GET{articles_lus}|sizeof||number_format{0,""," "}}
		#SET{milliers,#GET{stat}|match{(\d+ )(\d)\d\d,u,1}}
		#SET{centaines,#GET{stat}|match{(\d+) (\d)\d\d,u,2}}
		[(#GET{milliers}|oui)
			#SET{stat_court,#GET{milliers}|trim|concat{","}|concat{#GET{centaines}&nbsp;K}|replace{",0"}}
		]
		[(#GET{milliers}|non)
			#SET{stat_court,#GET{stat}}
		]
		<li>
			<div class="stats_contenu" style="padding-right:20px;">
				<div class="stats_valeur" title="[(#GET{stat})] articles lus">[(#GET{stat_court})]</div>
				<p><strong>articles lu[(#GET{stat}|>{1}|?{s})]</strong></p>
				<B_articles>
				#ANCRE_PAGINATION
				<ul class="valeur">
					<BOUCLE_articles(DATA){source table,#GET{articles_lus}}{!par visites}{pagination 50}>
					<li>
					<BOUCLE_article(ARTICLES){id_article=#CLE|replace{^a}}>
					<small><a href="[(#SELF|parametre_url{id_article,#ID_ARTICLE})]">[(#VISITES)] visites</a></small>
						 - <a href="[(#URL_ARTICLE)]">#TITRE</a>
					</BOUCLE_article>
					</li>
					</BOUCLE_articles>
				</ul>
				<p style="margin:10px">#PAGINATION</p>
				</B_articles>
			</div>
		</li>
		
		<BOUCLE_total_visites_domaine(DATA){source table,#GET{sites_affluents}}>
			#SET{total,#GET{total}|plus{#VISITES}}
		</BOUCLE_total_visites_domaine>
		
		<B_affluents>
		<li>
			#SET{stat,#GET{total}|number_format{0,""," "}}
			#SET{milliers,#GET{stat}|match{(\d+ )(\d)\d\d,u,1}}
			#SET{centaines,#GET{stat}|match{(\d+) (\d)\d\d,u,2}}
			[(#GET{milliers}|oui)
				#SET{stat_court,#GET{milliers}|trim|concat{","}|concat{#GET{centaines}&nbsp;K}|replace{",0"}}
			]
			[(#GET{milliers}|non)
				#SET{stat_court,#GET{stat}}
			]
			<div class="stats_contenu">
				<div class="stats_valeur" title="[(#GET{stat})] visites">[(#GET{stat_court})]</div>
				<p style="margin-bottom:0;"><strong>visite[(#GET{stat}|>{1}|?{s})]<br><small>par&nbsp;[(#GRAND_TOTAL|number_format{0," "," "})]&nbsp;domaine[(#GRAND_TOTAL|>{1}|?{s})] affluent[(#GRAND_TOTAL|>{0}|?{s})]</small></strong></p>
				#ANCRE_PAGINATION
				<ul class="valeur">
					<BOUCLE_affluents(DATA){source table,#GET{sites_affluents}}{!par visites}{pagination 10}>
					<li>
						<h3>[(#CLE|ucfirst)] <small>([(#VISITES) visite[(#VISITES|>{1}|?{s})]])</small></h3>
						
						<B_referers_>
						<ul style="margin-bottom:10px;height:4em;overflow:auto;">
						<BOUCLE_referers_(DATA){source table, #VALEUR|array_unique}{cle!=visites}{par valeur}>
							[<li><a href="(#VALEUR)">[(#VALEUR|replace{^https?://}|replace{"\?.*$"}|couper{30})]</a></li>]
						</BOUCLE_referers_>
						</ul>
						</B_referers_>
					</li>
					</BOUCLE_affluents>
				</ul>
				<p style="margin:10px">#PAGINATION</p>
			</div>
		</li>
		</B_affluents>
	</ul>
	
</div>
<p style="text-align:center;clear:both;">...</p>
