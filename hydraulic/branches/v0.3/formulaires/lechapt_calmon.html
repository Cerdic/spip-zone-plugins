[<div class='hyd_formulaire_erreur '><span>(#ENV*{message_erreur})</span></div>]
<script language="javascript" type="text/javascript" src="#CHEMIN{js/hyd_fonctions.js}"></script>
<script>
// Permet de switcher les valeur de L, M et N en fonction du matériau choisis
function change_valeur() {
    /*
     * Le select commence à 1 donc on diminue son indice de 1 vu qu'on utilise un tableau pour stocker
     * les valeurs (on commence a 0)
     */
    var choix_mat = getSelectValue('choix_materiau')-1;
    var materiau = new Array();

    <BOUCLE_mat1(POUR){tableau #ENV{mes_saisies_materiaux}}>
        <BOUCLE_mat2(POUR){tableau #VALEUR}>
            materiau.push('#VALEUR');
        </BOUCLE_mat2>
    </BOUCLE_mat1>

   document.getElementById('champs_L').value=materiau[choix_mat*3];
   document.getElementById('champs_M').value=materiau[(choix_mat*3)+1];
   document.getElementById('champs_N').value=materiau[(choix_mat*3)+2];
}

// Retourne sous forme de tableau tous les élèments de la Class classe et de type tagName
function elementsParClasse(classe, tagName){
    var divs = document.getElementsByTagName(tagName);
    var resultats = new Array();
    for(var i=0; i<divs.length; i++){
        if(divs[i].className == classe){
            resultats.push(divs[i]);
        }
    }
    return resultats;
}

// Tableau contenant tous les choix des groupes de boutons radios
var glob = [];

// Variables globales contenant le choix fait pour chaque ligne
<BOUCLE_sans_coeff(POUR){tableau #ENV{tableau_caract}}>
    glob['#VALEUR'] = '#ENV{choix_champs_#VALEUR}';
</BOUCLE_sans_coeff>

// Mise a jour des variables globales
function setVarGlob(){
    <BOUCLE_sans_coeff2(POUR){tableau #ENV{tableau_caract}}>
        // On récupère le choix effectué parmis les groupes de champs radios.
        glob['#VALEUR'] = getRadioValue('choix_champs_#VALEUR');
    </BOUCLE_sans_coeff2>
}

// Gére le comportement des boutons radios
function gestion_radios(nom,valeur){

    // Ce tableau contiendra tous les indices , ainsi que leur valeur, excepté celle qui a été cliquée
    var tabPartiel = {
        <BOUCLE_sans_coeff3(POUR){tableau #ENV{tableau_caract}}>
            '#VALEUR' : glob['#VALEUR'],
        </BOUCLE_sans_coeff3>
    };

    // On supprime du tableau l'élément sur lequel on a cliqué
    delete(tabPartiel[nom]);

    // Tableau des indices
    var tabIndice = [
        <BOUCLE_sans_coeff4(POUR){tableau #ENV{tableau_caract}}>
            '#VALEUR',
        </BOUCLE_sans_coeff4>
    ];

    if(valeur.substr(0,3) == 'cal'){
        /*
         * Pour toutes les lignes autres que celle passée en paramètre,
         * on contrôle  si il y a déjà une valeur à calculer.
         * Si oui, alors on fais les modifications adéquates sur les champs:
         * sélection, visibilité
         */
        for(var cle in tabPartiel){
            if(document.getElementById('calcul_val_'+cle).checked){
                document.getElementById('val_fixe_'+cle).checked=true;
                document.getElementById('caract_'+cle).disabled=false;
                document.getElementById('caract_'+nom).disabled=true;
                setVarGlob();
            }
        }
    }

    // Si on appuit sur un bouton de type "varier_val" ou "val_fixe"
    else if(valeur.substr(0,3) == 'var' || valeur.substr(0,3)=='val'){
        for(var cle in tabPartiel){
            if(document.getElementById('varier_val_'+cle).checked && (glob[nom] != "calcul_val_"+nom)){
                if(document.getElementById('varier_val_'+nom).checked){
                    document.getElementById('val_fixe_'+cle).checked=true;
                }
                setVarGlob();
            }
            else if(document.getElementById('varier_val_'+cle).checked && (glob[nom] == "calcul_val_"+nom) && valeur.substr(0,3) == 'var'){
                document.getElementById('calcul_val_'+cle).checked=true;
                document.getElementById('caract_'+cle).disabled=true;
                document.getElementById('caract_'+nom).disabled=false;
                setVarGlob();
            }
        }

        // Compte le nombre de calcul_val checké
        var cptValCal = 0;
        for(var cle in glob){
            if(document.getElementById('calcul_val_'+cle).checked){
                cptValCal++;
            }
        }
        // Si aucune calcul_val n'est checké
        if(cptValCal == 0){
            // Alors on chercher l'indice suivant...
            indice = '';
            for(var i = 0; i < tabIndice.length; i++){
                if(tabIndice[i] == nom){
                    // Si on est pas arrivé au dernier élément
                    if(i+1 <= tabIndice.length-1){
                        indice = tabIndice[i+1];
                    }
                    else{
                        indice = tabIndice[0];
                    }
                }

            }
            // ... et on le met a calcul_val
            document.getElementById('calcul_val_'+indice).checked=true;
            document.getElementById('caract_'+nom).disabled=false;
            document.getElementById('caract_'+indice).disabled=true;
            var cacher = elementsParClasse('champs_var_'+indice, 'tr');
            for(var i in cacher){
                cacher[i].style.display='none';
            }
            setVarGlob();
        }
    }

    // Si on appuis sur un bouton de type varier_val
    if(valeur.substr(0,3) == 'var'){
        setVarGlob();
        document.getElementById('caract_'+nom).disabled=true;
        for(var cle in glob){
            if(glob[cle].substr(0,3) == 'val'){
                document.getElementById('caract_'+cle).disabled=false;
            }
        }

        // on affiche les champs correspondant au bouton sélectionné
        var afficher = elementsParClasse('champs_var_'+nom, 'tr');
        for(var i in afficher){
            afficher[i].style.display='table-row';
        }
        // On cache tous les autres champs de variations.
        for(var cle in tabPartiel){
            var cacher = elementsParClasse('champs_var_'+cle, 'tr');
            for(var i in cacher){
                cacher[i].style.display='none';
            }
        }

        setVarGlob();
    }

    // Compte le nombre de varier_val checké
    var cptVarVal = 0;
    for(var cle in glob){
        if(document.getElementById('varier_val_'+cle).checked){
            cptVarVal++;
        }
    }

    if(cptVarVal == 0){
        for(var cle in glob){
            if(glob[cle].substr(0,3) != 'cal'){
                document.getElementById('caract_'+cle).disabled=false;
            }
        }
        var cacher = elementsParClasse('champs_var_'+nom, 'tr');
        for(var i in cacher){
            cacher[i].style.display='none';
        }
    }

    setVarGlob();
}
</script>
<form method="post" action="#ENV{action}" id="form_lechapt_calmon">
   #ACTION_FORMULAIRE{#ENV{action}}
   <table class="hyd_formulaire">
      <tbody>
            <tr id="type_materiau_field">
                <td colspan="5"><div class="hyd_formulaire_chapitre"><:hydraulic:type_materiau:></div></td>
            </tr>

            <tr id="type_materiau_choix">
                <td align="right">
                    <:hydraulic:choix_materiau:> :
                </td>

                <td colspan="4">
                    <select name="typeMateriau" id="choix_materiau" onChange="change_valeur();">
                        <option value="1" [(#ENV{typeMateriau}|=={'1'}|?{'selected',''})]><:hydraulic:fonte_beton_corrosive:></option>
                        <option value="2" [(#ENV{typeMateriau}|=={'2'}|?{'selected',''})]><:hydraulic:fonte_beton_ncorrosive:></option>
                        <option value="3" [(#ENV{typeMateriau}|=={'3'}|?{'selected',''})]><:hydraulic:fonte_revt_ciment:></option>
                        <option value="4" [(#ENV{typeMateriau}|=={'4'}|?{'selected',''})]><:hydraulic:fonte_revt_bitume:></option>
                        <option value="5" [(#ENV{typeMateriau}|=={'5'}|?{'selected',''})]><:hydraulic:acier_lamine:></option>
                        <option value="6" [(#ENV{typeMateriau}|=={'6'}|?{'selected',''})]><:hydraulic:fonte_revt_centrifuge:></option>
                        <option value="7" [(#ENV{typeMateriau}|=={'7'}|?{'selected',''})]><:hydraulic:pvc:></option>
                        <option value="8" [(#ENV{typeMateriau}|=={'8'}|?{'selected',''})]><:hydraulic:tuyau_lisse1:></option>
                        <option value="9" [(#ENV{typeMateriau}|=={'9'}|?{'selected',''})]><:hydraulic:tuyau_lisse2:></option>
                    </select>

                    [<div class='hyd_erreur'>(#ENV**{erreurs}|table_valeur{[(#VALEUR|table_valeur{0})]})</div>]

                </td>
            </tr>

            #SET{tableau_coeff,#ARRAY{1,L,2,M,3,N}}
            <BOUCLE_coeff(POUR) {tableau #GET{tableau_coeff}}>
                <tr id="materiau_coeff_#VALEUR">
                    <td align="right">
                        #VALEUR :
                    </td>

                    <td>
                        <input id="champs_#VALEUR" type="text" value="#ENV{#VALEUR}" maxlength="30" name="#VALEUR"/>
                        [<div class='hyd_erreur'>(#ENV**{erreurs}|table_valeur{#VALEUR})</div>]
                    </td>
                </tr>
            </BOUCLE_coeff>


            <tr id="caract_lechapt_calmon">
                <td colspan="5"><div class="hyd_formulaire_chapitre"><:hydraulic:caract_lechapt_calmon:></div></td>
            </tr>

            <tr>
                <td colspan="2"></td>
                <td align="center"><:hydraulic:calcul_val:></td>
                <td align="center"><:hydraulic:varier_val:></td>
                <td align="center"><:hydraulic:fixer_val:></td>
            </tr>

        <!-- On génère les champs du formulaire en suivant le tableau caract -->
        <BOUCLE_caract(POUR) {tableau #ENV{tableau_caract}}>

            <tr id="type_materiau_caract_#VALEUR">
                <td align="right">
                    [(#NUL|concat{param_,#VALEUR}|traduction_hydraulic)]
                </td>

                <td>
                    <input id="caract_#VALEUR" type="text" value="[(#ENV{choix_champs}|=={#VALEUR}|?{'',#ENV{#VALEUR}})]" maxlength="30" name="#VALEUR" [(#ENV{choix_champs_#VALEUR}|match{^((calcul_val_#VALEUR)|(varier_val_#VALEUR))$}|?{'disabled="true"',''})]/>
                    [<div class='hyd_erreur'>(#ENV**{erreurs}|table_valeur{#VALEUR})</div>]
                </td>

                <!-- Les 3 boutons radios pour le choix de la variable à calculer, varier, ou fixer -->
                <td align="center">
                    <input type="radio" id="calcul_val_#VALEUR" name="choix_champs_#VALEUR" value="calcul_val_#VALEUR" onclick="gestion_radios('#VALEUR', 'calcul_val_#VALEUR')" [(#ENV{choix_champs_#VALEUR}|=={calcul_val_#VALEUR}?{'checked',''})]/>
                </td>

                <td align="center">
                    <input type="radio" id="varier_val_#VALEUR" name="choix_champs_#VALEUR" value="varier_val_#VALEUR" onclick="gestion_radios('#VALEUR', 'varier_val_#VALEUR')" [(#ENV{choix_champs_#VALEUR}|=={varier_val_#VALEUR}?{'checked',''})]/>
                </td>

                <td align="center">
                    <input type="radio" id="val_fixe_#VALEUR" name="choix_champs_#VALEUR" value="val_fixe_#VALEUR" onclick="gestion_radios('#VALEUR', 'val_fixe_#VALEUR')" [(#ENV{choix_champs_#VALEUR}|=={val_fixe_#VALEUR}?{'checked',''})]/>
                </td>
            </tr>

            <!-- Champs pour les variations de calcul. Par défaut non visible. -->
            <tr class="champs_var_#VALEUR" style="display:[(#ENV{choix_champs_#VALEUR}|=={varier_val_#VALEUR}|?{'table-row','none'})];">
                <td colspan="3" align="right"><:hydraulic:val_min:> : </td>
                <td colspan="2">
                    <input name="val_min_#VALEUR" type="text" value="#ENV{val_min_#VALEUR}"/>
                    [<div class='hyd_erreur'>(#ENV**{erreurs}|table_valeur{val_min_#VALEUR})</div>]
                </td>
            </tr>

            <tr class="champs_var_#VALEUR" style="display:[(#ENV{choix_champs_#VALEUR}|=={varier_val_#VALEUR}|?{'table-row','none'})];">
                <td colspan="3" align="right"><:hydraulic:val_max:> :</td>
                <td colspan="2">
                    <input name="val_max_#VALEUR" type="text" value="#ENV{val_max_#VALEUR}"/>
                    [<div class='hyd_erreur'>(#ENV**{erreurs}|table_valeur{val_max_#VALEUR})</div>]
                </td>
            </tr>

            <tr class="champs_var_#VALEUR" style="display:[(#ENV{choix_champs_#VALEUR}|=={varier_val_#VALEUR}|?{'table-row','none'})];">
                <td colspan="3" align="right"><:hydraulic:pas_var:> :</td>
                <td colspan="2">
                    <input name="pas_var_#VALEUR" type="text" value="#ENV{pas_var_#VALEUR}"/>
                    [<div class='hyd_erreur'>(#ENV**{erreurs}|table_valeur{pas_var_#VALEUR})</div>]
                </td>
            </tr>

        </BOUCLE_caract>

            <!-- Fieldset + champs sur la précision du calcul.-->
            <tr id="param_calc_lechapt_calmon">
                <td colspan="5"><div class="hyd_formulaire_chapitre"><:hydraulic:param_calcul:></div></td>
            </tr>

            <tr id="precision_lechapt_calmon">
                <td align="right">
                    <:hydraulic:precision:> :
                </td>
                <td>
                    <input id="champs_rPrec" type="text" value="#ENV{rPrec}" maxlength="30" name="rPrec"/>
                    [<div class='hyd_erreur'>(#ENV**{erreurs}|table_valeur{rPrec})</div>]
                </td>
            </tr>

            <tr>
                <td colspan="5" class="hyd_bouton_submit">
                   <input type="submit" value="<:hydraulic:calculer_lechapt_calmon:>">
                </td>
            </tr>

      </tbody>
   </table>
</form>

[<div class='hydraulic_resultat' id="resultat_lechapt_calmon">(#ENV*{message_ok})</div>]
