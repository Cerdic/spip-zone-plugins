[(#REM)

  Surcharge du plugin medias.
  - Ajout de {par ordre} sur les boucles
  - Ajout du JS ordoc_liste_documents() également.

]
[(#REM) pour permettre d'inclure ce squelette plusieurs fois dans une page, fournir un parametre id_unique dans l'appel]

#SET{nbdocs,0}
<div id="portfolios#ENV{id_unique}" class="portfolios">
[(#REM) D'abord les images illustration]
<B_illustrations>
<h3><span class="image_loading"></span><:medias:info_illustrations:></h3>
<div class="liste_items documents" id="illustrations#ENV{id_unique}">
[<p class="pagination">(#PAGINATION{prive})</p>]
<BOUCLE_illustrations(DOCUMENTS documents_liens types_documents){inclus=image}{mode=image}{id_objet}{objet}{par rang_lien, num titre,date,id_document}{pagination 50}{statut?}>
	#MODELE{document_desc,id_document,id_objet,objet}
</BOUCLE_illustrations>
[<p class="pagination">(#PAGINATION{prive})</p>]
[(#AUTORISER{dissocierdocuments,#OBJET,#ID_OBJET})[(#BOUTON_ACTION{<:medias:lien_tout_enlever:>,#URL_ACTION_AUTEUR{dissocier_document,#ID_OBJET-#OBJET-I/image,#SELF|ancre_url{illustrations}},'ajax tout_supprimer',<:ecrire:lien_tout_supprimer:> ?})]]
</div>
#SET{nbdocs,#GET{nbdocs}|plus{#GRAND_TOTAL}}
</B_illustrations>

[(#REM) puis les images du portfolio]
<B_portfolio>
<h3><:medias:info_portfolio:></h3>
<div class="liste_items documents" id="portfolio#ENV{id_unique}">
[<p class="pagination">(#PAGINATION{prive})</p>]
<BOUCLE_portfolio(DOCUMENTS documents_liens types_documents){inclus=image}{mode=document}{id_objet}{objet}{par rang_lien, num titre,date,id_document}{pagination 50}{statut?}>
	#MODELE{document_desc,id_document,id_objet,objet}
</BOUCLE_portfolio>
[<p class="pagination">(#PAGINATION{prive})</p>]
[(#AUTORISER{dissocierdocuments,#OBJET,#ID_OBJET})[(#BOUTON_ACTION{<:medias:lien_tout_enlever:>,#URL_ACTION_AUTEUR{dissocier_document,#ID_OBJET-#OBJET-I/document,#SELF|ancre_url{portfolio}},'ajax tout_supprimer',<:ecrire:lien_tout_supprimer:> ?})]]
</div>
#SET{nbdocs,#GET{nbdocs}|plus{#GRAND_TOTAL}}
</B_portfolio>

[(#REM) puis les documents]
<B_documents>
<h3><:medias:info_documents:></h3>
<div class="liste_items documents" id="documents#ENV{id_unique}">
[<p class="pagination">(#PAGINATION{prive})</p>]
<BOUCLE_documents(DOCUMENTS documents_liens types_documents){inclus!=image}{mode!=vignette}{id_objet}{objet}{par rang_lien, num titre,date,id_document}{pagination 50}{statut?}>
	#MODELE{document_desc,id_document,id_objet,objet}
</BOUCLE_documents>
[<p class="pagination">(#PAGINATION{prive})</p>]
[(#AUTORISER{dissocierdocuments,#OBJET,#ID_OBJET})[(#BOUTON_ACTION{<:medias:lien_tout_enlever:>,#URL_ACTION_AUTEUR{dissocier_document,#ID_OBJET-#OBJET-D/document,#SELF|ancre_url{documents}},'ajax tout_supprimer',<:ecrire:lien_tout_supprimer:> ?})]]
</div>
#SET{nbdocs,#GET{nbdocs}|plus{#GRAND_TOTAL}}
</B_documents>

<script type="text/javascript">/*<![CDATA[*/
var multifile='[(#CHEMIN{javascript/jquery.multifile.js}|texte_script)]';
[(#INCLURE{javascript/medias_edit.js}|compacte{js})]
[(#OBJET|=={rubrique}|et{#EVAL{_AJAX}}|et{#GET{nbdocs}|=={1}}|oui)
if (window.jQuery) jQuery('#navigation .box.info').ajaxReload();]
function check_reload_page(){
	var reload = false;
	if($('#illustrations[(#ENV{id_unique})]').length && !$('#illustrations[(#ENV{id_unique})] .item').length){
		$('#illustrations#ENV{id_unique}').remove();reload = true;
	}
	if($('#portfolio[(#ENV{id_unique})]').length && !$('#portfolio[(#ENV{id_unique})] .item').length){
		$('#portfolio[(#ENV{id_unique})]').remove();reload = true;
	}
	if($('#documents[(#ENV{id_unique})]').length && !$('#documents[(#ENV{id_unique})] .item').length){
		$('#documents[(#ENV{id_unique})]').remove();reload = true;
	}
	if (reload) {
		jQuery('#portfolios[(#ENV{id_unique})]').ajaxReload();
		jQuery('#navigation .box.info').ajaxReload();
	}
}
function ordoc_liste_documents() {
	$.getScript("[(#CHEMIN{javascript/ui/core.js}|timestamp)]", function() {
		$.getScript("[(#CHEMIN{javascript/ui/widget.js}|timestamp)]", function () {
			$.getScript("[(#CHEMIN{javascript/ui/mouse.js}|timestamp)]", function () {
				$.getScript("[(#CHEMIN{javascript/ui/sortable.js}|timestamp)]", function () {
					$("#illustrations#ENV{id_unique}, #portfolio#ENV{id_unique}, #documents#ENV{id_unique}").each(function () {
						// détruire / recréer le sortable à chaque appel ajax
						if ($(this).has('.ui-sortable').length) {
							$(this).sortable('destroy');
						}
						// pas de tri possible s'il n'y a qu'un seul élément.
						if ($(this).find('> .item').length < 2) {
							$(this).find('.ordoc-deplacer').hide();
							return true; // continue
						} else {
							$(this).find('.ordoc-deplacer').show();
						}
						$(this).sortable({
							/*axis: "y",*/ /* minidoc a un affichage en case */
							handle: "",
							placeholder: "ui-state-highlight ordoc-document-placeholder",
							cancel: 'img.croix_centre_image',
							start: function(event, ui) {
								ui.item.addClass('ordoc-en-mouvement');
							},
							stop: function(event, ui) {
								ui.item.removeClass('ordoc-en-mouvement');
							},
							update: function (event, ui) {
								var items = $(this);
								var item = ui.item;
								var liste = items.sortable('toArray');
								var ordre = [];

								$.each(liste, function(i, id) {
									if (id) {
										ordre.push( id.substring(3) ); // doc123 => 123
									}
								});

								var action = '[(#VAL{ordonner_liens}|generer_url_action{"", 1})]';
								var params = {
									objet_source: 'document',
									objet_lie: '#OBJET',
									id_objet_lie: '#ID_OBJET',
									ordre: ordre,
								};

								item.animateLoading();

								$.ajax({
									url: action,
									data: params,
									dataType: 'json',
									cache: false,
								}).done(function(data) {

									var couleur_origine = item.css('background-color');
									var couleur_erreur = $("<div class='remove'></div>").css('background-color');
									var couleur_succes = $("<div class='append'></div>").css('background-color');
									item.endLoading(true);

									if (data.errors.length) {
										items.sortable('cancel');
										item.css({backgroundColor: couleur_erreur}).animate({backgroundColor: couleur_origine}, 'normal', function(){
											item.css({backgroundColor: ''});
										});
									} else {
										item.css({backgroundColor: couleur_succes}).animate({backgroundColor: couleur_origine}, 'normal', function(){
											item.css({backgroundColor: ''});
										});
									}
								});
							}
						});
					});
				});
			});
		});
	});
}
if (window.jQuery) jQuery(function(){
	onAjaxLoad(check_reload_page);
	ordoc_liste_documents();
	onAjaxLoad(ordoc_liste_documents);
});
/*]]>*/</script>
</div>
