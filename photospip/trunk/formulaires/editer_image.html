<div class='formulaire_spip formulaire_editer formulaire_#FORM formulaire_#FORM-#ENV{id_document}' style="position:relative">
	[<p class="reponse_formulaire reponse_formulaire_ok">(#ENV**{message_ok})</p>]
	[<p class="reponse_formulaire reponse_formulaire_erreur">(#ENV*{message_erreur})</p>]
	[(#ENV{erreurs}|table_valeur{message}|oui)
	<div class="notice">
			[(#ENV{erreurs}|table_valeur{message}|=={previsu}|oui)
			<span><:previsualisation:></span><br />
			<:photospip:erreur_previsu:>]
			[(#ENV{erreurs}|table_valeur{message}|=={sanstest}|oui)
			<:photospip:sanstest:>]
			[(#ENV{erreurs}|table_valeur{message}|=={sansfiltre}|oui)
			<:photospip:sansfiltre:>]
			[(#ENV{erreurs}|table_valeur{message}|=={sansconf}|oui)
			<:photospip:sansconf:>]
		</div>]
	<BOUCLE_editable(CONDITION){si #ENV{editable}|oui}>
	<BOUCLE_document(DOCUMENTS){id_document}{mode IN vignette,image,document}{tout}>
	[(#REM)
		Calcul du ratio entre notre image originale et la prévisualisation
		Utile pour les opération de recadrage notamment
	]
	#SET{largeur_max,#ENV{largeur_previsu,#ENV{erreurs}|table_valeur{largeur_previsu}|sinon{450}}}
	#SET{hauteur_max,#CONFIG{photospip/hauteur_previsu,#ENV{erreurs}|table_valeur{hauteur_previsu}|sinon{450}}}
	[(#SET{largeur_reduit,[(#FICHIER|image_reduire{#GET{largeur_max},#GET{hauteur_max}}|extraire_attribut{width})]})]
	#SET{ratio,#LARGEUR|div{#GET{largeur_reduit}}}
	<form method='post' action='#ENV{action}' enctype='multipart/form-data'><div>
		[(#REM) declarer les hidden qui declencheront le service du formulaire 
		parametre : url d'action ]
		#ACTION_FORMULAIRE{#ENV{action}}
		<input type='hidden' name='id_document' value='#ENV{id_document}' />
		<input type="submit" class="submit" name="tester" style="display:none;" value="<:photospip:bouton_tester:>" />
		<div id="modifier_image">
			<div id="image-container">
				<div id="image_modifier" style="[width:(#GET{largeur_max})px;]">
					[(#ENV{erreurs}|table_valeur{filtre}|oui)
					[(#_document:FICHIER|photospip_appliquer_filtre{[(#ENV{erreurs}|table_valeur{filtre})],[(#ENV{erreurs}|table_valeur{param1})],[(#ENV{erreurs}|table_valeur{param2})],[(#ENV{erreurs}|table_valeur{param3})],[(#ENV{erreurs}|table_valeur{param})]}|image_reduire{#GET{largeur_max},#GET{hauteur_max}}|inserer_attribut{alt,' '})]]
					[(#ENV{erreurs}|table_valeur{filtre}|non)
					[(#_document:FICHIER|image_reduire{#GET{largeur_max},#GET{hauteur_max}}|inserer_attribut{alt,' '})]]
				</div>
			</div>
			<BOUCLE_si_versions_et_vignettes(CONDITION){si #ENV{mode}|!={vignette}|ou{#ENV{mode}|=={vignette}|et{#ENV{vignette}|=={oui}}}|oui}>
			<B_interd_nb>
			<ul class="liste-versions">
				<li class="fieldset">
					<h3 class="legend">[(#GRAND_TOTAL|singulier_ou_pluriel{photospip:info_nb_versions_une,photospip:info_nb_versions})]</h3>
					<BOUCLE_interd_nb(DOCUMENTS_INTERS){id_document}{!par version}> </BOUCLE_interd_nb>
					<ul>
					<B_interd>
						<li id="image-versions" class="editer editer_version">
						<BOUCLE_interd(DOCUMENTS_INTERS){id_document}{!par version}>
						<div class="version choix">
						<label for="version_#VERSION" title="<:photospip:title_version{version=#VERSION}:>">
							[(#HAUTEUR|>{#LARGEUR}|non)
							[(#SET{fichier,[(#FICHIER|get_spip_doc)]})]
							[(#SET{miniature,[(#FICHIER|get_spip_doc|image_reduire{80,80}|inserer_attribut{alt,Version #VERSION})]})]]
							[(#HAUTEUR|>{#LARGEUR}|oui)
							[(#SET{fichier,[(#FICHIER|get_spip_doc)]})]
							[(#SET{miniature,[(#FICHIER|get_spip_doc|image_reduire{80,80}|inserer_attribut{alt,Version #VERSION}|inserer_attribut{style,'vertical-align:bottom;'})]})]]
							<a href="#GET{fichier}" class="mediabox">#GET{miniature}</a>
						</label>
						<input type="radio" name="version" id="version_#VERSION" value="#VERSION" />
						</div>
						</BOUCLE_interd>
						</li>
						<li class="boutons">
							<input type="submit" class="submit" name="revenir_version" value="<:photospip:bouton_revenir_version:>" />
							<input type="submit" class="submit" name="supprimer_version" value="<:photospip:bouton_supprimer_version:>" />
						</li>
					</B_interd>
					</ul>
				</li>
			</ul>
			</B_interd_nb>
			</BOUCLE_si_versions_et_vignettes>
		</div>
		<div>
			<BOUCLE_modifiable(CONDITION){si #ENV{modifiable,oui}|oui}>
			<ul>
				#CHEMIN{formulaires/editer_image_format}
				[<li class="fieldset" id="fragment-format">
					<h3 class="legend"><:photospip:legende_filtres_format:></h3>
					<ul>
					(#INCLURE{fond=formulaires/editer_image_format,env}|trim)
					</ul>
				</li>]
				
				[<li class="fieldset" id="fragment-couleurs">
					<h3 class="legend"><:photospip:legende_filtres_de_couleur:></h3>
					<ul>
						(#INCLURE{fond=formulaires/editer_image_couleurs,env}|trim)
					</ul>
				</li>]
				<BOUCLE_resultats_sup_un(CONDITION){si #ENV{mode}|!={vignette}|et{#CONFIG{photospip/resultats,#ARRAY{0,remplacer_image,1,creer_nouvelle_image,2,creer_version_image}}|count|>{1}}|oui}>
				<li>
					<label><:photospip:label_type_modification:></label>
					<BOUCLE_resultats(POUR){tableau #CONFIG{photospip/resultats,#ARRAY{0,remplacer_image,1,creer_nouvelle_image,2,creer_version_image}}}>
					<div class="choix">
						<input type="radio" id="#VALEUR" name="type_modification" value="#VALEUR"[(#ENV{type_modification,#CONFIG{photospip/resultats_defaut,creer_version_image}}|=={#VALEUR}|oui)checked="checked"] />
						<label for="#VALEUR">[(#VAL{photospip:label_modif_}|concat{#VALEUR}|_T)]</label>
					</div>
					</BOUCLE_resultats>
				</li>
				</BOUCLE_resultats_sup_un>
				[(#REM)
				
					Les résultats possible dans le cas d'une vignette.
					
					On affiche ce choix de résultat uniquement lorsque la vignette existe réellement
					
					Contrairement aux résultats du travail sur le document, seuls 2 résultats sont possibles :
					-* Le remplacement de la vignette purement et simplement;
					-* La création de versions de la vignette
				]
				<BOUCLE_resultats_sup_vignette_un(CONDITION){si #ENV{mode}|=={vignette}|et{#ENV{vignette}|=={oui}}|et{#CONFIG{photospip/resultats_vignette,#ARRAY{0,remplacer_image,1,creer_version_image}}|count|>{1}}|oui}>
				<li>
					<label><:photospip:label_type_modification:></label>
					<BOUCLE_resultats_vignette(POUR){tableau #CONFIG{photospip/resultats_vignette,#ARRAY{0,remplacer_image,1,creer_version_image}}}>
					<div class="choix">
						<input type="radio" id="#VALEUR" name="type_modification" value="#VALEUR"[(#ENV{type_modification,#CONFIG{photospip/resultats_defaut_vignette,creer_version_image}}|=={#VALEUR}|oui)checked="checked"] />
						<label for="#VALEUR">[(#VAL{photospip:label_modif_vignette_}|concat{#VALEUR}|_T)]</label>
					</div>
					</BOUCLE_resultats_vignette>
				</li>
				</BOUCLE_resultats_sup_vignette_un>
			</ul>
	  [(#REM) ajouter les saisies supplementaires : extra et autre, a cet endroit ]
	  <!--extra-->
	  <p class="boutons">
	  	<input type="submit" class="submit" name="tester" value="<:photospip:bouton_tester:>" />
	  	[(#ENV{mode}|=={vignette}|et{#ENV{vignette}|=={oui}}|oui)
	  	<input type="submit" class="submit" name="supprimer_vignette" value="<:photospip:bouton_supprimer_vignette:>" />
	  	]
	  	<input type="submit" class="submit" name="validation" value="<:photospip:bouton_valider:>" />
	  </p>
	 <script type="text/javascript"><!--
			[(#CONFIG{photospip/image_recadre,on}|=={on}|oui)
				var x1, y1, x2, y2, w, h, ias,ratio;
				var ratio = parseFloat([(#GET{ratio})]);
				function crop_selectchange(img, selection){
					// Le ratio est la relation entre notre image normale et la prévisualisation
					if(!isNaN(parseFloat(selection.x1*ratio))){
						x1.val(parseFloat(selection.x1*ratio).toFixed(0));
						y1.val(parseFloat(selection.y1*ratio).toFixed(0));
						x2.val(parseFloat(selection.x2*ratio).toFixed(0));
						y2.val(parseFloat(selection.y2*ratio).toFixed(0));
						w.val(parseFloat(selection.width*ratio).toFixed(0));
						h.val(parseFloat(selection.height*ratio).toFixed(0));
					}
				}

				var image_crop = function(){
					if(typeof(ias) == 'object'){
						image_crop_close();
					}

					ias = jQuery('#image_modifier img').imgAreaSelect(
						{
							parent:jQuery('#modifier_image'),
							x1:[(#ENV{recadre_x1}|>{0}|?{[(#ENV{recadre_x1}|div{#GET{ratio}}|intval)],10})],
							y1:[(#ENV{recadre_y1}|>{0}|?{[(#ENV{recadre_y1}|div{#GET{ratio}}|intval)],10})],
							x2:[(#ENV{recadre_x2}|>{0}|?{[(#ENV{recadre_x2}|div{#GET{ratio}}|intval)],60})],
							y2:[(#ENV{recadre_y2}|>{0}|?{[(#ENV{recadre_y2}|div{#GET{ratio}}|intval)],60})],
							show:true,
							instance: true,
							handles: true,
							keys: true,
							fadeSpeed:400,
							enable:true,
							onInit: function(img, c) {
								crop_selectchange(img,c);
							},
							onSelectStart: function(img, c) {},
							onSelectEnd: function(img, c) {},
							onSelectChange: function(img, c) {
								crop_selectchange(img,c);
							}
						}
					);
				}
				
				var image_crop_close = function(){
					ias.remove();
				}
			]
			
			var activatesliders = function(){
				var slider_image_rotation = jQuery('#sliderrotation').slider({
					min: -180,
					max: 180,
					value: #ENV{params_image_rotation,45},
					slide: function( event, ui ) {
						jQuery(this).parent().find('input').val(ui.value.toFixed(0));
					}
				});
				$("#param_image_rotation").change(function() {
					var val = parseInt($(this).val());
					slider_image_rotation.slider("value", val);
				});
				var slider_image_gamma = jQuery('#slidergamma').slider({
					min: -254,
					max: 254,
					value: #ENV{params_image_gamma,10},
					slide: function( event, ui ) {
						jQuery(this).parent().find('input').val(ui.value.toFixed(0));
					}
				});
				$("#param_image_gamma").change(function() {
					var val = parseInt($(this).val());
					slider_image_gamma.slider("value", val);
				});
				
				var slider_image_flou = jQuery('#sliderflou').slider({
					min: 1,
					max: 11,
					value : #ENV{param_image_flou,3},
					slide: function( event, ui ) {
						jQuery(this).parent().find('input').val(ui.value.toFixed(0));
					}
				});
				$("#param_image_flou").change(function() {
					var val = parseInt($(this).val());
					slider_image_flou.slider("value", val);
				});
			}
			
			jQuery(document).ready(function() {
				activatesliders();
				jQuery('.cache').hide();
				jQuery('input[name=filtre]:checked').parent().find('.cache').show();
			  	jQuery('#navigation .version').hover(function(){
					jQuery(this).find('label img').fadeTo('fast',.1,function(){
						jQuery(this).parent().parent().find('input').attr({
			  				checked: "checked"
				  		});
				  		jQuery(this).parent().parent().find('.revenir_version, .delete_version').show();	
					});	
			  	},function(){
					jQuery(this).find('label img').fadeTo('fast',1,function(){
						jQuery(this).parent().parent().find('.revenir_version, .delete_version').hide();
					});	
			  	});
				jQuery('form input[type=radio]').unbind().click(function(){
					if(jQuery(this).next().next('.cache').is(':hidden')){
				  		jQuery(".visible").slideUp().removeClass('visible');
						jQuery(this).parent().find('.cache').slideDown().addClass('visible');
						if(jQuery(this).attr('id') == 'image_recadre'){
							image_crop();
						}
						else{	
							image_crop_close();
						}
					}
			  	});
				[(#CONFIG{photospip/image_recadre,on}|oui)
				x1 = jQuery('#recadre_x1');
				x1.change(function(){
					jQuery('#image_modifier img').imgAreaSelect({x1:#ENV{recadre_x1,20},y1:#ENV{recadre_y1,20},x2:#ENV{recadre_x2,70},y2:#ENV{recadre_y2,70},width:#ENV{recadre_width,50},height:#ENV{recadre_height,50},onSelectChange: crop_selectchange,show:true});
				});
				y1 = jQuery('#recadre_y1');
				x2 = jQuery('#recadre_x2');
				y2 = jQuery('#recadre_y2');
				w = jQuery('#recadre_width');
				h = jQuery('#recadre_height');
				if(jQuery('#image_recadre').is(':checked')){
					image_crop();
				}]
				jQuery('#recadre_x1,#recadre_y1,#recadre_x2,#recadre_y2,#recadre_width,#recadre_height').change(function(){
					if(typeof(ias) == 'object'){
						var ias_selection = ias.getSelection();
						if($(this).is('#recadre_width')){
							var width_ratio = (parseFloat($(this).val())/ratio).toFixed(0);
							ias_selection.x2 = parseInt(ias_selection.x1)+parseInt(width_ratio);
						}
						else if($(this).is('#recadre_height')){
							var height_ratio = (parseFloat($(this).val())/ratio).toFixed(0);
							ias_selection.y2 = parseInt(ias_selection.y1)+parseInt(height_ratio);
						}
						else{
							var width = parseFloat(ias_selection.x2)-parseFloat(ias_selection.x1);
							console.log(width);
							var height = parseFloat(ias_selection.y2)-parseFloat(ias_selection.y1);
							console.log(height);
							if($(this).is('#recadre_x1')){
								var x1_ratio = (parseFloat($(this).val())/ratio).toFixed(0);
								ias_selection.x1 = parseInt(x1_ratio);
								ias_selection.x2 = parseInt(x1_ratio)+parseInt(width);
							}
							else if($(this).is('#recadre_y1')){
								var y1_ratio = (parseFloat($(this).val())/ratio).toFixed(0);
								ias_selection.y1 = parseInt(y1_ratio);
							}
							else if($(this).is('#recadre_x2')){
								var x2_ratio = (parseFloat($(this).val())/ratio).toFixed(0);
								ias_selection.x2 = parseInt(x2_ratio);
							}
							else if($(this).is('#recadre_y2')){
								var y2_ratio = (parseFloat($(this).val())/ratio).toFixed(0);
								ias_selection.y2 = parseInt(y2_ratio);
							}
						}
						ias.setSelection(ias_selection.x1,ias_selection.y1,ias_selection.x2,ias_selection.y2);
						ias.update();
						var new_selection = ias.getSelection();
						crop_selectchange($('image_modifier img'), new_selection);
					}
				});
				jQuery('.image_recadre input[type=radio]').click(function(){
					if (jQuery(this).val() != ''){
						jQuery('#image_modifier img').imgAreaSelect({aspectRatio: jQuery(this).val()});
					}
					else{
						jQuery('#image_modifier img').imgAreaSelect({aspectRatio: ''});
					}
				});
			});
			// -->
	</script>
	</BOUCLE_modifiable>
	</div></form>
	</BOUCLE_document>
	</BOUCLE_editable>
</div>