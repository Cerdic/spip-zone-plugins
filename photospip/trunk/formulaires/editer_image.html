<div class='formulaire_spip formulaire_editer formulaire_editer_document formulaire_editer_document-#ENV{id_document,nouveau}'>
	[<p class="reponse_formulaire reponse_formulaire_ok">(#ENV**{message_ok})</p>]
	[<p class="reponse_formulaire reponse_formulaire_erreur">(#ENV*{message_erreur})</p>]
	<BOUCLE_editable(CONDITION){si #ENV{editable}|oui}>
	[(#PLUGIN{fonctions_images}|oui)
		[(#CONFIG{photospip/image_niveau_de_gris_auto}|=={on}|oui)#SET{fonctions_images,on}]
		[(#CONFIG{photospip/image_sincity}|=={on}|oui)#SET{fonctions_images,on}]
		[(#CONFIG{photospip/image_contour_alpha}|=={on}|oui)#SET{fonctions_images,on}]
		[(#CONFIG{photospip/image_dispersion}|=={on}|oui)#SET{fonctions_images,on}]
		[(#CONFIG{photospip/image_saturer}|=={on}|oui)#SET{fonctions_images,on}]
	]
	<BOUCLE_document(DOCUMENTS){id_document}{tout}>
		<script type="text/javascript"><!--
			[(#REM)
				Calcul du ratio entre notre image originale et la prévisualisation
				Utile pour les opération de recadrage notamment
			]
			#SET{largeur_max,#ENV{largeur_previsu,450}}
			#SET{hauteur_max,#CONFIG{photospip/hauteur_previsu,450}}
			[(#SET{largeur_reduit,[(#FICHIER|image_reduire{#GET{largeur_max},#GET{hauteur_max}}|extraire_attribut{width})]})]
			#SET{ratio,#LARGEUR|div{#GET{largeur_reduit}}}
			[(#CONFIG{photospip/image_recadre,on}|=={on}|oui)
				var x1, y1, x2, y2, w, h, ias;
				function crop_selectchange(img, selection){
					// Le ratio est la relation entre notre image normale et la prévisualisation
					var ratio = parseFloat([(#GET{ratio})]);
					x1.val(parseFloat(selection.x1*ratio).toFixed(0));
					y1.val(parseFloat(selection.y1*ratio).toFixed(0));
					x2.val(parseFloat(selection.x2*ratio).toFixed(0));
					y2.val(parseFloat(selection.y2*ratio).toFixed(0));
					w.val(parseFloat(selection.width*ratio).toFixed(0));
					h.val(parseFloat(selection.height*ratio).toFixed(0));
				}

				var image_crop = function(){
					console.log('on init le crop');
					ias = jQuery('#image_modifier img').imgAreaSelect(
						{
							x1:10,
							y1:10,
							x2:50,
							y2:50,
							width:40,
							height:40,
							onSelectChange:crop_selectchange,
							show:true,
							fadeSpeed:400,
							handles: true,
							instance: true
						}
					);
				}
				
				var image_crop_close = function(){
					
					jQuery('#image_modifier img').imgAreaSelect({remove:true});
				}
			]
			
			var activatesliders = function(){
				var slider_image_rotation = jQuery('#sliderrotation').slider({
					min: -180,
					max: 180,
					value: #ENV{params_image_rotation,45},
					slide: function( event, ui ) {
						jQuery(this).parent().find('input').val(ui.value.toFixed(0));
					}
				});
				$("#param_image_rotation").change(function() {
					var val = parseInt($(this).val());
					slider_image_rotation.slider("value", val);
				});
				var slider_image_gamma = jQuery('#slidergamma').slider({
					min: -254,
					max: 254,
					value: #ENV{params_image_gamma,10},
					slide: function( event, ui ) {
						jQuery(this).parent().find('input').val(ui.value.toFixed(0));
					}
				});
				$("#param_image_gamma").change(function() {
					var val = parseInt($(this).val());
					slider_image_gamma.slider("value", val);
				});
				
				var slider_image_flou = jQuery('#sliderflou').slider({
					min: 1,
					max: 11,
					value : #ENV{param_image_flou,3},
					slide: function( event, ui ) {
						jQuery(this).parent().find('input').val(ui.value.toFixed(0));
					}
				});
				$("#param_image_flou").change(function() {
					var val = parseInt($(this).val());
					slider_image_flou.slider("value", val);
				});
			}
			
			jQuery(document).ready(function() {
				image_crop_close();
				activatesliders();
				jQuery('.cache').hide();
				jQuery('input[name=filtre]:checked').parent().find('.cache').show();
			  	jQuery('.version').hover(function(){
					jQuery(this).find('label img').fadeTo('fast',.1,function(){
						jQuery(this).parent().parent().find('input').attr({
			  				checked: "checked"
				  		});
				  		jQuery(this).parent().parent().find('.revenir_version, .delete_version').show();	
					});	
			  	},function(){
					jQuery(this).find('label img').fadeTo('fast',1,function(){
						jQuery(this).parent().parent().find('.revenir_version, .delete_version').hide();
					});	
			  	});
				jQuery('form input[type=radio]').not('.nocache').unbind().click(function(){
					if(jQuery(this).next().next('.cache').is(':hidden')){
				  		jQuery(".visible").slideUp().removeClass('visible')
						jQuery(this).parent().find('.cache').slideDown().addClass('visible');
						if(jQuery(this).attr('id') == 'image_recadre'){
							image_crop();
						}
						else{	
							image_crop_close();
						}
					}
			  	});
			  	jQuery('#versions input[type=radio]').css("display", "none");
				
				[(#CONFIG{photospip/image_recadre,on}|oui)
				x1 = jQuery('#recadre_x1');
				x1.change(function(){
					jQuery('#image_modifier img').imgAreaSelect({x1:20,y1:20,x2:70,y2:70,width:50,height:50,onSelectChange: crop_selectchange,show:true});
				});
				y1 = jQuery('#recadre_y1');
				x2 = jQuery('#recadre_x2');
				y2 = jQuery('#recadre_y2');
				w = jQuery('#recadre_width');
				h = jQuery('#recadre_height');
				if(jQuery('#image_recadre').is(':checked')){
					image_crop_close();
					image_crop();
				}]
				jQuery('.image_recadre input[type=radio]').click(function(){
					if (jQuery(this).val() != ''){
						jQuery('#image_modifier img').imgAreaSelect({aspectRatio: jQuery(this).val()});
					}
					else{
						jQuery('#image_modifier img').imgAreaSelect({aspectRatio: ''});
					}
				});
			});
			// -->
	</script>
	<form method='post' action='#ENV{action}' enctype='multipart/form-data'><div>
		[(#REM) declarer les hidden qui declencheront le service du formulaire 
		parametre : url d'action ]
		#ACTION_FORMULAIRE{#ENV{action}}
		<input type='hidden' name='id_document' value='#ENV{id_document}' />
		[(#REM) un bouton submit pour enregistrer qui sera declenche par le return
		il ne doit pas etre hidden pour marcher dans safari
		]
		<div id="modifier_image">
			<div id="image-container">
				<div id="image_modifier" style="[width:(#GET{largeur_max})px;]">
				[(#ENV{erreurs}|table_valeur{message}|oui)
				<div class="photospip_previsu">
					<div class="previsu_texte" style="[width:(#GET{largeur_max})px;]">
						[(#ENV{erreurs}|table_valeur{message}|=={previsu}|oui)
						<span><:previsualisation:></span>
						<:photospip:previsu:>]
						[(#ENV{erreurs}|table_valeur{message}|=={sanstest}|oui)
						<:photospip:sanstest:>]
						[(#ENV{erreurs}|table_valeur{message}|=={sansfiltre}|oui)
						<:photospip:sansfiltre:>]
						[(#ENV{erreurs}|table_valeur{message}|=={sansconf}|oui)
						<:photospip:sansconf:>]
					</div>
				</div>
				]
				[(#ENV{erreurs}|foreach)]
				[(#ENV{erreurs}|table_valeur{filtre}|oui)
				[(#_document:FICHIER|image_reduire{#GET{largeur_max,450},#GET{hauteur_max,450}}|photospip_appliquer_filtre{#ENV{erreurs}|table_valeur{filtre},[(#ENV{erreurs}|table_valeur{param})]}|image_reduire{[(#ENV{largeur_max}|sinon{450})],[(#ENV{hauteur_max}|sinon{450})]}|inserer_attribut{alt,' '})]]
				[(#ENV{erreurs}|table_valeur{filtre}|non)
				[(#_document:FICHIER|image_reduire{#GET{largeur_max,450},#GET{hauteur_max,450}}|inserer_attribut{alt,' '})]]
			</div>
			</div>
				[(#SET{photospip,pasok})]
				<BOUCLE_interd(DOCUMENTS_INTERS){id_document}> </BOUCLE_interd>
				[(#TOTAL_BOUCLE|>={#CONFIG{photospip/limite_version}}|?{#SET{photospip,ok},#SET{photospip,pasok}})]
				<//B_interd>
			<div>
			<ul>
				<li class="fieldset" id="fragment-format">
					<h3 class="legend"><:photospip:legende_filtres_format:></h3>
					<ul>
						[(#CONFIG{photospip/image_recadre,on}|=={on}|oui)
						<li class="editer editer_recadre">
							<input type="radio" name="filtre" id="image_recadre" value="image_recadre"[(#ENV{filtre}|=={image_recadre}|oui)checked="checked"] />
							<label for="image_recadre">[<img src="(#CHEMIN{images/photospip-ico/ico_rotation.png})" alt="<:photospip:image_recadre:>" /> ]<:photospip:label_image_recadre:></label>
							<div class="cache params_filtre image_recadre">
								<p class="explication">
									<:photospip:explication_image_recadre:>
									<:photospip:image_taille_actuelle:> #LARGEUR x #HAUTEUR px
								</p>
								<ul>
								<li>
									<label><:photospip:label_ratio:></label>
									<div class="choix">
										<input type="radio" id="ratio" name="ratio" value=""[(#ENV{ratio}|non)checked="checked"] />
										<label for="ratio"><:photospip:label_ratio_libre:></label>
									</div>
									<div class="choix">
										<input type="radio" id="ratio1" name="ratio" value="1:1"[(#ENV{ratio}|=={'1:1'}|oui)checked="checked"] />
										<label for="ratio1">1:1</label>
									</div>
									<div class="choix">
										<input type="radio" id="ratio2" name="ratio" value="4:3"[(#ENV{ratio}|=={'4:3'}|oui)checked="checked"] />
										<label for="ratio2">4:3</label>
									</div>
								</li>
								<li>
									<label for="recadre_width"><:photospip:label_recadre_width:></label>
									<input type="text" class="text" id="recadre_width" maxlength="5" name="recadre_width" value="#ENV{recadre_width}" readonly="readonly" />
								</li>
								<li>
									<label for="recadre_height"><:photospip:label_recadre_height:></label>
									<input type="text" class="text" id="recadre_height" maxlength="5" name="recadre_height" value="#ENV{recadre_height}" readonly="readonly" />
								</li>
								<li>
									<label><:photospip:label_recadre_x1_y1:></label>
									<div class="choix">
										<label for="recadre_x1">x</label>
										<input type="text" class="text" id="recadre_x1" name="recadre_x1" value="#ENV{recadre_x1}" readonly="readonly" />
									</div>
									<div class="choix">
										<label for="recadre_y1">y</label>
										<input type="text" class="text" id="recadre_y1" name="recadre_y1" value="#ENV{recadre_y1}" readonly="readonly" />
									</div>
								</li>
								<li>
									<label><:photospip:label_recadre_x2_y2:></label>
									<div class="choix">
										<label for="recadre_x2">x</label>
										<input type="text" class="text" id="recadre_x2" name="recadre_x2" value="#ENV{recadre_x2}" readonly="readonly" />
									</div>
									<div class="choix">
										<label for="recadre_y2">y</label>
										<input type="text" class="text" id="recadre_y2" name="recadre_y2" value="#ENV{recadre_y2}" readonly="readonly" />
									</div>
								</li>
							</ul>
							</div>
						</li>]
						[(#CONFIG{photospip/tourner,oui}|=={on}|oui)
						<li class="editer editer_tourner">
							<input type="radio" name="filtre" id="tourner" value="tourner"[(#ENV{filtre}|=={tourner}|oui)checked="checked"] />
							<label for="tourner">[<img src="(#CHEMIN{images/photospip-ico/ico_rotation.png})" alt="<:photospip:label_tourner:>" /> ]<:photospip:label_tourner:></label>
							<div class="cache params_filtre">
								<p class="explication"><:photospip:explication_tourner:></p>
								<ul>
									<li>
										<label><:photospip:label_angle_rotation:></label>
										<div class="choix">
											<input type="radio" name="params_tourner" value="90" id="param_tourner_90"[(#ENV{params_tourner}|=={90}|oui)checked="checked"] />
											<label for="param_tourner_90"><:photospip:label_tourner_90:></label>
										</div>
										<div class="choix">
											<input type="radio" name="params_tourner" value="180" id="param_tourner_180"[(#ENV{params_tourner}|=={180}|oui)checked="checked"] />
											<label for="param_tourner_180"><:photospip:label_tourner_180:></label>
										</div>
										<div class="choix">
											<input type="radio" name="params_tourner" value="270" id="param_tourner_270"[(#ENV{params_tourner}|=={270}|oui)checked="checked"] />
											<label for="param_tourner_270"><:photospip:label_tourner_270:></label>
										</div>
									</li>
								</ul>
							</div>
						</li>]
						[(#CONFIG{photospip/image_rotation}|=={on}|oui)
						<li class="editer editer_rotation">
							<input type="radio" name="filtre" id="image_rotation" value="image_rotation"[(#ENV{filtre}|=={image_rotation}|oui)checked="checked"] />
							<label for="image_rotation">[<img src="(#CHEMIN{images/photospip-ico/ico_rotation.png})" alt="<:photospip:label_image_rotation:>" /> ]<:photospip:label_image_rotation:></label>`
							<div class="cache params_filtre">
								<p class="explication"><:photospip:explication_image_rotation:></p>
								<div id='sliderrotation'>
									<div></div>	
								</div>
								<ul>
									<li class="editer editer_param_image_rotation">
										<label for="param_image_rotation"><:photospip:label_angle_rotation:></label>
										<input type="text" class="text" name="params_image_rotation" id="param_image_rotation" value="#ENV{params_image_rotation,45}" maxlength="4" />
									</li>
								</ul>
							</div>
						</li>]
						[(#CONFIG{photospip/image_flip_vertical}|=={on}|oui)
						<li class="editer editer_flip_vertical">
							<input type="radio" name="filtre" id="image_flip_vertical" value="image_flip_vertical"[(#ENV{filtre}|=={image_flip_vertical}|oui)checked="checked"] />
							<label for="image_flip_vertical">[<img src="(#CHEMIN{images/photospip-ico/ico_flip_vertical.png})" alt="<:photospip:image_flip_vertical:>" /> ]<:photospip:label_image_flip_vertical:></label>
							<div class="cache params_filtre">
								<p class="explication"><:photospip:explication_image_flip_vertical:></p>
							</div>
						</li>]
						[(#CONFIG{photospip/image_flip_horizontal}|=={on}|oui)
						<li class="editer editer_flip_horizontal">
							<input type="radio" name="filtre" id="image_flip_horizontal" value="image_flip_horizontal"[(#ENV{filtre}|=={image_flip_horizontal}|oui)checked="checked"] />
							<label for="image_flip_horizontal">[<img src="(#CHEMIN{images/photospip-ico/ico_flip_horizontal.png})" alt="<:photospip:image_flip_horizontal:>" /> ]<:photospip:label_image_flip_horizontal:></label>
							<div class="cache params_filtre">
								<p class="explication"><:photospip:explication_image_flip_horizontal:></p>
							</div>
						</li>]
					</ul>
				</li>
				<li class="fieldset" id="fragment-couleurs">
					<h3 class="legend"><:photospip:legende_filtres_de_couleur:></h3>
					<ul>
						[(#CONFIG{photospip/image_nb,on}|=={on}|oui)
						<li class="editer editer_nb">
							<input type="radio" name="filtre" id="filtre_nb" value="image_nb"[(#ENV{filtre}|=={image_nb}|oui)checked="checked"] />
							<label for="filtre_nb">[<img src="(#CHEMIN{images/photospip-ico/ico_nb.png})" alt="<:photospip:label_image_nb:>" /> ]<:photospip:label_image_nb:></label>
							<div class="cache params_filtre">
								<p class="explication"><:photospip:explication_image_nb:></p>
							</div>
						</li>]
						[(#CONFIG{photospip/image_gamma}|=={on}|oui)
						<li class="editer editer_gamma">
							<input type="radio" name="filtre" id="filtre_gamma" value="image_gamma"[(#ENV{filtre}|=={image_gamma}|oui)checked="checked"] />
							<label for="filtre_gamma"><:photospip:label_image_gamma:></label>
							<div class="cache params_filtre">
								<p class="explication"><:photospip:explication_image_gamma:></p>
								<div id='slidergamma'> </div>
								<ul>
									<li class="editer_params_image_gamma">
										<label for="param_image_gamma"><:photospip:label_niveau_gamma:></label>
										<input type="text" class="text" name="params_image_gamma" id="param_image_gamma" value="#ENV{params_image_gamma,10}" maxlength="4" />
									</li>
								</ul>
							</div>
						</li>]
						[(#CONFIG{photospip/image_flou}|=={on}|oui)
						<li class="editer editer_flou">
							<input type="radio" name="filtre" id="filtre_flou" value="image_flou"[(#ENV{filtre}|=={image_flou}|oui)checked="checked"] />
							<label for="filtre_flou"><:photospip:label_image_flou:></label>
							<div class="cache params_filtre">
								<p class="explication"><:photospip:explication_image_flou:></p>
								<div id='sliderflou'> </div>
								<ul>
									<li class="editer_param_image_flou">
										<label for="param_image_flou"><:photospip:label_niveau_flou:></label>
										<input type="text" class="text" name="params_image_flou" id="param_image_flou" value="#ENV{params_image_flou,3}" maxlength="2" />
									</li>
								</ul>
							</div>
						</li>]
						[(#CONFIG{photospip/image_sepia}|=={on}|oui)
						<li class="editer editer_image_sepia">
							<input type="radio" name="filtre" id="filtre_sepia" value="image_sepia"[(#ENV{filtre}|=={image_sepia}|oui)checked="checked"] />
							<label for="filtre_sepia">[<img src="(#CHEMIN{images/photospip-ico/ico_sepia.png})" alt="<:photospip:image_sepia:>" /> ]<:photospip:label_image_sepia:></label>
							<div class="cache params_filtre">
								<ul>
									<li class="editer_param_image_sepia">
										<label for="param_image_sepia"><:photospip:label_couleur_sepia:></label>
										<input type="text" name="params_image_sepia" class="text palette couleur" id="param_image_sepia" value="#ENV{params_image_sepia,#896f5e}" maxlength="7" />
									</li>
								</ul>
							</div>
						</li>]
					</ul>
				</li>
				[(#GET{fonctions_images}|=={on}|oui)
				<li class="fieldset" id="fragment-sup">
					<h3 class="legend"><:photospip:legende_filtres_supplementaires:></h3>
					<ul>
						[(#CONFIG{photospip/image_niveau_de_gris_auto}|=={on}|oui)
						<li class="editer editer_niveaux_auto">
							<input type="radio" name="filtre" id="filtre_niveaux_auto" value="image_niveaux_gris_auto"[(#ENV{filtre}|=={image_niveaux_gris_auto}|oui)checked="checked"] />
							<label for="filtre_niveaux_auto"><:photospip:label_image_niveau_de_gris_auto:></label>
							<div class="cache params_filtre explications">
								<p class="explication"><:photospip:explication_image_niveau_de_gris_auto:></p>
							</div>
						</li>]
						[(#CONFIG{photospip/image_sincity}|=={on}|oui)
						<li class="editer editer_sincity">
							<input type="radio" name="filtre" id="filtre_sincity" value="image_sincity"[(#ENV{filtre}|=={image_sincity}|oui)checked="checked"] />
							<label for="filtre_sincity"><:photospip:label_image_sincity:></label>
							<div class="cache params_filtre explications">
								<p class="explication"><:photospip:explication_image_sincity:></p>
							</div>
						</li>]
						[(#CONFIG{photospip/image_contour_alpha}|=={on}|oui)
						<li class="editer editer_contour_alpha">
							<input type="radio" name="filtre" id="filtre_contour_alpha" value="image_contour_alpha"[(#ENV{filtre}|=={image_contour_alpha}|oui)checked="checked"] />
							<label for="filtre_contour_alpha"><:photospip:label_image_contour_alpha:></label>
							<div class="cache params_filtre explications">
								<p class="explication"><:photospip:explication_image_contour_alpha:></p>
							</div>
						</li>]
						[(#CONFIG{photospip/image_saturer}|=={on}|oui)
						<li class="editer editer_saturer">
							<input type="radio" name="filtre" id="filtre_saturer" value="image_saturer"[(#ENV{filtre}|=={image_saturer}|oui)checked="checked"] />
							<label for="filtre_saturer"><:photospip:label_image_saturation_desaturation:></label>
							<div class="cache params_filtre explications">
								<p class="explication"><:photospip:explication_image_saturation_desaturation:></p>
								<div id='slidersaturer'> </div>
								<ul>
									<li class="editer editer_param_image_saturer">
										<label for="param_image_saturer"><:photospip:label_niveau_saturation_desaturation:></label>
										<input type="text" class="text" name="params_image_saturer" id="param_image_saturer" value="#ENV{params_image_saturer,1}" maxlength="3" />
									</li>
								</ul>
							</div>
						</li>]
					</ul>
				</li>]
			<li>
				<div class="choix">
					<input type="radio" name="validation" value="tester" id="tester" checked="checked" />
					<label for="tester">[<img src="(#CHEMIN{images/photospip-ico/ico_tester.png})" alt="<:photospip:bouton_tester:>" /> ]<:photospip:bouton_tester:></label>
				</div>
				<div class="choix">
				[(#GET{photospip}|=={pasok}|?{<input type="radio" name="validation" value="appliquer" id="appliquer" /><label for="appliquer">[<img src="(#CHEMIN{images/photospip-ico/ico_appliquer.png})" alt="<:photospip:valider:>" /> ]<:photospip:valider:></label>,<span class="warning"><:photospip:nb_versions_depasse:></span>})]
				</div>
			</li>
		</ul>
	  [(#REM) ajouter les saisies supplementaires : extra et autre, a cet endroit ]
	  <!--extra-->
	  <p class="boutons"><input type="submit" class="submit" name="valider" value="<:photospip:valider:>" /></p>
	</div></form>
	</BOUCLE_document>
	</BOUCLE_editable>
</div>