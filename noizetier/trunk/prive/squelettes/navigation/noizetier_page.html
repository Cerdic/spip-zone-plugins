[(#AUTORISER{configurerpage, noizetier, '', '', #ENV{page}|?{#ARRAY{page, #ENV{page}}, #ARRAY{objet,#OBJET,id_objet,#ID_OBJET}}}|sinon_interdire_acces)]
<BOUCLE_page_navigation(CONDITION) {si #ENV{exec}|=={noizetier_page}|et{#ENV{page}|ou{#OBJET|et{#ID_OBJET}}}}>
	[(#REM) <!-- Boite d'info de la page --> ]
	<BOUCLE_si_page(NOIZETIER_PAGES) {page}>
		[(#COMPOSITION|oui)
			[(#EST_VIRTUELLE|=={oui}|?{
				#SET{explication, noizetier:explication_composition_virtuelle},
				#SET{explication, noizetier:explication_composition}})]
		]
		[(#COMPOSITION|non)
			[(#EST_PAGE_OBJET|=={oui}|?{
				#SET{explication, noizetier:explication_page_objet},
				#SET{explication, noizetier:explication_page}})]
		]
		<INCLURE{fond=prive/squelettes/inclure/inc-infos_page,
			page=#PAGE,
			explication=#GET{explication},
			type,
			composition,
			est_virtuelle,
			est_page_objet,
			env} />
	</BOUCLE_si_page>
		#SET{explication, noizetier:explication_objet}
		<INCLURE{fond=prive/squelettes/inclure/inc-infos_page,
			id_objet=#ID_OBJET,
			explication=#GET{explication},
			type=#OBJET,
			est_virtuelle=non,
			env} />
	<//B_si_page>

	[(#REM) <!-- Liste des types de noisette disponibles --> ]
	[(#BOITE_OUVRIR{<:noizetier:noisettes_disponibles:>,'info noisettes_disponibles none'})]
		<p><:noizetier:explication_glisser_deposer:></p>
		<INCLURE{fond=formulaires/inclure/inc-liste_types_noisette,
			page,
			objet,
			id_objet} />
	#BOITE_FERMER
	<br class="clear">

	<script type="text/javascript">/*<!\[CDATA\[*/
		jQuery('.noisettes_disponibles').show();
		// Édition dans une popup
		jQuery('.liste-noisettes a.bouton-modifier').click(function(){
			var noisette = jQuery(this).parents('.noisette').eq(0);
			jQuery(noisette).animateLoading();
			jQuery.modalboxload(parametre_url(parametre_url(parametre_url(jQuery(this).attr('href'),'popin','oui'),'var_zajax','contenu'), 'redirect',''),{
				onClose: function (dialog) {jQuery(noisette).ajaxReload()}
			});
			return false;
		});
		// Rend les noisettes réordonnables
		jQuery('.liste-noisettes-bloc')
		.sortable({
			items: '.noisette',
			containment: '.liste-noisettes-bloc',
			revert: true,
			opacity: 0.66,
			placeholder: 'ui-state-highlight',
			forcePlaceholderSize: 1,
			// Event : début de l'ordonnancement fini, DOM pas encore changé
			// Noter le conteneur d'origine
			start: function( event, ui ) {
				var liste = $(this);
				var noisette = ui.item;
				liste.addClass('receptacle');
				if (noisette.parents('.noisette[data-conteneur]').length) {
					id_conteneur = noisette.parents('.noisette[data-conteneur]').data('conteneur');
				} else {
					id_conteneur = liste.data('id_conteneur');
				}
				noisette.data('id_conteneur_origine', id_conteneur);
			},
			// Event : stop
			stop: function( event, ui ) {
				var liste = $(this);
				var noisette = ui.item;
				liste.removeClass('receptacle');
			},
			// Event : ordonnancement fini, DOM modifié
			// Changer le rang d'une noisette, ou bien en créer une nouvelle
			update: function( event, ui ) {
				var liste = $(this);
				var noisette = ui.item;
				var id_noisette = noisette.data('id_noisette');
				var id_conteneur;

				// Conteneur où on a relaché la noisette (noisette ou racine)
				if (noisette.parents('.noisette[data-conteneur]').length) {
					id_conteneur_destination = noisette.parents('.noisette[data-conteneur]').data('conteneur');
				} else {
					id_conteneur_destination = liste.data('id_conteneur');
				}

				// Trouver le nouveau rang
				var rang;
				if (noisette.prev('.noisette').length){
					rang = noisette.prev('.noisette').data('rang') + 1;
				} else if (noisette.next('.noisette').length) {
					rang = noisette.next('.noisette').data('rang') - 1;
				} else {
					rang = 0;
				}

				// Actions
				// On ajoute la noisette si c'est un clone issu de .draggable()
				if (
					noisette.hasClass('clone')
					&& typeof(id_conteneur != 'undefined')
				) {
					var type_noisette = noisette.data('type_noisette');
					var params = {
						_type_noisette: type_noisette,
						_id_conteneur: id_conteneur_destination,
						rang: rang,
					};
					//console.log(params);
					var action = '[(#VAL{ajouter_noisette_ajax}|generer_url_action{"",1})]';
					noisette.animateLoading(); // Animation
					$.ajax({
						url: action,
						data: params,
						dataType: 'json',
						cache: false,
					}).done(function(data) {
						noisette.endLoading(true).removeClass('clone');
						if (data.success.length) {
							var id_noisette = data.success;
							noisette.ajaxReload({
								callback: function(){
									$('.noisette[data-id_noisette="'+id_noisette+'"]').animateAppend();
								}
							});
						}
						if (data.errors.length) {
							noisette.animateRemove(function(){$(this).remove()});
							console.log(data.errors);
						}
					});

				// Sinon on la déplace
				} else {
					var id_conteneur_origine = noisette.data('id_conteneur_origine');
					var params = {
						_id_noisette: id_noisette,
						rang: rang,
						_id_conteneur_origine: id_conteneur_origine,
						_id_conteneur_destination: id_conteneur_destination,
					};
					console.log(params);
					var action = '[(#VAL{deplacer_noisette_ajax}|generer_url_action{"",1})]';
					$.ajax({
						url: action,
						data: params,
						dataType: 'json',
						cache: false,
					}).complete(function(data) {
						if (data.success.length) {
							var id_noisette = data.success;
							noisette.ajaxReload();
						}
						if (data.errors.length) {
							liste.sortable('cancel');
							console.log(data.errors);
						}
					});
				}
			}
		});
		// Rend les noisettes déplaçables par drag and drop
		// La traitement se fait dans .sortable()
		jQuery('.liste-noisettes-disponibles .noisette').draggable({
			connectToSortable: '.liste-noisettes-bloc',
			containment: '.liste-noisettes-bloc',
			helper: 'clone', // Doit correspondre à ce qu'il y a dans .sortable()
			cursor: 'move',
			opacity: 0.66,
			start: function( event, ui ) {
				var liste = $(this);
				liste.addClass('receptacle');
			},
			stop: function( event, ui ) {
				var liste = $(this);
				var noisette = ui.helper;
				noisette.addClass('clone');
				liste.removeClass('receptacle');
			}
		});
		// Position fixe lors du scroll
		noisettes_dispos_sticky = function(){
			var container = $(".noisettes_disponibles");
			var limite = container.offset().top;
			var largeur = container.width()+'px';
			$(window).scroll(function() {
				if($(this).scrollTop() > limite)
					container.addClass('is-stuck').css({'width': largeur});
				if($(this).scrollTop() < limite)
					container.removeClass('is-stuck').css({'width': 'auto'});
			});
		}
		//noisettes_dispos_sticky();
	/*\]\]>*/</script>
</BOUCLE_page_navigation>
	[(#ENV{exec}|=={noisette_edit}|oui)<INCLURE{fond=prive/squelettes/navigation/noisette_edit,env}>]
	[(#ENV{exec}|=={noisette_add}|oui)<INCLURE{fond=prive/squelettes/navigation/noisette_add,env}>]
	[(#ENV{exec}|=={noizetier_page_edit}|oui)<INCLURE{fond=prive/squelettes/navigation/noizetier_page_edit,env}>]
<//B_page_navigation>
