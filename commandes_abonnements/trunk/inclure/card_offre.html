[(#REM)

	Présentation résumée d'une commande en cours d'offre d'abonnement.

	Utile pour une inclusion dans un tunnel de commande par exemple.

	On affiche les informations suivantes :
	- Titre de l'offre
	- Référence de la commande
	- Prix de la commande (possiblement supérieur au prix de l'offre)
	- Type de paiement : unique ou récurrent
	- Durée et dates si pas renouvelable

]
[(#REM)

	1. Récupération et normalisation des infos (prix, renouvellement, etc.)
	On place les infos dans 2 variables 'commande' et 'offre'
	
]

[(#REM) Soit il y a une commande... ]
<BOUCLE_commande(COMMANDES)
	{id_auteur = #SESSION{id_auteur}}
	{statut = encours}
	{id_commande?}
	{reference?}
	{0,1}
	{!par date}
>
<BOUCLE_details(COMMANDES_DETAILS)
	{id_commande}
	{objet = abonnements_offre}
	{0,1}
>
#SET{commande, #ARRAY{
	montant, #PRIX*,
	id_abonnements_offre, #ID_OBJET,
	reference, #REFERENCE,
}}
</BOUCLE_details>
</BOUCLE_commande>

[(#REM) ...soit les infos sont encore en session ]
#SET{commande, #ARRAY{
	montant, #SESSION{commande_abonnement/montant},
	id_abonnements_offre, #SESSION{commande_abonnement/id_abonnements_offre}
}}
<//B_commande>

[(#REM) L'offre choisie ]
<BOUCLE_offre(ABONNEMENTS_OFFRES) {id_abonnements_offre = #GET{commande/id_abonnements_offre}}>
#SET{offre, #ARRAY{
	titre, #TITRE,
	duree, #DUREE,
	periode, #PERIODE,
	renouvellement_auto, #RENOUVELLEMENT_AUTO}
}
</BOUCLE_offre>

[(#REM) Y a-t-il un abonnement actif de cette offre ? Si oui la date de début c'est sa date de fin ]
<BOUCLE_abonnement(ABONNEMENTS)
	{id_auteur=#SESSION{id_auteur}}
	{id_abonnements_offre=#GET{commande/id_abonnements_offre}}
	{statut=actif}
	{!par date_fin}
	{0,1}
>
#SET{date_debut, #DATE_FIN}
</BOUCLE_abonnement>
#SET{date_debut, #ENV{date}}
<//B_abonnement>

[(#REM) Calcul de l'affichage du prix avec 2 cas particuliers ]
[(#SET{periodicite, #GET{offre/duree}|=={0}|?{<:abonnementsoffre:champ_duree_0:>,#VAL{abonnementsoffre:champ_periode_nb_}|concat{#GET{offre/periode}}|_T{#ARRAY{nb,#GET{offre/duree}}}}})]
[(#GET{offre/duree}|=={1}|et{#GET{offre/periode}|=={mois}})
	#SET{periodicite, mois}
]
[(#GET{offre/duree}|=={12}|et{#GET{offre/periode}|=={mois}})
	#SET{periodicite, an}
]

[(#REM) Formatage des dates si non renouvelable ]
[(#GET{offre/renouvellement_auto}|non)
	#SET{periodes, #ARRAY{
		heures,hour,
		jours, day,
		mois, month}
	}
	#SET{periode, #GET{periodes/#GET{offre/periode}}}
	#SET{date_fin, #VAL{Y-m-d H:i:s}|date{#GET{date_debut}|concat{" + ", #GET{offre/duree}, #GET{periode}}|strtotime}}
	#SET{dates, #GET{date_debut}|affdate_debut_fin{#GET{date_fin}, non}}
]

[(#REM)

	2. Affichage

]
<BOUCLE_affichage(CONDITION){si #GET{commande}|et{#GET{offre}}}>
<div class="offre offre--resume[ (#GET{offre/renouvellement_auto}|oui)renouvelable]">
	<div class="offre__wrapper">

		[<h3 class="offre__titre">
			(#GET{offre/titre})
		</h3>]

		[<div class="offre__commande">
			Commande n°(#GET{commande/reference})
		</div>]

		<div class="offre__prix">
			<span class="montant">#GET{commande/montant} €</span>
			[(#GET{offre/renouvellement_auto}|oui)
				<span class="par">/</span>
				<span class="periodicite">#GET{periodicite}</span>
			]
		</div>

		<div class="offre__duree">
			[(#GET{offre/renouvellement_auto}|non)
			<span class="label"><:abonnementsoffre:info_duree:> :</span>
				[(#GET{offre/duree}|singulier_ou_pluriel{abonnementsoffre:champ_periode_nb_#GET{offre/periode},abonnementsoffre:champ_periode_nb_#GET{offre/periode}})]
			]
			[(#GET{offre/renouvellement_auto}|oui)
				<:abonnementsoffre:info_renouvellement_auto:>
			]
		</div>
		
		<div class="offre__paiement">
			[(#GET{offre/renouvellement_auto}|non)
				<span class="label"><:abonnementsoffre:info_paiement:> :</span> <:abonnementsoffre:info_paiement_unique:>
			]
			[(#GET{offre/renouvellement_auto}|oui)
			<span class="label"><:abonnementsoffre:info_paiement_auto:> :</span> [(#GET{offre/duree})][ (#GET{offre/periode})]
			]
		</div>
		
		[<div class="offre__detail">
			(#SESSION{id_auteur}|?{#GET{dates}, <em><:abonnementsoffre:explication_renouvellement:></em>})
		</div>]
	</div>
</div>
</BOUCLE_affichage>
