#HTTP_HEADER{Content-Type: text/javascript}
#CACHE{24*3600,cache-client}

soundManager.setup({
	url: '[(#CHEMIN{swf/soundmanager2.swf}|url_absolue|dirname)/]',
	flashVersion: 9, // optional: shiny features (default = 8)
	useFlashBlock: false, // optionally, enable when you're ready to dive in
	debugMode: false
});

threeSixtyPlayer.config.scaleFont = (navigator.userAgent.match(/msie/i)?false:true);
threeSixtyPlayer.config.showHMSTime = true;

// enable some spectrum stuffs

threeSixtyPlayer.config.useWaveformData = true;
threeSixtyPlayer.config.useEQData = true;

// enable this in SM2 as well, as needed

if (threeSixtyPlayer.config.useWaveformData) {
  soundManager.flash9Options.useWaveformData = true;
}
if (threeSixtyPlayer.config.useEQData) {
  soundManager.flash9Options.useEQData = true;
}
if (threeSixtyPlayer.config.usePeakData) {
  soundManager.flash9Options.usePeakData = true;
}

if (threeSixtyPlayer.config.useWaveformData || threeSixtyPlayer.flash9Options.useEQData || threeSixtyPlayer.flash9Options.usePeakData) {
  // even if HTML5 supports MP3, prefer flash so the visualization features can be used.
  soundManager.preferFlash = true;
}

$(document).ready(function(){
	
	// scroller vers le player si timecode dans l'url d'arrivée #t10000
	var tc = window.location.hash.match(/^#t(\d+)$/);
	if(typeof tc !== "undefined" && tc){
		tc = parseInt(tc[1]);
		var archives = 0 ;
		var arch = $(".lesarchives").height();
		if(arch > 0)
			archives = arch + 150 ;
		$('body, html').animate({scrollTop: $("#podcast_player").offset().top - 40 - archives }, 500);
	}
	
	// sur quel son clique t'on ?
	$(".ui360").on("click",function(){
		// tuer tous les sons actifs
		var s = Object.values(soundManager.sounds)[Object.values(soundManager.sounds).length - 1] ;
		if(typeof s !== "undefined"){
			var son = Object.values(soundManager.sounds)[Object.values(soundManager.sounds).length - 1].id ;
			//var sound = soundManager.getSoundById('chinaCymbal');
			// console.log("clic sur", son);
		}
		// console.log("clic 360");
		$(this).addClass("playing");
	});
	
	// classe audio sur les liens avec time code.
	$("a").each(function(){
		var timecode = $(this)[0].href.match(/t(\d+)/) ;
		if(typeof timecode !== "undefined" && timecode){
			$(this).addClass("audio");
		}
	});
	
	// clic sur un lien avec timecode #t10000 ?
	$("a.audio").on("click",function(){
		// stopper un eventuel son en pause
		if(Object.values(soundManager.sounds).length > 0){
			soundManager.stopAll();
		}
		var timecode = $(this)[0].href.match(/t(\d+)/) ;
		if(typeof timecode !== "undefined" && timecode){
			timecode = timecode[1];
		}
		
		// démarrer le son
		if(typeof timecode !== "undefined" && timecode){
			$(".sm2-360btn").eq(0).click();
		}
		// décaler le dernier son ajouté par clic avec timecode
		var son = Object.values(soundManager.sounds)[Object.values(soundManager.sounds).length - 1] ;
		if(typeof timecode !== "undefined" && timecode && Object.values(soundManager.sounds).length > 0){
			// son.from = timecode ;
			// la valeur de from ci dessus n'est pas prise en compte, alors in décale le son
			son.setPosition(timecode);
		}
	});
	
	soundManager.onready(function() {
		$('.ui360').each( function(){
			var urlogo = $(this).find('.logo').attr('data-url');
			var couleur = $(this).find('.logo').attr('data-couleur');
			$(this).find('.sm2-360ui').css('background', '#'+couleur+' url("'+urlogo+'")');
			$(this).find('.logo').css('display', 'none');
		});
		
	});
	
	// bouton play / pause annexe ?
	if($(".ui360").length > 0){
		$("button.play_pause").click(function(){
			// son déjà chargé ?
			if(Object.values(soundManager.sounds).length == 0){
				$(".sm2-360btn").eq(0).click();
			}else{
				var son = Object.values(soundManager.sounds)[Object.values(soundManager.sounds).length - 1] ;
				if(typeof son !== "undefined" && Object.values(soundManager.sounds).length > 0){
					soundManager.togglePause(son.id);
				}
			}
		});
	}
	
	function maj_bouton_play_pause(){
		// console.log("toggle");
		if($("button.play_pause").text() === "pause"){
			$("button.play_pause").removeClass("bouton_playing").html("play").attr("title", $("button.play_pause").attr("data-lecture"));
		}else{
			$("button.play_pause").addClass("bouton_playing").html("pause").attr("title", $("button.play_pause").attr("data-pause"));
		}
	}
	// surcharge des events play/pause/finish : https://stackoverflow.com/questions/10127009/soundmanager2-onplay-event-configuration-does-not-work
	var onplay360 = threeSixtyPlayer.events.play;
	var myOnplay = function(){
		// le dernier son ajouté par clic
		var son = Object.values(soundManager.sounds)[Object.values(soundManager.sounds).length - 1] ;
		
		// décaler le départ du son qui joue si on a un timecode &f=30000 ou #t30000 dans l'url.
		// forcer les properties to et from ne semble pas marcher dans le player 360, on se limite à changer décaler la lecture avec setPosition.
		var from = (window.location.href).match(/f=(\d+)/) || (window.location.hash).match(/t(\d+)/) ;
		if(typeof from !== "undefined" && from){
			// son.from = parseInt(from[1]) ;
			// la valeur de from ci dessus n'est pas prise en compte, alors in décale le son
			son.setPosition(from[1]);
			//console.log(from);
		}else{
			var from = parseInt($(".playing").attr("data-from")) ;
			if(typeof from !== "undefined" && from){
				son.from = from ;
				// la valeur de from ci dessus n'est pas prise en compte, alors on décale le son
				son.setPosition(from);
				// console.log(from);
			}
		}
		
		// la valeur de to ci dessous n'est pas pris en compte
		var to = (window.location.href).match(/t=(\d+)/);
		if(typeof to !== "undefined" && to){
			// son.to = parseInt(to[1]) ;
		}
		
		$(".playing").removeClass("playing");
		maj_bouton_play_pause();
		onplay360.apply(this); // forces the scope to 'this' = the sound object
	};
	threeSixtyPlayer.events.play = myOnplay;
	
	var onpause360 = threeSixtyPlayer.events.pause;
	var myOnpause = function(){
		// console.log("pause de " + this.id);
		maj_bouton_play_pause();
		onpause360.apply(this); // forces the scope to 'this' = the sound object
	};
	threeSixtyPlayer.events.pause = myOnpause;
	
	var onresume360 = threeSixtyPlayer.events.resume;
	var myOnresume = function(){
		// console.log("resume de " + this.id);
		maj_bouton_play_pause();
		onresume360.apply(this); // forces the scope to 'this' = the sound object
	};
	threeSixtyPlayer.events.resume = myOnresume;
	
	var onfinish360 = threeSixtyPlayer.events.finish;
	var myOnfinish = function(){
		// console.log("finish de " + this.id);
		maj_bouton_play_pause();
		onfinish360.apply(this); // forces the scope to 'this' = the sound object
	};
	threeSixtyPlayer.events.finish = myOnfinish;
	
	var onstop360 = threeSixtyPlayer.events.stop;
	var myStop = function(){
		// console.log("arret de " + this.id);
		maj_bouton_play_pause();
		onstop360.apply(this); // forces the scope to 'this' = the sound object
	};
	threeSixtyPlayer.events.stop = myStop;

	var whileloading360 = threeSixtyPlayer.events.whileloading;
	var mywhileloading = function(){
		//console.log(this.id + ': loading ' + this.bytesLoaded + ' / ' + this.bytesTotal);
		whileloading360.apply(this); // forces the scope to 'this' = the sound object
	};
	threeSixtyPlayer.events.whileloading = mywhileloading;
	
	var onload360 = threeSixtyPlayer.events.onload;
	var myonload = function(){
		//console.log(this.id + ': loaded ' + this.bytesLoaded + ' / ' + this.bytesTotal);
		onload360.apply(this); // forces the scope to 'this' = the sound object
	};
	threeSixtyPlayer.events.onload = myonload;
	
	var whileplaying360 = threeSixtyPlayer.events.whileplaying;
	var mywhileplaying = function(){
		$(".id3").attr("title", Math.round(this.position));
		whileplaying360.apply(this); // forces the scope to 'this' = the sound object
	};
	threeSixtyPlayer.events.whileplaying = mywhileplaying;
});
