<?php
	if (!defined('_ECRIRE_INC_VERSION'))
		include ("inc_version.php");
	if (!defined("_ECRIRE_INC_TEXTE"))
		include_ecrire("inc_texte.php");
	if (!defined("_MES_FONCTIONS"))
		include("mes_fonctions.php");

	$toobar_selected='messages';
	$ajoute_toolbar="";

	//$ajoute_toolbar.="<div class='toolbar-agenda'>";
	$urlbase=parametre_url('[(#SELF)]','envoyes','');
	$urlbase=str_replace("&amp;","&",$urlbase);

	$url=$urlbase;
	if (!isset($envoyes))
		$ajoute_toolbar.="<span class='toolbar-icone-selected'>";
	else
		$ajoute_toolbar.="<span class='toolbar-icone'>";
	$ajoute_toolbar.="<a href='$url' title='Messages re&ccedil;us'><img src='habillage/ico_post_in.png'  widht='34' height='34' style='border:0px'></a>";
	$ajoute_toolbar.="</span>";
	$url=parametre_url($urlbase,'envoyes','1');
	if (isset($envoyes))
		$ajoute_toolbar.="<span class='toolbar-icone-selected'>";
	else
		$ajoute_toolbar.="<span class='toolbar-icone'>";
	$ajoute_toolbar.="<a href='$url' title='Messages envoy&eacute;s'><img src='habillage/ico_post_out.png'  widht='34' height='34' style='border:0px'></a>";
	$ajoute_toolbar.="</span>";
	//$ajoute_toolbar.="</div>";

?>
<INCLURE(haut.php)>
<!-- CONTENU -->

<?php
	// inits
	$nom_auteur=$visiteur_nom;
	$id_auteurs_destinataires=array();

	$visu_messages=array();
	$urlbase="[(#SELF|parametre_url{'new','1'}|parametre_url{'edit',''}|parametre_url{'del',''}|parametre_url{'ndate',''}|parametre_url{'id_message',''})]";
	$urlbase=str_replace("&amp;","&",$urlbase);

	// suppression
	if (isset($_POST['supprimer'])){
		foreach($_POST['action'] as $key=>$value){
	  	$query="SELECT spip_messages.* FROM `spip_messages` WHERE `id_message` = '$key';";
			$res = spip_query($query);
			if ($row=spip_fetch_array($res)) {
				if ($row['id_auteur']==$visiteur_id){ // message dont on est l'auteur --> suppression'
			  	spip_query("DELETE FROM `spip_auteurs_messages` WHERE `id_message` = '$key';");
			  	spip_query("DELETE FROM `spip_messages` WHERE `id_message` = '$key';");
				}
				else{ // message dont on est destinataire
			  	spip_query("DELETE FROM `spip_auteurs_messages` WHERE `id_message` = '$key' AND `id_auteur` = '$visiteur_id';");
			  	$query="SELECT spip_auteurs_messages.* FROM `spip_auteurs_messages` WHERE `id_message` = '$key';";
					$res = spip_query($query);
					if (!spip_fetch_array($res)) { // si tous les destinataires l'ont supprimé --> supression
				  	spip_query("DELETE FROM `spip_messages` WHERE `id_message` = '$key';");
				 	}
				}
		 	}
		}
	}

	// rappels
	if (isset($_POST['rappeler'])){
		foreach($_POST['action'] as $key=>$value){
			$query="UPDATE `spip_auteurs_messages` SET `vu`='non' WHERE `id_message` = '$key' AND `id_auteur` = '$visiteur_id';";
			$res=spip_query($query);
		}
	}
	// envoi
	if (isset($_POST['envoyer'])){
		$id_auteur=$_POST['id_auteur'];
		if ($id_auteur==$visiteur_id){
			$sujet=addslashes($_POST['sujet']);
			$texte=addslashes($_POST['texte']);
			$date_heure=date('Y-m-d H:i:s');
			$id_message = spip_abstract_insert("spip_messages",
					"(titre,texte,type,date_heure,date_fin,rv,statut,id_auteur,maj)",
					"('$sujet','$texte','normal','$date_heure','$date_heure','non','publie',$visiteur_id,NOW())");

			echo "id_auteur:$id_auteur:visiteur_id:$visiteur_id:id_message:$id_message";

			if ($id_message!=0){
				foreach($_POST['id_destinataires'] as $value){
					$id_dest=addslashes($value);
					spip_query("INSERT INTO `spip_auteurs_messages` (id_message, id_auteur, vu) VALUES ($id_message, $id_dest,'non');");
				}
			}
		}
	}

	<BOUCLE_voir(MESSAGES){id_message}>
		if (isset($visu_messages['#ID_MESSAGE'])){
			set_messages_toolbar('[(#SELF)]',$type);
			if (!isset($new)){
				$fid_message='#ID_MESSAGE';
				$ftitre='[(#TITRE|addslashes)]';
				$ftexte='[(#TEXTE|addslashes)]';
				$ftype='[(#TYPE|addslashes)]';
				$fstdatedeb=strtotime('#DATE_HEURE');
				$fstdatefin=strtotime('#DATE_FIN');
				$fstatut='#STATUT';
				$fidauteur='#ID_AUTEUR';
				$id_auteurs_destinataires=array();
				<BOUCLE_estdest(AUTEURS_MESSAGES){id_message}>
					$id_auteurs_destinataires['#ID_AUTEUR']=1;
				</BOUCLE_estdest>
			}
		}
	</BOUCLE_voir>
		if ($new==1) 	set_messages_toolbar('[(#SELF)]',$type);
		unset($id_message);
	<//B_voir>


	$query="SELECT nom FROM spip_auteurs WHERE id_auteur=$visiteur_id;";
	$res = spip_query($query);
	if ($row = spip_fetch_array($res)) {
		// tous les messages dont le visiteur est destinataire
		if (isset($envoyes))
			$query = "SELECT spip_messages.*,spip_auteurs.nom FROM spip_messages RIGHT JOIN spip_auteurs ON spip_messages.id_auteur=spip_auteurs.id_auteur WHERE spip_messages.id_auteur='$visiteur_id' AND spip_messages.type='normal' ORDER BY spip_messages.date_heure DESC;";
		else
			$query = "SELECT spip_messages.*,spip_auteurs.nom,spip_auteurs_messages.vu FROM spip_messages LEFT JOIN spip_auteurs_messages ON spip_messages.id_message=spip_auteurs_messages.id_message RIGHT JOIN spip_auteurs ON spip_messages.id_auteur=spip_auteurs.id_auteur WHERE spip_auteurs_messages.id_auteur='$visiteur_id' AND spip_messages.type='normal' ORDER BY spip_messages.date_heure DESC;";
		$res = spip_query($query);
		$table_messages[]="|{{ }}|{{De}}|{{A}}|{{Titre}}|{{Texte}}|{{Date}}|";
		$table_auteurs=array();
		while ($row = spip_fetch_array($res)){
			$url=parametre_url($urlbase,'id_message',$row['id_message']);
			if (!isset($row['vu'])) $row['vu']='oui';
			if (date("d-m-Y",strtotime($row['date_heure']))==date("d-m-Y"))
			  $date=date("H:i:s",strtotime($row['date_heure']));
			else
				$date=date("d-m-Y",strtotime($row['date_heure']));
			if ($row['vu']=='oui') {
				$texte = "|<input type='checkbox' name='action[".$row['id_message']."]'/>|".xhtmlEncodeText($row['nom'])."|";
				$query2 = "SELECT spip_auteurs_messages.*,spip_auteurs.nom FROM spip_auteurs_messages LEFT JOIN spip_auteurs ON spip_auteurs_messages.id_auteur=spip_auteurs.id_auteur WHERE spip_auteurs_messages.id_message='".$row['id_message']."' ;";
				$res2 = spip_query($query2);
				while ($row2 = spip_fetch_array($res2)){
					if (isset($envoyes)){
						if ($row2['vu']=='non')
							$texte.="{{".$row2['nom']."}}<br/>";
						else
							$texte.=$row2['nom']."<br/>";
					}
					else
						$texte.=$row2['nom']."<br/>";
				}
				$texte .= "|".xhtmlEncodeText($row['titre'])."|".nl2br(xhtmlEncodeText($row['texte']))."|$date|";
			}
			else {
				$texte = "|<input type='checkbox' name='action[".$row['id_message']."]'/>|{{".xhtmlEncodeText($row['nom'])."}}|";
				$query2 = "SELECT spip_auteurs_messages.*,spip_auteurs.nom FROM spip_auteurs_messages LEFT JOIN spip_auteurs ON spip_auteurs_messages.id_auteur=spip_auteurs.id_auteur WHERE spip_auteurs_messages.id_message='".$row['id_message']."' ;";
				$res2 = spip_query($query2);
				while ($row2 = spip_fetch_array($res2)){
					$texte.=$row2['nom']."<br/>";
				}
				$texte .= "|{{".xhtmlEncodeText($row['titre'])."}}|{{".nl2br(xhtmlEncodeText($row['texte']))."}}|{{ $date }}|";
			}
			$table_messages[]=$texte;
			/*$texte=wordwrap($row['objet'],15,"<br />\n")."<hr />";
			if ($type!='mois')
				$texte.=wordwrap(stripslashes($row['description']),15, "<br />\n");
			if (strlen($texte)==0) $texte="(sans objet)";
			agenda_memo_duree($row['date_debut'],$row['date_fin'],$row['lieu'],$texte,$url,$categorie[$row['type']]);
			$visu_messages[$row['id_evenement']]=1;*/
		}
		if (isset($envoyes))
			$table_messages[]="| |<input type='submit' name='supprimer' value='Supprimer'> | | | | |";
		else
			$table_messages[]="| |<input type='submit' name='rappeler' value='Rappeler'>|<input type='submit' name='supprimer' value='Supprimer'> | | | |";
		$texte=implode("\n",$table_messages);
		echo "<div class='messages-liste'>";
		if (isset($envoyes))
			echo "<div class='titre'>Messages Envoy&eacute;s</div>";
		else
			echo "<div class='titre'>Messages Re&ccedil;us</div>";

		echo "<form name='gestion' action='[(#SELF)]' method='post'>";
		echo propre($texte);
		echo "</form>";
		echo "</div>";
	}

	//boucle auteurs mutualisee
	$organisateur_output="";
	$invites_output="";
	$id_auteurs_invites=array();
	<BOUCLE_auteurtous(AUTEURS){par nom}{tout}>
	  if ('#STATUT'=='0minirezo'){
			if ($visiteur_id=='#ID_AUTEUR'){
				$organisateur_output .= "<option value='#ID_AUTEUR'";
				$organisateur_output .= " selected='selected'";
				$organisateur_output .= ">#NOM</option>\n";
			}

			$invites_output .= "<option value='#ID_AUTEUR'";
			if ((isset($id_auteurs_invites['#ID_AUTEUR']))||($id_dest=='#ID_AUTEUR'))
				$invites_output .= " selected='selected'";
			$invites_output .= ">#NOM</option>\n";
		}
	</BOUCLE_auteurtous>

	echo "<div class='messages-edition'>";
	echo "<form name='nouveau' action='[(#SELF|parametre_url{'envoyes','1'})]' method='post'>";
	echo "<div class='messages-edition-auteur-titre'>De</div><div class='messages-edition-auteur'>";
	echo "<select name='id_auteur' size='1'>\n";
	echo $organisateur_output;
	echo "</select></div>\n";
	echo "<div class='messages-edition-dest-titre'>A</div><div class='messages-edition-dest'>";
	echo "<select name='id_destinataires[]' size='8' multiple>\n";
	echo $invites_output;
	echo "</select></div>\n";
	echo "<div class='messages-edition-sujet-titre'>Sujet</div><div class='messages-edition-sujet'>";
	echo "<input type='text' name='sujet' value='' size='55' />";
	echo "</div>\n";
	echo "<div class='messages-edition-texte-titre'>Texte</div><div class='messages-edition-texte'>";
	echo "<textarea name='texte' cols='41' rows='7'>";
	echo "</textarea>\n";
	echo "</div>\n";
	echo "<div class='messages-edition-boutons'><input type='submit' name='envoyer' value='Envoyer'></div>\n";

?>

</div>
<!-- FIN CONTENU -->
<INCLURE(bas.php)>

