#CACHE{7200}
#HTTP_HEADER{"Cache-Control: no-store, no-cache, must-revalidate"}
#HTTP_HEADER{Pragma: no-cache}
#HTTP_HEADER{Content-type: text/html}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html dir="#LANG_DIR" lang="#LANG">
<head>
	<title>[(#NOM_SITE_SPIP|textebrut)]</title>
	<meta http-equiv="Content-Type" content="text/html; charset=#CHARSET" />
	[<meta name="description" content="(#DESCRIPTIF_SITE_SPIP|couper{150}|attribut_html)" />]
	<meta name="generator" content="SPIP" />
	[<link rel="shortcut icon" href="(#CHEMIN{favicon.ico})" />]

	<!-- Ceci est la feuille de style par defaut pour le code genere par SPIP -->
	<link rel="stylesheet" href="[(#CHEMIN{spip_style.css}|direction_css)]" type="text/css" media="all" />
	<!-- Feuille de styles CSS pour les postit -->
	<link rel="stylesheet" href="[(#CHEMIN{postit.css}|direction_css)]" type="text/css" media="projection, screen, tv" />
	<!-- Feuille de styles CSS pour l'impression -->
	<link rel="stylesheet" href="[(#CHEMIN{impression.css}|direction_css)]" type="text/css" media="print" />
	
<?php
	if ($auteur_session) {
		echo '<meta http-equiv="Refresh" content="180">';
	}
	echo "</head>\n";
	echo "<body >\n";

	if ($auteur_session) {
		$visiteur_id=$auteur_session['id_auteur'];
		$visiteur_nom=$auteur_session['nom'];
		$visiteur_statut=$auteur_session['statut'];

		include_spip("inc/filtres");

		// Messages non vus affiches en post-it ------------------------------------

		$res = spip_query("SELECT nom FROM spip_auteurs WHERE id_auteur=".spip_abstract_quote($visiteur_id));
		if ($row = spip_fetch_array($res)) {
		// un message a ete vu
			if (($id=_request('vu'))!==NULL){
				spip_query("UPDATE spip_auteurs_messages SET vu='oui' WHERE id_message = ".spip_abstract_quote($id)." AND id_auteur=".spip_abstract_quote($visiteur_id));
			}

			// tous les messages non lus dont le visiteur est destinataire
			$res = spip_query("SELECT messages.*,auteurs.nom FROM spip_messages AS messages 
								JOIN spip_auteurs_messages AS auteurs_messages, spip_auteurs AS auteurs 
								ON messages.id_message=auteurs_messages.id_message AND messages.id_auteur=auteurs.id_auteur 
								WHERE auteurs_messages.id_auteur=".spip_abstract_quote($visiteur_id).
								" AND messages.type='normal' AND auteurs_messages.vu='non'
								GROUP BY messages.id_message
								ORDER BY messages.date_heure DESC");
			$url=self();
			while ($row = spip_fetch_array($res)){
				echo "<div class='postit'>";
				$url=parametre_url($url,'vu',$row['id_message']);
				echo "<div class='postit-titre'><a href='$url'><img src='#CHEMIN{img_pack/croix.png}' width='12' height='12' alt='fermer' /></a>";
				echo propre($row['titre'])."</div>";
				echo "<div class='postit-auteur'>".propre($row['nom'])."</div>";
				echo "<div class='postit-texte'>".propre($row['texte'])."</div>";
				echo "</div>";
			}
 		}

		// Petit hack pour indiquer la connexion d'un visiteur
		@spip_query("UPDATE spip_auteurs SET en_ligne=NOW() WHERE id_auteur='$visiteur_id'");
	}
?>
</body>
</html>